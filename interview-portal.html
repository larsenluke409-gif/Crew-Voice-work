<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Interview Portal">
<meta name="theme-color" content="#0f1117">
<title>Crew Voice ‚Äî Interview Portal</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='%2300BFA5'/><text x='50' y='62' text-anchor='middle' font-size='40' font-weight='bold' fill='white' font-family='sans-serif'>CV</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#171b26;--surface2:#1e2336;--border:#2a3050;
  --text:#e8ecf4;--dim:#6b7a94;--teal:#00BFA5;--teal-dim:#009688;
  --emerald:#00E676;--sky:#40C4FF;--coral:#FF6B6B;--amber:#FFB300;
  --violet:#B388FF;--rose:#F06292;
  --red:#EF5350;--orange:#FFA726;--green:#66BB6A;
}
body.light-mode{
  --bg:#f4f5f7;--surface:#ffffff;--surface2:#eef0f4;--border:#d4d8e0;
  --text:#1a1a2e;--dim:#5a6478;--teal:#00897B;--teal-dim:#00695C;
  --emerald:#2E7D32;--sky:#0288D1;--coral:#d44040;--amber:#D4930D;
  --violet:#7C4DFF;--rose:#c93a6d;
  --red:#C62828;--orange:#EF6C00;--green:#2E7D32;
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-tap-highlight-color:transparent}
button,a,input,select,textarea{-webkit-tap-highlight-color:transparent;touch-action:manipulation;font-family:inherit}
a{color:var(--teal);text-decoration:none}
a:hover{color:var(--teal-dim)}
::selection{background:rgba(0,191,165,0.3)}

/* NAV */
#topNav{position:fixed;top:0;left:0;right:0;height:56px;background:linear-gradient(135deg,#12141f,#1a1e30);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:1000;backdrop-filter:blur(10px)}
body.light-mode #topNav{background:linear-gradient(135deg,#ffffff,#f0f1f5);border-bottom-color:var(--border)}
.nav-brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:15px;letter-spacing:1.5px;color:var(--teal);text-transform:uppercase}
.nav-brand svg{width:28px;height:28px;filter:drop-shadow(0 0 6px rgba(0,191,165,0.4))}
.nav-links{display:flex;gap:4px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.nav-links a{padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600;color:var(--dim);cursor:pointer;transition:all .2s;position:relative;white-space:nowrap}
.nav-links a:hover{color:var(--text);background:rgba(0,191,165,0.08)}
.nav-links a.active{color:var(--teal);background:rgba(0,191,165,0.12)}
.nav-links a.active::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:20px;height:2px;background:var(--teal);border-radius:2px}
.nav-right{display:flex;align-items:center;gap:4px}
.gear-btn{background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;padding:8px;border-radius:8px;transition:all .2s}
.gear-btn:hover{color:var(--teal);background:rgba(0,191,165,0.1)}

/* MAIN */
main{padding:72px 20px 24px;max-width:900px;margin:0 auto}
.view{display:none}
.view.active{display:block}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.card-glow{box-shadow:0 0 20px rgba(0,191,165,0.06)}
.card h3{font-size:15px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.section-title{font-size:22px;font-weight:800;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.section-title .icon{font-size:24px}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.kpi-value{font-size:28px;font-weight:800;color:var(--teal)}
.kpi-label{font-size:11px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-top:4px}
.kpi-card.warn .kpi-value{color:var(--coral)}
.kpi-card.good .kpi-value{color:var(--emerald)}

/* BADGES */
.badge{display:inline-block;padding:2px 10px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.badge-done{background:rgba(0,230,118,0.15);color:var(--emerald)}
.badge-pending{background:rgba(255,179,0,0.15);color:var(--amber)}
.badge-due{background:rgba(255,107,107,0.15);color:var(--coral)}
.badge-draft{background:rgba(179,136,255,0.15);color:var(--violet)}
.badge-delivered{background:rgba(0,191,165,0.15);color:var(--teal)}
.badge-scheduled{background:rgba(64,196,255,0.15);color:var(--sky)}
.badge-skipped{background:rgba(107,122,148,0.15);color:var(--dim)}

/* BUTTONS */
.btn{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--teal);color:#fff}
.btn-primary:hover{background:var(--teal-dim)}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--border)}
.btn-danger{background:rgba(239,83,80,0.15);color:var(--red);border:1px solid rgba(239,83,80,0.3)}
.btn-danger:hover{background:rgba(239,83,80,0.25)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn:disabled{opacity:0.4;cursor:not-allowed}

/* FORM */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.form-control{width:100%;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:14px;outline:none;transition:border-color .2s}
.form-control:focus{border-color:var(--teal)}
select.form-control{cursor:pointer}
textarea.form-control{resize:vertical;min-height:80px}

/* PROGRESS BAR */
.progress-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin:8px 0}
.progress-fill{height:100%;background:var(--teal);border-radius:4px;transition:width .4s ease}
.progress-fill.warn{background:var(--orange)}
.progress-fill.danger{background:var(--red)}

/* CLIENT ROW */
.client-row{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;background:var(--surface2);margin-bottom:8px;transition:all .2s;cursor:pointer}
.client-row:hover{background:var(--border)}
.client-name{flex:1;font-weight:700;font-size:14px}
.client-meta{font-size:12px;color:var(--dim)}
.client-progress{width:120px}

/* SCHEDULE */
.month-nav{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.month-nav .month-label{font-size:18px;font-weight:800;min-width:180px;text-align:center}
.month-nav button{background:var(--surface2);border:1px solid var(--border);color:var(--text);width:36px;height:36px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.month-nav button:hover{background:var(--border);color:var(--teal)}

.emp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-top:12px}
.emp-chip{padding:10px 14px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);display:flex;flex-direction:column;gap:4px;transition:all .2s;cursor:pointer}
.emp-chip:hover{border-color:var(--teal)}
.emp-chip .emp-name{font-weight:700;font-size:13px}
.emp-chip .emp-role{font-size:11px;color:var(--dim)}
.emp-chip .emp-lang{font-size:11px;color:var(--sky)}
.emp-chip.status-completed{border-color:var(--emerald);background:rgba(0,230,118,0.05)}
.emp-chip.status-scheduled{border-color:var(--sky);background:rgba(64,196,255,0.05)}
.emp-chip.status-skipped{border-color:var(--dim);opacity:0.6}

/* INTERVIEW FORM */
.interview-header{background:linear-gradient(135deg,rgba(0,191,165,0.12),rgba(0,191,165,0.04));border:1px solid rgba(0,191,165,0.2);border-radius:14px;padding:20px;margin-bottom:20px}
.interview-header .ih-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px}
.interview-header .ih-company{font-size:18px;font-weight:800;color:var(--teal)}
.interview-header .ih-crew{font-size:14px;color:var(--text);margin-top:4px}
.interview-header .ih-meta{font-size:12px;color:var(--dim);margin-top:4px}
.timer{font-size:24px;font-weight:800;color:var(--teal);font-variant-numeric:tabular-nums}

.q-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.q-num{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;background:rgba(0,191,165,0.15);color:var(--teal);font-size:13px;font-weight:800;margin-right:8px;flex-shrink:0}
.q-category{font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.q-bilingual{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:12px 0}
.q-text{font-size:14px;line-height:1.5}
.q-text.es{color:var(--dim);font-style:italic}
.q-lang-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.q-lang-label.en{color:var(--sky)}
.q-lang-label.es{color:var(--amber)}

.rating-row{display:flex;align-items:center;gap:8px;margin:12px 0}
.rating-btn{width:40px;height:40px;border-radius:10px;border:2px solid var(--border);background:var(--surface2);color:var(--text);font-size:16px;font-weight:800;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.rating-btn:hover{border-color:var(--teal);transform:scale(1.05)}
.rating-btn.active.r1,.rating-btn.active.r2{background:var(--red);border-color:var(--red);color:#fff}
.rating-btn.active.r3{background:var(--orange);border-color:var(--orange);color:#fff}
.rating-btn.active.r4,.rating-btn.active.r5{background:var(--green);border-color:var(--green);color:#fff}
.rating-label{font-size:11px;color:var(--dim);margin-left:4px}

.flag-btn{padding:5px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--dim);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.flag-btn:hover{border-color:var(--coral)}
.flag-btn.flagged{background:rgba(255,107,107,0.15);border-color:var(--coral);color:var(--coral)}

.mood-grid{display:flex;gap:8px}
.mood-btn{width:44px;height:44px;border-radius:10px;border:2px solid var(--border);background:var(--surface2);font-size:22px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.mood-btn:hover{border-color:var(--teal);transform:scale(1.1)}
.mood-btn.active{border-color:var(--teal);background:rgba(0,191,165,0.15)}

.risk-select{display:flex;gap:8px}
.risk-opt{padding:6px 14px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--dim);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.risk-opt:hover{border-color:var(--teal)}
.risk-opt.active.risk-none{border-color:var(--green);color:var(--green);background:rgba(102,187,106,0.1)}
.risk-opt.active.risk-low{border-color:var(--amber);color:var(--amber);background:rgba(255,179,0,0.1)}
.risk-opt.active.risk-medium{border-color:var(--orange);color:var(--orange);background:rgba(255,167,38,0.1)}
.risk-opt.active.risk-high{border-color:var(--red);color:var(--red);background:rgba(239,83,80,0.1)}

.interview-actions{display:flex;gap:10px;justify-content:flex-end;padding:20px 0;flex-wrap:wrap}

/* REPORTS */
.report-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.report-card .rc-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
.rc-company{font-size:16px;font-weight:800}
.rc-meta{font-size:12px;color:var(--dim);margin-top:4px}

/* REPORT BUILDER */
.report-preview{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;margin-top:16px}
.rp-header{text-align:center;border-bottom:3px solid var(--teal);padding-bottom:16px;margin-bottom:20px}
.rp-header h2{font-size:20px;font-weight:800;color:var(--teal)}
.rp-header p{font-size:13px;color:var(--dim);margin-top:4px}
.rp-section{margin-bottom:20px}
.rp-section h4{font-size:14px;font-weight:800;margin-bottom:10px;color:var(--teal)}
.cat-bar{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.cat-bar .cat-name{width:110px;font-size:12px;font-weight:600;text-align:right}
.cat-bar .cat-track{flex:1;height:20px;background:var(--surface2);border-radius:4px;overflow:hidden}
.cat-bar .cat-fill{height:100%;border-radius:4px;transition:width .4s}
.cat-bar .cat-val{width:30px;font-size:13px;font-weight:700;text-align:center}
.strength-item,.concern-item{padding:8px 14px;border-radius:8px;margin-bottom:6px;font-size:13px}
.strength-item{background:rgba(0,230,118,0.08);border-left:3px solid var(--emerald)}
.concern-item{background:rgba(255,107,107,0.08);border-left:3px solid var(--coral)}

.crew-card-report{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:12px}
.crew-card-report .ccr-name{font-weight:700;font-size:14px}
.crew-card-report .ccr-role{font-size:12px;color:var(--dim)}

/* HISTORY */
.trend-chart{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;overflow-x:auto}
.trend-svg{width:100%;min-width:400px}
.history-row{padding:12px 16px;border-radius:10px;background:var(--surface2);margin-bottom:8px;cursor:pointer;transition:all .2s}
.history-row:hover{background:var(--border)}
.history-row .hr-top{display:flex;justify-content:space-between;align-items:center}
.history-row .hr-date{font-weight:700;font-size:14px}
.history-row .hr-detail{display:none;padding-top:12px;border-top:1px solid var(--border);margin-top:12px}
.history-row.expanded .hr-detail{display:block}

/* COMPARISON */
.comparison-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.comp-col{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px}
.comp-col h4{font-size:14px;font-weight:800;margin-bottom:12px;color:var(--teal)}
.delta-pos{color:var(--emerald);font-weight:700}
.delta-neg{color:var(--coral);font-weight:700}
.delta-flat{color:var(--dim);font-weight:700}

/* ALERTS */
.alert-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;margin-bottom:6px;font-size:13px}
.alert-item.alert-warning{background:rgba(255,167,38,0.08);border-left:3px solid var(--orange)}
.alert-item.alert-danger{background:rgba(239,83,80,0.08);border-left:3px solid var(--red)}
.alert-item .alert-icon{font-size:16px}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.active{display:flex}
body.light-mode .modal-overlay{background:rgba(0,0,0,0.4)}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto}
.modal h3{font-size:18px;font-weight:800;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.modal-wide{max-width:800px}

/* EMPTY */
.empty-state{text-align:center;padding:40px 20px;color:var(--dim)}
.empty-state .empty-icon{font-size:48px;margin-bottom:12px}
.empty-state p{font-size:14px;line-height:1.6}

/* PRINT */
@media print{
  #topNav,.nav-links,.gear-btn,.btn,.modal-overlay,.no-print,
  .interview-actions,.month-nav{display:none!important}
  body,body.light-mode{background:#fff!important;color:#1a1a2e!important;font-size:11pt}
  main{padding:0!important;max-width:100%!important}
  .view{display:none!important}
  #printReport{display:block!important}
  .card,.report-preview,.report-card,.crew-card-report,.q-card{
    background:#fff!important;border:1px solid #ddd!important;break-inside:avoid;
    -webkit-print-color-adjust:exact;print-color-adjust:exact
  }
  .rp-header{border-bottom:3px solid #00BFA5!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .rp-header h2{color:#00BFA5!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .cat-fill{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
  .strength-item{border-left:3px solid #00E676!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .concern-item{border-left:3px solid #FF6B6B!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .print-footer{display:block!important;text-align:center;font-size:10pt;color:#666;margin-top:30px;padding-top:12px;border-top:1px solid #ddd}
  .detail-actions{display:none!important}
  .risk-table{border:1px solid #ddd!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .risk-table th,.risk-table td{border:1px solid #ddd!important}
  #aiLoadingOverlay,.toast{display:none!important}
  .detail-rating .dr-dot{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .detail-flag{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .detail-notes{background:#f5f5f5!important;border:1px solid #ddd!important}
  .interview-detail .detail-header{border:1px solid #00BFA5!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
.print-footer{display:none}
#printReport{display:none}

/* CLIENT EDIT MODAL */
.edit-btn{background:none;border:none;cursor:pointer;font-size:14px;padding:4px 6px;border-radius:6px;transition:all .2s;color:var(--dim);flex-shrink:0}
.edit-btn:hover{color:var(--teal);background:rgba(0,191,165,0.1)}
.crew-list-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;background:var(--surface2);margin-bottom:6px}
.crew-list-item .crew-info{flex:1;min-width:0}
.crew-list-item .crew-name{font-weight:700;font-size:13px}
.crew-list-item .crew-detail{font-size:11px;color:var(--dim)}
.crew-list-item .crew-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:16px;padding:4px 8px;border-radius:6px;transition:all .2s}
.crew-list-item .crew-del:hover{color:var(--red);background:rgba(239,83,80,0.1)}
.add-crew-form{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:8px}
.add-crew-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.add-crew-chip{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border-radius:10px;background:var(--surface2);border:2px dashed var(--border);color:var(--dim);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.add-crew-chip:hover{border-color:var(--teal);color:var(--teal);background:rgba(0,191,165,0.05)}

/* AI ANALYSIS */
.ai-loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:3000;display:flex;align-items:center;justify-content:center}
.ai-loading-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px 40px;text-align:center;max-width:360px}
.ai-spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--teal);border-radius:50%;animation:aiSpin 1s linear infinite;margin:0 auto 16px}
@keyframes aiSpin{to{transform:rotate(360deg)}}
.ai-loading-card .ai-msg{font-size:14px;font-weight:600;color:var(--text)}
.ai-loading-card .ai-sub{font-size:12px;color:var(--dim);margin-top:6px}
.ai-analysis-section{background:linear-gradient(135deg,rgba(0,191,165,0.08),rgba(179,136,255,0.05));border:1px solid rgba(0,191,165,0.2);border-radius:14px;padding:20px;margin:16px 0}
.ai-analysis-section h3{font-size:16px;font-weight:800;color:var(--teal);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.ai-rec-item{padding:10px 14px;border-radius:8px;margin-bottom:6px;font-size:13px;background:var(--surface2);border:1px solid var(--border)}
.ai-rec-priority{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-left:6px;padding:1px 6px;border-radius:4px}
.ai-rec-priority.high{color:var(--red);background:rgba(239,83,80,0.1)}
.ai-rec-priority.medium{color:var(--orange);background:rgba(255,167,38,0.1)}
.ai-rec-priority.low{color:var(--green);background:rgba(102,187,106,0.1)}
.ai-talk-item{padding:8px 14px;border-radius:8px;margin-bottom:6px;font-size:13px;border-left:3px solid var(--amber);background:rgba(255,179,0,0.06)}
.ai-risk-box{padding:14px;border-radius:10px;border:1px solid var(--border);margin:12px 0}
.ai-risk-box.risk-high{border-color:var(--red);background:rgba(239,83,80,0.06)}
.ai-risk-box.risk-medium{border-color:var(--orange);background:rgba(255,167,38,0.06)}
.ai-risk-box.risk-low{border-color:var(--amber);background:rgba(255,179,0,0.06)}
.ai-risk-box.risk-none{border-color:var(--green);background:rgba(102,187,106,0.06)}
.ai-error-box{padding:14px;border-radius:10px;border:1px solid rgba(239,83,80,0.3);background:rgba(239,83,80,0.08);color:var(--coral);font-size:13px;margin:12px 0}
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:4000;opacity:0;pointer-events:none;transition:opacity .3s,transform .3s;transform:translateY(20px)}
.toast.show{opacity:1;pointer-events:auto;transform:translateY(0)}
.toast-success{background:var(--emerald);color:#fff}
.toast-error{background:var(--red);color:#fff}

/* INTERVIEW DETAIL (read-only view) */
.interview-detail{padding-bottom:20px}
.interview-detail .detail-header{background:linear-gradient(135deg,rgba(0,191,165,0.12),rgba(0,191,165,0.04));border:1px solid rgba(0,191,165,0.2);border-radius:14px;padding:20px;margin-bottom:20px}
.interview-detail .detail-header .dh-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px}
.interview-detail .detail-header .dh-company{font-size:18px;font-weight:800;color:var(--teal)}
.interview-detail .detail-header .dh-crew{font-size:14px;color:var(--text);margin-top:4px}
.interview-detail .detail-header .dh-meta{font-size:12px;color:var(--dim);margin-top:4px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.detail-rating{display:inline-flex;align-items:center;gap:4px;margin:12px 0}
.detail-rating .dr-dot{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff}
.detail-rating .dr-dot.inactive{background:var(--surface2);color:var(--dim);border:1px solid var(--border)}
.detail-rating .dr-dot.r1,.detail-rating .dr-dot.r2{background:var(--red)}
.detail-rating .dr-dot.r3{background:var(--orange)}
.detail-rating .dr-dot.r4,.detail-rating .dr-dot.r5{background:var(--green)}
.detail-rating .dr-label{font-size:12px;font-weight:600;color:var(--dim);margin-left:6px}
.detail-notes{font-size:13px;line-height:1.6;color:var(--text);background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin-top:8px;white-space:pre-wrap}
.detail-notes:empty{display:none}
.detail-field{margin-bottom:12px}
.detail-field .df-label{font-size:12px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.detail-field .df-value{font-size:13px;line-height:1.6;color:var(--text);white-space:pre-wrap}
.detail-flag{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:6px;background:rgba(255,107,107,0.15);border:1px solid rgba(255,107,107,0.3);color:var(--coral);font-size:11px;font-weight:700}
.detail-actions{display:flex;gap:10px;flex-wrap:wrap;padding:20px 0;border-top:1px solid var(--border);margin-top:20px}

/* RESPONSIVE */
@media(max-width:768px){
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .q-bilingual{grid-template-columns:1fr}
  .nav-links{gap:2px}
  .nav-links a{padding:6px 10px;font-size:12px}
  .comparison-grid{grid-template-columns:1fr}
  .emp-grid{grid-template-columns:1fr 1fr}
  .month-nav .month-label{font-size:15px;min-width:140px}
  .interview-header .ih-top{flex-direction:column}
  .interview-actions{flex-direction:column}
  .interview-actions .btn{width:100%;justify-content:center}
  .detail-actions{flex-direction:column}
  .detail-actions .btn{width:100%;justify-content:center}
  .interview-detail .detail-header .dh-top{flex-direction:column}
}
@media(max-width:480px){
  .emp-grid{grid-template-columns:1fr}
  #topNav{padding:0 12px}
  main{padding:64px 12px 16px}
  .kpi-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<!-- NAV -->
<nav id="topNav">
  <div class="nav-brand">
    <svg viewBox="0 0 100 100" width="28" height="28"><circle cx="50" cy="50" r="48" fill="#00BFA5"/><text x="50" y="62" text-anchor="middle" font-size="40" font-weight="bold" fill="white" font-family="sans-serif">CV</text></svg>
    Interview Portal
  </div>
  <div class="nav-links">
    <a onclick="showView('dashboard')" data-view="dashboard">Dashboard</a>
    <a onclick="showView('schedule')" data-view="schedule">Schedule</a>
    <a onclick="showView('interview')" data-view="interview">Interview</a>
    <a onclick="showView('reports')" data-view="reports">Reports</a>
    <a onclick="showView('history')" data-view="history">History</a>
  </div>
  <div class="nav-right">
    <button class="gear-btn" onclick="toggleTheme()" title="Toggle theme">‚óê</button>
    <button class="gear-btn" onclick="openSettings()" title="Settings">‚öô</button>
  </div>
</nav>

<main>
  <!-- DASHBOARD -->
  <div id="v-dashboard" class="view active">
    <div class="section-title"><span class="icon">üìä</span> Dashboard</div>
    <div class="kpi-grid" id="kpiGrid"></div>
    <div class="card" id="alertsCard" style="display:none">
      <h3>‚ö† Alerts</h3>
      <div id="alertsList"></div>
    </div>
    <div class="card">
      <h3>üìã Client Progress</h3>
      <div id="clientProgressList"></div>
    </div>
    <div class="card">
      <h3>üìÖ Upcoming Interviews</h3>
      <div id="upcomingList"></div>
    </div>
  </div>

  <!-- SCHEDULE -->
  <div id="v-schedule" class="view">
    <div class="section-title"><span class="icon">üìÖ</span> Schedule</div>
    <div class="month-nav">
      <button onclick="changeSchedMonth(-1)">‚óÄ</button>
      <span class="month-label" id="schedMonthLabel"></span>
      <button onclick="changeSchedMonth(1)">‚ñ∂</button>
      <button class="btn btn-sm btn-secondary" onclick="goToday()">Today</button>
      <select class="form-control" id="schedClientFilter" onchange="renderSchedule()" style="width:auto;margin-left:auto"></select>
    </div>
    <div id="scheduleContent"></div>
  </div>

  <!-- INTERVIEW -->
  <div id="v-interview" class="view">
    <div id="interviewSelect">
      <div class="section-title"><span class="icon">üé§</span> Start Interview</div>
      <div class="card">
        <div class="form-group">
          <label>Client</label>
          <select class="form-control" id="intClient" onchange="loadIntEmployees()">
            <option value="">Select client...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Crew Member</label>
          <select class="form-control" id="intEmployee" disabled>
            <option value="">Select crew member...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Language</label>
          <select class="form-control" id="intLanguage">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="both">Both</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="startInterview()">üé§ Start Interview</button>
      </div>
      <div class="card" id="draftsCard" style="display:none">
        <h3>üìù Saved Drafts</h3>
        <div id="draftsList"></div>
      </div>
    </div>
    <div id="interviewForm" style="display:none"></div>
  </div>

  <!-- REPORTS -->
  <div id="v-reports" class="view">
    <div class="section-title"><span class="icon">üìÑ</span> Reports</div>
    <div class="month-nav">
      <button onclick="changeReportMonth(-1)">‚óÄ</button>
      <span class="month-label" id="reportMonthLabel"></span>
      <button onclick="changeReportMonth(1)">‚ñ∂</button>
      <button class="btn btn-sm btn-secondary" onclick="goReportToday()">Today</button>
    </div>
    <div id="reportsContent"></div>
    <div id="reportBuilder" style="display:none"></div>
  </div>

  <!-- HISTORY -->
  <div id="v-history" class="view">
    <div class="section-title"><span class="icon">üìà</span> History</div>
    <div class="card">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div class="form-group" style="flex:1;min-width:200px">
          <label>Client</label>
          <select class="form-control" id="histClient" onchange="loadHistEmployees()">
            <option value="">Select client...</option>
          </select>
        </div>
        <div class="form-group" style="flex:1;min-width:200px">
          <label>Crew Member</label>
          <select class="form-control" id="histEmployee" disabled onchange="renderHistory()">
            <option value="">Select crew member...</option>
          </select>
        </div>
      </div>
    </div>
    <div id="historyContent"></div>
  </div>
</main>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()">
  <div class="modal">
    <h3>‚öô Settings</h3>
    <div class="form-group">
      <label>Interviewer Name</label>
      <input class="form-control" id="setName" placeholder="Your name">
    </div>
    <div class="form-group">
      <label>Company Name</label>
      <input class="form-control" id="setCompany" value="Crew Voice">
    </div>
    <div class="form-group">
      <label>Default Interview Duration (min)</label>
      <input class="form-control" type="number" id="setDuration" value="20" min="5" max="60">
    </div>
    <div class="form-group">
      <label>Theme</label>
      <select class="form-control" id="setTheme">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
    </div>
    <div style="border-top:1px solid var(--border);margin:16px 0;padding-top:16px">
      <div style="font-size:14px;font-weight:800;margin-bottom:12px;color:var(--teal)">AI Analysis</div>
      <div class="form-group">
        <label>Claude API Key</label>
        <div style="position:relative">
          <input class="form-control" type="password" id="setApiKey" placeholder="sk-ant-..." style="padding-right:40px">
          <button type="button" onclick="toggleApiKeyVisibility()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--dim);cursor:pointer;font-size:14px" id="apiKeyToggle">üëÅ</button>
        </div>
        <div style="font-size:11px;color:var(--dim);margin-top:4px">Required for AI interview analysis. Stored locally, only sent to Anthropic's API.</div>
      </div>
      <div class="form-group">
        <label>AI Model</label>
        <select class="form-control" id="setAiModel">
          <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 (recommended)</option>
          <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (faster, cheaper)</option>
        </select>
      </div>
    </div>
    <div style="border-top:1px solid var(--border);margin:16px 0;padding-top:16px">
      <div style="font-size:14px;font-weight:800;margin-bottom:12px;color:var(--teal)">Data Backup</div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="exportData()" style="flex:1">&#11123; Export Backup</button>
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="flex:1">&#11121; Import Backup</button>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
      </div>
      <div style="font-size:11px;color:var(--dim);margin-top:6px">Export regularly to protect your interview data.</div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
      <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<!-- SCHEDULE INTERVIEW MODAL -->
<div class="modal-overlay" id="scheduleModal" onclick="if(event.target===this)closeSchedModal()">
  <div class="modal">
    <h3>üìÖ Schedule Interview</h3>
    <div id="schedModalContent"></div>
  </div>
</div>

<!-- DELIVERY MODAL -->
<div class="modal-overlay" id="deliveryModal" onclick="if(event.target===this)closeDeliveryModal()">
  <div class="modal">
    <h3>üì¨ Mark as Delivered</h3>
    <div class="form-group">
      <label>Delivery Method</label>
      <select class="form-control" id="delMethod">
        <option value="email">Email</option>
        <option value="in-person">In-Person Meeting</option>
        <option value="video">Video Call</option>
        <option value="mail">Physical Mail</option>
      </select>
    </div>
    <div class="form-group">
      <label>Delivery Date</label>
      <input class="form-control" type="date" id="delDate">
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea class="form-control" id="delNotes" placeholder="Optional delivery notes..."></textarea>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
      <button class="btn btn-secondary" onclick="closeDeliveryModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmDelivery()">Confirm Delivery</button>
    </div>
  </div>
</div>

<!-- CLIENT EDIT MODAL -->
<div class="modal-overlay" id="clientEditModal" onclick="if(event.target===this)closeClientEdit()">
  <div class="modal modal-wide">
    <h3>‚úèÔ∏è Edit Client</h3>
    <div id="clientEditContent"></div>
  </div>
</div>

<!-- PRINT REPORT (hidden, shown only for print) -->
<div id="printReport"></div>

<!-- AI LOADING OVERLAY -->
<div id="aiLoadingOverlay" style="display:none" class="ai-loading-overlay">
  <div class="ai-loading-card">
    <div class="ai-spinner"></div>
    <div class="ai-msg">Generating report...</div>
    <div class="ai-sub">Analyzing all interviews ‚Äî this usually takes 10-20 seconds</div>
  </div>
</div>

<!-- TOAST -->
<div id="toastEl" class="toast"></div>

<script>
/* ============ CONSTANTS ============ */
const LS_KEY = 'crewVoiceInterviews';
const HQ_KEY = 'crewVoiceHQ';
const CATEGORIES = ['satisfaction','management','pay','safety','communication','equipment','teamMorale','workload','training','future'];
const CAT_LABELS = {satisfaction:'Satisfaction',management:'Management',pay:'Pay & Benefits',safety:'Safety',communication:'Communication',equipment:'Equipment',teamMorale:'Team Morale',workload:'Workload',training:'Training',future:'Future / Retention'};
const MOODS = ['üòü','üòê','üôÇ','üòä','ü§©'];
const QUESTIONS = [
  {id:1,cat:'satisfaction',en:'How has your last month been overall?',es:'¬øC√≥mo ha sido tu √∫ltimo mes en general?'},
  {id:2,cat:'communication',en:'Have any issues been solved or improved since our last call? If so, what are they?',es:'¬øSe han resuelto o mejorado algunos problemas desde nuestra √∫ltima llamada? Si es as√≠, ¬øcu√°les?'},
  {id:3,cat:'satisfaction',en:'What have you been enjoying about working here lately?',es:'¬øQu√© has estado disfrutando de trabajar aqu√≠ √∫ltimamente?'},
  {id:4,cat:'management',en:'How have you felt working with your supervisor this past month?',es:'¬øC√≥mo te has sentido trabajando con tu supervisor este √∫ltimo mes?'},
  {id:5,cat:'communication',en:'Do you feel like you can bring up concerns or ideas and be heard?',es:'¬øSientes que puedes expresar tus preocupaciones o ideas y ser escuchado?'},
  {id:6,cat:'workload',en:'What issues do you see that are still affecting the effectiveness of the company?',es:'¬øQu√© problemas ves que todav√≠a afectan la efectividad de la empresa?'},
  {id:7,cat:'equipment',en:'Are there any issues with the equipment and tools? Anything broken, missing, or needed?',es:'¬øHay alg√∫n problema con los equipos y herramientas? ¬øAlgo roto, que falte o que se necesite?'},
  {id:8,cat:'workload',en:'How do you feel about your schedule and hours? Is the workload manageable?',es:'¬øC√≥mo te sientes con tu horario y horas? ¬øEs manejable la carga de trabajo?'},
  {id:9,cat:'pay',en:'How do you feel about your pay? Do you feel it\'s fair for the work you do?',es:'¬øC√≥mo te sientes con tu pago? ¬øSientes que es justo por el trabajo que haces?'},
  {id:10,cat:'safety',en:'Do you feel safe on the job? Any safety concerns?',es:'¬øTe sientes seguro en el trabajo? ¬øAlguna preocupaci√≥n de seguridad?'},
  {id:11,cat:'teamMorale',en:'How\'s team morale? How\'s your relationship with the rest of the crew?',es:'¬øC√≥mo est√° la moral del equipo? ¬øC√≥mo es tu relaci√≥n con el resto del equipo?'},
  {id:12,cat:'future',en:'Do you see yourself working here long-term ‚Äî another year or more? What would keep you here?',es:'¬øTe ves trabajando aqu√≠ a largo plazo ‚Äî un a√±o m√°s o m√°s? ¬øQu√© te har√≠a quedarte?'},
  {id:13,cat:'satisfaction',en:'Is there anything in your personal life that is affecting your work life?',es:'¬øHay algo en tu vida personal que est√© afectando tu vida laboral?'},
  {id:14,cat:'satisfaction',en:'Is there anything that would help you be happier at work? Anything else you\'d like to share?',es:'¬øHay algo que te ayudar√≠a a estar m√°s feliz en el trabajo? ¬øAlgo m√°s que quieras compartir?'}
];

/* ============ HELPERS ============ */
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function today(){return new Date().toISOString().slice(0,10)}
function thisMonth(){return new Date().toISOString().slice(0,7)}
function monthStr(ym){const[y,m]=ym.split('-');const mn=['January','February','March','April','May','June','July','August','September','October','November','December'];return mn[parseInt(m)-1]+' '+y}
function addMonth(ym,d){const[y,m]=ym.split('-').map(Number);const dt=new Date(y,m-1+d,1);return dt.toISOString().slice(0,7)}

/* ============ DATA ============ */
function loadData(){
  try{
    const d=JSON.parse(localStorage.getItem(LS_KEY))||defaultData();
    // Migrate old data
    if(!d.clientQuestions)d.clientQuestions={};
    if(!d.settings)d.settings={};
    if(!d.settings.claudeApiKey)d.settings.claudeApiKey='';
    if(!d.settings.aiModel)d.settings.aiModel='claude-sonnet-4-5-20250929';
    return d;
  }catch(e){return defaultData()}
}
function defaultData(){
  return{interviews:[],reports:[],schedule:[],clientQuestions:{},settings:{theme:'dark',defaultInterviewDuration:20,interviewerName:'Luke',companyName:'Crew Voice',claudeApiKey:'',aiModel:'claude-sonnet-4-5-20250929'}}
}
function save(d){localStorage.setItem(LS_KEY,JSON.stringify(d))}

function exportData(){
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='interview-portal-backup-'+new Date().toISOString().slice(0,10)+'.json';
  a.click();URL.revokeObjectURL(a.href);
}
function importData(e){
  var file=e.target.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(ev){
    try{
      var imported=JSON.parse(ev.target.result);
      if(!imported||typeof imported!=='object'){alert('Invalid backup file.');return}
      if(!confirm('This will REPLACE all current data with the backup. Are you sure?'))return;
      data=imported;save(data);location.reload();
    }catch(err){alert('Error reading backup file: '+err.message)}
  };
  reader.readAsText(file);
  e.target.value='';
}

function getHQ(){
  try{return JSON.parse(localStorage.getItem(HQ_KEY))||null}
  catch(e){return null}
}
function getActiveClients(){
  const hq=getHQ();
  if(!hq||!hq.contacts)return[];
  return hq.contacts.filter(l=>l.status==='Closed');
}
function getClientEmployees(clientId){
  const hq=getHQ();
  if(!hq||!hq.contacts)return[];
  const client=hq.contacts.find(l=>l.id===clientId);
  return client&&client.employees?client.employees:[];
}
function getClientName(clientId){
  const clients=getActiveClients();
  const c=clients.find(cl=>cl.id===clientId);
  return c?c.company||c.name||'Unknown':'Unknown';
}
function getEmployeeName(clientId,empId){
  const emps=getClientEmployees(clientId);
  const e=emps.find(em=>em.id===empId);
  return e?e.name||'Unknown':'Unknown';
}
function getEmployeeObj(clientId,empId){
  const emps=getClientEmployees(clientId);
  return emps.find(em=>em.id===empId)||null;
}
function saveHQ(hqData){
  localStorage.setItem(HQ_KEY,JSON.stringify(hqData));
}
function getClientQuestions(clientId){
  if(!data.clientQuestions)data.clientQuestions={};
  return data.clientQuestions[clientId]||[];
}
function getAllQuestions(clientId){
  return QUESTIONS.concat(getClientQuestions(clientId).map((cq,i)=>({id:'cq_'+cq.id,cat:cq.cat||'satisfaction',en:cq.en,es:cq.es||'',isCustom:true})));
}

/* ============ CLIENT EDIT ============ */
let editingClientId=null;
let addCrewFormOpen=false;
let addCustomQOpen=false;

function openClientEdit(clientId,scrollToCrew){
  const hq=getHQ();
  if(!hq||!hq.contacts)return;
  const client=hq.contacts.find(c=>c.id===clientId);
  if(!client)return;
  editingClientId=clientId;
  addCrewFormOpen=false;
  renderClientEditModal(scrollToCrew);
  document.getElementById('clientEditModal').classList.add('active');
}
function closeClientEdit(){
  document.getElementById('clientEditModal').classList.remove('active');
  editingClientId=null;
  addCrewFormOpen=false;
  addCustomQOpen=false;
  const activeView=document.querySelector('.nav-links a.active');
  if(activeView)showView(activeView.dataset.view);
}

function renderClientEditModal(scrollToCrew){
  const hq=getHQ();
  if(!hq)return;
  const client=hq.contacts.find(c=>c.id===editingClientId);
  if(!client)return;
  const emps=client.employees||[];

  let html=`
    <div style="margin-bottom:20px">
      <div style="font-size:16px;font-weight:800;color:var(--teal);margin-bottom:16px">${esc(client.company||client.name)}</div>
      <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group"><label>Owner Name</label><input class="form-control" id="ceOwnerName" value="${esc(client.ownerName||'')}"></div>
        <div class="form-group"><label>Email</label><input class="form-control" type="email" id="ceEmail" value="${esc(client.email||'')}"></div>
        <div class="form-group"><label>Phone</label><input class="form-control" id="cePhone" value="${esc(client.phone||'')}"></div>
        <div class="form-group"><label>Client Health</label>
          <select class="form-control" id="ceHealth">
            <option value="good"${client.health==='good'?' selected':''}>Good</option>
            <option value="warning"${client.health==='warning'?' selected':''}>Warning</option>
            <option value="at-risk"${client.health==='at-risk'?' selected':''}>At Risk</option>
          </select>
        </div>
        <div class="form-group"><label>Last Report Delivered</label><input class="form-control" type="date" id="ceLastDelivery" value="${client.lastDelivery||''}"></div>
        <div class="form-group"><label>Next Report Due</label><input class="form-control" type="date" id="ceNextDelivery" value="${client.nextDelivery||''}"></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea class="form-control" id="ceNotes" rows="2">${esc(client.notes||'')}</textarea></div>
    </div>

    <div id="crewSection">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:14px;font-weight:800">üë• Crew Members (${emps.length})</div>
        <button class="btn btn-sm btn-primary" onclick="toggleAddCrewForm()">+ Add Crew Member</button>
      </div>`;

  if(addCrewFormOpen){
    html+=`<div class="add-crew-form" id="addCrewForm">
      <div class="form-row">
        <div class="form-group" style="margin-bottom:10px"><label>Name *</label><input class="form-control" id="acName" placeholder="Full name"></div>
        <div class="form-group" style="margin-bottom:10px"><label>Role</label><input class="form-control" id="acRole" placeholder="e.g. Crew Leader"></div>
        <div class="form-group" style="margin-bottom:10px"><label>Phone</label><input class="form-control" id="acPhone" placeholder="Phone number"></div>
        <div class="form-group" style="margin-bottom:10px"><label>Language</label>
          <select class="form-control" id="acLang">
            <option value="English">English</option>
            <option value="Spanish">Spanish</option>
            <option value="Both">Both</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-sm btn-secondary" onclick="toggleAddCrewForm()">Cancel</button>
        <button class="btn btn-sm btn-primary" onclick="addCrewMember()">Add</button>
      </div>
    </div>`;
  }

  if(!emps.length){
    html+=`<div style="text-align:center;padding:20px;color:var(--dim);font-size:13px">No crew members yet.</div>`;
  }else{
    emps.forEach(emp=>{
      const lang=emp.language==='Spanish'?'üá≤üáΩ ES':emp.language==='Both'?'üá∫üá∏üá≤üáΩ':'üá∫üá∏ EN';
      html+=`<div class="crew-list-item">
        <div class="crew-info">
          <div class="crew-name">${esc(emp.name)}</div>
          <div class="crew-detail">${esc(emp.role||'Crew')} ¬∑ ${esc(emp.phone||'No phone')} ¬∑ ${lang}</div>
        </div>
        <button class="crew-del" onclick="deleteCrewMember('${emp.id}')" title="Remove crew member">√ó</button>
      </div>`;
    });
  }

  html+=`</div>

  <div id="customQSection" style="margin-top:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-size:14px;font-weight:800">üé§ Custom Interview Questions</div>
      <button class="btn btn-sm btn-primary" onclick="toggleAddCustomQ()">+ Add Question</button>
    </div>
    <div style="font-size:11px;color:var(--dim);margin-bottom:10px">These questions will be added to the standard interview for this client only.</div>`;

  if(addCustomQOpen){
    html+=`<div class="add-crew-form" id="addCustomQForm">
      <div class="form-group" style="margin-bottom:10px"><label>Question (English) *</label><input class="form-control" id="cqEn" placeholder="e.g. How do you feel about the new route schedule?"></div>
      <div class="form-group" style="margin-bottom:10px"><label>Question (Spanish)</label><input class="form-control" id="cqEs" placeholder="Spanish translation (optional)"></div>
      <div class="form-group" style="margin-bottom:10px"><label>Category</label>
        <select class="form-control" id="cqCat">
          ${CATEGORIES.map(c=>'<option value="'+c+'">'+CAT_LABELS[c]+'</option>').join('')}
        </select>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-sm btn-secondary" onclick="toggleAddCustomQ()">Cancel</button>
        <button class="btn btn-sm btn-primary" onclick="addCustomQuestion()">Add</button>
      </div>
    </div>`;
  }

  const cqs=getClientQuestions(editingClientId);
  if(!cqs.length){
    html+=`<div style="text-align:center;padding:16px;color:var(--dim);font-size:13px">No custom questions. Standard interview questions will be used.</div>`;
  }else{
    cqs.forEach(cq=>{
      html+=`<div class="crew-list-item">
        <div class="crew-info">
          <div class="crew-name" style="font-size:12px">${esc(cq.en)}</div>
          <div class="crew-detail">${CAT_LABELS[cq.cat]||cq.cat}${cq.es?' ¬∑ '+esc(cq.es):''}</div>
        </div>
        <button class="crew-del" onclick="deleteCustomQuestion('${cq.id}')" title="Remove question">√ó</button>
      </div>`;
    });
  }

  html+=`</div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;border-top:1px solid var(--border);padding-top:16px">
      <button class="btn btn-secondary" onclick="closeClientEdit()">Cancel</button>
      <button class="btn btn-primary" onclick="saveClientEdit()">Save Changes</button>
    </div>`;

  document.getElementById('clientEditContent').innerHTML=html;
  if(scrollToCrew){
    setTimeout(()=>{
      const s=document.getElementById('crewSection');
      if(s)s.scrollIntoView({behavior:'smooth',block:'start'});
    },100);
  }
}

function toggleAddCrewForm(){
  addCrewFormOpen=!addCrewFormOpen;
  renderClientEditModal(addCrewFormOpen);
}

function addCrewMember(){
  const name=document.getElementById('acName').value.trim();
  if(!name){alert('Name is required.');return}
  const role=document.getElementById('acRole').value.trim();
  const phone=document.getElementById('acPhone').value.trim();
  const language=document.getElementById('acLang').value;

  const hq=getHQ();
  if(!hq)return;
  const client=hq.contacts.find(c=>c.id===editingClientId);
  if(!client)return;
  if(!client.employees)client.employees=[];
  client.employees.push({id:uid(),name,role,phone,language});
  client.crewSize=client.employees.length;
  saveHQ(hq);
  addCrewFormOpen=false;
  renderClientEditModal(true);
}

function deleteCrewMember(empId){
  if(!confirm('Remove this crew member?'))return;
  const hq=getHQ();
  if(!hq)return;
  const client=hq.contacts.find(c=>c.id===editingClientId);
  if(!client||!client.employees)return;
  client.employees=client.employees.filter(e=>e.id!==empId);
  client.crewSize=client.employees.length;
  saveHQ(hq);
  renderClientEditModal(true);
}

function saveClientEdit(){
  const hq=getHQ();
  if(!hq)return;
  const client=hq.contacts.find(c=>c.id===editingClientId);
  if(!client)return;

  client.ownerName=document.getElementById('ceOwnerName').value.trim();
  client.email=document.getElementById('ceEmail').value.trim();
  client.phone=document.getElementById('cePhone').value.trim();
  client.health=document.getElementById('ceHealth').value;
  client.lastDelivery=document.getElementById('ceLastDelivery').value;
  client.nextDelivery=document.getElementById('ceNextDelivery').value;
  client.notes=document.getElementById('ceNotes').value.trim();
  client.crewSize=(client.employees||[]).length;

  saveHQ(hq);
  closeClientEdit();
}

function toggleAddCustomQ(){
  addCustomQOpen=!addCustomQOpen;
  renderClientEditModal(false);
  if(addCustomQOpen){
    setTimeout(()=>{const s=document.getElementById('customQSection');if(s)s.scrollIntoView({behavior:'smooth',block:'start'})},100);
  }
}

function addCustomQuestion(){
  const en=document.getElementById('cqEn').value.trim();
  if(!en){alert('Question text is required.');return}
  const es=document.getElementById('cqEs').value.trim();
  const cat=document.getElementById('cqCat').value;
  if(!data.clientQuestions)data.clientQuestions={};
  if(!data.clientQuestions[editingClientId])data.clientQuestions[editingClientId]=[];
  data.clientQuestions[editingClientId].push({id:uid(),en,es,cat});
  save(data);
  addCustomQOpen=false;
  renderClientEditModal(false);
  setTimeout(()=>{const s=document.getElementById('customQSection');if(s)s.scrollIntoView({behavior:'smooth',block:'start'})},100);
}

function deleteCustomQuestion(cqId){
  if(!confirm('Remove this custom question?'))return;
  if(!data.clientQuestions||!data.clientQuestions[editingClientId])return;
  data.clientQuestions[editingClientId]=data.clientQuestions[editingClientId].filter(q=>q.id!==cqId);
  save(data);
  renderClientEditModal(false);
}

/* ============ STATE ============ */
let data=loadData();
let schedMonth=thisMonth();
let reportMonth=thisMonth();
let activeInterview=null;
let timerInterval=null;
let timerSeconds=0;
let currentReportClientId=null;
let deliveryReportId=null;

/* ============ THEME ============ */
function applyTheme(){
  if(data.settings.theme==='light')document.body.classList.add('light-mode');
  else document.body.classList.remove('light-mode');
}
function toggleTheme(){
  data.settings.theme=data.settings.theme==='dark'?'light':'dark';
  save(data);applyTheme();
}

/* ============ NAVIGATION ============ */
function showView(v){
  document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-links a').forEach(el=>el.classList.remove('active'));
  const viewEl=document.getElementById('v-'+v);
  if(viewEl)viewEl.classList.add('active');
  const navEl=document.querySelector(`[data-view="${v}"]`);
  if(navEl)navEl.classList.add('active');

  if(v==='dashboard')renderDashboard();
  if(v==='schedule')renderSchedule();
  if(v==='interview')renderInterviewSelect();
  if(v==='reports')renderReports();
  if(v==='history')renderHistorySelectors();
}

/* ============ SETTINGS ============ */
function openSettings(){
  document.getElementById('setName').value=data.settings.interviewerName||'';
  document.getElementById('setCompany').value=data.settings.companyName||'Crew Voice';
  document.getElementById('setDuration').value=data.settings.defaultInterviewDuration||20;
  document.getElementById('setTheme').value=data.settings.theme||'dark';
  document.getElementById('setApiKey').value=data.settings.claudeApiKey||'';
  document.getElementById('setAiModel').value=data.settings.aiModel||'claude-sonnet-4-5-20250929';
  document.getElementById('settingsModal').classList.add('active');
}
function closeSettings(){document.getElementById('settingsModal').classList.remove('active')}
function toggleApiKeyVisibility(){
  const input=document.getElementById('setApiKey');
  const btn=document.getElementById('apiKeyToggle');
  if(input.type==='password'){input.type='text';btn.textContent='üôà'}
  else{input.type='password';btn.textContent='üëÅ'}
}
function saveSettings(){
  data.settings.interviewerName=document.getElementById('setName').value.trim();
  data.settings.companyName=document.getElementById('setCompany').value.trim()||'Crew Voice';
  data.settings.defaultInterviewDuration=parseInt(document.getElementById('setDuration').value)||20;
  data.settings.theme=document.getElementById('setTheme').value;
  data.settings.claudeApiKey=document.getElementById('setApiKey').value.trim();
  data.settings.aiModel=document.getElementById('setAiModel').value;
  save(data);applyTheme();closeSettings();
  showView(document.querySelector('.nav-links a.active')?.dataset.view||'dashboard');
}

/* ============ DASHBOARD ============ */
function renderDashboard(){
  const clients=getActiveClients();
  const month=thisMonth();
  const monthInterviews=data.interviews.filter(i=>i.month===month&&i.status==='completed');
  const totalCrewThisMonth=clients.reduce((s,c)=>(c.employees?s+c.employees.length:s),0);
  const reportsDelivered=data.reports.filter(r=>r.month===month&&r.status==='delivered').length;
  const avgSat=monthInterviews.length?
    (monthInterviews.reduce((s,i)=>{
      const vals=Object.values(i.ratings||{}).filter(v=>v>0);
      return s+(vals.length?vals.reduce((a,b)=>a+b,0)/vals.length:0);
    },0)/monthInterviews.length).toFixed(1):'‚Äî';
  const clientsDue=clients.filter(c=>{
    const emps=c.employees||[];
    const done=monthInterviews.filter(i=>i.clientId===c.id).length;
    return done<emps.length;
  }).length;

  document.getElementById('kpiGrid').innerHTML=`
    <div class="kpi-card"><div class="kpi-value">${monthInterviews.length}/${totalCrewThisMonth}</div><div class="kpi-label">Interviews This Month</div></div>
    <div class="kpi-card${clientsDue>0?' warn':''}"><div class="kpi-value">${clientsDue}</div><div class="kpi-label">Clients Due</div></div>
    <div class="kpi-card"><div class="kpi-value">${reportsDelivered}</div><div class="kpi-label">Reports Delivered</div></div>
    <div class="kpi-card${avgSat!=='‚Äî'&&parseFloat(avgSat)>=4?' good':''}"><div class="kpi-value">${avgSat}</div><div class="kpi-label">Avg Satisfaction</div></div>
  `;

  // Alerts
  const alerts=[];
  clients.forEach(c=>{
    const emps=c.employees||[];
    const done=monthInterviews.filter(i=>i.clientId===c.id).length;
    if(done<emps.length){
      const today_d=new Date();
      if(today_d.getDate()>20){
        alerts.push({type:'warning',text:`${esc(c.company||c.name)} ‚Äî ${emps.length-done} interviews remaining, month ending soon`});
      }
    }
  });
  // Previous concerns
  data.interviews.filter(i=>i.status==='completed').forEach(i=>{
    const lowRatings=Object.entries(i.ratings||{}).filter(([k,v])=>v>0&&v<=2);
    if(lowRatings.length>0||i.flightRisk==='high'){
      const empName=getEmployeeName(i.clientId,i.employeeId);
      const clientName=getClientName(i.clientId);
      if(i.flightRisk==='high'){
        alerts.push({type:'danger',text:`${esc(empName)} (${esc(clientName)}) ‚Äî HIGH flight risk flagged in ${monthStr(i.month)}`});
      }
    }
  });

  const alertsCard=document.getElementById('alertsCard');
  if(alerts.length){
    alertsCard.style.display='';
    document.getElementById('alertsList').innerHTML=alerts.slice(0,5).map(a=>
      `<div class="alert-item alert-${a.type}"><span class="alert-icon">${a.type==='danger'?'üî¥':'üü°'}</span>${a.text}</div>`
    ).join('');
  }else{alertsCard.style.display='none'}

  // Client progress
  let cpHtml='';
  if(!clients.length){
    cpHtml='<div class="empty-state"><div class="empty-icon">üì≠</div><p>No active clients found.<br>Close deals in HQ to see them here.</p></div>';
  }else{
    clients.forEach(c=>{
      const emps=c.employees||[];
      const done=monthInterviews.filter(i=>i.clientId===c.id).length;
      const pct=emps.length?Math.round(done/emps.length*100):0;
      const badge=pct>=100?'<span class="badge badge-done">Complete</span>':
                  pct>0?'<span class="badge badge-pending">In Progress</span>':
                  '<span class="badge badge-due">Due</span>';
      cpHtml+=`<div class="client-row" onclick="showView('schedule')">
        <div class="client-name">${esc(c.company||c.name)}</div>
        <div class="client-meta">${emps.length} crew</div>
        <div class="client-progress"><div class="progress-bar"><div class="progress-fill${pct<50?' warn':''}" style="width:${pct}%"></div></div></div>
        <div>${done}/${emps.length}</div>
        ${badge}
        <button class="edit-btn" onclick="event.stopPropagation();openClientEdit('${c.id}')" title="Edit client">‚úèÔ∏è</button>
      </div>`;
    });
  }
  document.getElementById('clientProgressList').innerHTML=cpHtml;

  // Upcoming
  const upcoming=data.schedule.filter(s=>s.status==='scheduled'&&s.scheduledDate>=today())
    .sort((a,b)=>a.scheduledDate.localeCompare(b.scheduledDate)).slice(0,5);
  if(!upcoming.length){
    document.getElementById('upcomingList').innerHTML='<div class="empty-state"><p>No upcoming interviews scheduled.</p></div>';
  }else{
    document.getElementById('upcomingList').innerHTML=upcoming.map(s=>{
      const empName=getEmployeeName(s.clientId,s.employeeId);
      const clientName=getClientName(s.clientId);
      return`<div class="client-row" onclick="startInterviewFromSchedule('${s.clientId}','${s.employeeId}','${s.id}')">
        <div><div class="client-name">${esc(empName)}</div><div class="client-meta">${esc(clientName)}</div></div>
        <div class="client-meta">${s.scheduledDate}${s.scheduledTime?' @ '+s.scheduledTime:''}</div>
        <button class="btn btn-sm btn-primary no-print">Start</button>
      </div>`;
    }).join('');
  }
}

/* ============ SCHEDULE ============ */
function changeSchedMonth(d){schedMonth=addMonth(schedMonth,d);renderSchedule()}
function goToday(){schedMonth=thisMonth();renderSchedule()}

function renderSchedule(){
  document.getElementById('schedMonthLabel').textContent=monthStr(schedMonth);
  const clients=getActiveClients();
  const filterVal=document.getElementById('schedClientFilter').value;

  // Populate filter
  const filterEl=document.getElementById('schedClientFilter');
  const prevVal=filterEl.value;
  let fopts='<option value="">All Clients</option>';
  clients.forEach(c=>{fopts+=`<option value="${c.id}">${esc(c.company||c.name)}</option>`});
  filterEl.innerHTML=fopts;
  if(prevVal)filterEl.value=prevVal;

  const filtered=filterVal?clients.filter(c=>c.id===filterVal):clients;
  if(!filtered.length){
    document.getElementById('scheduleContent').innerHTML='<div class="empty-state"><div class="empty-icon">üìÖ</div><p>No clients to schedule.</p></div>';
    return;
  }

  let html='';
  filtered.forEach(c=>{
    const emps=c.employees||[];
    const doneCount=data.interviews.filter(i=>i.clientId===c.id&&i.month===schedMonth&&i.status==='completed').length;
    const pct=emps.length?Math.round(doneCount/emps.length*100):0;

    html+=`<div class="card">
      <div class="card-header">
        <div>
          <h3>${esc(c.company||c.name)} <button class="edit-btn" onclick="openClientEdit('${c.id}')" title="Edit client">‚úèÔ∏è</button></h3>
          <div style="font-size:12px;color:var(--dim)">${emps.length} crew members ‚Äî ${doneCount}/${emps.length} completed</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-sm btn-secondary" onclick="scheduleAll('${c.id}')">üìÖ Schedule All</button>
          ${pct>=100?`<button class="btn btn-sm btn-primary" onclick="goToReportBuilder('${c.id}','${schedMonth}')">üìÑ Generate Report</button>`:''}
        </div>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="emp-grid">`;

    emps.forEach(emp=>{
      const sched=data.schedule.find(s=>s.clientId===c.id&&s.employeeId===emp.id&&s.month===schedMonth);
      const interview=data.interviews.find(i=>i.clientId===c.id&&i.employeeId===emp.id&&i.month===schedMonth&&i.status==='completed');
      let statusClass='',statusBadge='',dateInfo='';

      if(interview){
        statusClass='status-completed';
        statusBadge='<span class="badge badge-done">Done</span>';
        dateInfo=interview.date||'';
      }else if(sched&&sched.status==='skipped'){
        statusClass='status-skipped';
        statusBadge='<span class="badge badge-skipped">Skipped</span>';
      }else if(sched&&sched.status==='scheduled'){
        statusClass='status-scheduled';
        statusBadge='<span class="badge badge-scheduled">Scheduled</span>';
        dateInfo=sched.scheduledDate||'';
      }else{
        statusBadge='<span class="badge badge-due" style="font-size:10px">Unscheduled</span>';
      }

      const lang=emp.language||'en';
      const langLabel=lang==='es'?'üá≤üáΩ ES':lang==='both'?'üá∫üá∏üá≤üáΩ':'üá∫üá∏ EN';

      html+=`<div class="emp-chip ${statusClass}" onclick="openSchedModal('${c.id}','${emp.id}')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="emp-name">${esc(emp.name)}</span>
          <span class="emp-lang">${langLabel}</span>
        </div>
        <div class="emp-role">${esc(emp.role||'Crew')}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
          ${statusBadge}
          <span style="font-size:11px;color:var(--dim)">${dateInfo}</span>
        </div>
      </div>`;
    });

    html+=`<div class="add-crew-chip" onclick="openClientEdit('${c.id}',true)">+ Add Crew</div>`;
    html+=`</div></div>`;
  });

  document.getElementById('scheduleContent').innerHTML=html;
}

function scheduleAll(clientId){
  const emps=getClientEmployees(clientId);
  const month=schedMonth;
  const[y,m]=month.split('-').map(Number);
  // Get weekdays in month
  const weekdays=[];
  const daysInMonth=new Date(y,m,0).getDate();
  for(let d=1;d<=daysInMonth;d++){
    const dt=new Date(y,m-1,d);
    if(dt.getDay()>=1&&dt.getDay()<=5)weekdays.push(d);
  }

  let wi=0;
  emps.forEach(emp=>{
    const existing=data.schedule.find(s=>s.clientId===clientId&&s.employeeId===emp.id&&s.month===month);
    const completed=data.interviews.find(i=>i.clientId===clientId&&i.employeeId===emp.id&&i.month===month&&i.status==='completed');
    if(!completed&&!existing){
      const day=weekdays[wi%weekdays.length];
      const dateStr=`${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      data.schedule.push({id:uid(),clientId,employeeId:emp.id,month,scheduledDate:dateStr,scheduledTime:'',status:'scheduled',interviewId:null,skipReason:null});
      wi++;
    }
  });
  save(data);renderSchedule();
}

function openSchedModal(clientId,empId){
  const emp=getEmployeeObj(clientId,empId);
  if(!emp)return;
  const month=schedMonth;
  const sched=data.schedule.find(s=>s.clientId===clientId&&s.employeeId===empId&&s.month===month);
  const interview=data.interviews.find(i=>i.clientId===clientId&&i.employeeId===empId&&i.month===month&&i.status==='completed');

  let html=`<p style="margin-bottom:12px"><strong>${esc(emp.name)}</strong> ‚Äî ${esc(getClientName(clientId))}</p>`;

  if(interview){
    html+=`<p style="color:var(--emerald);font-weight:700;margin-bottom:12px">‚úÖ Interview completed on ${interview.date}</p>
      <button class="btn btn-sm btn-primary" onclick="closeSchedModal();openInterviewDetail('${interview.id}','schedule')">üëÅ View Interview</button>`;
  }else{
    const curDate=sched?sched.scheduledDate:today();
    const curTime=sched?sched.scheduledTime||'':'';
    html+=`
      <div class="form-group"><label>Date</label><input class="form-control" type="date" id="smDate" value="${curDate}"></div>
      <div class="form-group"><label>Time (optional)</label><input class="form-control" type="time" id="smTime" value="${curTime}"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px">
        <button class="btn btn-danger btn-sm" onclick="skipSchedule('${clientId}','${empId}')">Skip</button>
        <button class="btn btn-secondary btn-sm" onclick="closeSchedModal()">Cancel</button>
        <button class="btn btn-primary btn-sm" onclick="saveSchedule('${clientId}','${empId}')">Save</button>
        <button class="btn btn-primary btn-sm" onclick="closeSchedModal();startInterviewFromSchedule('${clientId}','${empId}','${sched?sched.id:''}')">üé§ Interview Now</button>
      </div>`;
  }

  document.getElementById('schedModalContent').innerHTML=html;
  document.getElementById('scheduleModal').classList.add('active');
}
function closeSchedModal(){document.getElementById('scheduleModal').classList.remove('active')}

function saveSchedule(clientId,empId){
  const month=schedMonth;
  const date=document.getElementById('smDate').value;
  const time=document.getElementById('smTime').value;
  let sched=data.schedule.find(s=>s.clientId===clientId&&s.employeeId===empId&&s.month===month);
  if(!sched){
    sched={id:uid(),clientId,employeeId:empId,month,scheduledDate:date,scheduledTime:time,status:'scheduled',interviewId:null,skipReason:null};
    data.schedule.push(sched);
  }else{
    sched.scheduledDate=date;
    sched.scheduledTime=time;
    sched.status='scheduled';
    sched.skipReason=null;
  }
  save(data);closeSchedModal();renderSchedule();
}

function skipSchedule(clientId,empId){
  const month=schedMonth;
  let sched=data.schedule.find(s=>s.clientId===clientId&&s.employeeId===empId&&s.month===month);
  if(!sched){
    sched={id:uid(),clientId,employeeId:empId,month,scheduledDate:'',scheduledTime:'',status:'skipped',interviewId:null,skipReason:'Skipped'};
    data.schedule.push(sched);
  }else{
    sched.status='skipped';
    sched.skipReason='Skipped';
  }
  save(data);closeSchedModal();renderSchedule();
}

/* ============ INTERVIEW ============ */
function renderInterviewSelect(){
  document.getElementById('interviewSelect').style.display='';
  document.getElementById('interviewForm').style.display='none';
  if(timerInterval){clearInterval(timerInterval);timerInterval=null}

  const clients=getActiveClients();
  const sel=document.getElementById('intClient');
  sel.innerHTML='<option value="">Select client...</option>'+
    clients.map(c=>`<option value="${c.id}">${esc(c.company||c.name)}</option>`).join('');
  document.getElementById('intEmployee').innerHTML='<option value="">Select crew member...</option>';
  document.getElementById('intEmployee').disabled=true;

  // Drafts
  const drafts=data.interviews.filter(i=>i.status==='draft');
  const draftsCard=document.getElementById('draftsCard');
  if(drafts.length){
    draftsCard.style.display='';
    document.getElementById('draftsList').innerHTML=drafts.map(d=>{
      const empName=getEmployeeName(d.clientId,d.employeeId);
      const clientName=getClientName(d.clientId);
      return`<div class="client-row" onclick="resumeDraft('${d.id}')">
        <div><div class="client-name">${esc(empName)}</div><div class="client-meta">${esc(clientName)} ‚Äî ${monthStr(d.month)}</div></div>
        <span class="badge badge-draft">Draft</span>
        <button class="btn btn-sm btn-primary">Resume</button>
      </div>`;
    }).join('');
  }else{draftsCard.style.display='none'}
}

function loadIntEmployees(){
  const clientId=document.getElementById('intClient').value;
  const sel=document.getElementById('intEmployee');
  if(!clientId){sel.innerHTML='<option value="">Select crew member...</option>';sel.disabled=true;return}
  const emps=getClientEmployees(clientId);
  sel.innerHTML='<option value="">Select crew member...</option>'+
    emps.map(e=>`<option value="${e.id}">${esc(e.name)} ‚Äî ${esc(e.role||'Crew')}</option>`).join('');
  sel.disabled=false;
}

function startInterviewFromSchedule(clientId,empId,schedId){
  showView('interview');
  document.getElementById('intClient').value=clientId;
  loadIntEmployees();
  document.getElementById('intEmployee').value=empId;
  const emp=getEmployeeObj(clientId,empId);
  if(emp&&emp.language)document.getElementById('intLanguage').value=emp.language;
  startInterview(schedId);
}

function startInterview(schedId){
  const clientId=document.getElementById('intClient').value;
  const empId=document.getElementById('intEmployee').value;
  const lang=document.getElementById('intLanguage').value;
  if(!clientId||!empId){alert('Please select a client and crew member.');return}

  // Check if already has a completed interview this month
  const existing=data.interviews.find(i=>i.clientId===clientId&&i.employeeId===empId&&i.month===thisMonth()&&i.status==='completed');
  if(existing){
    if(!confirm('This crew member already has a completed interview this month. Start another?'))return;
  }

  activeInterview={
    id:uid(),clientId,employeeId:empId,month:thisMonth(),date:today(),
    status:'draft',duration:0,language:lang,
    ratings:{},responses:getAllQuestions(clientId).map(q=>({questionId:q.id,rating:0,notes:'',flagged:false})),
    concerns:'',highlights:'',quotes:'',privateNotes:'',
    flightRisk:'none',mood:0,
    createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()
  };
  if(schedId)activeInterview._schedId=schedId;

  timerSeconds=0;
  renderInterviewForm();
  startTimer();
}

function resumeDraft(id){
  const draft=data.interviews.find(i=>i.id===id);
  if(!draft)return;
  activeInterview={...draft,responses:draft.responses.map(r=>({...r})),ratings:{...draft.ratings}};
  timerSeconds=(draft.duration||0)*60;
  renderInterviewForm();
  startTimer();
}

function startTimer(){
  if(timerInterval)clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    timerSeconds++;
    const timerEl=document.getElementById('interviewTimer');
    if(timerEl){
      const m=Math.floor(timerSeconds/60);
      const s=timerSeconds%60;
      timerEl.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
  },1000);
}

function renderInterviewForm(){
  document.getElementById('interviewSelect').style.display='none';
  document.getElementById('interviewForm').style.display='';
  const ai=activeInterview;
  const clientName=getClientName(ai.clientId);
  const emp=getEmployeeObj(ai.clientId,ai.employeeId);
  const empName=emp?emp.name:'Unknown';
  const empRole=emp?emp.role||'Crew':'Crew';
  const m=Math.floor(timerSeconds/60);
  const s=timerSeconds%60;

  let html=`
    <div class="interview-header">
      <div class="ih-top">
        <div>
          <div class="ih-company">${esc(clientName)}</div>
          <div class="ih-crew">${esc(empName)} ‚Äî ${esc(empRole)}</div>
          <div class="ih-meta">üìÖ ${ai.date} &nbsp; üåê ${ai.language==='es'?'Spanish':ai.language==='both'?'Bilingual':'English'}</div>
        </div>
        <div class="timer" id="interviewTimer">${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</div>
      </div>
    </div>`;

  // Questions (core + custom)
  const allQs=getAllQuestions(ai.clientId);
  allQs.forEach((q,idx)=>{
    const resp=ai.responses.find(r=>r.questionId===q.id)||{rating:0,notes:'',flagged:false};
    const qIdStr=typeof q.id==='string'?`'${q.id}'`:q.id;
    const isCustom=q.isCustom;
    html+=`<div class="q-card" id="qcard-${q.id}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><span class="q-num">${idx+1}</span><span class="q-category">${CAT_LABELS[q.cat]||q.cat}${isCustom?' ¬∑ Custom':''}</span></div>
        <button class="flag-btn${resp.flagged?' flagged':''}" onclick="toggleFlag(${qIdStr})" id="flag-${q.id}">üö© Flag</button>
      </div>
      <div class="q-bilingual">
        <div><div class="q-lang-label en">English</div><div class="q-text">${esc(q.en)}</div></div>
        ${q.es?`<div><div class="q-lang-label es">Espa√±ol</div><div class="q-text es">${esc(q.es)}</div></div>`:''}
      </div>
      <div class="rating-row">
        <span style="font-size:12px;font-weight:700;color:var(--dim);margin-right:4px">Rating:</span>
        ${[1,2,3,4,5].map(n=>`<button class="rating-btn r${n}${resp.rating===n?' active':''}" onclick="setRating(${qIdStr},${n})" id="rbtn-${q.id}-${n}">${n}</button>`).join('')}
        <span class="rating-label" id="rlabel-${q.id}">${ratingWord(resp.rating)}</span>
      </div>
      <textarea class="form-control" placeholder="Notes / verbatim response..." rows="2" id="qnotes-${q.id}" oninput="updateNotes(${qIdStr})">${esc(resp.notes)}</textarea>
    </div>`;
  });

  // Additional fields
  html+=`
    <div class="card">
      <h3>üìù Additional Notes</h3>
      <div class="form-group">
        <label>Key Concerns</label>
        <textarea class="form-control" id="intConcerns" placeholder="Main concerns raised...">${esc(ai.concerns)}</textarea>
      </div>
      <div class="form-group">
        <label>Highlights / Positives</label>
        <textarea class="form-control" id="intHighlights" placeholder="Positive feedback...">${esc(ai.highlights)}</textarea>
      </div>
      <div class="form-group">
        <label>Notable Quotes</label>
        <textarea class="form-control" id="intQuotes" placeholder="Direct quotes worth including in report...">${esc(ai.quotes)}</textarea>
      </div>
      <div class="form-group">
        <label>Private Notes (excluded from client report)</label>
        <textarea class="form-control" id="intPrivate" placeholder="For your eyes only...">${esc(ai.privateNotes)}</textarea>
      </div>
      <div class="form-group">
        <label>Flight Risk</label>
        <div class="risk-select">
          ${['none','low','medium','high'].map(r=>
            `<button class="risk-opt risk-${r}${ai.flightRisk===r?' active':''}" onclick="setRisk('${r}')" id="risk-${r}">${r.charAt(0).toUpperCase()+r.slice(1)}</button>`
          ).join('')}
        </div>
      </div>
      <div class="form-group">
        <label>Overall Mood</label>
        <div class="mood-grid">
          ${MOODS.map((m,i)=>
            `<button class="mood-btn${ai.mood===i+1?' active':''}" onclick="setMood(${i+1})" id="mood-${i+1}">${m}</button>`
          ).join('')}
        </div>
      </div>
    </div>
    <div class="interview-actions">
      <button class="btn btn-secondary" onclick="cancelInterview()">Cancel</button>
      <button class="btn btn-secondary" onclick="saveDraft()">üíæ Save Draft</button>
      <button class="btn btn-primary" onclick="completeInterview()">‚úÖ Complete Interview</button>
    </div>`;

  document.getElementById('interviewForm').innerHTML=html;
}

function ratingWord(n){return['','Poor','Needs Work','Okay','Good','Excellent'][n]||''}

function setRating(qId,val){
  const resp=activeInterview.responses.find(r=>r.questionId===qId);
  if(resp)resp.rating=val;
  // Update category rating
  const allQs=getAllQuestions(activeInterview.clientId);
  const qDef=allQs.find(q=>q.id===qId);
  if(qDef)activeInterview.ratings[qDef.cat]=val;
  // Update UI
  for(let i=1;i<=5;i++){
    const btn=document.getElementById(`rbtn-${qId}-${i}`);
    if(btn){btn.classList.toggle('active',i===val)}
  }
  const label=document.getElementById(`rlabel-${qId}`);
  if(label)label.textContent=ratingWord(val);
}

function toggleFlag(qId){
  const resp=activeInterview.responses.find(r=>r.questionId===qId);
  if(resp)resp.flagged=!resp.flagged;
  const btn=document.getElementById(`flag-${qId}`);
  if(btn)btn.classList.toggle('flagged',resp.flagged);
}

function updateNotes(qId){
  const resp=activeInterview.responses.find(r=>r.questionId===qId);
  const el=document.getElementById(`qnotes-${qId}`);
  if(resp&&el)resp.notes=el.value;
}

function setRisk(val){
  activeInterview.flightRisk=val;
  ['none','low','medium','high'].forEach(r=>{
    const el=document.getElementById(`risk-${r}`);
    if(el)el.classList.toggle('active',r===val);
  });
}

function setMood(val){
  activeInterview.mood=val;
  for(let i=1;i<=5;i++){
    const el=document.getElementById(`mood-${i}`);
    if(el)el.classList.toggle('active',i===val);
  }
}

function gatherAdditionalFields(){
  activeInterview.concerns=document.getElementById('intConcerns')?.value||'';
  activeInterview.highlights=document.getElementById('intHighlights')?.value||'';
  activeInterview.quotes=document.getElementById('intQuotes')?.value||'';
  activeInterview.privateNotes=document.getElementById('intPrivate')?.value||'';
  activeInterview.duration=Math.round(timerSeconds/60);
  activeInterview.updatedAt=new Date().toISOString();
  // Recompute category ratings from responses
  const allQs=getAllQuestions(activeInterview.clientId);
  CATEGORIES.forEach(cat=>{
    const catResps=activeInterview.responses.filter(r=>{
      const q=allQs.find(qq=>qq.id===r.questionId);
      return q&&q.cat===cat&&r.rating>0;
    });
    if(catResps.length){
      activeInterview.ratings[cat]=Math.round(catResps.reduce((s,r)=>s+r.rating,0)/catResps.length*10)/10;
    }
  });
}

function saveDraft(){
  gatherAdditionalFields();
  activeInterview.status='draft';
  const idx=data.interviews.findIndex(i=>i.id===activeInterview.id);
  if(idx>=0)data.interviews[idx]={...activeInterview};
  else data.interviews.push({...activeInterview});
  save(data);
  alert('Draft saved!');
}

function completeInterview(){
  gatherAdditionalFields();
  activeInterview.status='completed';
  const idx=data.interviews.findIndex(i=>i.id===activeInterview.id);
  if(idx>=0)data.interviews[idx]={...activeInterview};
  else data.interviews.push({...activeInterview});

  // Update schedule
  if(activeInterview._schedId){
    const sched=data.schedule.find(s=>s.id===activeInterview._schedId);
    if(sched){sched.status='completed';sched.interviewId=activeInterview.id}
  }else{
    const sched=data.schedule.find(s=>s.clientId===activeInterview.clientId&&s.employeeId===activeInterview.employeeId&&s.month===activeInterview.month&&s.status==='scheduled');
    if(sched){sched.status='completed';sched.interviewId=activeInterview.id}
  }

  save(data);
  if(timerInterval){clearInterval(timerInterval);timerInterval=null}
  activeInterview=null;
  renderInterviewSelect();
}

function cancelInterview(){
  if(!confirm('Cancel this interview? Unsaved changes will be lost.'))return;
  if(timerInterval){clearInterval(timerInterval);timerInterval=null}
  activeInterview=null;
  renderInterviewSelect();
}

/* ============ REPORTS ============ */
function changeReportMonth(d){reportMonth=addMonth(reportMonth,d);renderReports()}
function goReportToday(){reportMonth=thisMonth();renderReports()}

function renderReports(){
  document.getElementById('reportMonthLabel').textContent=monthStr(reportMonth);
  document.getElementById('reportBuilder').style.display='none';
  const clients=getActiveClients();

  let html='';
  clients.forEach(c=>{
    const interviews=data.interviews.filter(i=>i.clientId===c.id&&i.month===reportMonth&&i.status==='completed');
    const emps=c.employees||[];
    const report=data.reports.find(r=>r.clientId===c.id&&r.month===reportMonth);
    let statusBadge,statusText;

    if(!interviews.length){
      statusBadge='<span class="badge badge-skipped">No Data</span>';
      statusText='No completed interviews';
    }else if(report&&report.status==='delivered'){
      statusBadge='<span class="badge badge-delivered">Delivered</span>';
      statusText=`Delivered ${report.deliveryDate||''} via ${report.deliveryMethod||''}`;
    }else if(report&&report.status==='finalized'){
      statusBadge='<span class="badge badge-done">Finalized</span>';
      statusText='Ready for delivery';
    }else if(report){
      statusBadge='<span class="badge badge-draft">Draft</span>';
      statusText='Report in progress';
    }else{
      statusBadge='<span class="badge badge-pending">Pending</span>';
      statusText=`${interviews.length}/${emps.length} interviews completed`;
    }

    html+=`<div class="report-card">
      <div class="rc-header">
        <div>
          <div class="rc-company">${esc(c.company||c.name)}</div>
          <div class="rc-meta">${interviews.length} interviews ‚Äî ${statusText}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          ${statusBadge}
          ${interviews.length?`<button class="btn btn-sm btn-primary" onclick="openReportBuilder('${c.id}')">üìÑ ${report?'Edit':'Build'} Report</button>`:''}
          ${report&&report.status==='finalized'?`<button class="btn btn-sm btn-secondary" onclick="openDeliveryModal('${report.id}')">üì¨ Mark Delivered</button>`:''}
        </div>
      </div>
    </div>`;
  });

  if(!clients.length){
    html='<div class="empty-state"><div class="empty-icon">üìÑ</div><p>No active clients.</p></div>';
  }

  document.getElementById('reportsContent').innerHTML=html;
}

function goToReportBuilder(clientId,month){
  if(month)reportMonth=month;
  showView('reports');
  openReportBuilder(clientId);
}

function openReportBuilder(clientId){
  try{
  currentReportClientId=clientId;
  const client=getActiveClients().find(c=>c.id===clientId);
  if(!client)return;
  const interviews=data.interviews.filter(i=>i.clientId===clientId&&i.month===reportMonth&&i.status==='completed');
  if(!interviews.length){alert('No completed interviews for this client.');return}
  const emps=client.employees||[];
  const ownerName=client.contact||client.name||'Owner';

  let report=data.reports.find(r=>r.clientId===clientId&&r.month===reportMonth);
  if(!report){
    report={id:uid(),clientId,month:reportMonth,status:'draft',
      overallSummary:'',moraleLevel:'',positives:'',concerns:'',
      riskFlags:[],focusAreas:'',
      headerOwner:ownerName,headerCompany:client.company||client.name,
      headerPeriod:monthStr(reportMonth),headerCrewCount:interviews.length+' of '+emps.length,
      headerDate:today(),avgSatisfaction:'',satRange:'',
      deliveryMethod:'',deliveryDate:'',deliveryNotes:'',
      createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
    data.reports.push(report);
    save(data);
  }
  // Migrate old reports
  if(report.executiveSummary&&!report.overallSummary){report.overallSummary=report.executiveSummary}
  if(report.recommendations&&!report.focusAreas){report.focusAreas=report.recommendations}
  // Migrate header fields
  if(!report.headerOwner)report.headerOwner=ownerName;
  if(!report.headerCompany)report.headerCompany=client.company||client.name;
  if(!report.headerPeriod)report.headerPeriod=monthStr(reportMonth);
  if(!report.headerCrewCount)report.headerCrewCount=interviews.length+' of '+emps.length;
  if(!report.headerDate)report.headerDate=today();

  // Compute overall satisfaction (defaults ‚Äî editable fields override)
  const allRatings=interviews.flatMap(i=>Object.values(i.ratings||{}).filter(v=>v>0));
  const calcAvg=allRatings.length?(allRatings.reduce((a,b)=>a+b,0)/allRatings.length):0;
  const minSat=allRatings.length?Math.min(...allRatings):0;
  const maxSat=allRatings.length?Math.max(...allRatings):0;
  if(!report.avgSatisfaction)report.avgSatisfaction=calcAvg?calcAvg.toFixed(1)+' / 5.0':'';
  if(!report.satRange&&allRatings.length>1)report.satRange=minSat+' ‚Äì '+maxSat;
  const morale=report.moraleLevel||(calcAvg>=4?'high':calcAvg>=3?'medium':'low');
  const moraleColor=morale==='high'?'var(--emerald)':morale==='medium'?'var(--amber)':'var(--red)';
  const moraleEmoji=morale==='high'?'üü¢':morale==='medium'?'üü°':'üî¥';

  // Init risk flags from interviews if empty
  if(!report.riskFlags||!report.riskFlags.length){
    report.riskFlags=[];
    interviews.forEach(i=>{
      const emp=getEmployeeObj(clientId,i.employeeId);
      report.riskFlags.push({name:emp?.name||'Unknown',level:i.flightRisk||'none',signal:i.flightRisk==='none'?'No concerns identified':'',action:i.flightRisk==='none'?'Continue current approach':''});
    });
    save(data);
  }

  const hasApiKey=!!data.settings.claudeApiKey;
  const hasContent=!!(report.overallSummary||report.positives||report.concerns||report.focusAreas);

  let bHtml=`
    <div class="report-preview" id="reportPreviewContent">
      <div class="rp-header">
        <h2>Crew Voice ‚Äî Monthly Crew Intelligence Report</h2>
        <div style="margin-top:12px;font-size:13px;color:var(--dim);line-height:2.2">
          <div style="display:flex;align-items:center;gap:6px"><strong>Prepared for:</strong>
            <input class="form-control no-print" style="display:inline;width:auto;flex:1;padding:4px 8px;font-size:13px" value="${esc(report.headerOwner)}" oninput="updateReportField('headerOwner',this.value)">
            <span class="print-only" style="display:none">${esc(report.headerOwner)}</span>,
            <input class="form-control no-print" style="display:inline;width:auto;flex:1;padding:4px 8px;font-size:13px" value="${esc(report.headerCompany)}" oninput="updateReportField('headerCompany',this.value)">
            <span class="print-only" style="display:none">${esc(report.headerCompany)}</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px"><strong>Report Period:</strong>
            <input class="form-control no-print" style="display:inline;width:auto;flex:1;padding:4px 8px;font-size:13px" value="${esc(report.headerPeriod)}" oninput="updateReportField('headerPeriod',this.value)">
            <span class="print-only" style="display:none">${esc(report.headerPeriod)}</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px"><strong>Crew Members Interviewed:</strong>
            <input class="form-control no-print" style="display:inline;width:120px;padding:4px 8px;font-size:13px" value="${esc(report.headerCrewCount)}" oninput="updateReportField('headerCrewCount',this.value)">
            <span class="print-only" style="display:none">${esc(report.headerCrewCount)}</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px"><strong>Report Date:</strong>
            <input class="form-control no-print" type="date" style="display:inline;width:auto;padding:4px 8px;font-size:13px" value="${esc(report.headerDate)}" oninput="updateReportField('headerDate',this.value)">
            <span class="print-only" style="display:none">${esc(report.headerDate)}</span>
          </div>
        </div>
      </div>

      <div class="rp-section">
        <h4>Overall Morale Score</h4>
        <div class="no-print" style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <span style="font-size:12px;font-weight:700;color:var(--dim)">Morale:</span>
          ${['high','medium','low'].map(l=>{
            const lc=l==='high'?'var(--emerald)':l==='medium'?'var(--amber)':'var(--red)';
            const le=l==='high'?'üü¢':l==='medium'?'üü°':'üî¥';
            return`<button style="padding:6px 14px;border-radius:6px;border:2px solid ${morale===l?lc:'var(--border)'};background:${morale===l?lc+'22':'transparent'};color:${morale===l?lc:'var(--dim)'};font-weight:700;cursor:pointer;font-size:13px" onclick="updateReportField('moraleLevel','${l}');openReportBuilder('${clientId}')">${le} ${l.toUpperCase()}</button>`;
          }).join('')}
        </div>
        <div class="print-only" style="display:none;margin-bottom:10px">
          <span style="font-size:28px">${moraleEmoji}</span>
          <span style="font-size:20px;font-weight:800;color:${moraleColor};text-transform:uppercase">${morale}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap">
          <span style="font-size:13px;color:var(--dim)"><strong>Average Satisfaction:</strong></span>
          <input class="form-control no-print" style="display:inline;width:120px;padding:4px 8px;font-size:13px" value="${esc(report.avgSatisfaction)}" oninput="updateReportField('avgSatisfaction',this.value)" placeholder="e.g. 4.2 / 5.0">
          <span class="print-only" style="display:none;font-size:13px">${esc(report.avgSatisfaction)}</span>
          ${report.satRange?`
          <span style="font-size:13px;color:var(--dim)">&nbsp;|&nbsp;<strong>Range:</strong></span>
          <input class="form-control no-print" style="display:inline;width:100px;padding:4px 8px;font-size:13px" value="${esc(report.satRange)}" oninput="updateReportField('satRange',this.value)" placeholder="e.g. 2 ‚Äì 5">
          <span class="print-only" style="display:none;font-size:13px">${esc(report.satRange)}</span>
          `:`
          <span style="font-size:13px;color:var(--dim)">&nbsp;|&nbsp;<strong>Range:</strong></span>
          <input class="form-control no-print" style="display:inline;width:100px;padding:4px 8px;font-size:13px" value="" oninput="updateReportField('satRange',this.value)" placeholder="e.g. 2 ‚Äì 5">
          <span class="print-only" style="display:none;font-size:13px"></span>
          `}
        </div>
        <textarea class="form-control no-print" rows="2" id="rpSummary" placeholder="1-2 sentence summary of overall team sentiment..." oninput="updateReportField('overallSummary',this.value)">${esc(report.overallSummary)}</textarea>
        <div class="print-only" style="display:none;white-space:pre-wrap;font-size:13px;line-height:1.6;font-style:italic">${esc(report.overallSummary)}</div>
      </div>

      <div class="rp-section">
        <h4>Top 3 Positives</h4>
        <p style="font-size:12px;color:var(--dim);margin-bottom:6px">What the crew appreciates most right now:</p>
        <textarea class="form-control no-print" rows="4" id="rpPositives" placeholder="1. [Theme] ‚Äî Brief explanation...&#10;2. [Theme] ‚Äî Brief explanation...&#10;3. [Theme] ‚Äî Brief explanation..." oninput="updateReportField('positives',this.value)">${esc(report.positives)}</textarea>
        <div class="print-only" style="display:none;white-space:pre-wrap;font-size:13px;line-height:1.8">${esc(report.positives)}</div>
      </div>

      <div class="rp-section">
        <h4>Top 3 Concerns</h4>
        <p style="font-size:12px;color:var(--dim);margin-bottom:6px">Issues the crew raised this month:</p>
        <textarea class="form-control no-print" rows="4" id="rpConcerns" placeholder="1. [Theme] ‚Äî Brief explanation...&#10;2. [Theme] ‚Äî Brief explanation...&#10;3. [Theme] ‚Äî Brief explanation..." oninput="updateReportField('concerns',this.value)">${esc(report.concerns)}</textarea>
        <div class="print-only" style="display:none;white-space:pre-wrap;font-size:13px;line-height:1.8">${esc(report.concerns)}</div>
      </div>

      <div class="rp-section">
        <h4>Retention Risk Flags</h4>
        <div id="riskFlagsContainer">
          ${renderEditableRiskTable(report.riskFlags,clientId)}
        </div>
      </div>

      <div class="rp-section">
        <h4>Suggested Focus Areas</h4>
        <p style="font-size:12px;color:var(--dim);margin-bottom:6px">Based on this month's interviews, we recommend focusing on:</p>
        <textarea class="form-control no-print" rows="4" id="rpFocus" placeholder="1. [Action Item] ‚Äî Why it matters and what to do...&#10;2. [Action Item] ‚Äî Why it matters and what to do...&#10;3. [Action Item] ‚Äî Why it matters and what to do..." oninput="updateReportField('focusAreas',this.value)">${esc(report.focusAreas)}</textarea>
        <div class="print-only" style="display:none;white-space:pre-wrap;font-size:13px;line-height:1.8">${esc(report.focusAreas)}</div>
      </div>

      <div class="rp-section" style="font-size:11px;color:var(--dim);font-style:italic;line-height:1.6;border-top:1px solid var(--border);padding-top:16px">
        This report is provided by Crew Voice as feedback data only. It is not HR advice, legal counsel, or medical guidance. The information contained in this report reflects the opinions and statements of the individuals interviewed and has not been independently verified. Crew Voice recommends consulting qualified HR, legal, or medical professionals for decisions related to employment law, workplace safety, discrimination, harassment, or employee health. Crew Voice assumes no liability for actions taken based on the contents of this report.
      </div>

      <div class="print-footer">Crew Voice | mycrewvoice.com | (864) 334-6982 | luke@mycrewvoice.com</div>
    </div>

    <div class="interview-actions no-print" style="margin-top:16px">
      <button class="btn btn-secondary" onclick="closeReportBuilder()">‚Üê Back</button>
      ${hasApiKey?`<button class="btn btn-primary" onclick="generateReportWithAI('${clientId}')" id="btnGenAI">üìù ${hasContent?'Regenerate':'Generate'} Report</button>`:''}
      <button class="btn btn-secondary" onclick="printReport('${clientId}')">üñ® Print Report</button>
      <button class="btn btn-secondary" onclick="printAllInterviews('${clientId}')">üìã Download All Interviews</button>
      ${report.status==='draft'?`<button class="btn btn-primary" onclick="finalizeReport('${report.id}')">‚úÖ Finalize Report</button>`:''}
      ${report.status==='finalized'?`<button class="btn btn-primary" onclick="openDeliveryModal('${report.id}')">üì¨ Mark Delivered</button>`:''}
      ${report.status==='delivered'?'<span class="badge badge-delivered" style="padding:8px 16px;font-size:13px">‚úÖ Delivered</span>':''}
    </div>`;

  document.getElementById('reportBuilder').innerHTML=bHtml;
  document.getElementById('reportBuilder').style.display='';
  document.getElementById('reportsContent').style.display='none';
  }catch(e){alert('Error building report: '+e.message);console.error('Report builder error:',e)}
}

function closeReportBuilder(){
  document.getElementById('reportBuilder').style.display='none';
  document.getElementById('reportsContent').style.display='';
  renderReports();
}

function updateReportField(field,val){
  const report=data.reports.find(r=>r.clientId===currentReportClientId&&r.month===reportMonth);
  if(report){report[field]=val;report.updatedAt=new Date().toISOString();save(data)}
}

function renderEditableRiskTable(riskFlags,clientId){
  const levelColor=l=>l==='high'?'var(--red)':l==='medium'?'var(--orange)':l==='low'?'var(--amber)':'var(--green)';
  const levelEmoji=l=>l==='high'?'üî¥':l==='medium'?'üü°':l==='low'?'üü†':'üü¢';
  const rows=riskFlags||[];

  // Print-only static table
  let t=`<table class="risk-table print-only" style="display:none;width:100%;border-collapse:collapse;font-size:13px">
    <thead><tr style="text-align:left;border-bottom:2px solid var(--border)">
      <th style="padding:8px">Crew Member</th><th style="padding:8px">Risk Level</th><th style="padding:8px">Key Signal</th><th style="padding:8px">Recommended Action</th>
    </tr></thead><tbody>`;
  rows.forEach(r=>{
    t+=`<tr style="border-bottom:1px solid var(--border)">
      <td style="padding:8px;font-weight:600">${esc(r.name)}</td>
      <td style="padding:8px;color:${levelColor(r.level)};font-weight:700">${levelEmoji(r.level)} ${(r.level||'none').charAt(0).toUpperCase()+(r.level||'none').slice(1)}</td>
      <td style="padding:8px">${esc(r.signal||'')}</td>
      <td style="padding:8px">${esc(r.action||'')}</td>
    </tr>`;
  });
  t+='</tbody></table>';

  // Editable table (no-print)
  t+=`<table class="risk-table no-print" style="width:100%;border-collapse:collapse;font-size:13px">
    <thead><tr style="text-align:left;border-bottom:2px solid var(--border)">
      <th style="padding:8px">Crew Member</th><th style="padding:8px">Risk Level</th><th style="padding:8px">Key Signal</th><th style="padding:8px">Recommended Action</th><th style="padding:8px;width:40px"></th>
    </tr></thead><tbody>`;
  rows.forEach((r,i)=>{
    t+=`<tr style="border-bottom:1px solid var(--border)">
      <td style="padding:4px"><input class="form-control" style="padding:4px 8px;font-size:13px;font-weight:600" value="${esc(r.name)}" oninput="updateRiskRow(${i},'name',this.value)"></td>
      <td style="padding:4px"><select class="form-control" style="padding:4px 8px;font-size:13px;font-weight:700;color:${levelColor(r.level)}" onchange="updateRiskRow(${i},'level',this.value)">
        ${['none','low','medium','high'].map(l=>`<option value="${l}"${r.level===l?' selected':''}>${levelEmoji(l)} ${l.charAt(0).toUpperCase()+l.slice(1)}</option>`).join('')}
      </select></td>
      <td style="padding:4px"><input class="form-control" style="padding:4px 8px;font-size:13px" value="${esc(r.signal||'')}" oninput="updateRiskRow(${i},'signal',this.value)"></td>
      <td style="padding:4px"><input class="form-control" style="padding:4px 8px;font-size:13px" value="${esc(r.action||'')}" oninput="updateRiskRow(${i},'action',this.value)"></td>
      <td style="padding:4px;text-align:center"><button style="background:none;border:none;color:var(--red);cursor:pointer;font-size:16px" onclick="removeRiskRow(${i})" title="Remove row">√ó</button></td>
    </tr>`;
  });
  t+=`</tbody></table>
  <button class="btn btn-sm btn-secondary no-print" style="margin-top:8px" onclick="addRiskRow()">+ Add Row</button>`;

  const flaggedCount=rows.filter(r=>r.level&&r.level!=='none'&&r.level!=='low').length;
  if(flaggedCount)t+=`<p style="font-size:12px;color:var(--dim);margin-top:8px"><strong>${flaggedCount} crew member${flaggedCount>1?'s':''} flagged</strong></p>`;
  return t;
}

function updateRiskRow(idx,field,val){
  const report=data.reports.find(r=>r.clientId===currentReportClientId&&r.month===reportMonth);
  if(!report||!report.riskFlags||!report.riskFlags[idx])return;
  report.riskFlags[idx][field]=val;
  report.updatedAt=new Date().toISOString();
  save(data);
}

function removeRiskRow(idx){
  const report=data.reports.find(r=>r.clientId===currentReportClientId&&r.month===reportMonth);
  if(!report||!report.riskFlags)return;
  report.riskFlags.splice(idx,1);
  report.updatedAt=new Date().toISOString();
  save(data);
  openReportBuilder(currentReportClientId);
}

function addRiskRow(){
  const report=data.reports.find(r=>r.clientId===currentReportClientId&&r.month===reportMonth);
  if(!report)return;
  if(!report.riskFlags)report.riskFlags=[];
  report.riskFlags.push({name:'',level:'none',signal:'',action:''});
  report.updatedAt=new Date().toISOString();
  save(data);
  openReportBuilder(currentReportClientId);
}

function finalizeReport(reportId){
  const report=data.reports.find(r=>r.id===reportId);
  if(report){report.status='finalized';report.updatedAt=new Date().toISOString();save(data)}
  openReportBuilder(currentReportClientId);
}

function openDeliveryModal(reportId){
  deliveryReportId=reportId;
  document.getElementById('delDate').value=today();
  document.getElementById('delNotes').value='';
  document.getElementById('deliveryModal').classList.add('active');
}
function closeDeliveryModal(){document.getElementById('deliveryModal').classList.remove('active')}
function confirmDelivery(){
  const report=data.reports.find(r=>r.id===deliveryReportId);
  if(report){
    report.status='delivered';
    report.deliveryMethod=document.getElementById('delMethod').value;
    report.deliveryDate=document.getElementById('delDate').value;
    report.deliveryNotes=document.getElementById('delNotes').value;
    report.updatedAt=new Date().toISOString();
    save(data);
  }
  closeDeliveryModal();
  if(currentReportClientId&&document.getElementById('reportBuilder').style.display!=='none'){
    openReportBuilder(currentReportClientId);
  }else{renderReports()}
}

function printReport(clientId){
  const content=document.getElementById('reportPreviewContent');
  if(!content)return;
  // Clone report to print container
  const printEl=document.getElementById('printReport');
  printEl.innerHTML=content.innerHTML;
  // Show print-only elements, hide no-print
  printEl.querySelectorAll('.no-print').forEach(el=>el.style.display='none');
  printEl.querySelectorAll('.print-only').forEach(el=>el.style.display='block');
  window.print();
}

function printAllInterviews(clientId){
  const client=getActiveClients().find(c=>c.id===clientId);
  if(!client)return;
  const interviews=data.interviews.filter(i=>i.clientId===clientId&&i.month===reportMonth&&i.status==='completed')
    .sort((a,b)=>(a.date||'').localeCompare(b.date||''));
  if(!interviews.length){alert('No completed interviews for this month.');return}

  const companyName=client.company||client.name;
  const ownerName=client.contact||client.name||'Owner';
  let html=`<div style="font-family:Inter,system-ui,sans-serif;color:#1a1a2e;max-width:800px;margin:0 auto">
    <div style="text-align:center;border-bottom:2px solid #2a2a4a;padding-bottom:16px;margin-bottom:24px">
      <div style="font-size:22px;font-weight:800;letter-spacing:1px">CREW VOICE</div>
      <div style="font-size:16px;font-weight:700;margin-top:4px">Individual Interview Records ‚Äî ${monthStr(reportMonth)}</div>
      <div style="font-size:13px;color:#666;margin-top:4px">${esc(companyName)} | Prepared for ${esc(ownerName)}</div>
      <div style="font-size:12px;color:#999;margin-top:2px">${interviews.length} crew member${interviews.length!==1?'s':''} interviewed</div>
    </div>`;

  interviews.forEach((interview,iIdx)=>{
    const emp=getEmployeeObj(clientId,interview.employeeId);
    const empName=emp?emp.name:'Unknown';
    const empRole=emp?emp.role||'Crew':'Crew';
    const moodEmoji=interview.mood>=1&&interview.mood<=5?MOODS[interview.mood-1]:'';
    const moodLabel=interview.mood?['','Poor','Below Average','Neutral','Positive','Excellent'][interview.mood]:'';
    const riskLabel=(interview.flightRisk||'none').charAt(0).toUpperCase()+(interview.flightRisk||'none').slice(1);
    const riskColor=interview.flightRisk==='high'?'#e53935':interview.flightRisk==='medium'?'#fb8c00':'#4caf50';

    html+=`<div style="${iIdx>0?'page-break-before:always;':''}margin-bottom:32px">
      <div style="background:#f5f5f5;border-radius:8px;padding:16px;margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
          <div>
            <div style="font-size:18px;font-weight:800">${esc(empName)}</div>
            <div style="font-size:13px;color:#666">${esc(empRole)} | Interview Date: ${interview.date||'N/A'}</div>
          </div>
          <div style="display:flex;gap:12px;align-items:center;font-size:13px">
            ${moodEmoji?`<span>${moodEmoji} ${moodLabel}</span>`:''}
            <span style="color:${riskColor};font-weight:700">Flight Risk: ${riskLabel}</span>
          </div>
        </div>
      </div>`;

    // All questions with answers
    const allQs=getAllQuestions(interview.clientId);
    const allResps=interview.responses||[];
    allQs.forEach((q,idx)=>{
      const resp=allResps.find(r=>r.questionId===q.id)||{rating:0,notes:'',flagged:false};
      const ratingStr=resp.rating?ratingWord(resp.rating)+' ('+resp.rating+'/5)':'No rating';
      const rColor=resp.rating>=4?'#4caf50':resp.rating>=3?'#fb8c00':resp.rating>0?'#e53935':'#999';
      html+=`<div style="border-bottom:1px solid #eee;padding:10px 0">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
          <div style="font-size:13px;font-weight:700;color:#333;flex:1">${idx+1}. ${esc(q.en)}${resp.flagged?' <span style="color:#e53935">üö©</span>':''}</div>
          <div style="font-size:12px;font-weight:700;color:${rColor};white-space:nowrap">${ratingStr}</div>
        </div>
        ${resp.notes?`<div style="font-size:13px;color:#444;margin-top:4px;padding-left:20px">${esc(resp.notes)}</div>`:'<div style="font-size:12px;color:#999;margin-top:4px;padding-left:20px;font-style:italic">No response recorded</div>'}
      </div>`;
    });

    // Summary section (skip private notes)
    const hasSummary=interview.highlights||interview.concerns||interview.quotes;
    if(hasSummary){
      html+=`<div style="margin-top:16px;background:#fafafa;border-radius:8px;padding:14px">
        <div style="font-size:14px;font-weight:700;margin-bottom:8px">Interviewer Notes</div>
        ${interview.highlights?`<div style="font-size:13px;margin-bottom:6px"><span style="color:#4caf50;font-weight:700">Highlights:</span> ${esc(interview.highlights)}</div>`:''}
        ${interview.concerns?`<div style="font-size:13px;margin-bottom:6px"><span style="color:#e53935;font-weight:700">Concerns:</span> ${esc(interview.concerns)}</div>`:''}
        ${interview.quotes?`<div style="font-size:13px;font-style:italic;color:#555">"${esc(interview.quotes)}"</div>`:''}
      </div>`;
    }

    html+=`</div>`;
  });

  html+=`<div style="text-align:center;font-size:11px;color:#999;border-top:1px solid #ddd;padding-top:12px;margin-top:24px">
    Crew Voice | mycrewvoice.com | (864) 334-6982 | luke@mycrewvoice.com
  </div></div>`;

  const printEl=document.getElementById('printReport');
  printEl.innerHTML=html;
  window.print();
}

/* ============ HISTORY ============ */
function renderHistorySelectors(){
  const clients=getActiveClients();
  const sel=document.getElementById('histClient');
  sel.innerHTML='<option value="">Select client...</option>'+
    clients.map(c=>`<option value="${c.id}">${esc(c.company||c.name)}</option>`).join('');
  document.getElementById('histEmployee').innerHTML='<option value="">Select crew member...</option>';
  document.getElementById('histEmployee').disabled=true;
  document.getElementById('historyContent').innerHTML='<div class="empty-state"><div class="empty-icon">üìà</div><p>Select a client and crew member to view interview history.</p></div>';
}

function loadHistEmployees(){
  const clientId=document.getElementById('histClient').value;
  const sel=document.getElementById('histEmployee');
  if(!clientId){sel.innerHTML='<option value="">Select crew member...</option>';sel.disabled=true;return}
  const emps=getClientEmployees(clientId);
  sel.innerHTML='<option value="">Select crew member...</option>'+
    emps.map(e=>`<option value="${e.id}">${esc(e.name)}</option>`).join('');
  sel.disabled=false;
}

function renderHistory(){
  const clientId=document.getElementById('histClient').value;
  const empId=document.getElementById('histEmployee').value;
  if(!clientId||!empId){document.getElementById('historyContent').innerHTML='';return}

  const emp=getEmployeeObj(clientId,empId);
  const interviews=data.interviews.filter(i=>i.clientId===clientId&&i.employeeId===empId&&i.status==='completed')
    .sort((a,b)=>a.month.localeCompare(b.month));

  if(!interviews.length){
    document.getElementById('historyContent').innerHTML='<div class="empty-state"><div class="empty-icon">üìã</div><p>No completed interviews for this crew member yet.</p></div>';
    return;
  }

  const latest=interviews[interviews.length-1];
  const moodEmoji=latest.mood>=1&&latest.mood<=5?MOODS[latest.mood-1]:'';

  let html=`
    <div class="card card-glow">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <div>
          <div style="font-size:18px;font-weight:800">${esc(emp?.name||'Unknown')}</div>
          <div style="font-size:13px;color:var(--dim)">${esc(emp?.role||'Crew')} ‚Äî ${esc(getClientName(clientId))}</div>
          <div style="font-size:12px;color:var(--dim);margin-top:4px">Language: ${emp?.language==='es'?'Spanish':emp?.language==='both'?'Bilingual':'English'} | Total interviews: ${interviews.length}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          ${moodEmoji?`<span style="font-size:28px">${moodEmoji}</span>`:''}
          ${latest.flightRisk&&latest.flightRisk!=='none'?`<span class="badge badge-${latest.flightRisk==='high'?'due':latest.flightRisk==='medium'?'pending':'scheduled'}">${latest.flightRisk} risk</span>`:''}
        </div>
      </div>
    </div>`;

  // Trend chart (SVG)
  if(interviews.length>=2){
    html+=`<div class="trend-chart"><h3 style="margin-bottom:12px">üìà Rating Trends</h3>`;
    const chartW=Math.max(400,interviews.length*80);
    const chartH=200;
    const padL=50,padR=20,padT=20,padB=40;
    const plotW=chartW-padL-padR;
    const plotH=chartH-padT-padB;
    const catColors={satisfaction:'#00BFA5',management:'#40C4FF',pay:'#FFB300',safety:'#66BB6A',communication:'#B388FF',equipment:'#F06292',teamMorale:'#FF6B6B',workload:'#FFA726',training:'#00E676',future:'#EF5350'};

    let svg=`<svg class="trend-svg" viewBox="0 0 ${chartW} ${chartH}" xmlns="http://www.w3.org/2000/svg">`;
    // Grid lines
    for(let v=1;v<=5;v++){
      const y=padT+plotH-(v-1)/(5-1)*plotH;
      svg+=`<line x1="${padL}" y1="${y}" x2="${chartW-padR}" y2="${y}" stroke="var(--border)" stroke-width="1" stroke-dasharray="4"/>`;
      svg+=`<text x="${padL-8}" y="${y+4}" text-anchor="end" fill="var(--dim)" font-size="11" font-family="Inter">${v}</text>`;
    }
    // Month labels
    interviews.forEach((int,idx)=>{
      const x=padL+idx/(Math.max(interviews.length-1,1))*plotW;
      svg+=`<text x="${x}" y="${chartH-5}" text-anchor="middle" fill="var(--dim)" font-size="10" font-family="Inter">${int.month.slice(5)+'/'+ int.month.slice(2,4)}</text>`;
    });

    // Lines per category
    CATEGORIES.forEach(cat=>{
      const points=interviews.map((int,idx)=>{
        const val=int.ratings[cat]||0;
        if(!val)return null;
        const x=padL+idx/(Math.max(interviews.length-1,1))*plotW;
        const y=padT+plotH-(val-1)/4*plotH;
        return{x,y};
      }).filter(Boolean);
      if(points.length<2)return;
      const d=points.map((p,i)=>i===0?`M${p.x},${p.y}`:`L${p.x},${p.y}`).join(' ');
      svg+=`<path d="${d}" fill="none" stroke="${catColors[cat]}" stroke-width="2" opacity="0.7"/>`;
      points.forEach(p=>{
        svg+=`<circle cx="${p.x}" cy="${p.y}" r="4" fill="${catColors[cat]}"/>`;
      });
    });

    svg+=`</svg>`;
    // Legend
    svg+=`<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">`;
    CATEGORIES.forEach(cat=>{
      svg+=`<span style="font-size:11px;display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;border-radius:2px;background:${catColors[cat]};display:inline-block"></span>${CAT_LABELS[cat]}</span>`;
    });
    svg+=`</div>`;
    html+=svg+`</div>`;
  }

  // Interview history (expandable)
  html+=`<div class="card"><h3>üìã Interview History</h3>`;
  interviews.slice().reverse().forEach(i=>{
    const avgVals=Object.values(i.ratings||{}).filter(v=>v>0);
    const avg=avgVals.length?(avgVals.reduce((a,b)=>a+b,0)/avgVals.length).toFixed(1):'‚Äî';
    const moodE=i.mood>=1&&i.mood<=5?MOODS[i.mood-1]:'';
    html+=`<div class="history-row" onclick="this.classList.toggle('expanded')">
      <div class="hr-top">
        <div class="hr-date">${monthStr(i.month)} ‚Äî ${i.date}</div>
        <div style="display:flex;gap:8px;align-items:center">
          <span style="font-size:13px;font-weight:700;color:var(--teal)">${avg}/5</span>
          ${moodE?`<span>${moodE}</span>`:''}
          ${i.flightRisk&&i.flightRisk!=='none'?`<span class="badge badge-${i.flightRisk==='high'?'due':'pending'}" style="font-size:10px">${i.flightRisk}</span>`:''}
        </div>
      </div>
      <div class="hr-detail">
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
          ${CATEGORIES.map(cat=>{
            const v=i.ratings[cat];
            if(!v)return'';
            const c=v>=4?'var(--green)':v>=3?'var(--orange)':'var(--red)';
            return`<span style="font-size:11px;padding:2px 8px;border-radius:4px;border:1px solid ${c};color:${c}">${CAT_LABELS[cat]}: ${v}</span>`;
          }).join('')}
        </div>
        ${i.highlights?`<div style="font-size:12px;margin-bottom:4px">‚úÖ <strong>Highlights:</strong> ${esc(i.highlights)}</div>`:''}
        ${i.concerns?`<div style="font-size:12px;margin-bottom:4px">‚ö† <strong>Concerns:</strong> ${esc(i.concerns)}</div>`:''}
        ${i.quotes?`<div style="font-size:12px;font-style:italic;color:var(--dim)">"${esc(i.quotes)}"</div>`:''}
        ${i.responses.filter(r=>r.flagged).map(r=>{
          const q=QUESTIONS.find(qq=>qq.id===r.questionId);
          return`<div style="font-size:12px;margin-top:4px;color:var(--coral)">üö© ${q?q.en:''}: ${esc(r.notes)}</div>`;
        }).join('')}
        <div style="margin-top:10px"><button class="btn btn-sm btn-primary" onclick="event.stopPropagation();openInterviewDetail('${i.id}','history')">üëÅ View Full Interview</button></div>
      </div>
    </div>`;
  });
  html+=`</div>`;

  // Month comparison (if 2+ interviews)
  if(interviews.length>=2){
    const last=interviews[interviews.length-1];
    const prev=interviews[interviews.length-2];
    html+=`<div class="card"><h3>üìä Month Comparison</h3>
      <div class="comparison-grid">
        <div class="comp-col"><h4>${monthStr(prev.month)}</h4>
          ${CATEGORIES.map(cat=>{
            const v=prev.ratings[cat]||0;
            const c=v>=4?'var(--green)':v>=3?'var(--orange)':'var(--red)';
            return v?`<div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px"><span>${CAT_LABELS[cat]}</span><span style="color:${c};font-weight:700">${v}</span></div>`:'';
          }).join('')}
        </div>
        <div class="comp-col"><h4>${monthStr(last.month)}</h4>
          ${CATEGORIES.map(cat=>{
            const v=last.ratings[cat]||0;
            const pv=prev.ratings[cat]||0;
            const c=v>=4?'var(--green)':v>=3?'var(--orange)':'var(--red)';
            const delta=v&&pv?(v-pv):0;
            const dc=delta>0?'delta-pos':delta<0?'delta-neg':'delta-flat';
            const ds=delta>0?`+${delta.toFixed(1)}`:delta<0?delta.toFixed(1):'‚Äî';
            return v?`<div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px"><span>${CAT_LABELS[cat]}</span><span><span style="color:${c};font-weight:700">${v}</span> <span class="${dc}" style="font-size:11px">${ds}</span></span></div>`:'';
          }).join('')}
        </div>
      </div>
    </div>`;
  }

  document.getElementById('historyContent').innerHTML=html;
}

/* ============ INTERVIEW DETAIL ============ */
let detailReturnView='history'; // track where user came from

function openInterviewDetail(interviewId,fromView){
  const interview=data.interviews.find(i=>i.id===interviewId);
  if(!interview)return;
  if(fromView)detailReturnView=fromView;

  // Navigate to Interview tab
  document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-links a').forEach(el=>el.classList.remove('active'));
  document.getElementById('v-interview').classList.add('active');
  const navEl=document.querySelector('[data-view="interview"]');
  if(navEl)navEl.classList.add('active');

  document.getElementById('interviewSelect').style.display='none';
  document.getElementById('interviewForm').style.display='';
  if(timerInterval){clearInterval(timerInterval);timerInterval=null}

  const clientName=getClientName(interview.clientId);
  const emp=getEmployeeObj(interview.clientId,interview.employeeId);
  const empName=emp?emp.name:'Unknown';
  const empRole=emp?emp.role||'Crew':'Crew';
  const moodEmoji=interview.mood>=1&&interview.mood<=5?MOODS[interview.mood-1]:'';
  const langLabel=interview.language==='es'?'Spanish':interview.language==='both'?'Bilingual':'English';
  const riskColor=interview.flightRisk==='high'?'var(--red)':interview.flightRisk==='medium'?'var(--orange)':interview.flightRisk==='low'?'var(--amber)':'var(--green)';

  let html=`<div class="interview-detail" id="interviewDetailContent">
    <div class="detail-header">
      <div class="dh-top">
        <div>
          <div class="dh-company">${esc(clientName)}</div>
          <div class="dh-crew">${esc(empName)} ‚Äî ${esc(empRole)}</div>
          <div class="dh-meta">
            <span>üìÖ ${interview.date}</span>
            <span>‚è± ${interview.duration||0} min</span>
            <span>üåê ${langLabel}</span>
            ${moodEmoji?`<span style="font-size:18px">${moodEmoji}</span>`:''}
            ${interview.flightRisk&&interview.flightRisk!=='none'?`<span class="badge badge-${interview.flightRisk==='high'?'due':interview.flightRisk==='medium'?'pending':'scheduled'}">${interview.flightRisk} risk</span>`:''}
          </div>
        </div>
        <div style="font-size:12px;color:var(--dim);text-align:right">
          <div>Month: ${monthStr(interview.month)}</div>
          <div>ID: ${interview.id.slice(0,8)}</div>
        </div>
      </div>
    </div>`;

  // Question cards (read-only) ‚Äî core + custom
  const detailQs=getAllQuestions(interview.clientId);
  // Also include any responses for questions not in current set (from older interviews)
  const allResps=interview.responses||[];
  detailQs.forEach((q,idx)=>{
    const resp=allResps.find(r=>r.questionId===q.id)||{rating:0,notes:'',flagged:false};
    html+=`<div class="q-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><span class="q-num">${idx+1}</span><span class="q-category">${CAT_LABELS[q.cat]||q.cat}${q.isCustom?' ¬∑ Custom':''}</span></div>
        ${resp.flagged?'<span class="detail-flag">üö© Flagged</span>':''}
      </div>
      <div class="q-bilingual">
        <div><div class="q-lang-label en">English</div><div class="q-text">${esc(q.en)}</div></div>
        ${q.es?`<div><div class="q-lang-label es">Espa√±ol</div><div class="q-text es">${esc(q.es)}</div></div>`:''}
      </div>
      <div class="detail-rating">
        ${[1,2,3,4,5].map(n=>`<span class="dr-dot ${resp.rating===n?'r'+n:'inactive'}">${n}</span>`).join('')}
        <span class="dr-label">${ratingWord(resp.rating)}</span>
      </div>
      ${resp.notes?`<div class="detail-notes">${esc(resp.notes)}</div>`:''}
    </div>`;
  });

  // Summary section
  html+=`<div class="card">
    <h3>üìù Summary</h3>
    ${interview.highlights?`<div class="detail-field"><div class="df-label">Highlights / Positives</div><div class="df-value" style="color:var(--emerald)">‚úÖ ${esc(interview.highlights)}</div></div>`:''}
    ${interview.concerns?`<div class="detail-field"><div class="df-label">Key Concerns</div><div class="df-value" style="color:var(--coral)">‚ö† ${esc(interview.concerns)}</div></div>`:''}
    ${interview.quotes?`<div class="detail-field"><div class="df-label">Notable Quotes</div><div class="df-value" style="font-style:italic">"${esc(interview.quotes)}"</div></div>`:''}
    ${interview.privateNotes?`<div class="detail-field"><div class="df-label">Private Notes</div><div class="df-value" style="color:var(--dim)">${esc(interview.privateNotes)}</div></div>`:''}
    <div class="detail-field">
      <div class="df-label">Flight Risk</div>
      <div class="df-value"><span style="color:${riskColor};font-weight:700">${(interview.flightRisk||'none').charAt(0).toUpperCase()+(interview.flightRisk||'none').slice(1)}</span></div>
    </div>
    <div class="detail-field">
      <div class="df-label">Overall Mood</div>
      <div class="df-value">${moodEmoji||'Not set'} ${interview.mood?['','Poor','Below Average','Neutral','Positive','Excellent'][interview.mood]:''}</div>
    </div>
  </div>`;

  html+=`
  <div class="print-footer">Prepared by Crew Voice | mycrewvoice.com | (864) 334-6982</div>

  <div class="detail-actions no-print">
    <button class="btn btn-secondary" onclick="goBackFromDetail()">‚Üê Back</button>
    <button class="btn btn-primary" onclick="editInterview('${interview.id}')">‚úèÔ∏è Edit Interview</button>
    <button class="btn btn-secondary" onclick="printInterviewDetail()">üìÑ Download PDF</button>
    <button class="btn btn-danger" onclick="deleteInterview('${interview.id}')">üóë Delete Interview</button>
  </div>
  </div>`;

  document.getElementById('interviewForm').innerHTML=html;
}

function goBackFromDetail(){
  showView(detailReturnView||'history');
}

function editInterview(interviewId){
  const interview=data.interviews.find(i=>i.id===interviewId);
  if(!interview)return;

  // Load interview into activeInterview for editing
  activeInterview={...interview,responses:interview.responses.map(r=>({...r})),ratings:{...(interview.ratings||{})}};
  activeInterview._editMode=true;

  document.getElementById('interviewSelect').style.display='none';
  document.getElementById('interviewForm').style.display='';

  const clientName=getClientName(interview.clientId);
  const emp=getEmployeeObj(interview.clientId,interview.employeeId);
  const empName=emp?emp.name:'Unknown';
  const empRole=emp?emp.role||'Crew':'Crew';

  let html=`
    <div class="interview-header">
      <div class="ih-top">
        <div>
          <div class="ih-company">${esc(clientName)}</div>
          <div class="ih-crew">${esc(empName)} ‚Äî ${esc(empRole)}</div>
          <div class="ih-meta">üìÖ ${interview.date} &nbsp; üåê ${interview.language==='es'?'Spanish':interview.language==='both'?'Bilingual':'English'} &nbsp; ‚úèÔ∏è Editing</div>
        </div>
        <div style="font-size:13px;font-weight:700;color:var(--amber)">EDIT MODE</div>
      </div>
    </div>`;

  // Questions (editable ‚Äî core + custom)
  const editQs=getAllQuestions(interview.clientId);
  editQs.forEach((q,idx)=>{
    const resp=activeInterview.responses.find(r=>r.questionId===q.id)||{rating:0,notes:'',flagged:false};
    const qIdStr=typeof q.id==='string'?`'${q.id}'`:q.id;
    html+=`<div class="q-card" id="qcard-${q.id}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><span class="q-num">${idx+1}</span><span class="q-category">${CAT_LABELS[q.cat]||q.cat}${q.isCustom?' ¬∑ Custom':''}</span></div>
        <button class="flag-btn${resp.flagged?' flagged':''}" onclick="toggleFlag(${qIdStr})" id="flag-${q.id}">üö© Flag</button>
      </div>
      <div class="q-bilingual">
        <div><div class="q-lang-label en">English</div><div class="q-text">${esc(q.en)}</div></div>
        ${q.es?`<div><div class="q-lang-label es">Espa√±ol</div><div class="q-text es">${esc(q.es)}</div></div>`:''}
      </div>
      <div class="rating-row">
        <span style="font-size:12px;font-weight:700;color:var(--dim);margin-right:4px">Rating:</span>
        ${[1,2,3,4,5].map(n=>`<button class="rating-btn r${n}${resp.rating===n?' active':''}" onclick="setRating(${qIdStr},${n})" id="rbtn-${q.id}-${n}">${n}</button>`).join('')}
        <span class="rating-label" id="rlabel-${q.id}">${ratingWord(resp.rating)}</span>
      </div>
      <textarea class="form-control" placeholder="Notes / verbatim response..." rows="2" id="qnotes-${q.id}" oninput="updateNotes(${qIdStr})">${esc(resp.notes)}</textarea>
    </div>`;
  });

  // Additional fields
  html+=`
    <div class="card">
      <h3>üìù Additional Notes</h3>
      <div class="form-group">
        <label>Key Concerns</label>
        <textarea class="form-control" id="intConcerns" placeholder="Main concerns raised...">${esc(activeInterview.concerns)}</textarea>
      </div>
      <div class="form-group">
        <label>Highlights / Positives</label>
        <textarea class="form-control" id="intHighlights" placeholder="Positive feedback...">${esc(activeInterview.highlights)}</textarea>
      </div>
      <div class="form-group">
        <label>Notable Quotes</label>
        <textarea class="form-control" id="intQuotes" placeholder="Direct quotes worth including in report...">${esc(activeInterview.quotes)}</textarea>
      </div>
      <div class="form-group">
        <label>Private Notes (excluded from client report)</label>
        <textarea class="form-control" id="intPrivate" placeholder="For your eyes only...">${esc(activeInterview.privateNotes)}</textarea>
      </div>
      <div class="form-group">
        <label>Flight Risk</label>
        <div class="risk-select">
          ${['none','low','medium','high'].map(r=>
            `<button class="risk-opt risk-${r}${activeInterview.flightRisk===r?' active':''}" onclick="setRisk('${r}')" id="risk-${r}">${r.charAt(0).toUpperCase()+r.slice(1)}</button>`
          ).join('')}
        </div>
      </div>
      <div class="form-group">
        <label>Overall Mood</label>
        <div class="mood-grid">
          ${MOODS.map((m,i)=>
            `<button class="mood-btn${activeInterview.mood===i+1?' active':''}" onclick="setMood(${i+1})" id="mood-${i+1}">${m}</button>`
          ).join('')}
        </div>
      </div>
    </div>
    <div class="interview-actions">
      <button class="btn btn-secondary" onclick="cancelEdit('${interviewId}')">Cancel Edit</button>
      <button class="btn btn-primary" onclick="saveEditedInterview('${interviewId}')">üíæ Save Changes</button>
    </div>`;

  document.getElementById('interviewForm').innerHTML=html;
}

function saveEditedInterview(interviewId){
  if(!activeInterview)return;
  // Gather fields from the form
  activeInterview.concerns=document.getElementById('intConcerns')?.value||'';
  activeInterview.highlights=document.getElementById('intHighlights')?.value||'';
  activeInterview.quotes=document.getElementById('intQuotes')?.value||'';
  activeInterview.privateNotes=document.getElementById('intPrivate')?.value||'';
  activeInterview.updatedAt=new Date().toISOString();

  // Recompute category ratings
  const editAllQs=getAllQuestions(activeInterview.clientId);
  CATEGORIES.forEach(cat=>{
    const catResps=activeInterview.responses.filter(r=>{
      const q=editAllQs.find(qq=>qq.id===r.questionId);
      return q&&q.cat===cat&&r.rating>0;
    });
    if(catResps.length){
      activeInterview.ratings[cat]=Math.round(catResps.reduce((s,r)=>s+r.rating,0)/catResps.length*10)/10;
    }
  });

  // Save back
  const idx=data.interviews.findIndex(i=>i.id===interviewId);
  if(idx>=0){
    const editMode=activeInterview._editMode;
    delete activeInterview._editMode;
    data.interviews[idx]={...activeInterview};
    save(data);
    activeInterview=null;
    openInterviewDetail(interviewId);
  }
}

function cancelEdit(interviewId){
  activeInterview=null;
  openInterviewDetail(interviewId);
}

function deleteInterview(interviewId){
  if(!confirm('Are you sure you want to delete this interview? This cannot be undone.'))return;
  const interview=data.interviews.find(i=>i.id===interviewId);
  if(!interview)return;

  // Remove interview
  data.interviews=data.interviews.filter(i=>i.id!==interviewId);

  // Clean up schedule entry
  const sched=data.schedule.find(s=>s.interviewId===interviewId);
  if(sched){
    sched.status='scheduled';
    sched.interviewId=null;
  }else{
    // Try to find by client/employee/month and reset
    const s2=data.schedule.find(s=>s.clientId===interview.clientId&&s.employeeId===interview.employeeId&&s.month===interview.month&&s.status==='completed');
    if(s2){s2.status='scheduled';s2.interviewId=null}
  }

  save(data);
  showView(detailReturnView||'history');
}

function printInterviewDetail(){
  const content=document.getElementById('interviewDetailContent');
  if(!content)return;
  const printEl=document.getElementById('printReport');
  printEl.innerHTML=content.innerHTML;
  printEl.querySelectorAll('.no-print').forEach(el=>el.style.display='none');
  printEl.querySelectorAll('.print-only').forEach(el=>el.style.display='block');
  window.print();
}

/* ============ REPORT GENERATION ============ */
function showAiLoading(){document.getElementById('aiLoadingOverlay').style.display='flex'}
function hideAiLoading(){document.getElementById('aiLoadingOverlay').style.display='none'}
function showToast(msg,type){
  const el=document.getElementById('toastEl');
  el.className='toast toast-'+(type||'success')+' show';
  el.textContent=msg;
  setTimeout(()=>{el.classList.remove('show')},4000);
}

function buildBatchReportPrompt(client,interviews){
  const ownerName=client.contact||client.name||'Owner';
  const companyName=client.company||client.name;
  const interviewsData=interviews.map(i=>{
    const emp=getEmployeeObj(client.id,i.employeeId);
    const allQs=getAllQuestions(i.clientId);
    return{
      employee:emp?.name||'Unknown',role:emp?.role||'Crew',
      mood:i.mood?['','Poor','Below Average','Neutral','Positive','Excellent'][i.mood]:'Not set',
      flightRisk:i.flightRisk||'none',
      categoryRatings:Object.entries(i.ratings||{}).map(([k,v])=>({category:CAT_LABELS[k]||k,rating:v})).filter(c=>c.rating>0),
      responses:i.responses.map(r=>{
        const q=allQs.find(qq=>qq.id===r.questionId);
        return{question:q?q.en:'',rating:r.rating,notes:r.notes||'',flagged:r.flagged};
      }).filter(r=>r.notes||r.flagged||r.rating),
      concerns:i.concerns||'',highlights:i.highlights||'',quotes:i.quotes||''
    };
  });

  return `You are writing a monthly crew intelligence report for a lawn care / landscaping business owner. This report is from Crew Voice, a third-party service that interviews crew members monthly. The feedback IS shared with the owner ‚Äî this is not confidential.

Company: ${companyName}
Owner: ${ownerName}
Month: ${interviews[0]?.month||''}
Crew interviewed: ${interviews.length}

Here are ALL the interviews for this month:

${JSON.stringify(interviewsData,null,2)}

Ratings: 1=Poor, 2=Needs Work, 3=Okay, 4=Good, 5=Excellent.

Respond with ONLY valid JSON (no markdown, no code fences):

{
  "overallSummary": "1-2 sentences summarizing overall team sentiment. Be direct and specific.",
  "moraleLevel": "high|medium|low",
  "positives": "1. **[Theme]** ‚Äî Brief explanation with detail from interviews\\n\\n2. **[Theme]** ‚Äî Brief explanation\\n\\n3. **[Theme]** ‚Äî Brief explanation",
  "concerns": "1. **[Theme]** ‚Äî Brief explanation. How many mentioned it.\\n\\n2. **[Theme]** ‚Äî Brief explanation\\n\\n3. **[Theme]** ‚Äî Brief explanation",
  "riskFlags": [
    {"name": "Employee Name", "level": "high|medium|low|none", "signal": "What they said or indicated", "action": "Specific recommended action"}
  ],
  "focusAreas": "1. **[Action]** ‚Äî Why it matters and what to do. Be specific.\\n\\n2. **[Action]** ‚Äî Why it matters and what to do.\\n\\n3. **[Action]** ‚Äî Why it matters and what to do."
}

Rules:
- Be SHORT and to the point. No fluff.
- Highlight wins clearly in positives.
- Point out real losses/problems in concerns.
- Only include an employee in riskFlags if their risk is medium or high. For low/none risk employees, leave them out entirely.
- Recommendations should be specific and actionable, not generic HR advice.
- Reference actual things employees said. Use their names only when relevant to a specific concern or risk.
- Consider lawn care industry context: outdoor work, bilingual crews, seasonal patterns, small teams.
- Write as if a professional wrote this report ‚Äî no mention of AI anywhere.
- The positives, concerns, and focusAreas should be numbered plain text with **bold** themes.`;
}

async function generateReportWithAI(clientId){
  const apiKey=data.settings.claudeApiKey;
  if(!apiKey){alert('Please add your Claude API key in Settings.');openSettings();return}
  const client=getActiveClients().find(c=>c.id===clientId);
  if(!client)return;
  const interviews=data.interviews.filter(i=>i.clientId===clientId&&i.month===reportMonth&&i.status==='completed');
  if(!interviews.length)return;

  showAiLoading();
  try{
    const prompt=buildBatchReportPrompt(client,interviews);
    const model=data.settings.aiModel||'claude-sonnet-4-5-20250929';
    const response=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:model,max_tokens:4096,messages:[{role:'user',content:prompt}]})
    });
    if(!response.ok){
      let errMsg='API error ('+response.status+')';
      try{const errJson=await response.json();errMsg=errJson.error?.message||errMsg}catch(e){}
      if(response.status===401)errMsg='Invalid API key. Check your key in Settings.';
      if(response.status===429)errMsg='Rate limited. Please wait a moment and try again.';
      if(response.status===529)errMsg='API is overloaded. Try again later.';
      throw new Error(errMsg);
    }
    const result=await response.json();
    let text=result.content[0].text.trim();
    if(text.startsWith('\`\`\`json'))text=text.slice(7);
    else if(text.startsWith('\`\`\`'))text=text.slice(3);
    if(text.endsWith('\`\`\`'))text=text.slice(0,-3);
    const parsed=JSON.parse(text.trim());

    // Update report
    const report=data.reports.find(r=>r.clientId===clientId&&r.month===reportMonth);
    if(report){
      report.overallSummary=parsed.overallSummary||'';
      report.moraleLevel=parsed.moraleLevel||'';
      report.positives=parsed.positives||'';
      report.concerns=parsed.concerns||'';
      report.riskFlags=Array.isArray(parsed.riskFlags)?parsed.riskFlags:[];
      report.focusAreas=parsed.focusAreas||'';
      report.updatedAt=new Date().toISOString();
      save(data);
    }
    hideAiLoading();
    showToast('Report generated!','success');
    openReportBuilder(clientId);
  }catch(e){
    hideAiLoading();
    showToast('Report generation failed: '+(e.message||'Unknown error'),'error');
  }
}

/* ============ INIT ============ */
applyTheme();
showView('dashboard');
</script>
</body>
</html>
