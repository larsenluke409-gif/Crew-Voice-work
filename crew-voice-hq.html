<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crew Voice HQ â€” Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:#0a0a14;
  --surface:#12121f;
  --surface-2:#1a1a2e;
  --surface-3:#22223a;
  --border:#2a2a4a;
  --border-light:#3a3a5a;
  --text:#e8e8f0;
  --text-2:#9898b0;
  --text-3:#686880;
  --green:#4CAF50;
  --green-dark:#2E7D32;
  --gold:#D4930D;
  --gold-hover:#B87E0B;
  --blue:#2196F3;
  --purple:#9C27B0;
  --teal:#00BCD4;
  --red:#ef4444;
  --red-dark:#dc2626;
  --orange:#FF7043;
  --sidebar-w:220px;
}

body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex}

/* Sidebar */
.sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);position:fixed;top:0;left:0;bottom:0;display:flex;flex-direction:column;z-index:100;transition:transform .3s}
.sidebar-brand{padding:20px 16px;border-bottom:1px solid var(--border)}
.sidebar-brand h1{font-size:15px;font-weight:800;color:var(--green);letter-spacing:-.3px}
.sidebar-brand p{font-size:10px;color:var(--text-2);margin-top:2px;text-transform:uppercase;letter-spacing:1px}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 16px;color:var(--text-2);cursor:pointer;font-size:13px;font-weight:500;border-left:3px solid transparent;transition:all .2s}
.nav-item:hover{background:var(--surface-3);color:var(--text)}
.nav-item.active{color:var(--text);background:rgba(76,175,80,.06);border-left-color:var(--green)}
.nav-item svg{width:18px;height:18px;flex-shrink:0}
.nav-divider{height:1px;background:var(--border);margin:8px 16px}
.nav-label{padding:8px 16px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-3)}

.mobile-toggle{display:none;position:fixed;top:14px;left:14px;z-index:200;background:var(--surface);border:1px solid var(--border);color:var(--text);width:40px;height:40px;border-radius:8px;cursor:pointer;font-size:18px;align-items:center;justify-content:center}

/* Main */
.main{margin-left:var(--sidebar-w);flex:1;min-height:100vh;padding:28px 32px;max-width:1200px}
.view{display:none}.view.active{display:block}

/* Typography */
.page-title{font-size:22px;font-weight:700;margin-bottom:20px}
.section-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-2);margin-bottom:10px}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:14px}
.card-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.card-head h2{font-size:14px;font-weight:600}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px;margin-bottom:20px}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center}
.kpi-value{font-size:28px;font-weight:800;margin-bottom:2px}
.kpi-label{font-size:11px;color:var(--text-2);text-transform:uppercase;letter-spacing:.5px}
.kpi-sub{font-size:11px;color:var(--text-3);margin-top:4px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:7px;border:none;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--green);color:#fff}.btn-primary:hover{background:var(--green-dark)}
.btn-gold{background:var(--gold);color:#fff}.btn-gold:hover{background:var(--gold-hover)}
.btn-ghost{background:transparent;color:var(--text-2);border:1px solid var(--border)}.btn-ghost:hover{background:var(--surface-3);color:var(--text)}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{background:var(--red-dark)}
.btn-sm{padding:4px 8px;font-size:11px}
.btn-blue{background:var(--blue);color:#fff}.btn-blue:hover{opacity:.9}

/* Tags */
.tag{display:inline-block;padding:2px 8px;border-radius:14px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.tag-lead{background:rgba(33,150,243,.12);color:var(--blue)}
.tag-contacted{background:rgba(156,39,176,.12);color:var(--purple)}
.tag-replied{background:rgba(0,188,212,.12);color:var(--teal)}
.tag-call-scheduled{background:rgba(255,112,67,.12);color:var(--orange)}
.tag-proposal{background:rgba(212,147,13,.12);color:var(--gold)}
.tag-closed{background:rgba(76,175,80,.12);color:var(--green)}
.tag-lost{background:rgba(239,68,68,.12);color:var(--red)}
.tag-churned{background:rgba(239,68,68,.12);color:var(--red)}
.tag-bad-email{background:rgba(239,68,68,.12);color:var(--red)}
.bad-email-row td{opacity:.6}.bad-email-row td:first-child{opacity:1}
.flag-btn{padding:4px 6px;font-size:14px;cursor:pointer;background:none;border:none;opacity:.3;transition:all .2s}
.flag-btn:hover{opacity:.7}.flag-btn.flagged{opacity:1}

/* Forms */
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:var(--text-2)}
.form-control{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:inherit;font-size:13px;transition:border-color .2s}
.form-control:focus{outline:none;border-color:var(--green)}
select.form-control{cursor:pointer}
textarea.form-control{resize:vertical;min-height:60px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.form-row-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}

/* Email templates */
.tpl-tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0}
.tpl-tab{padding:8px 16px;font-size:12px;font-weight:600;color:var(--text-3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;background:none;border-top:none;border-left:none;border-right:none;font-family:inherit}
.tpl-tab:hover{color:var(--text)}
.tpl-tab.active{color:var(--green);border-bottom-color:var(--green)}
.tpl-contact-bar{display:flex;gap:8px;align-items:center;margin-bottom:16px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px}
.tpl-contact-bar label{font-size:12px;font-weight:600;color:var(--text-2);white-space:nowrap}
.tpl-contact-bar select{flex:1;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;font-size:12px}
.tpl-contact-bar input{flex:1;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;font-size:12px}
.tpl-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:12px;overflow:hidden}
.tpl-card-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer}
.tpl-card-head:hover{background:var(--surface-3)}
.tpl-card-title{font-size:13px;font-weight:700}
.tpl-card-timing{font-size:11px;color:var(--text-3)}
.tpl-card-body{padding:16px;display:none}
.tpl-card.open .tpl-card-body{display:block}
.tpl-card.open .tpl-card-head{background:var(--surface-2)}
.tpl-subject{display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px}
.tpl-subject-label{font-size:10px;font-weight:700;color:var(--text-3);text-transform:uppercase;white-space:nowrap}
.tpl-subject-text{flex:1;font-size:13px;font-weight:500}
.tpl-body-text{font-size:13px;line-height:1.7;color:var(--text);white-space:pre-wrap;padding:12px 14px;background:var(--bg);border:1px solid var(--border);border-radius:6px;margin-bottom:10px;max-height:300px;overflow-y:auto}
.tpl-copy-bar{display:flex;gap:6px;justify-content:flex-end}
.tpl-copy-bar .btn{font-size:11px}
.tpl-note{font-size:11px;color:var(--text-3);font-style:italic;margin-bottom:8px}

/* Social media */
.soc-tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border)}
.soc-tab{padding:8px 16px;font-size:12px;font-weight:600;color:var(--text-3);cursor:pointer;border:none;border-bottom:2px solid transparent;background:none;font-family:inherit;transition:all .2s}
.soc-tab:hover{color:var(--text)}
.soc-tab.active{color:var(--green);border-bottom-color:var(--green)}
.soc-week{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:16px}
.soc-day{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;min-width:0}
.soc-day-head{font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text-2);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.soc-day-head .soc-day-pct{font-size:10px;font-weight:600;padding:1px 6px;border-radius:8px}
.soc-task{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:11px;cursor:pointer;transition:opacity .2s}
.soc-task.done{opacity:.5;text-decoration:line-through}
.soc-check{width:14px;height:14px;border:2px solid var(--border);border-radius:3px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all .2s}
.soc-task.done .soc-check{background:var(--green);border-color:var(--green);color:#fff}
.soc-task-label{flex:1;line-height:1.3}
.soc-plat-icon{width:14px;height:14px;border-radius:3px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;color:#fff}
.soc-plat-icon.li{background:var(--blue)}
.soc-plat-icon.fb{background:var(--purple)}
.soc-plat-icon.ig{background:var(--orange)}
.soc-plat-icon.nd{background:var(--green)}
.soc-week-nav{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.soc-week-nav button{background:none;border:1px solid var(--border);color:var(--text-2);border-radius:6px;padding:4px 10px;cursor:pointer;font-family:inherit;font-size:12px}
.soc-week-nav button:hover{background:var(--surface-3);color:var(--text)}
.soc-week-nav span{font-size:13px;font-weight:600}
.soc-streak{display:flex;gap:8px;margin-bottom:16px}
.soc-streak-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 16px;text-align:center;flex:1}
.soc-streak-val{font-size:22px;font-weight:800}
.soc-streak-lbl{font-size:10px;color:var(--text-2);text-transform:uppercase;margin-top:2px}
.social-filters{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.social-filter{padding:6px 14px;border-radius:16px;font-size:12px;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--text-2);cursor:pointer;font-family:inherit;transition:all .2s}
.social-filter:hover{border-color:var(--text-3);color:var(--text)}
.social-filter.active{background:var(--green);border-color:var(--green);color:#fff}
.social-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden}
.social-card-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;cursor:pointer}
.social-card-head:hover{background:var(--surface-3)}
.social-card-title{font-size:13px;font-weight:700}
.social-card-platforms{display:flex;gap:4px}
.social-plat{padding:2px 8px;border-radius:10px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.social-plat-li{background:rgba(33,150,243,.12);color:var(--blue)}
.social-plat-fb{background:rgba(156,39,176,.12);color:var(--purple)}
.social-plat-ig{background:rgba(255,112,67,.12);color:var(--orange)}
.social-plat-nd{background:rgba(76,175,80,.12);color:var(--green)}
.social-plat-r{background:rgba(255,112,67,.12);color:var(--orange)}
.social-card-body{display:none;padding:16px}
.social-card.open .social-card-body{display:block}
.social-card.open .social-card-head{background:var(--surface-2)}
.social-post-text{font-size:13px;line-height:1.7;white-space:pre-wrap;padding:12px 14px;background:var(--bg);border:1px solid var(--border);border-radius:6px;margin-bottom:10px;color:var(--text)}
.social-copy-bar{display:flex;gap:6px;justify-content:flex-end}
.social-img-hint{font-size:11px;color:var(--teal);margin-bottom:8px;padding:6px 10px;background:rgba(0,188,212,.06);border-radius:6px}
.soc-engage-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;font-size:12px}
.soc-engage-row .eng-date{font-size:11px;color:var(--text-3);width:70px}
.soc-engage-row .eng-plat{width:20px}
.soc-engage-row .eng-type{font-weight:600;width:100px}
.soc-engage-row .eng-detail{flex:1;color:var(--text-2)}
.soc-engage-row .eng-result{font-weight:600}
.soc-strategy{margin-top:16px}
.soc-strategy-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px}
.soc-strategy-card h4{font-size:13px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.soc-strategy-card p,.soc-strategy-card li{font-size:12px;color:var(--text-2);line-height:1.6}
.soc-strategy-card ul{padding-left:16px;margin:0}

/* Searchable dropdown */
.search-select{position:relative}
.search-select input{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:inherit;font-size:13px}
.search-select input:focus{outline:none;border-color:var(--green)}
.search-select-list{position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 7px 7px;z-index:50;display:none}
.search-select.open .search-select-list{display:block}
.search-select-item{padding:8px 12px;font-size:12px;cursor:pointer;transition:background .15s}
.search-select-item:hover,.search-select-item.highlighted{background:var(--surface-3)}
.search-select-item .ss-company{font-weight:600}
.search-select-item .ss-owner{color:var(--text-2);font-size:11px;margin-left:6px}
.search-select-item .ss-stage{float:right;font-size:10px;color:var(--text-3)}
.search-select-none{padding:12px;font-size:12px;color:var(--text-3);text-align:center}

/* Template tracking */
.tpl-track-section{margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.tpl-stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:16px}
.tpl-stat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 14px}
.tpl-stat-name{font-size:12px;font-weight:600;margin-bottom:6px}
.tpl-stat-row{display:flex;justify-content:space-between;font-size:11px;color:var(--text-2);margin-top:2px}
.tpl-stat-row strong{color:var(--text)}
.tpl-send-log{font-size:12px}
.tpl-send-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:4px}
.tpl-send-row .send-date{font-size:11px;color:var(--text-3);width:80px}
.tpl-send-row .send-tpl{font-weight:600;flex:1}
.tpl-send-row .send-contact{color:var(--text-2);flex:1}
.tpl-reply-badge{display:inline-block;padding:1px 6px;border-radius:10px;font-size:9px;font-weight:700;text-transform:uppercase}
.tpl-reply-badge.replied{background:rgba(76,175,80,.12);color:var(--green)}
.tpl-reply-badge.no-reply{background:rgba(104,104,128,.12);color:var(--text-3)}

/* Batch send */
.batch-contact-list{max-height:340px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;margin-top:10px}
.batch-contact-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid rgba(42,42,74,.3);font-size:12px;cursor:pointer;transition:background .15s}
.batch-contact-item:last-child{border-bottom:none}
.batch-contact-item:hover{background:var(--surface-3)}
.batch-contact-item.selected{background:rgba(76,175,80,.06)}
.batch-contact-item.no-email{opacity:.4;cursor:default}
.batch-contact-item input[type="checkbox"]{accent-color:var(--green);width:15px;height:15px;cursor:pointer;flex-shrink:0}
.batch-contact-item .bc-name{font-weight:600;flex:1}
.batch-contact-item .bc-email{color:var(--text-2);font-size:11px}
.batch-contact-item .bc-stage{font-size:10px}
.batch-progress{margin-bottom:16px}
.batch-progress-bar{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:6px}
.batch-progress-fill{height:100%;background:var(--green);border-radius:4px;transition:width .4s ease}
.batch-progress-text{font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.batch-current{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px}
.batch-current-name{font-size:16px;font-weight:700;margin-bottom:4px}
.batch-current-email{font-size:12px;color:var(--text-2);margin-bottom:10px}
.batch-current-preview{font-size:12px;line-height:1.6;color:var(--text);white-space:pre-wrap;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;max-height:200px;overflow-y:auto;margin-bottom:12px}
.batch-current-subj{font-size:12px;font-weight:600;color:var(--green);margin-bottom:6px}
.batch-actions{display:flex;gap:8px;justify-content:center}
.batch-done-screen{text-align:center;padding:32px 16px}
.batch-done-screen .done-icon{font-size:48px;margin-bottom:12px}
.batch-done-screen .done-text{font-size:18px;font-weight:700;margin-bottom:8px}
.batch-done-screen .done-sub{font-size:13px;color:var(--text-2)}
.batch-wizard-steps{display:flex;gap:0;margin-bottom:20px}
.batch-step-dot{flex:1;text-align:center;padding:8px 0;font-size:11px;font-weight:700;color:var(--text-3);border-bottom:2px solid var(--border);transition:all .2s}
.batch-step-dot.active{color:var(--green);border-bottom-color:var(--green)}
.batch-step-dot.done{color:var(--text-2);border-bottom-color:var(--text-2)}
.batch-select-bar{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.batch-select-bar input[type="text"]{flex:1;padding:7px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:inherit;font-size:12px}
.batch-select-bar input:focus{outline:none;border-color:var(--green)}
.batch-count{font-size:12px;color:var(--text-2);margin-top:6px}

/* Chat panel */
.chat-fab{position:fixed;bottom:24px;right:24px;width:52px;height:52px;border-radius:50%;background:var(--green);color:#fff;border:none;cursor:pointer;z-index:400;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.4);transition:transform .2s}
.chat-fab:hover{transform:scale(1.08)}
.chat-fab svg{width:24px;height:24px}
.chat-panel{position:fixed;top:0;right:-420px;width:420px;height:100vh;background:var(--surface);border-left:1px solid var(--border);z-index:450;display:flex;flex-direction:column;transition:right .3s ease}
.chat-panel.open{right:0}
.chat-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.chat-header h3{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px}
.chat-header h3 span{font-size:10px;color:var(--text-3);font-weight:500}
.chat-header-btns{display:flex;gap:4px}
.chat-header-btns button{background:none;border:none;color:var(--text-2);cursor:pointer;padding:4px 6px;border-radius:4px;font-size:13px}
.chat-header-btns button:hover{color:var(--text);background:var(--surface-3)}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
.chat-msg{max-width:90%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5;white-space:pre-wrap;word-wrap:break-word}
.chat-msg.user{align-self:flex-end;background:var(--green);color:#fff;border-bottom-right-radius:4px}
.chat-msg.assistant{align-self:flex-start;background:var(--surface-2);border:1px solid var(--border);color:var(--text);border-bottom-left-radius:4px}
.chat-msg.system{align-self:center;background:transparent;color:var(--text-3);font-size:11px;text-align:center;padding:4px}
.chat-msg.assistant strong{color:var(--green)}
.chat-msg.assistant code{background:var(--bg);padding:1px 5px;border-radius:3px;font-size:12px}
.chat-typing{align-self:flex-start;padding:10px 14px;font-size:13px;color:var(--text-3)}
.chat-typing span{animation:blink 1.4s infinite both}
.chat-typing span:nth-child(2){animation-delay:.2s}
.chat-typing span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
.chat-input-area{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px}
.chat-input-area textarea{flex:1;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:13px;resize:none;min-height:40px;max-height:120px}
.chat-input-area textarea:focus{outline:none;border-color:var(--green)}
.chat-input-area button{background:var(--green);color:#fff;border:none;border-radius:8px;padding:0 14px;cursor:pointer;font-size:14px;flex-shrink:0}
.chat-input-area button:hover{background:var(--green-dark)}
.chat-input-area button:disabled{opacity:.4;cursor:default}
.chat-key-setup{padding:24px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px}
.chat-key-setup p{font-size:13px;color:var(--text-2);max-width:300px}
.chat-key-setup input{width:100%;max-width:300px;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:inherit;font-size:13px}
.chat-key-setup input:focus{outline:none;border-color:var(--green)}
.chat-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:440;display:none}
.chat-overlay.open{display:block}

/* Import */
.import-drop{border:2px dashed var(--border);border-radius:10px;padding:32px;text-align:center;cursor:pointer;transition:border-color .2s;margin-bottom:14px}
.import-drop:hover,.import-drop.dragover{border-color:var(--green);background:rgba(76,175,80,.04)}
.import-drop p{color:var(--text-2);font-size:13px;margin-bottom:4px}
.import-drop .hint{font-size:11px;color:var(--text-3)}
.import-preview{max-height:300px;overflow-y:auto;margin-bottom:14px}
.import-preview table{width:100%;border-collapse:collapse;font-size:12px}
.import-preview th{text-align:left;padding:6px 8px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text-2);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface)}
.import-preview td{padding:6px 8px;border-bottom:1px solid rgba(42,42,74,.3);color:var(--text)}
.import-preview tr:hover td{background:var(--surface-3)}
.import-map{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:14px}
.import-map label{font-size:11px;font-weight:600;color:var(--text-2);margin-bottom:2px;display:block}
.import-map select{width:100%;padding:5px 8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:inherit;font-size:12px}
.import-stats{display:flex;gap:16px;margin-bottom:10px;font-size:13px}
.import-stats span{color:var(--text-2)}
.import-stats strong{color:var(--green)}

/* Employee contacts */
.emp-section{margin-top:14px;border-top:1px solid var(--border);padding-top:14px}
.emp-section h4{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between}
.emp-list{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.emp-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;font-size:12px}
.emp-row .emp-name{font-weight:600;min-width:100px}
.emp-row .emp-role{color:var(--text-2);min-width:80px}
.emp-row .emp-lang{color:var(--teal);font-size:10px;font-weight:600;text-transform:uppercase}
.emp-row .emp-phone{color:var(--text-2);margin-left:auto}
.emp-row .emp-del{background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;padding:0 4px;opacity:.6}
.emp-row .emp-del:hover{opacity:1}
.emp-add-form{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.emp-add-form input,.emp-add-form select{padding:6px 8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:inherit;font-size:12px}
.emp-add-form input:focus,.emp-add-form select:focus{outline:none;border-color:var(--green)}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:500;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;width:92%;max-width:550px;max-height:90vh;overflow-y:auto}
.modal h3{font-size:16px;margin-bottom:16px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

/* Progress bar */
.prog{width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:6px}
.prog-fill{height:100%;border-radius:3px;transition:width .4s ease}

/* Table */
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th{text-align:left;padding:8px 10px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-2);border-bottom:1px solid var(--border)}
.tbl td{padding:10px;border-bottom:1px solid rgba(42,42,74,.4);vertical-align:top}
.tbl tr:hover td{background:var(--surface-3)}
.tbl .company{font-weight:600;font-size:14px}
.tbl .owner{color:var(--text-2);font-size:12px}
.tbl .meta{color:var(--text-3);font-size:11px}
.tbl .copyable{cursor:pointer;position:relative;user-select:all;color:var(--text-2);transition:color .2s}
.tbl .copyable:hover{color:var(--green)}
.copied-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;padding:6px 16px;border-radius:6px;font-size:12px;font-weight:600;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none}

/* Pipeline kanban */
.pipeline{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;overflow-x:auto;min-height:400px}
.pipe-col{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px;min-width:160px}
.pipe-col-head{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.pipe-col-count{background:var(--border);border-radius:10px;padding:1px 8px;font-size:10px}
.pipe-card{background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:6px;cursor:pointer;transition:border-color .2s}
.pipe-card:hover{border-color:var(--border-light)}
.pipe-card-company{font-size:13px;font-weight:600;margin-bottom:2px}
.pipe-card-owner{font-size:11px;color:var(--text-2);margin-bottom:4px}
.pipe-card-crew{font-size:11px;color:var(--text-3)}
.pipe-card-rev{font-size:11px;font-weight:600;color:var(--green);margin-top:4px}

/* Activity log */
.activity-targets{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:20px}
.target-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center}
.target-current{font-size:24px;font-weight:800}
.target-goal{font-size:12px;color:var(--text-2)}
.target-label{font-size:11px;color:var(--text-3);text-transform:uppercase;margin-top:4px}

.activity-row{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:13px}
.activity-type{width:80px;flex-shrink:0}
.activity-notes{flex:1;color:var(--text-2);font-size:12px}
.activity-count{font-weight:700;width:40px;text-align:right}
.activity-date{font-size:11px;color:var(--text-3);width:90px}

/* Roadmap */
.roadmap-month{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px}
.roadmap-month h3{font-size:14px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.roadmap-item{display:flex;align-items:center;gap:10px;padding:6px 0;font-size:13px}
.roadmap-check{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;flex-shrink:0;font-size:11px;color:transparent}
.roadmap-check.done{border-color:var(--green);background:var(--green);color:#fff}

/* Follow-up list */
.followup-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg);border-radius:8px;margin-bottom:4px;font-size:13px}
.followup-item.overdue{border-left:3px solid var(--red)}
.followup-item.today{border-left:3px solid var(--gold)}
.followup-item.upcoming{border-left:3px solid var(--blue)}

/* Client card */
.client-row{display:flex;align-items:center;gap:14px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px}
.client-name{font-weight:600;font-size:14px}
.client-owner{font-size:12px;color:var(--text-2)}
.client-rev{font-weight:700;color:var(--green);font-size:15px;margin-left:auto}

/* Search */
.search-bar{display:flex;gap:8px;margin-bottom:16px}
.search-bar input{flex:1}
.search-bar select{width:150px}

/* Responsive */
@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .mobile-toggle{display:flex}
  .main{margin-left:0;padding:20px 14px;padding-top:64px}
  .pipeline{grid-template-columns:1fr 1fr;gap:6px}
  .form-row,.form-row-3{grid-template-columns:1fr}
  .kpi-grid{grid-template-columns:1fr 1fr}
}
@media(max-width:600px){
  .pipeline{grid-template-columns:1fr}
  .kpi-grid{grid-template-columns:1fr}
}

::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* Streak */
.streak-box{background:linear-gradient(135deg,#1a2a1a,#12121f);border:1px solid var(--green-dark);border-radius:10px;padding:16px;display:flex;align-items:center;gap:16px;margin-bottom:14px}
.streak-fire{font-size:36px}
.streak-num{font-size:38px;font-weight:800;color:var(--green)}
.streak-label{font-size:12px;color:var(--text-2)}
.streak-zero .streak-num{color:var(--red)}
.streak-zero{border-color:var(--red)}

/* Funnel */
.funnel{max-width:600px;margin:0 auto 24px}
.funnel-step{display:flex;align-items:center;margin-bottom:2px}
.funnel-bar{height:38px;border-radius:6px;display:flex;align-items:center;padding:0 14px;font-size:12px;font-weight:600;color:#fff;min-width:40px;transition:width .4s}
.funnel-meta{margin-left:12px;font-size:12px;color:var(--text-2)}
.funnel-pct{font-weight:700;margin-left:4px}

/* Weekly review */
.review-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:10px}
.review-week{font-size:14px;font-weight:700;margin-bottom:6px}
.review-stats{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:10px}
.review-stat{font-size:12px;color:var(--text-2)}
.review-stat strong{color:var(--text);font-size:14px}
.review-text{font-size:13px;color:var(--text-2);line-height:1.5}
.review-score{font-size:28px;font-weight:800;margin-right:12px;flex-shrink:0;width:60px;text-align:center}

/* Win/Loss */
.wl-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:8px}
.wl-reason{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;margin-right:6px}

/* Health indicator */
.health-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.health-good{background:var(--green)}
.health-warning{background:var(--gold)}
.health-risk{background:var(--red)}

/* Analytics */
.analytics-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:12px}
.analytics-bar-label{width:100px;color:var(--text-2);flex-shrink:0}
.analytics-bar-track{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden}
.analytics-bar-fill{height:100%;border-radius:4px;transition:width .4s}
.analytics-bar-val{width:60px;text-align:right;font-weight:600;flex-shrink:0}
.analytics-metric{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(42,42,74,.4);font-size:13px}
.analytics-metric:last-child{border-bottom:none}
.analytics-metric-label{color:var(--text-2)}
.analytics-metric-val{font-weight:700;font-size:15px}

/* Onboarding */
.ob-client{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px}
.ob-client-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;cursor:pointer}
.ob-client-head h3{font-size:14px;font-weight:600}
.ob-steps{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px}
.ob-step{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border-radius:6px;font-size:12px;cursor:pointer;transition:all .2s}
.ob-step:hover{background:var(--surface-3)}
.ob-step.done{opacity:.6;text-decoration:line-through}
.ob-check{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;color:transparent;flex-shrink:0;transition:all .2s}
.ob-check.done{border-color:var(--green);background:var(--green);color:#fff}
.ob-delivery{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px}
.ob-month{text-align:center;padding:10px 6px;background:var(--bg);border-radius:6px;font-size:11px;cursor:pointer;transition:all .2s;border:1px solid transparent}
.ob-month:hover{border-color:var(--border-light)}
.ob-month.delivered{border-color:var(--green);background:rgba(76,175,80,.06)}
.ob-month.scheduled{border-color:var(--gold);background:rgba(212,147,13,.06)}
.ob-month-label{font-weight:600;margin-bottom:2px}

/* Script cards */
.script-section{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:12px}
.script-section h3{font-size:14px;font-weight:700;margin-bottom:10px;color:var(--green)}
.script-block{background:var(--bg);border-radius:8px;padding:14px;margin-bottom:8px;font-size:13px;line-height:1.6;color:var(--text-2)}
.script-block strong{color:var(--text)}
.objection-card{background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px;cursor:pointer;transition:all .2s}
.objection-card:hover{border-color:var(--border-light)}
.objection-q{font-size:13px;font-weight:600;color:var(--red);margin-bottom:6px}
.objection-a{font-size:12px;color:var(--text-2);line-height:1.5;display:none}
.objection-card.open .objection-a{display:block}

/* Proposal */
.proposal-preview{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:24px;font-size:13px;line-height:1.6}
.proposal-preview h2{font-size:18px;color:var(--green);margin-bottom:4px}
.proposal-preview .price-box{background:var(--surface);border:1px solid var(--green);border-radius:8px;padding:16px;text-align:center;margin:16px 0}
.proposal-preview .price-big{font-size:32px;font-weight:800;color:var(--green)}
.proposal-preview .price-sub{font-size:12px;color:var(--text-2)}
.proposal-saved{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:13px}

/* Campaign tracker */
.camp-row{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:13px}
.camp-row:hover{border-color:var(--border-light)}
.camp-step-dots{display:flex;gap:4px}
.camp-dot{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;border:2px solid var(--border);color:var(--text-3);transition:all .2s}
.camp-dot.sent{border-color:var(--green);background:var(--green);color:#fff}
.camp-dot.current{border-color:var(--gold);background:rgba(212,147,13,.2);color:var(--gold)}

/* Battle Plan */
.bp-section{margin-bottom:20px}
.bp-section-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-3);margin-bottom:8px;display:flex;align-items:center;gap:8px}
.bp-section-title .bp-count{background:var(--green);color:#fff;font-size:10px;padding:1px 7px;border-radius:10px}
.bp-task{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:4px;font-size:13px;cursor:pointer;transition:all .2s}
.bp-task:hover{border-color:var(--border-light)}
.bp-task.done{opacity:.5;text-decoration:line-through}
.bp-task .bp-check{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;font-size:11px}
.bp-task.done .bp-check{border-color:var(--green);background:var(--green);color:#fff}
.bp-task .bp-tag{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600;margin-left:auto;flex-shrink:0}
.bp-tag-overdue{background:rgba(239,68,68,.15);color:var(--red)}
.bp-tag-followup{background:rgba(33,150,243,.15);color:var(--blue)}
.bp-tag-pipeline{background:rgba(156,39,176,.15);color:var(--purple)}
.bp-tag-outreach{background:rgba(76,175,80,.15);color:var(--green)}
.bp-tag-custom{background:rgba(255,112,67,.15);color:var(--orange)}
.bp-score{display:flex;align-items:center;gap:16px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:16px}
.bp-score-ring{position:relative;width:64px;height:64px;flex-shrink:0}
.bp-score-ring svg{transform:rotate(-90deg)}
.bp-score-pct{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800}
.bp-add-row{display:flex;gap:8px;margin-top:8px}
.bp-add-row input{flex:1}

/* Time Audit */
.ta-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:16px}
.ta-cat{padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;text-align:center;cursor:pointer;transition:all .2s}
.ta-cat:hover{border-color:var(--green)}
.ta-cat.active{border-color:var(--green);background:rgba(76,175,80,.08)}
.ta-cat-icon{font-size:20px;margin-bottom:4px}
.ta-cat-name{font-size:11px;font-weight:600;color:var(--text-2)}
.ta-cat-time{font-size:16px;font-weight:800;color:var(--text);margin-top:2px}
.ta-timer{display:flex;align-items:center;gap:16px;padding:16px;background:var(--surface);border:1px solid var(--green);border-radius:10px;margin-bottom:16px}
.ta-timer-display{font-size:32px;font-weight:800;font-variant-numeric:tabular-nums;color:var(--green)}
.ta-timer-cat{font-size:13px;color:var(--text-2)}
.ta-bar{height:24px;border-radius:6px;overflow:hidden;display:flex;margin-bottom:8px}
.ta-bar-seg{height:100%;transition:width .3s}
.ta-history-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;font-size:12px}

/* Vision Board */
.vb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.vb-card{padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;transition:all .2s;position:relative}
.vb-card:hover{border-color:var(--border-light);transform:translateY(-2px)}
.vb-card-cat{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.vb-card h3{font-size:15px;font-weight:700;margin-bottom:4px}
.vb-card p{font-size:12px;color:var(--text-2);line-height:1.5}
.vb-card .vb-target{font-size:11px;color:var(--text-3);margin-top:8px}
.vb-card .vb-actions{position:absolute;top:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity .2s}
.vb-card:hover .vb-actions{opacity:1}
.vb-quote{padding:20px;background:linear-gradient(135deg,rgba(76,175,80,.08),rgba(33,150,243,.08));border:1px solid var(--border);border-radius:10px;text-align:center;font-size:16px;font-style:italic;color:var(--text);line-height:1.6;margin-bottom:12px}
.vb-quote-author{font-size:12px;color:var(--text-2);font-style:normal;margin-top:6px}

/* Milestone Countdown */
.ms-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
.ms-card{padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;position:relative;overflow:hidden}
.ms-card.achieved{border-color:var(--green);background:rgba(76,175,80,.06)}
.ms-card .ms-progress-bg{position:absolute;bottom:0;left:0;height:4px;background:var(--border);width:100%}
.ms-card .ms-progress-fill{height:4px;background:var(--green);transition:width .5s}
.ms-card .ms-emoji{font-size:28px;margin-bottom:6px}
.ms-card h3{font-size:14px;font-weight:700;margin-bottom:2px}
.ms-card .ms-sub{font-size:12px;color:var(--text-2)}
.ms-card .ms-number{font-size:28px;font-weight:800;color:var(--green);margin-top:6px}
.ms-card .ms-remaining{font-size:11px;color:var(--text-3);margin-top:2px}
.ms-card.achieved .ms-number{color:var(--green)}
.ms-card.achieved::after{content:'';position:absolute;top:8px;right:8px;width:20px;height:20px;background:var(--green);border-radius:50%;display:flex;align-items:center;justify-content:center}
.ms-topline{display:flex;gap:12px;margin-bottom:16px}
.ms-topline .ms-bigstat{flex:1;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;text-align:center}
.ms-bigstat-num{font-size:32px;font-weight:800;color:var(--green)}
.ms-bigstat-label{font-size:11px;color:var(--text-2);margin-top:2px}

/* Decision Journal */
.dj-card{padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all .2s}
.dj-card:hover{border-color:var(--border-light)}
.dj-card-header{display:flex;justify-content:space-between;align-items:flex-start}
.dj-card h3{font-size:14px;font-weight:700}
.dj-card .dj-date{font-size:11px;color:var(--text-3)}
.dj-card .dj-context{font-size:12px;color:var(--text-2);margin-top:6px;line-height:1.5}
.dj-card .dj-detail{display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.dj-card.expanded .dj-detail{display:block}
.dj-card .dj-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-3);margin-bottom:4px;margin-top:8px}
.dj-card .dj-text{font-size:12px;color:var(--text-2);line-height:1.5}
.dj-outcome{display:inline-block;font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.dj-outcome-good{background:rgba(76,175,80,.15);color:var(--green)}
.dj-outcome-bad{background:rgba(239,68,68,.15);color:var(--red)}
.dj-outcome-pending{background:rgba(212,147,13,.15);color:var(--gold)}

/* CEO Review */
.ceo-card{padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px}
.ceo-card h3{font-size:14px;font-weight:700;margin-bottom:2px}
.ceo-card .ceo-date{font-size:11px;color:var(--text-3);margin-bottom:10px}
.ceo-grade{display:inline-block;font-size:20px;font-weight:800;padding:4px 14px;border-radius:8px;margin-bottom:10px}
.ceo-grade-A{background:rgba(76,175,80,.15);color:var(--green)}
.ceo-grade-B{background:rgba(33,150,243,.15);color:var(--blue)}
.ceo-grade-C{background:rgba(212,147,13,.15);color:var(--gold)}
.ceo-grade-D{background:rgba(255,112,67,.15);color:var(--orange)}
.ceo-grade-F{background:rgba(239,68,68,.15);color:var(--red)}
.ceo-section{margin-bottom:8px}
.ceo-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-3);margin-bottom:4px}
.ceo-section-text{font-size:12px;color:var(--text-2);line-height:1.5;white-space:pre-line}

/* Idea Capture */
.idea-card{padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;position:relative;transition:all .2s}
.idea-card:hover{border-color:var(--border-light)}
.idea-card h3{font-size:14px;font-weight:600}
.idea-card p{font-size:12px;color:var(--text-2);line-height:1.5;margin-top:4px}
.idea-card .idea-meta{display:flex;align-items:center;gap:8px;margin-top:6px;font-size:11px;color:var(--text-3)}
.idea-card .idea-actions{position:absolute;top:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity .2s}
.idea-card:hover .idea-actions{opacity:1}
.idea-priority{display:inline-block;font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.idea-priority-high{background:rgba(239,68,68,.15);color:var(--red)}
.idea-priority-medium{background:rgba(212,147,13,.15);color:var(--gold)}
.idea-priority-low{background:rgba(33,150,243,.15);color:var(--blue)}
.idea-cats{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.idea-cat-btn{padding:4px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text-2);font-size:12px;cursor:pointer;transition:all .2s}
.idea-cat-btn.active{border-color:var(--green);color:var(--green);background:rgba(76,175,80,.08)}

/* Client Results */
.cr-card{padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;position:relative}
.cr-card:hover{border-color:var(--border-light)}
.cr-card h3{font-size:14px;font-weight:600}
.cr-card .cr-client{font-size:12px;color:var(--green);font-weight:600;margin-top:2px}
.cr-card .cr-desc{font-size:12px;color:var(--text-2);line-height:1.5;margin-top:4px}
.cr-card .cr-meta{font-size:11px;color:var(--text-3);margin-top:6px;display:flex;gap:12px}
.cr-card .cr-actions{position:absolute;top:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity .2s}
.cr-card:hover .cr-actions{opacity:1}
.cr-highlight{padding:16px;background:linear-gradient(135deg,rgba(76,175,80,.08),rgba(212,147,13,.06));border:1px solid var(--green);border-radius:10px;text-align:center;margin-bottom:16px}
.cr-highlight .cr-big{font-size:32px;font-weight:800;color:var(--green)}
.cr-highlight .cr-sub{font-size:12px;color:var(--text-2);margin-top:2px}

/* Mentor Log */
.ml-card{padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;cursor:pointer;transition:all .2s}
.ml-card:hover{border-color:var(--border-light)}
.ml-card h3{font-size:14px;font-weight:600}
.ml-card .ml-role{font-size:12px;color:var(--green);font-weight:500}
.ml-card .ml-topic{font-size:12px;color:var(--text-2);margin-top:4px}
.ml-card .ml-detail{display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.ml-card.expanded .ml-detail{display:block}
.ml-card .ml-takeaway{font-size:12px;color:var(--text-2);line-height:1.5}
.ml-card .ml-next{font-size:12px;color:var(--gold);margin-top:6px;font-weight:500}
.ml-card .ml-date{font-size:11px;color:var(--text-3);margin-top:4px}
.ml-card .ml-actions{position:absolute;top:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity .2s}
.ml-card:hover .ml-actions{opacity:1}
.ml-card{position:relative}

/* Quick Email */
.qe-contact{padding:12px 16px;background:var(--surface-2);border-radius:8px;margin-bottom:12px;display:flex;align-items:center;gap:12px}
.qe-contact-name{font-size:15px;font-weight:700}
.qe-contact-company{font-size:12px;color:var(--text-2)}
.qe-tabs{display:flex;gap:4px;margin-bottom:12px}
.qe-tab{padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-2);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.qe-tab.active{border-color:var(--green);color:var(--green);background:rgba(76,175,80,.08)}
.qe-card{padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .2s}
.qe-card:hover{border-color:var(--border-light)}
.qe-card.selected{border-color:var(--green);background:rgba(76,175,80,.04)}
.qe-card-title{font-size:13px;font-weight:600;margin-bottom:2px}
.qe-card-timing{font-size:11px;color:var(--text-3)}
.qe-preview{margin-top:12px;padding:16px;background:var(--bg);border:1px solid var(--border);border-radius:8px}
.qe-preview-subject{font-size:13px;font-weight:600;color:var(--green);margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.qe-preview-body{font-size:12px;color:var(--text-2);line-height:1.6;white-space:pre-line;max-height:300px;overflow-y:auto}
.qe-copy-bar{display:flex;gap:8px;margin-top:12px}
</style>
</head>
<body>

<button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">&#9776;</button>

<aside class="sidebar">
  <div class="sidebar-brand">
    <h1>CREW VOICE HQ</h1>
    <p>Command Center</p>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-item active" data-view="dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </div>
    <div class="nav-divider"></div>
    <div class="nav-label">Sales</div>
    <div class="nav-item" data-view="contacts">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      Contacts / CRM
    </div>
    <div class="nav-item" data-view="pipeline">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="6" height="18" rx="1"/><rect x="9" y="8" width="6" height="13" rx="1"/><rect x="17" y="1" width="6" height="20" rx="1"/></svg>
      Pipeline
    </div>
    <div class="nav-item" data-view="activity">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Activity Log
    </div>
    <div class="nav-divider"></div>
    <div class="nav-label">Business</div>
    <div class="nav-item" data-view="revenue">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      Revenue
    </div>
    <div class="nav-item" data-view="clients">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      Active Clients
    </div>
    <div class="nav-item" data-view="roadmap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
      50-Client Roadmap
    </div>
    <div class="nav-divider"></div>
    <div class="nav-label">Intelligence</div>
    <div class="nav-item" data-view="winloss">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 00-6 0v4"/><rect x="2" y="9" width="20" height="12" rx="2"/><circle cx="12" cy="15" r="2"/></svg>
      Win / Loss
    </div>
    <div class="nav-item" data-view="weekly">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Weekly Review
    </div>
    <div class="nav-item" data-view="analytics">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 118 2.83"/><path d="M22 12A10 10 0 0012 2v10z"/></svg>
      Analytics
    </div>
    <div class="nav-divider"></div>
    <div class="nav-label">Operations</div>
    <div class="nav-item" data-view="onboarding">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
      Onboarding
    </div>
    <div class="nav-item" data-view="scripts">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Sales Scripts
    </div>
    <div class="nav-item" data-view="proposals">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
      Proposals
    </div>
    <div class="nav-item" data-view="campaigns">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      Campaigns
    </div>
    <div class="nav-divider"></div>
    <div class="nav-label">Outreach</div>
    <div class="nav-item" data-view="templates">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>
      Email Templates
    </div>
    <div class="nav-item" data-view="social">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg>
      Social Media
    </div>
    <div class="nav-divider"></div>
    <div class="nav-label">Command Center</div>
    <div class="nav-item" data-view="battleplan">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Daily Battle Plan
    </div>
    <div class="nav-item" data-view="timeaudit">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Time Audit
    </div>
    <div class="nav-item" data-view="milestones">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
      Milestones
    </div>
    <div class="nav-divider"></div>
    <div class="nav-label">Strategy</div>
    <div class="nav-item" data-view="vision">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/></svg>
      Vision Board
    </div>
    <div class="nav-item" data-view="decisions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      Decision Journal
    </div>
    <div class="nav-item" data-view="ceoreview">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      Weekly CEO Review
    </div>
    <div class="nav-divider"></div>
    <div class="nav-label">Growth</div>
    <div class="nav-item" data-view="ideas">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.674M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
      Idea Capture
    </div>
    <div class="nav-item" data-view="results">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
      Client Results
    </div>
    <div class="nav-item" data-view="mentors">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      Mentor Log
    </div>
  </nav>
  <div style="padding:12px 16px;border-top:1px solid var(--border)">
    <div style="font-size:10px;font-weight:700;color:var(--text-2);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Backup</div>
    <button onclick="exportData()" style="width:100%;padding:8px;margin-bottom:6px;border-radius:8px;border:1px solid var(--border);background:var(--surface-3);color:var(--text);font-size:12px;font-weight:600;cursor:pointer">&#11123; Export Backup</button>
    <button onclick="document.getElementById('importFile').click()" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--surface-3);color:var(--text);font-size:12px;font-weight:600;cursor:pointer">&#11121; Import Backup</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
  </div>
</aside>

<main class="main">

  <!-- DASHBOARD -->
  <div id="view-dashboard" class="view active">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div>
        <h1 class="page-title" style="margin-bottom:2px" id="dash-greet"></h1>
        <p style="font-size:13px;color:var(--text-2)" id="dash-date"></p>
      </div>
      <button class="btn btn-primary" onclick="openContactModal()">+ New Contact</button>
    </div>
    <div id="dash-streak"></div>
    <div class="kpi-grid" id="dash-kpis"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
      <div class="card">
        <div class="card-head"><h2>Follow-ups Due</h2></div>
        <div id="dash-followups"></div>
      </div>
      <div class="card">
        <div class="card-head"><h2>Today's Outreach</h2></div>
        <div id="dash-outreach"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-head">
        <h2>50-Client Goal Progress</h2>
        <span id="dash-goal-pct" style="font-weight:700;color:var(--green)"></span>
      </div>
      <div class="prog" style="height:12px">
        <div class="prog-fill" id="dash-goal-bar" style="background:var(--green)"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:12px;color:var(--text-2)">
        <span id="dash-goal-clients"></span>
        <span id="dash-goal-deadline"></span>
      </div>
    </div>
  </div>

  <!-- CONTACTS -->
  <div id="view-contacts" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Contacts / CRM</h1>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="openImportModal()">Import CSV</button>
        <button class="btn btn-primary" onclick="openContactModal()">+ Add Contact</button>
      </div>
    </div>
    <div class="search-bar">
      <input type="text" class="form-control" id="contact-search" placeholder="Search companies, names..." oninput="renderContacts()">
      <select class="form-control" id="contact-filter-status" onchange="renderContacts()">
        <option value="all">All Stages</option>
        <option value="Lead">Lead</option>
        <option value="Contacted">Contacted</option>
        <option value="Replied">Replied</option>
        <option value="Call Scheduled">Call Scheduled</option>
        <option value="Proposal Sent">Proposal Sent</option>
        <option value="Closed">Closed</option>
        <option value="Lost">Lost</option>
        <option value="Churned">Churned</option>
        <option value="Bad Email">&#128681; Bad Email</option>
      </select>
      <select class="form-control" id="contact-filter-source" onchange="renderContacts()" style="width:140px">
        <option value="all">All Sources</option>
        <option value="Cold Email">Cold Email</option>
        <option value="LinkedIn">LinkedIn</option>
        <option value="Referral">Referral</option>
        <option value="Facebook Group">Facebook</option>
        <option value="Website">Website</option>
        <option value="NALP Event">NALP Event</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div id="contacts-table"></div>
  </div>

  <!-- PIPELINE -->
  <div id="view-pipeline" class="view">
    <h1 class="page-title">Sales Pipeline</h1>
    <div class="card" style="margin-bottom:20px">
      <div class="card-head"><h2>Conversion Funnel</h2></div>
      <div class="funnel" id="pipeline-funnel"></div>
    </div>
    <div class="pipeline" id="pipeline-board"></div>
  </div>

  <!-- ACTIVITY -->
  <div id="view-activity" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Activity Log</h1>
      <button class="btn btn-primary" onclick="openActivityModal()">+ Log Activity</button>
    </div>
    <div class="section-label">Today's Targets</div>
    <div class="activity-targets" id="activity-targets"></div>
    <div class="section-label" style="margin-top:20px">Recent Activity</div>
    <div id="activity-list"></div>
  </div>

  <!-- REVENUE -->
  <div id="view-revenue" class="view">
    <h1 class="page-title">Revenue</h1>
    <div class="kpi-grid" id="revenue-kpis"></div>
    <div class="card">
      <div class="card-head"><h2>MRR Goal Tracker</h2></div>
      <div id="revenue-goal"></div>
    </div>
    <div class="card" style="margin-top:14px">
      <div class="card-head"><h2>Revenue by Client</h2></div>
      <div id="revenue-clients"></div>
    </div>
  </div>

  <!-- CLIENTS -->
  <div id="view-clients" class="view">
    <h1 class="page-title">Active Clients</h1>
    <div id="clients-list"></div>
  </div>

  <!-- WIN/LOSS -->
  <div id="view-winloss" class="view">
    <h1 class="page-title">Win / Loss Analysis</h1>
    <div class="kpi-grid" style="margin-bottom:20px" id="wl-kpis"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px">
      <div class="card">
        <div class="card-head"><h2 style="color:var(--green)">Why They Said Yes</h2></div>
        <div id="wl-wins"></div>
      </div>
      <div class="card">
        <div class="card-head"><h2 style="color:var(--red)">Why They Said No</h2></div>
        <div id="wl-losses"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-head"><h2>All Closed & Lost Deals</h2></div>
      <div id="wl-list"></div>
    </div>
  </div>

  <!-- WEEKLY REVIEW -->
  <div id="view-weekly" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Weekly Review</h1>
      <button class="btn btn-primary" onclick="openReviewModal()">+ New Review</button>
    </div>
    <div id="weekly-list"></div>
  </div>

  <!-- ROADMAP -->
  <div id="view-roadmap" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">50-Client Roadmap</h1>
      <span id="roadmap-days" style="font-size:14px;color:var(--text-2)"></span>
    </div>
    <div class="card" style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:16px">
        <div style="text-align:center">
          <div style="font-size:48px;font-weight:800;color:var(--green)" id="roadmap-current">0</div>
          <div style="font-size:12px;color:var(--text-2)">of 50 clients</div>
        </div>
        <div style="flex:1">
          <div class="prog" style="height:14px">
            <div class="prog-fill" id="roadmap-bar" style="background:linear-gradient(90deg,var(--green),var(--teal))"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="roadmap-list"></div>
  </div>

  <!-- ANALYTICS -->
  <div id="view-analytics" class="view">
    <h1 class="page-title">Conversion Analytics</h1>
    <div class="kpi-grid" id="analytics-kpis"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
      <div class="card">
        <div class="card-head"><h2>Outreach-to-Response Rate</h2></div>
        <div id="analytics-response"></div>
      </div>
      <div class="card">
        <div class="card-head"><h2>Stage Conversion Rates</h2></div>
        <div id="analytics-stages"></div>
      </div>
    </div>
    <div class="card" style="margin-bottom:14px">
      <div class="card-head"><h2>Deal Velocity</h2></div>
      <div id="analytics-velocity"></div>
    </div>
    <div class="card">
      <div class="card-head"><h2>Channel Performance</h2></div>
      <div id="analytics-channels"></div>
    </div>
  </div>

  <!-- ONBOARDING -->
  <div id="view-onboarding" class="view">
    <h1 class="page-title">Client Onboarding & Delivery</h1>
    <div class="kpi-grid" id="ob-kpis"></div>
    <div class="section-label">Active Clients</div>
    <div id="ob-clients"></div>
  </div>

  <!-- SALES SCRIPTS -->
  <div id="view-scripts" class="view">
    <h1 class="page-title">Sales Call Script & Objections</h1>
    <div id="scripts-content"></div>
  </div>

  <!-- PROPOSALS -->
  <div id="view-proposals" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Proposal Generator</h1>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px">
      <div class="card">
        <div class="card-head"><h2>Create Proposal</h2></div>
        <div class="form-row">
          <div class="form-group">
            <label>Company Name</label>
            <input type="text" class="form-control" id="prop-company" placeholder="Greenscape Lawn Care">
          </div>
          <div class="form-group">
            <label>Owner Name</label>
            <input type="text" class="form-control" id="prop-owner" placeholder="Mike Thompson">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Crew Size</label>
            <input type="number" class="form-control" id="prop-crew" min="1" placeholder="8">
          </div>
          <div class="form-group">
            <label>Industry</label>
            <select class="form-control" id="prop-industry">
              <option value="Lawn Care">Lawn Care</option>
              <option value="Landscaping">Landscaping</option>
              <option value="Lawn Care & Landscaping">Lawn Care & Landscaping</option>
              <option value="HVAC">HVAC</option>
              <option value="Plumbing">Plumbing</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Primary Pain Point</label>
          <select class="form-control" id="prop-pain">
            <option value="High turnover â€” losing good crew members">High turnover</option>
            <option value="Language barrier â€” can't communicate with Spanish-speaking crew">Language barrier</option>
            <option value="No visibility into crew morale or satisfaction">No visibility into morale</option>
            <option value="Blindsided by quits â€” no early warning system">Blindsided by quits</option>
            <option value="Growing too fast to stay connected to crew">Scaling too fast</option>
          </select>
        </div>
        <div class="form-group">
          <label>Custom Notes (optional)</label>
          <textarea class="form-control" id="prop-notes" placeholder="Anything specific to mention..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="generateProposal()" style="width:100%">Generate Proposal</button>
      </div>
      <div id="proposal-preview"></div>
    </div>
    <div class="card">
      <div class="card-head"><h2>Saved Proposals</h2></div>
      <div id="proposals-list"></div>
    </div>
  </div>

  <!-- CAMPAIGNS -->
  <div id="view-campaigns" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Email Campaign Tracker</h1>
      <button class="btn btn-primary" onclick="openCampaignModal()">+ Add to Sequence</button>
    </div>
    <div class="kpi-grid" id="camp-kpis"></div>
    <div class="section-label">Active Sequences</div>
    <div id="camp-active"></div>
    <div class="section-label" style="margin-top:20px">Completed / Converted</div>
    <div id="camp-done"></div>
  </div>

  <!-- SOCIAL MEDIA -->
  <div id="view-social" class="view">
    <h1 class="page-title">Social Media Command Center</h1>
    <div class="soc-tabs">
      <button class="soc-tab active" onclick="switchSocTab('tracker')">Weekly Tracker</button>
      <button class="soc-tab" onclick="switchSocTab('content')">Content Library</button>
      <button class="soc-tab" onclick="switchSocTab('engage')">Engagement Log</button>
      <button class="soc-tab" onclick="switchSocTab('strategy')">Strategy Guide</button>
    </div>
    <div id="soc-tab-tracker">
      <div class="soc-streak" id="soc-streak"></div>
      <div class="soc-week-nav" id="soc-week-nav"></div>
      <div class="soc-week" id="soc-week"></div>
    </div>
    <div id="soc-tab-content" style="display:none">
      <div class="social-filters" id="social-filters">
        <button class="social-filter active" onclick="filterSocial('all')">All</button>
        <button class="social-filter" onclick="filterSocial('LI')">LinkedIn</button>
        <button class="social-filter" onclick="filterSocial('FB')">Facebook</button>
        <button class="social-filter" onclick="filterSocial('IG')">Instagram</button>
        <button class="social-filter" onclick="filterSocial('ND')">Nextdoor</button>
        <button class="social-filter" onclick="filterSocial('R')">Reels</button>
      </div>
      <div id="social-posts"></div>
    </div>
    <div id="soc-tab-engage" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="section-label" style="margin-bottom:0">Engagement Tracking</div>
        <button class="btn btn-primary btn-sm" onclick="openEngageModal()">+ Log Response</button>
      </div>
      <div class="kpi-grid" id="soc-engage-kpis"></div>
      <div class="section-label">Recent Activity</div>
      <div id="soc-engage-log"></div>
    </div>
    <div id="soc-tab-strategy" style="display:none">
      <div id="soc-strategy-content"></div>
    </div>
  </div>

  <!-- DAILY BATTLE PLAN -->
  <div id="view-battleplan" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div>
        <h1 class="page-title" style="margin-bottom:2px">Daily Battle Plan</h1>
        <p class="text-muted" id="bp-date"></p>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" onclick="bpPrevDay()">&larr; Yesterday</button>
        <button class="btn btn-ghost btn-sm" onclick="bpToday()">Today</button>
        <button class="btn btn-ghost btn-sm" onclick="bpNextDay()">Tomorrow &rarr;</button>
      </div>
    </div>
    <div class="bp-score" id="bp-score"></div>
    <div id="bp-content"></div>
    <div class="bp-section">
      <div class="bp-section-title">Custom Tasks</div>
      <div id="bp-custom"></div>
      <div class="bp-add-row">
        <input type="text" class="form-control" id="bp-new-task" placeholder="Add a task for today..." onkeydown="if(event.key==='Enter')addBpTask()">
        <button class="btn btn-primary btn-sm" onclick="addBpTask()">Add</button>
      </div>
    </div>
  </div>

  <!-- TIME AUDIT -->
  <div id="view-timeaudit" class="view">
    <h1 class="page-title">Time Audit</h1>
    <div class="ta-timer" id="ta-timer">
      <div>
        <div class="ta-timer-display" id="ta-display">00:00:00</div>
        <div class="ta-timer-cat" id="ta-active-cat">Select a category to start tracking</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn btn-primary btn-sm" id="ta-start-btn" onclick="taToggle()">Start</button>
        <button class="btn btn-ghost btn-sm" onclick="taStop()">Stop & Log</button>
      </div>
    </div>
    <div class="ta-grid" id="ta-categories"></div>
    <div class="section-label">Today's Breakdown</div>
    <div id="ta-bar-container"></div>
    <div class="kpi-grid" id="ta-kpis"></div>
    <div class="section-label">Time Log</div>
    <div id="ta-history"></div>
  </div>

  <!-- MILESTONES -->
  <div id="view-milestones" class="view">
    <h1 class="page-title">Milestone Countdown</h1>
    <div class="ms-topline" id="ms-topline"></div>
    <div class="ms-grid" id="ms-grid"></div>
  </div>

  <!-- VISION BOARD -->
  <div id="view-vision" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Vision Board</h1>
      <button class="btn btn-primary btn-sm" onclick="openVisionModal()">+ Add to Board</button>
    </div>
    <div class="vb-quote" id="vb-quote"></div>
    <div class="vb-grid" id="vb-grid"></div>
  </div>

  <!-- DECISION JOURNAL -->
  <div id="view-decisions" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Decision Journal</h1>
      <button class="btn btn-primary btn-sm" onclick="openDecisionModal()">+ Log Decision</button>
    </div>
    <div class="kpi-grid" id="dj-kpis"></div>
    <div id="dj-list"></div>
  </div>

  <!-- CEO REVIEW -->
  <div id="view-ceoreview" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Weekly CEO Review</h1>
      <button class="btn btn-primary btn-sm" onclick="openCeoModal()">+ New Review</button>
    </div>
    <div class="kpi-grid" id="ceo-kpis"></div>
    <div id="ceo-list"></div>
  </div>

  <!-- IDEA CAPTURE -->
  <div id="view-ideas" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Idea Capture</h1>
      <button class="btn btn-primary btn-sm" onclick="openIdeaModal()">+ Capture Idea</button>
    </div>
    <div class="idea-cats" id="idea-cats"></div>
    <div id="idea-list"></div>
  </div>

  <!-- CLIENT RESULTS -->
  <div id="view-results" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Client Results Tracker</h1>
      <button class="btn btn-primary btn-sm" onclick="openResultModal()">+ Log Result</button>
    </div>
    <div class="cr-highlight" id="cr-highlight"></div>
    <div id="cr-list"></div>
  </div>

  <!-- MENTOR LOG -->
  <div id="view-mentors" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="page-title" style="margin-bottom:0">Mentor & Network Log</h1>
      <button class="btn btn-primary btn-sm" onclick="openMentorModal()">+ Log Conversation</button>
    </div>
    <div class="kpi-grid" id="ml-kpis"></div>
    <div id="ml-list"></div>
  </div>

  <!-- EMAIL TEMPLATES -->
  <div id="view-templates" class="view">
    <h1 class="page-title">Email Templates</h1>
    <div class="tpl-contact-bar">
      <label>Personalize for:</label>
      <div class="search-select" id="tpl-contact-ss" style="flex:1">
        <input type="text" id="tpl-contact-search" placeholder="Search by name or company..." autocomplete="off" onfocus="openSearchSelect('tpl-contact')" oninput="filterSearchSelect('tpl-contact')">
        <div class="search-select-list" id="tpl-contact-list"></div>
      </div>
      <input type="hidden" id="tpl-contact-select" value="">
      <input type="text" id="tpl-pain" placeholder="Pain point (optional)">
    </div>
    <div class="tpl-tabs" style="align-items:center">
      <button class="tpl-tab active" onclick="switchTplTab('cold')">Cold Emails</button>
      <button class="tpl-tab" onclick="switchTplTab('followup')">Post-Call Follow-Up</button>
      <button class="tpl-tab" onclick="switchTplTab('linkedin')">LinkedIn</button>
      <button class="btn btn-primary btn-sm" onclick="openBatchSend()" style="margin-left:auto;margin-bottom:0">Batch Send</button>
    </div>
    <div id="tpl-content"></div>
    <div class="tpl-track-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="section-label" style="margin-bottom:0">Template Performance</div>
        <button class="btn btn-ghost btn-sm" onclick="openSendModal()">+ Log a Send</button>
      </div>
      <div class="tpl-stat-grid" id="tpl-stats"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;margin-bottom:8px">
        <div class="section-label" style="margin-bottom:0">Recent Sends</div>
        <input type="text" class="form-control" id="send-log-search" placeholder="Search by name or company..." style="max-width:250px;font-size:12px" oninput="renderTplStats()">
      </div>
      <div id="tpl-send-log"></div>
    </div>
  </div>

</main>

<!-- Chat -->
<button class="chat-fab" onclick="toggleChat()" title="Ask Claude">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
</button>
<div class="chat-overlay" id="chat-overlay" onclick="toggleChat()"></div>
<div class="chat-panel" id="chat-panel">
  <div class="chat-header">
    <h3>Claude <span>AI Assistant</span></h3>
    <div class="chat-header-btns">
      <button onclick="clearChat()" title="New chat">New</button>
      <button onclick="chatSettings()" title="API key">Key</button>
      <button onclick="toggleChat()" title="Close">&times;</button>
    </div>
  </div>
  <div id="chat-key-setup" class="chat-key-setup">
    <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" width="32" height="32"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    <p><strong>Connect your Claude API key</strong> to chat with Claude about your business, leads, and sales strategy.</p>
    <input type="password" id="chat-api-key" placeholder="sk-ant-...">
    <button class="btn btn-primary" onclick="saveApiKey()">Connect</button>
    <p style="font-size:11px;color:var(--text-3)">Key is stored locally in your browser. Never sent anywhere except Anthropic.</p>
  </div>
  <div id="chat-body" style="display:none;flex:1;display:none;flex-direction:column;overflow:hidden">
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input-area">
      <textarea id="chat-input" placeholder="Ask about your pipeline, leads, strategy..." rows="1" onkeydown="chatKeydown(event)"></textarea>
      <button id="chat-send-btn" onclick="sendChat()">&#9654;</button>
    </div>
  </div>
</div>

<div class="copied-toast" id="copied-toast">Copied!</div>

<!-- Contact Modal -->
<div class="modal-overlay" id="contact-modal">
  <div class="modal">
    <h3 id="contact-modal-title">Add Contact</h3>
    <input type="hidden" id="ct-id">
    <div class="form-row">
      <div class="form-group">
        <label>Company Name</label>
        <input type="text" class="form-control" id="ct-company" placeholder="Greenscape Lawn Care">
      </div>
      <div class="form-group">
        <label>Owner Name</label>
        <input type="text" class="form-control" id="ct-owner" placeholder="Mike Thompson">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Email</label>
        <input type="email" class="form-control" id="ct-email" placeholder="mike@greenscape.com">
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input type="tel" class="form-control" id="ct-phone" placeholder="(555) 234-5678">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>LinkedIn URL</label>
        <input type="text" class="form-control" id="ct-linkedin" placeholder="linkedin.com/in/...">
      </div>
      <div class="form-group">
        <label>City, State</label>
        <input type="text" class="form-control" id="ct-state" placeholder="Greenville, SC">
      </div>
    </div>
    <div class="form-row-4">
      <div class="form-group">
        <label>Crew Size</label>
        <input type="number" class="form-control" id="ct-crew" min="1" placeholder="8">
      </div>
      <div class="form-group">
        <label>Monthly Price</label>
        <input type="number" class="form-control" id="ct-price" min="0" placeholder="Auto">
      </div>
      <div class="form-group">
        <label>Industry</label>
        <select class="form-control" id="ct-industry">
          <option value="Lawn Care">Lawn Care</option>
          <option value="Landscaping">Landscaping</option>
          <option value="Lawn Care & Landscaping">Lawn Care & Landscaping</option>
          <option value="Landscaping & Hardscaping">Landscaping & Hardscaping</option>
          <option value="HVAC">HVAC</option>
          <option value="Plumbing">Plumbing</option>
          <option value="Pest Control">Pest Control</option>
          <option value="Cleaning">Cleaning</option>
          <option value="Roofing">Roofing</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Source</label>
        <select class="form-control" id="ct-source">
          <option value="Cold Email">Cold Email</option>
          <option value="LinkedIn">LinkedIn</option>
          <option value="Referral">Referral</option>
          <option value="Facebook Group">Facebook Group</option>
          <option value="Website">Website</option>
          <option value="NALP Event">NALP Event</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Pipeline Stage</label>
        <select class="form-control" id="ct-status">
          <option value="Lead">Lead</option>
          <option value="Contacted">Contacted</option>
          <option value="Replied">Replied</option>
          <option value="Call Scheduled">Call Scheduled</option>
          <option value="Proposal Sent">Proposal Sent</option>
          <option value="Closed">Closed</option>
          <option value="Lost">Lost</option>
          <option value="Churned">Churned</option>
        </select>
      </div>
      <div class="form-group">
        <label>Follow-up Date</label>
        <input type="date" class="form-control" id="ct-followup">
      </div>
    </div>
    <div class="form-group" id="ct-close-reason-wrap" style="display:none">
      <label>Why did they close? (Win reason)</label>
      <select class="form-control" id="ct-close-reason">
        <option value="">Select...</option>
        <option value="Language barrier pain">Language barrier pain</option>
        <option value="Recent turnover event">Recent turnover event</option>
        <option value="Referral trust">Referral trust</option>
        <option value="ROI math clicked">ROI math clicked</option>
        <option value="First month guarantee">First month guarantee</option>
        <option value="Bilingual differentiator">Bilingual differentiator</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-group" id="ct-loss-reason-wrap" style="display:none">
      <label>Why did we lose them?</label>
      <select class="form-control" id="ct-loss-reason">
        <option value="">Select...</option>
        <option value="Price objection">Price objection</option>
        <option value="Already doing it themselves">Already doing it themselves</option>
        <option value="Not enough crew">Not enough crew</option>
        <option value="Bad timing / seasonal">Bad timing / seasonal</option>
        <option value="No budget">No budget</option>
        <option value="Went with competitor">Went with competitor</option>
        <option value="Ghosted / no response">Ghosted / no response</option>
        <option value="Doesn't see value">Doesn't see value</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-group" id="ct-health-wrap" style="display:none">
      <label>Client Health</label>
      <select class="form-control" id="ct-health">
        <option value="good">Good â€” happy, engaged</option>
        <option value="warning">Warning â€” needs attention</option>
        <option value="risk">At Risk â€” might churn</option>
      </select>
    </div>
    <div class="form-row" id="ct-delivery-wrap" style="display:none">
      <div class="form-group">
        <label>Last Report Delivered</label>
        <input type="date" class="form-control" id="ct-last-delivery">
      </div>
      <div class="form-group">
        <label>Next Report Due</label>
        <input type="date" class="form-control" id="ct-next-delivery">
      </div>
    </div>
    <div class="form-group" id="ct-referrer-wrap" style="display:none">
      <label>Referred By (company name)</label>
      <input type="text" class="form-control" id="ct-referrer" placeholder="Who referred this client?">
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea class="form-control" id="ct-notes" placeholder="Context, pain points, objections..."></textarea>
    </div>
    <div class="emp-section" id="ct-emp-section" style="display:none">
      <h4>Employee Contacts <button class="btn btn-ghost btn-sm" onclick="toggleEmpForm()">+ Add</button></h4>
      <div class="emp-list" id="ct-emp-list"></div>
      <div id="ct-emp-form" style="display:none">
        <div class="emp-add-form">
          <input type="text" id="emp-name" placeholder="Employee name">
          <input type="text" id="emp-role" placeholder="Role (e.g. Foreman)">
          <input type="tel" id="emp-phone" placeholder="Phone number">
          <select id="emp-lang">
            <option value="English">English</option>
            <option value="Spanish">Spanish</option>
            <option value="Both">Both</option>
          </select>
        </div>
        <div style="margin-top:6px;display:flex;gap:6px;justify-content:flex-end">
          <button class="btn btn-ghost btn-sm" onclick="toggleEmpForm()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="addEmployee()">Add Employee</button>
        </div>
      </div>
    </div>
    <div id="ct-email-history" style="display:none">
      <div class="section-label" style="margin-top:12px;margin-bottom:6px">Emails Sent</div>
      <div id="ct-email-history-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="ct-delete-btn" onclick="deleteContact()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('contact-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveContact()">Save Contact</button>
    </div>
  </div>
</div>

<!-- Activity Modal -->
<div class="modal-overlay" id="activity-modal">
  <div class="modal">
    <h3>Log Activity</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Type</label>
        <select class="form-control" id="act-type">
          <option value="Cold Email">Cold Emails Sent</option>
          <option value="Call">Calls Made</option>
          <option value="LinkedIn">LinkedIn Messages</option>
          <option value="Follow-up">Follow-ups</option>
          <option value="Meeting">Discovery Calls</option>
          <option value="Referral Ask">Referral Asks</option>
        </select>
      </div>
      <div class="form-group">
        <label>Count</label>
        <input type="number" class="form-control" id="act-count" min="1" value="1">
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <input type="text" class="form-control" id="act-notes" placeholder="Any details...">
    </div>
    <div class="form-group">
      <label>Date</label>
      <input type="date" class="form-control" id="act-date">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('activity-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveActivity()">Log It</button>
    </div>
  </div>
</div>

<!-- Weekly Review Modal -->
<div class="modal-overlay" id="review-modal">
  <div class="modal">
    <h3>Weekly Review</h3>
    <div class="form-group">
      <label>Week Ending (date)</label>
      <input type="date" class="form-control" id="rev-date">
    </div>
    <div class="form-group">
      <label>What worked this week?</label>
      <textarea class="form-control" id="rev-worked" placeholder="Messaging that got replies, channels that converted, breakthroughs..."></textarea>
    </div>
    <div class="form-group">
      <label>What didn't work?</label>
      <textarea class="form-control" id="rev-didnt" placeholder="What fell flat? What did you skip or avoid?"></textarea>
    </div>
    <div class="form-group">
      <label>What are you changing next week?</label>
      <textarea class="form-control" id="rev-changing" placeholder="Specific actions. No vague promises."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Energy / Motivation (1-10)</label>
        <input type="number" class="form-control" id="rev-energy" min="1" max="10" value="7">
      </div>
      <div class="form-group">
        <label>Confidence in hitting 50 (1-10)</label>
        <input type="number" class="form-control" id="rev-confidence" min="1" max="10" value="7">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('review-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveReview()">Save Review</button>
    </div>
  </div>
</div>

<!-- Campaign Modal -->
<div class="modal-overlay" id="campaign-modal">
  <div class="modal">
    <h3>Add Prospect to Email Sequence</h3>
    <input type="hidden" id="camp-id">
    <div class="form-group">
      <label>Prospect (select from contacts)</label>
      <select class="form-control" id="camp-contact"></select>
    </div>
    <div class="form-group">
      <label>Sequence Type</label>
      <select class="form-control" id="camp-sequence">
        <option value="Post-Call Follow-Up">Post-Call Follow-Up (5 emails)</option>
        <option value="Cold Outreach">Cold Outreach</option>
        <option value="Nurture">Nurture / Stay In Touch</option>
        <option value="Re-engagement">Re-engagement (Lost Leads)</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Sequence Started</label>
        <input type="date" class="form-control" id="camp-start">
      </div>
      <div class="form-group">
        <label>Current Email #</label>
        <input type="number" class="form-control" id="camp-current" min="1" max="5" value="1">
      </div>
    </div>
    <div class="form-group">
      <label>Status</label>
      <select class="form-control" id="camp-status">
        <option value="Active">Active</option>
        <option value="Paused">Paused</option>
        <option value="Completed">Completed (no conversion)</option>
        <option value="Converted">Converted (signed up!)</option>
        <option value="Opted Out">Opted Out</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <input type="text" class="form-control" id="camp-notes" placeholder="Any replies, opens, clicks...">
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="camp-delete-btn" onclick="deleteCampaign()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('campaign-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveCampaign()">Save</button>
    </div>
  </div>
</div>

<!-- Social Engagement Modal -->
<div class="modal-overlay" id="engage-modal">
  <div class="modal">
    <h3>Log Social Media Response</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Platform</label>
        <select class="form-control" id="eng-platform">
          <option value="LinkedIn">LinkedIn</option>
          <option value="Facebook">Facebook</option>
          <option value="Instagram">Instagram</option>
          <option value="Nextdoor">Nextdoor</option>
        </select>
      </div>
      <div class="form-group">
        <label>Type</label>
        <select class="form-control" id="eng-type">
          <option value="Connection Accepted">Connection Accepted</option>
          <option value="DM Reply">DM Reply</option>
          <option value="Comment Reply">Comment Reply</option>
          <option value="Post Like">Post Like/React</option>
          <option value="Post Share">Post Share</option>
          <option value="Profile Visit">Profile Visit</option>
          <option value="Follow">New Follower</option>
          <option value="Lead Generated">Lead Generated</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Details</label>
      <input type="text" class="form-control" id="eng-detail" placeholder="Name, post topic, any context...">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Date</label>
        <input type="date" class="form-control" id="eng-date">
      </div>
      <div class="form-group">
        <label>Result</label>
        <select class="form-control" id="eng-result">
          <option value="Positive">Positive</option>
          <option value="Neutral">Neutral</option>
          <option value="Negative">Not Interested</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('engage-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEngagement()">Log It</button>
    </div>
  </div>
</div>

<!-- Send Log Modal -->
<div class="modal-overlay" id="send-modal">
  <div class="modal">
    <h3>Log Email Send</h3>
    <div class="form-group">
      <label>Contact</label>
      <div class="search-select" id="send-contact-ss">
        <input type="text" id="send-contact-search" placeholder="Search by name or company..." autocomplete="off" onfocus="openSearchSelect('send-contact')" oninput="filterSearchSelect('send-contact')">
        <div class="search-select-list" id="send-contact-list"></div>
      </div>
      <input type="hidden" id="send-contact" value="">
    </div>
    <div class="form-group">
      <label>Template Sent</label>
      <select class="form-control" id="send-template">
        <optgroup label="Cold Emails">
          <option value="Cold 1 â€” Wake-Up Call">Cold 1 â€” Wake-Up Call</option>
          <option value="Cold 2 â€” Language Gap">Cold 2 â€” Language Gap</option>
          <option value="Cold 3 â€” The Math">Cold 3 â€” The Math</option>
        </optgroup>
        <optgroup label="Post-Call Follow-Up">
          <option value="Follow-Up 1 â€” Recap">Follow-Up 1 â€” Recap</option>
          <option value="Follow-Up 2 â€” Thinking It Over">Follow-Up 2 â€” Thinking It Over</option>
          <option value="Follow-Up 3 â€” Urgency">Follow-Up 3 â€” Urgency</option>
          <option value="Follow-Up 4 â€” Nurture">Follow-Up 4 â€” Nurture</option>
          <option value="Follow-Up 5 â€” Win-Back">Follow-Up 5 â€” Win-Back</option>
        </optgroup>
        <optgroup label="LinkedIn">
          <option value="LinkedIn â€” Connection Request">LinkedIn â€” Connection Request</option>
          <option value="LinkedIn â€” Follow-Up Message">LinkedIn â€” Follow-Up Message</option>
          <option value="LinkedIn â€” InMail">LinkedIn â€” InMail</option>
        </optgroup>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Date Sent</label>
        <input type="date" class="form-control" id="send-date">
      </div>
      <div class="form-group">
        <label>Got a Reply?</label>
        <select class="form-control" id="send-replied">
          <option value="no">No reply yet</option>
          <option value="yes">Yes â€” replied!</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <input type="text" class="form-control" id="send-notes" placeholder="Any details on the response...">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('send-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSend()">Log Send</button>
    </div>
  </div>
</div>

<!-- Batch Send Modal -->
<div class="modal-overlay" id="batch-send-modal">
  <div class="modal" style="max-width:600px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="margin-bottom:0">Batch Send</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeBatchSend()">&times;</button>
    </div>
    <div class="batch-wizard-steps">
      <div class="batch-step-dot active" id="batch-dot-1">1. Select Contacts</div>
      <div class="batch-step-dot" id="batch-dot-2">2. Pick Template</div>
      <div class="batch-step-dot" id="batch-dot-3">3. Send</div>
    </div>
    <div id="batch-step-1">
      <div class="batch-select-bar">
        <input type="text" id="batch-search" placeholder="Search contacts..." oninput="filterBatchContacts()">
        <select id="batch-filter-industry" style="padding:7px 8px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:inherit;font-size:12px" onchange="filterBatchContacts()">
          <option value="all">All Industries</option>
        </select>
        <select id="batch-filter-status" style="padding:7px 8px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:inherit;font-size:12px" onchange="filterBatchContacts()">
          <option value="all">All Stages</option>
          <option value="Lead">Lead</option>
          <option value="Contacted">Contacted</option>
          <option value="Replied">Replied</option>
          <option value="Call Scheduled">Call Scheduled</option>
          <option value="Proposal Sent">Proposal Sent</option>
          <option value="Closed">Closed</option>
        </select>
        <label style="font-size:12px;display:flex;align-items:center;gap:4px;white-space:nowrap;cursor:pointer"><input type="checkbox" id="batch-select-all" onchange="toggleBatchAll()" style="accent-color:var(--green)"> Select All</label>
      </div>
      <div class="batch-contact-list" id="batch-contact-list"></div>
      <div class="batch-count" id="batch-count">0 selected</div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeBatchSend()">Cancel</button>
        <button class="btn btn-primary" onclick="batchStep2()">Next &rarr;</button>
      </div>
    </div>
    <div id="batch-step-2" style="display:none">
      <div class="form-group">
        <label>Template</label>
        <select class="form-control" id="batch-template">
          <optgroup label="Cold Emails"></optgroup>
          <optgroup label="Post-Call Follow-Up"></optgroup>
        </select>
      </div>
      <div class="form-group">
        <label>Subject Line</label>
        <select class="form-control" id="batch-subject"></select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="batchBackTo1()">&larr; Back</button>
        <button class="btn btn-primary" onclick="batchStart()">Start Sending</button>
      </div>
    </div>
    <div id="batch-step-3" style="display:none">
      <div class="batch-progress" id="batch-progress">
        <div class="batch-progress-text">
          <span id="batch-prog-label">0 of 0</span>
          <span id="batch-prog-pct">0%</span>
        </div>
        <div class="batch-progress-bar"><div class="batch-progress-fill" id="batch-prog-fill"></div></div>
      </div>
      <div id="batch-current-area"></div>
      <div id="batch-done-area" style="display:none"></div>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div class="modal-overlay" id="import-modal">
  <div class="modal" style="max-width:700px">
    <h3>Import Contacts from CSV</h3>
    <div id="import-step-upload">
      <div class="import-drop" id="import-drop" onclick="document.getElementById('import-file').click()">
        <p>Drop a CSV file here or click to browse</p>
        <div class="hint">Export your Google Sheet as CSV (File â†’ Download â†’ .csv)</div>
      </div>
      <input type="file" id="import-file" accept=".csv" style="display:none" onchange="handleImportFile(this)">
    </div>
    <div id="import-step-map" style="display:none">
      <div class="import-stats" id="import-stats"></div>
      <p style="font-size:12px;color:var(--text-2);margin-bottom:10px">Map your columns to contact fields:</p>
      <div class="import-map" id="import-map"></div>
      <div class="section-label">Preview</div>
      <div class="import-preview" id="import-preview"></div>
      <div style="margin-top:10px">
        <label style="font-size:12px;color:var(--text-2);display:flex;align-items:center;gap:6px;cursor:pointer">
          <input type="checkbox" id="import-update" checked> Update existing contacts if company name matches (otherwise duplicates are skipped)
        </label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeImportModal()">Cancel</button>
      <button class="btn btn-primary" id="import-btn" onclick="executeImport()" style="display:none">Import Contacts</button>
    </div>
  </div>
</div>

<!-- Quick Email Modal -->
<div class="modal-overlay" id="quick-email-modal">
  <div class="modal" style="max-width:650px">
    <h3>Quick Email</h3>
    <div class="qe-contact" id="qe-contact-info"></div>
    <div class="form-group">
      <label>Pain Point (optional)</label>
      <input type="text" class="form-control" id="qe-pain" placeholder="e.g., losing crew without warning" oninput="renderQuickEmailPreview()">
    </div>
    <div class="qe-tabs" id="qe-tabs"></div>
    <div id="qe-template-list"></div>
    <div id="qe-preview-area"></div>
  </div>
</div>

<!-- Vision Modal -->
<div class="modal-overlay" id="vision-modal">
  <div class="modal">
    <h3 id="vision-modal-title">Add to Vision Board</h3>
    <input type="hidden" id="vb-id">
    <div class="form-group">
      <label>Title</label>
      <input type="text" class="form-control" id="vb-title" placeholder="e.g., Hit $17,500 MRR">
    </div>
    <div class="form-group">
      <label>Description / Why This Matters</label>
      <textarea class="form-control" id="vb-desc" rows="3" placeholder="Why is this important to you?"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" id="vb-category">
          <option>Revenue</option>
          <option>Lifestyle</option>
          <option>Growth</option>
          <option>Personal</option>
          <option>Legacy</option>
        </select>
      </div>
      <div class="form-group">
        <label>Target Date</label>
        <input type="date" class="form-control" id="vb-target">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('vision-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveVision()">Save</button>
    </div>
  </div>
</div>

<!-- Decision Modal -->
<div class="modal-overlay" id="decision-modal">
  <div class="modal" style="max-width:550px">
    <h3 id="decision-modal-title">Log Decision</h3>
    <input type="hidden" id="dj-id">
    <div class="form-group">
      <label>Decision Title</label>
      <input type="text" class="form-control" id="dj-title" placeholder="e.g., Expand to HVAC industry">
    </div>
    <div class="form-group">
      <label>Context / Situation</label>
      <textarea class="form-control" id="dj-context" rows="2" placeholder="What prompted this decision?"></textarea>
    </div>
    <div class="form-group">
      <label>Options Considered</label>
      <textarea class="form-control" id="dj-options" rows="2" placeholder="What alternatives did you consider?"></textarea>
    </div>
    <div class="form-group">
      <label>Decision Made</label>
      <textarea class="form-control" id="dj-decision" rows="2" placeholder="What did you decide and why?"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Date</label>
        <input type="date" class="form-control" id="dj-date">
      </div>
      <div class="form-group">
        <label>Review In</label>
        <select class="form-control" id="dj-review">
          <option value="7">1 Week</option>
          <option value="14">2 Weeks</option>
          <option value="30" selected>1 Month</option>
          <option value="90">3 Months</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Outcome (fill in later)</label>
      <select class="form-control" id="dj-outcome">
        <option value="pending">Pending</option>
        <option value="good">Good Decision</option>
        <option value="bad">Bad Decision</option>
      </select>
    </div>
    <div class="form-group">
      <label>Outcome Notes</label>
      <textarea class="form-control" id="dj-outcome-notes" rows="2" placeholder="What happened? What did you learn?"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('decision-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDecision()">Save</button>
    </div>
  </div>
</div>

<!-- CEO Review Modal -->
<div class="modal-overlay" id="ceo-modal">
  <div class="modal" style="max-width:550px">
    <h3 id="ceo-modal-title">Weekly CEO Review</h3>
    <input type="hidden" id="ceo-id">
    <div class="form-row">
      <div class="form-group">
        <label>Week Of</label>
        <input type="date" class="form-control" id="ceo-week">
      </div>
      <div class="form-group">
        <label>Grade Yourself</label>
        <select class="form-control" id="ceo-grade">
          <option value="A">A â€” Crushed it</option>
          <option value="B">B â€” Solid week</option>
          <option value="C">C â€” Average</option>
          <option value="D">D â€” Off track</option>
          <option value="F">F â€” Need a reset</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Wins This Week</label>
      <textarea class="form-control" id="ceo-wins" rows="3" placeholder="What went well? What are you proud of?"></textarea>
    </div>
    <div class="form-group">
      <label>Losses / Challenges</label>
      <textarea class="form-control" id="ceo-losses" rows="3" placeholder="What didn't go well? What held you back?"></textarea>
    </div>
    <div class="form-group">
      <label>Lessons Learned</label>
      <textarea class="form-control" id="ceo-lessons" rows="2" placeholder="What will you do differently?"></textarea>
    </div>
    <div class="form-group">
      <label>Next Week's Focus</label>
      <textarea class="form-control" id="ceo-focus" rows="2" placeholder="Top 3 priorities for next week"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('ceo-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveCeoReview()">Save Review</button>
    </div>
  </div>
</div>

<!-- Idea Modal -->
<div class="modal-overlay" id="idea-modal">
  <div class="modal">
    <h3 id="idea-modal-title">Capture Idea</h3>
    <input type="hidden" id="idea-id">
    <div class="form-group">
      <label>Idea Title</label>
      <input type="text" class="form-control" id="idea-title" placeholder="e.g., Partner with payroll company">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea class="form-control" id="idea-desc" rows="3" placeholder="Describe the idea in detail..."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" id="idea-category">
          <option>Business</option>
          <option>Marketing</option>
          <option>Product</option>
          <option>Partnership</option>
          <option>Content</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Priority</label>
        <select class="form-control" id="idea-priority">
          <option value="high">High</option>
          <option value="medium" selected>Medium</option>
          <option value="low">Low</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('idea-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveIdea()">Save Idea</button>
    </div>
  </div>
</div>

<!-- Client Result Modal -->
<div class="modal-overlay" id="result-modal">
  <div class="modal">
    <h3 id="result-modal-title">Log Client Result</h3>
    <input type="hidden" id="cr-id">
    <div class="form-group">
      <label>Client</label>
      <div class="search-select" id="cr-contact-ss">
        <input type="text" id="cr-contact-search" placeholder="Search client..." autocomplete="off" onfocus="openSearchSelect('cr-contact')" oninput="filterSearchSelect('cr-contact')">
        <div class="search-select-list" id="cr-contact-list"></div>
      </div>
      <input type="hidden" id="cr-contact-select" value="">
    </div>
    <div class="form-group">
      <label>Result Title</label>
      <input type="text" class="form-control" id="cr-title" placeholder="e.g., Caught retention risk in first month">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea class="form-control" id="cr-desc" rows="3" placeholder="What happened? What was the impact?"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" id="cr-category">
          <option>Retention Save</option>
          <option>Morale Insight</option>
          <option>Cost Savings</option>
          <option>Process Improvement</option>
          <option>Testimonial</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" class="form-control" id="cr-date">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Metric (optional)</label>
        <input type="text" class="form-control" id="cr-metric" placeholder="e.g., $ saved, people retained">
      </div>
      <div class="form-group">
        <label>Value</label>
        <input type="text" class="form-control" id="cr-value" placeholder="e.g., $8,000">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('result-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveResult()">Save Result</button>
    </div>
  </div>
</div>

<!-- Mentor Modal -->
<div class="modal-overlay" id="mentor-modal">
  <div class="modal">
    <h3 id="mentor-modal-title">Log Conversation</h3>
    <input type="hidden" id="ml-id">
    <div class="form-row">
      <div class="form-group">
        <label>Person's Name</label>
        <input type="text" class="form-control" id="ml-name" placeholder="e.g., John Smith">
      </div>
      <div class="form-group">
        <label>Role / Relationship</label>
        <input type="text" class="form-control" id="ml-role" placeholder="e.g., Mentor, Business Owner, Coach">
      </div>
    </div>
    <div class="form-group">
      <label>Topic Discussed</label>
      <input type="text" class="form-control" id="ml-topic" placeholder="What did you talk about?">
    </div>
    <div class="form-group">
      <label>Key Takeaways</label>
      <textarea class="form-control" id="ml-takeaway" rows="3" placeholder="What did you learn? What stood out?"></textarea>
    </div>
    <div class="form-group">
      <label>Next Action</label>
      <input type="text" class="form-control" id="ml-next" placeholder="What's your next step based on this conversation?">
    </div>
    <div class="form-group">
      <label>Date</label>
      <input type="date" class="form-control" id="ml-date">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('mentor-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveMentor()">Save</button>
    </div>
  </div>
</div>

<script>
// ===== DATA =====
const STORAGE_KEY = 'crewVoiceHQ';
const STAGES = ['Lead','Contacted','Replied','Call Scheduled','Proposal Sent','Closed','Lost','Churned'];
const STAGE_COLORS = {Lead:'blue',Contacted:'purple',Replied:'teal','Call Scheduled':'orange','Proposal Sent':'gold',Closed:'green',Lost:'red',Churned:'red'};
const DAILY_TARGETS = {'Cold Email':50,Call:20,LinkedIn:15,'Follow-up':10,Meeting:3,'Referral Ask':5};
const TARGET_DATE = new Date('2026-08-31');

function defaultData(){
  return {contacts:[],activities:[],roadmapItems:[],weeklyReviews:[],onboarding:{},deliveryLog:[],proposals:[],emailCampaigns:[],emailSends:[],socialChecks:{},socialEngagement:[],battlePlan:{},timeEntries:[],visionItems:[],decisions:[],ceoReviews:[],ideas:[],clientResults:[],mentorLog:[]};
}

function loadData(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return seedData();
    const d=JSON.parse(raw);
    const def=defaultData();
    // Deep merge: ensure all default keys exist without overwriting saved data
    Object.keys(def).forEach(function(k){
      if(d[k]===undefined||d[k]===null) d[k]=def[k];
      else if(Array.isArray(def[k])&&!Array.isArray(d[k])) d[k]=def[k];
    });
    return d;
  }catch{return seedData();}
}

function seedData(){
  const d=defaultData();
  // Seed roadmap from business plan
  const roadmap=[
    {month:1,title:'Buy custom domain (mycrewvoice.com)',done:true},
    {month:1,title:'Set up professional email (luke@mycrewvoice.com)',done:false},
    {month:1,title:'Set up CRM / tracking system',done:false},
    {month:1,title:'Set up Stripe for payments',done:false},
    {month:1,title:'Get referrals from Russell Nafziger',done:false},
    {month:1,title:'Send first 500 cold emails',done:false},
    {month:1,title:'Target: 5 clients',done:false},
    {month:2,title:'Deliver first reports, document results',done:false},
    {month:2,title:'Create 2-3 case studies with real numbers',done:false},
    {month:2,title:'Get 3+ video/written testimonials',done:false},
    {month:2,title:'Scale outreach to 200 emails/week',done:false},
    {month:2,title:'Target: 10 clients',done:false},
    {month:3,title:'Launch weekly content schedule (LinkedIn, Facebook, Reels)',done:false},
    {month:3,title:'Start SEO blog posts',done:false},
    {month:3,title:'Attend 1 local industry event',done:false},
    {month:3,title:'Target: 18 clients',done:false},
    {month:4,title:'Formalize referral program',done:false},
    {month:4,title:'Reach out to 10 potential partners',done:false},
    {month:4,title:'Hire first part-time bilingual interviewer',done:false},
    {month:4,title:'Target: 28 clients',done:false},
    {month:5,title:'Double down on best-performing channels',done:false},
    {month:5,title:'Document all SOPs for scale',done:false},
    {month:5,title:'Add second interviewer if needed',done:false},
    {month:5,title:'Target: 38 clients',done:false},
    {month:6,title:'Final push with increased outreach',done:false},
    {month:6,title:'Run limited-time promotion if needed',done:false},
    {month:6,title:'Plan expansion to HVAC/plumbing verticals',done:false},
    {month:6,title:'TARGET: 50 CLIENTS',done:false}
  ];
  d.roadmapItems=roadmap.map((r,i)=>({id:'rm'+i,...r}));
  return d;
}

function saveData(d){localStorage.setItem(STORAGE_KEY,JSON.stringify(d))}
function save(){saveData(data)}

function exportData(){
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='crew-voice-hq-backup-'+new Date().toISOString().slice(0,10)+'.json';
  a.click();URL.revokeObjectURL(a.href);
}
function importData(e){
  var file=e.target.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(ev){
    try{
      var imported=JSON.parse(ev.target.result);
      if(!imported||typeof imported!=='object'){alert('Invalid backup file.');return}
      if(!confirm('This will REPLACE all current data with the backup. Are you sure?'))return;
      data=imported;save();location.reload();
    }catch(err){alert('Error reading backup file: '+err.message)}
  };
  reader.readAsText(file);
  e.target.value='';
}

let data=loadData();

function uid(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function todayStr(){return new Date().toISOString().split('T')[0]}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1)}

function calcRevenue(crewSize){
  const c=parseInt(crewSize)||0;
  if(c<=0) return 0;
  if(c<=8) return 299;
  return 299+(c-8)*30;
}
function contactRevenue(c){
  if(c.customPrice>0) return c.customPrice;
  return calcRevenue(c.crewSize);
}

function formatMoney(n){return '$'+n.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0})}
function formatDate(s){if(!s)return '';const d=new Date(s+'T00:00:00');return d.toLocaleDateString('en-US',{month:'short',day:'numeric'})}

function closedContacts(){return data.contacts.filter(c=>c.status==='Closed')}
function activeContacts(){return data.contacts.filter(c=>c.status!=='Lost'&&c.status!=='Churned')}
function pipelineContacts(){return data.contacts.filter(c=>c.status!=='Closed'&&c.status!=='Lost'&&c.status!=='Churned')}

function getMRR(){return closedContacts().reduce((s,c)=>s+contactRevenue(c),0)}
function getPipelineValue(){return pipelineContacts().reduce((s,c)=>s+contactRevenue(c),0)}
function getCloseRate(){
  const closed=closedContacts().length;
  const lost=data.contacts.filter(c=>c.status==='Lost').length;
  const total=closed+lost;
  return total>0?Math.round((closed/total)*100):0;
}

// ===== NAV =====
document.querySelectorAll('.nav-item').forEach(item=>{
  item.addEventListener('click',()=>{
    switchView(item.dataset.view);
    document.querySelector('.sidebar').classList.remove('open');
  });
});

function switchView(view){
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelector(`.nav-item[data-view="${view}"]`).classList.add('active');
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+view).classList.add('active');
  const fn={dashboard:renderDashboard,contacts:renderContacts,pipeline:renderPipeline,activity:renderActivity,revenue:renderRevenue,clients:renderClients,roadmap:renderRoadmap,winloss:renderWinLoss,weekly:renderWeekly,analytics:renderAnalytics,onboarding:renderOnboarding,scripts:renderScripts,proposals:renderProposals,campaigns:renderCampaigns,templates:renderTemplates,social:renderSocial,battleplan:renderBattlePlan,timeaudit:renderTimeAudit,milestones:renderMilestones,vision:renderVision,decisions:renderDecisions,ceoreview:renderCeoReview,ideas:renderIdeas,results:renderResults,mentors:renderMentors};
  if(fn[view])fn[view]();
}

// ===== MODAL =====
function closeModal(id){document.getElementById(id).classList.remove('active')}
function openModal(id){document.getElementById(id).classList.add('active')}
document.querySelectorAll('.modal-overlay').forEach(ov=>{ov.addEventListener('click',e=>{if(e.target===ov)ov.classList.remove('active')})});

// ===== DASHBOARD =====
function renderDashboard(){
  const h=new Date().getHours();
  const greet=h<12?'morning':h<17?'afternoon':'evening';
  document.getElementById('dash-greet').textContent=`Good ${greet}, Luke`;
  document.getElementById('dash-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});

  const mrr=getMRR();
  const clients=closedContacts().length;
  const pipeVal=getPipelineValue();
  const closeRate=getCloseRate();
  const daysLeft=Math.max(0,Math.ceil((TARGET_DATE-new Date())/(1000*60*60*24)));

  // Outreach streak
  const streak=calcOutreachStreak();
  document.getElementById('dash-streak').innerHTML=`
    <div class="streak-box ${streak===0?'streak-zero':''}">
      <div class="streak-fire">${streak>0?'&#128293;':'&#10060;'}</div>
      <div>
        <div class="streak-num">${streak}</div>
        <div class="streak-label">${streak===1?'day':'days'} outreach streak</div>
      </div>
      <div style="margin-left:auto;font-size:12px;color:var(--text-3)">${streak>=7?'ON FIRE. Keep going.':streak>=3?'Building momentum.':streak>0?'Good start. Don\'t break it.':'Hit your targets today to start a streak.'}</div>
    </div>
  `;

  document.getElementById('dash-kpis').innerHTML=`
    <div class="kpi">
      <div class="kpi-value" style="color:var(--green)">${formatMoney(mrr)}</div>
      <div class="kpi-label">Monthly Revenue</div>
      <div class="kpi-sub">Target: $17,500</div>
    </div>
    <div class="kpi">
      <div class="kpi-value" style="color:var(--green)">${clients}</div>
      <div class="kpi-label">Active Clients</div>
      <div class="kpi-sub">Goal: 50</div>
    </div>
    <div class="kpi">
      <div class="kpi-value" style="color:var(--gold)">${formatMoney(pipeVal)}</div>
      <div class="kpi-label">Pipeline Value</div>
      <div class="kpi-sub">${pipelineContacts().length} prospects</div>
    </div>
    <div class="kpi">
      <div class="kpi-value" style="color:var(--blue)">${closeRate}%</div>
      <div class="kpi-label">Close Rate</div>
    </div>
    <div class="kpi">
      <div class="kpi-value" style="color:${daysLeft<60?'var(--red)':'var(--teal)'}">${daysLeft}</div>
      <div class="kpi-label">Days to Goal</div>
      <div class="kpi-sub">Aug 31, 2026</div>
    </div>
  `;

  // Follow-ups
  const today=todayStr();
  const followups=data.contacts.filter(c=>c.followUpDate&&c.status!=='Closed'&&c.status!=='Lost').sort((a,b)=>a.followUpDate.localeCompare(b.followUpDate));
  const upcoming=followups.slice(0,6);
  if(upcoming.length){
    document.getElementById('dash-followups').innerHTML=upcoming.map(c=>{
      const cls=c.followUpDate<today?'overdue':c.followUpDate===today?'today':'upcoming';
      const label=c.followUpDate<today?'OVERDUE':c.followUpDate===today?'TODAY':formatDate(c.followUpDate);
      return `<div class="followup-item ${cls}" style="cursor:pointer" onclick="editContact('${c.id}')">
        <span style="flex:1"><strong>${esc(c.company)}</strong> â€” ${esc(c.ownerName)}</span>
        <span class="tag tag-${STAGE_COLORS[c.status]||'blue'}">${c.status}</span>
        <span style="font-size:11px;font-weight:600;color:${cls==='overdue'?'var(--red)':cls==='today'?'var(--gold)':'var(--text-2)'}">${label}</span>
      </div>`;
    }).join('');
  }else{
    document.getElementById('dash-followups').innerHTML='<p style="color:var(--text-3);font-size:13px">No follow-ups scheduled. Add follow-up dates to your contacts.</p>';
  }

  // Today's outreach
  const todayActs=data.activities.filter(a=>a.date===today);
  const actTotals={};
  todayActs.forEach(a=>{actTotals[a.type]=(actTotals[a.type]||0)+a.count});
  const targetTypes=['Cold Email','Call','LinkedIn','Follow-up'];
  document.getElementById('dash-outreach').innerHTML=targetTypes.map(t=>{
    const done=actTotals[t]||0;
    const goal=DAILY_TARGETS[t]||0;
    const pct=goal>0?Math.min(100,Math.round((done/goal)*100)):0;
    const color=pct>=100?'var(--green)':pct>=50?'var(--gold)':'var(--red)';
    return `<div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px">
        <span>${t}</span><span style="font-weight:600;color:${color}">${done}/${goal}</span>
      </div>
      <div class="prog"><div class="prog-fill" style="width:${pct}%;background:${color}"></div></div>
    </div>`;
  }).join('');

  // 50-client goal
  const pct=Math.min(100,Math.round((clients/50)*100));
  document.getElementById('dash-goal-pct').textContent=pct+'%';
  document.getElementById('dash-goal-bar').style.width=pct+'%';
  document.getElementById('dash-goal-clients').textContent=clients+' / 50 clients';
  document.getElementById('dash-goal-deadline').textContent=daysLeft+' days remaining';
}

// ===== CONTACTS =====
function renderContacts(){
  const search=(document.getElementById('contact-search').value||'').toLowerCase();
  const filterStatus=document.getElementById('contact-filter-status').value;
  const filterSource=document.getElementById('contact-filter-source').value;

  let list=[...data.contacts];
  if(search) list=list.filter(c=>(c.company+' '+c.ownerName+' '+c.email+' '+(c.state||'')).toLowerCase().includes(search));
  if(filterStatus==='Bad Email') list=list.filter(c=>c.badEmail);
  else if(filterStatus!=='all') list=list.filter(c=>c.status===filterStatus);
  if(filterSource!=='all') list=list.filter(c=>c.source===filterSource);

  list.sort((a,b)=>{
    const order=STAGES.indexOf(a.status)-STAGES.indexOf(b.status);
    if(order!==0)return order;
    return(b.lastContact||'').localeCompare(a.lastContact||'');
  });

  if(!list.length){
    document.getElementById('contacts-table').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-3)">No contacts found.</div>';
    return;
  }

  document.getElementById('contacts-table').innerHTML=`
    <table class="tbl">
      <thead><tr>
        <th>Company</th><th>Email</th><th>Phone</th><th>Stage</th><th>Industry</th><th>Location</th><th>Crew</th><th>MRR</th><th>Follow-up</th><th></th>
      </tr></thead>
      <tbody>${list.map(c=>{
        const rev=contactRevenue(c);
        const today=todayStr();
        const fuClass=c.followUpDate?(c.followUpDate<today?'color:var(--red)':c.followUpDate===today?'color:var(--gold)':''):'';
        return `<tr class="${c.badEmail?'bad-email-row':''}">
          <td><div class="company">${esc(c.company)}</div><div class="owner">${esc(c.ownerName)}</div></td>
          <td class="copyable" style="font-size:12px" onclick="copyCell(this)">${c.email?esc(c.email):'â€”'}${c.badEmail?' <span class="tag tag-bad-email" style="margin-left:4px;font-size:9px">BAD</span>':''}</td>
          <td class="copyable" style="font-size:12px" onclick="copyCell(this)">${c.phone?esc(c.phone):'â€”'}</td>
          <td><span class="tag tag-${STAGE_COLORS[c.status]||'blue'}">${c.status}</span></td>
          <td style="font-size:12px">${c.industry||'â€”'}</td>
          <td style="font-size:12px">${c.state?esc(c.state):'â€”'}</td>
          <td>${c.crewSize||'â€”'}</td>
          <td style="font-weight:600;color:var(--green)">${rev?formatMoney(rev)+'/mo':'â€”'}</td>
          <td style="font-size:12px;${fuClass}">${c.followUpDate?formatDate(c.followUpDate):'â€”'}</td>
          <td style="white-space:nowrap"><button class="flag-btn ${c.badEmail?'flagged':''}" onclick="toggleBadEmail('${c.id}')" title="${c.badEmail?'Unflag bad email':'Flag as bad email'}">&#128681;</button><button class="btn btn-ghost btn-sm" onclick="openQuickEmail('${c.id}')" title="Quick Email" style="padding:4px 6px">&#9993;</button><button class="btn btn-ghost btn-sm" onclick="editContact('${c.id}')">Edit</button></td>
        </tr>`;
      }).join('')}</tbody>
    </table>
  `;
}

function toggleBadEmail(id){
  const c=data.contacts.find(x=>x.id===id);
  if(!c)return;
  c.badEmail=!c.badEmail;
  saveData(data);renderContacts();renderDashboard();
}

function openContactModal(contactId){
  document.getElementById('contact-modal-title').textContent=contactId?'Edit Contact':'Add Contact';
  document.getElementById('ct-id').value=contactId||'';
  if(contactId){
    const c=data.contacts.find(x=>x.id===contactId);
    if(!c)return;
    document.getElementById('ct-company').value=c.company||'';
    document.getElementById('ct-owner').value=c.ownerName||'';
    document.getElementById('ct-email').value=c.email||'';
    document.getElementById('ct-phone').value=c.phone||'';
    document.getElementById('ct-linkedin').value=c.linkedin||'';
    document.getElementById('ct-state').value=c.state||'';
    document.getElementById('ct-crew').value=c.crewSize||'';
    document.getElementById('ct-price').value=c.customPrice||'';
    document.getElementById('ct-industry').value=c.industry||'Lawn Care';
    document.getElementById('ct-source').value=c.source||'Cold Email';
    document.getElementById('ct-status').value=c.status||'Lead';
    document.getElementById('ct-followup').value=c.followUpDate||'';
    document.getElementById('ct-notes').value=c.notes||'';
    document.getElementById('ct-close-reason').value=c.closeReason||'';
    document.getElementById('ct-loss-reason').value=c.lossReason||'';
    document.getElementById('ct-health').value=c.health||'good';
    document.getElementById('ct-last-delivery').value=c.lastDelivery||'';
    document.getElementById('ct-next-delivery').value=c.nextDelivery||'';
    document.getElementById('ct-referrer').value=c.referrer||'';
    currentEmployees=c.employees?JSON.parse(JSON.stringify(c.employees)):[];
    renderEmployeeList();
    document.getElementById('ct-emp-section').style.display='block';
    document.getElementById('ct-delete-btn').style.display='inline-flex';
    renderContactEmailHistory(contactId);
  }else{
    ['ct-company','ct-owner','ct-email','ct-phone','ct-linkedin','ct-state','ct-notes','ct-referrer'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('ct-crew').value='';
    document.getElementById('ct-price').value='';
    document.getElementById('ct-industry').value='Lawn Care';
    document.getElementById('ct-source').value='Cold Email';
    document.getElementById('ct-status').value='Lead';
    document.getElementById('ct-followup').value='';
    document.getElementById('ct-close-reason').value='';
    document.getElementById('ct-loss-reason').value='';
    document.getElementById('ct-health').value='good';
    document.getElementById('ct-last-delivery').value='';
    document.getElementById('ct-next-delivery').value='';
    currentEmployees=[];
    renderEmployeeList();
    document.getElementById('ct-emp-section').style.display='block';
    document.getElementById('ct-delete-btn').style.display='none';
    document.getElementById('ct-email-history').style.display='none';
    document.getElementById('ct-email-history-list').innerHTML='';
  }
  updateContactModalFields();
  openModal('contact-modal');
}

function updateContactModalFields(){
  const status=document.getElementById('ct-status').value;
  document.getElementById('ct-close-reason-wrap').style.display=status==='Closed'?'block':'none';
  document.getElementById('ct-loss-reason-wrap').style.display=(status==='Lost'||status==='Churned')?'block':'none';
  document.getElementById('ct-health-wrap').style.display=status==='Closed'?'block':'none';
  document.getElementById('ct-delivery-wrap').style.display=status==='Closed'?'grid':'none';
  document.getElementById('ct-referrer-wrap').style.display=(status==='Closed'||status==='Lead')?'block':'none';
}

// Listen for status changes to show/hide conditional fields
document.getElementById('ct-status').addEventListener('change',updateContactModalFields);

function copyCell(td){
  var text=td.textContent.trim();
  if(!text||text==='â€”')return;
  navigator.clipboard.writeText(text).then(function(){
    var toast=document.getElementById('copied-toast');
    toast.textContent='Copied: '+text;
    toast.style.opacity='1';
    clearTimeout(toast._t);
    toast._t=setTimeout(function(){toast.style.opacity='0'},1500);
  });
}

function showToast(msg){
  var toast=document.getElementById('copied-toast');
  toast.textContent=msg;
  toast.style.opacity='1';
  clearTimeout(toast._t);
  toast._t=setTimeout(function(){toast.style.opacity='0'},1500);
}

function renderContactEmailHistory(contactId){
  var sends=(data.emailSends||[]).filter(function(s){return s.contactId===contactId});
  var section=document.getElementById('ct-email-history');
  var list=document.getElementById('ct-email-history-list');
  if(!sends.length){
    section.style.display='none';
    list.innerHTML='';
    return;
  }
  section.style.display='block';
  sends.sort(function(a,b){return b.date>a.date?1:-1});
  var html='';
  sends.forEach(function(s){
    html+='<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;font-size:12px">'
      +'<span style="color:var(--green);font-size:14px">&#9993;</span>'
      +'<span style="font-weight:600;flex:1">'+esc(s.template)+'</span>'
      +'<span style="color:var(--text-3)">'+s.date+'</span>'
      +'<span class="tag tag-'+(s.replied?'green':'blue')+'" style="font-size:10px">'+(s.replied?'Replied':'Sent')+'</span>'
      +'</div>';
  });
  list.innerHTML=html;
}

function editContact(id){openContactModal(id)}

function saveContact(){
  const company=document.getElementById('ct-company').value.trim();
  if(!company)return;
  const id=document.getElementById('ct-id').value;
  const status=document.getElementById('ct-status').value;
  const obj={
    company,
    ownerName:document.getElementById('ct-owner').value.trim(),
    email:document.getElementById('ct-email').value.trim(),
    phone:document.getElementById('ct-phone').value.trim(),
    linkedin:document.getElementById('ct-linkedin').value.trim(),
    state:document.getElementById('ct-state').value.trim(),
    crewSize:parseInt(document.getElementById('ct-crew').value)||0,
    customPrice:parseInt(document.getElementById('ct-price').value)||0,
    industry:document.getElementById('ct-industry').value,
    source:document.getElementById('ct-source').value,
    status,
    followUpDate:document.getElementById('ct-followup').value,
    notes:document.getElementById('ct-notes').value.trim(),
    lastContact:todayStr(),
    closeReason:status==='Closed'?document.getElementById('ct-close-reason').value:'',
    lossReason:(status==='Lost'||status==='Churned')?document.getElementById('ct-loss-reason').value:'',
    health:status==='Closed'?document.getElementById('ct-health').value:'',
    lastDelivery:status==='Closed'?document.getElementById('ct-last-delivery').value:'',
    nextDelivery:status==='Closed'?document.getElementById('ct-next-delivery').value:'',
    referrer:document.getElementById('ct-referrer').value.trim(),
    employees:currentEmployees
  };
  if(id){
    const idx=data.contacts.findIndex(c=>c.id===id);
    if(idx>=0) data.contacts[idx]={...data.contacts[idx],...obj};
  }else{
    data.contacts.push({id:uid(),...obj,createdAt:todayStr()});
  }
  saveData(data);
  closeModal('contact-modal');
  // Re-render whichever view is active
  document.querySelectorAll('.view.active').forEach(v=>{
    const viewName=v.id.replace('view-','');
    const fn={dashboard:renderDashboard,contacts:renderContacts,pipeline:renderPipeline,revenue:renderRevenue,clients:renderClients};
    if(fn[viewName])fn[viewName]();
  });
}

function deleteContact(){
  const id=document.getElementById('ct-id').value;
  if(!id||!confirm('Delete this contact permanently?'))return;
  data.contacts=data.contacts.filter(c=>c.id!==id);
  saveData(data);
  closeModal('contact-modal');
  renderContacts();
}

// ===== CSV IMPORT =====
var importRows=[];
var importHeaders=[];

var IMPORT_FIELDS=[
  {key:'company',label:'Company Name',match:['company','business','name']},
  {key:'ownerName',label:'Owner Name',match:['owner','contact','first','name','full']},
  {key:'email',label:'Email',match:['email','e-mail']},
  {key:'phone',label:'Phone',match:['phone','tel','mobile','cell']},
  {key:'linkedin',label:'LinkedIn',match:['linkedin','li']},
  {key:'state',label:'City / State',match:['state','city','location','address']},
  {key:'crewSize',label:'Crew Size',match:['crew','size','employees','team']},
  {key:'industry',label:'Industry',match:['industry','type','sector']},
  {key:'source',label:'Source',match:['source','channel','how','origin']},
  {key:'status',label:'Pipeline Stage',match:['status','stage','pipeline']},
  {key:'notes',label:'Notes',match:['notes','comments','description','details']},
  {key:'followUpDate',label:'Follow-up Date',match:['follow','followup','follow-up']},
  {key:'customPrice',label:'Monthly Price',match:['price','rate','monthly','revenue','mrr']}
];

function openImportModal(){
  importRows=[];
  importHeaders=[];
  document.getElementById('import-step-upload').style.display='block';
  document.getElementById('import-step-map').style.display='none';
  document.getElementById('import-btn').style.display='none';
  document.getElementById('import-file').value='';
  openModal('import-modal');
}

function closeImportModal(){
  closeModal('import-modal');
}

// Drag-and-drop
(function(){
  var drop=document.getElementById('import-drop');
  drop.addEventListener('dragover',function(e){e.preventDefault();drop.classList.add('dragover')});
  drop.addEventListener('dragleave',function(){drop.classList.remove('dragover')});
  drop.addEventListener('drop',function(e){
    e.preventDefault();
    drop.classList.remove('dragover');
    if(e.dataTransfer.files.length){
      handleImportFile({files:e.dataTransfer.files});
    }
  });
})();

function handleImportFile(input){
  var file=input.files[0];
  if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){
    parseCSV(e.target.result);
  };
  reader.readAsText(file);
}

function parseCSV(text){
  var lines=text.split(/\r?\n/).filter(function(l){return l.trim()});
  if(lines.length<2){alert('CSV needs at least a header row and one data row.');return;}
  importHeaders=parseCSVLine(lines[0]);
  importRows=[];
  for(var i=1;i<lines.length;i++){
    var vals=parseCSVLine(lines[i]);
    if(vals.length&&vals.some(function(v){return v.trim()})){
      importRows.push(vals);
    }
  }
  if(!importRows.length){alert('No data rows found in CSV.');return;}
  document.getElementById('import-step-upload').style.display='none';
  document.getElementById('import-step-map').style.display='block';
  document.getElementById('import-btn').style.display='inline-flex';
  buildImportMapping();
  renderImportPreview();
}

function parseCSVLine(line){
  var result=[];
  var current='';
  var inQuotes=false;
  for(var i=0;i<line.length;i++){
    var ch=line[i];
    if(inQuotes){
      if(ch==='"'&&i+1<line.length&&line[i+1]==='"'){
        current+='"';i++;
      }else if(ch==='"'){
        inQuotes=false;
      }else{
        current+=ch;
      }
    }else{
      if(ch==='"'){inQuotes=true;}
      else if(ch===','){result.push(current);current='';}
      else{current+=ch;}
    }
  }
  result.push(current);
  return result;
}

function guessMapping(header){
  var h=header.toLowerCase().replace(/[^a-z0-9]/g,' ');
  for(var i=0;i<IMPORT_FIELDS.length;i++){
    var f=IMPORT_FIELDS[i];
    for(var j=0;j<f.match.length;j++){
      if(h.indexOf(f.match[j])>=0) return f.key;
    }
  }
  return '';
}

function buildImportMapping(){
  var mapDiv=document.getElementById('import-map');
  mapDiv.innerHTML=importHeaders.map(function(h,i){
    var guess=guessMapping(h);
    var opts='<option value="">â€” Skip â€”</option>';
    IMPORT_FIELDS.forEach(function(f){
      opts+='<option value="'+f.key+'"'+(guess===f.key?' selected':'')+'>'+f.label+'</option>';
    });
    return '<div><label>'+esc(h)+'</label><select id="imp-col-'+i+'" onchange="renderImportPreview()">'+opts+'</select></div>';
  }).join('');
  document.getElementById('import-stats').innerHTML='<span>Found <strong>'+importRows.length+'</strong> rows</span><span>'+importHeaders.length+' columns</span>';
}

function getColumnMapping(){
  var mapping={};
  importHeaders.forEach(function(h,i){
    var sel=document.getElementById('imp-col-'+i);
    if(sel&&sel.value) mapping[i]=sel.value;
  });
  return mapping;
}

function renderImportPreview(){
  var mapping=getColumnMapping();
  var mappedKeys=Object.values(mapping);
  if(!mappedKeys.length){
    document.getElementById('import-preview').innerHTML='<p style="color:var(--text-3);font-size:12px;text-align:center;padding:20px">Map at least one column to see preview</p>';
    return;
  }
  var cols=[];
  for(var i=0;i<importHeaders.length;i++){
    if(mapping[i]) cols.push({idx:i,key:mapping[i],label:IMPORT_FIELDS.find(function(f){return f.key===mapping[i]}).label});
  }
  var preview=importRows.slice(0,10);
  var html='<table><thead><tr>'+cols.map(function(c){return '<th>'+esc(c.label)+'</th>'}).join('')+'</tr></thead><tbody>';
  preview.forEach(function(row){
    html+='<tr>'+cols.map(function(c){return '<td>'+esc(row[c.idx]||'')+'</td>'}).join('')+'</tr>';
  });
  html+='</tbody></table>';
  if(importRows.length>10) html+='<p style="font-size:11px;color:var(--text-3);text-align:center;padding:8px">Showing 10 of '+importRows.length+' rows</p>';
  document.getElementById('import-preview').innerHTML=html;
}

function executeImport(){
  var mapping=getColumnMapping();
  var mappedKeys=Object.values(mapping);
  if(!mappedKeys.length){alert('Map at least one column before importing.');return;}
  if(!mappedKeys.includes('company')&&!mappedKeys.includes('ownerName')){
    alert('Please map at least a Company Name or Owner Name column.');return;
  }
  var updateExisting=document.getElementById('import-update').checked;
  var count=0;
  var updated=0;
  var skipped=0;
  importRows.forEach(function(row){
    var obj={};
    for(var i in mapping){
      var key=mapping[i];
      var val=(row[i]||'').trim();
      if(key==='crewSize'||key==='customPrice'){
        obj[key]=parseInt(val)||0;
      }else{
        obj[key]=val;
      }
    }
    if(!obj.company&&!obj.ownerName) return;
    // Check for existing contact by company name
    var existing=obj.company?data.contacts.find(function(c){return c.company.toLowerCase()===obj.company.toLowerCase()}):null;
    if(existing){
      if(updateExisting){
        // Merge new data into existing, keeping fields that aren't in the CSV
        for(var key in obj){
          if(obj[key]) existing[key]=obj[key];
        }
        updated++;
      }else{
        skipped++;
      }
      return;
    }
    // Default values for new contacts
    if(!obj.status) obj.status='Lead';
    if(!obj.source) obj.source='Other';
    if(!obj.industry) obj.industry='Lawn Care';
    obj.id=uid();
    obj.createdAt=todayStr();
    obj.lastContact=todayStr();
    if(!obj.employees) obj.employees=[];
    data.contacts.push(obj);
    count++;
  });
  saveData(data);
  closeImportModal();
  renderContacts();
  var parts=[];
  if(count) parts.push(count+' new contact'+(count!==1?'s':'')+' imported');
  if(updated) parts.push(updated+' existing contact'+(updated!==1?'s':'')+' updated');
  if(skipped) parts.push(skipped+' duplicate'+(skipped!==1?'s':'')+' skipped');
  alert(parts.join(', ')+'!');
}

// ===== EMPLOYEE CONTACTS =====
var currentEmployees=[];

function renderEmployeeList(){
  var el=document.getElementById('ct-emp-list');
  if(!currentEmployees.length){
    el.innerHTML='<div style="font-size:12px;color:var(--text-3);padding:6px 0">No employees added yet.</div>';
    return;
  }
  el.innerHTML=currentEmployees.map(function(e,i){
    return '<div class="emp-row">'
      +'<span class="emp-name">'+esc(e.name)+'</span>'
      +'<span class="emp-role">'+esc(e.role||'â€”')+'</span>'
      +'<span class="emp-lang">'+esc(e.language)+'</span>'
      +'<span class="emp-phone">'+esc(e.phone||'â€”')+'</span>'
      +'<button class="emp-del" onclick="removeEmployee('+i+')">&times;</button>'
      +'</div>';
  }).join('');
}

function toggleEmpForm(){
  var form=document.getElementById('ct-emp-form');
  form.style.display=form.style.display==='none'?'block':'none';
  if(form.style.display==='block'){
    document.getElementById('emp-name').value='';
    document.getElementById('emp-role').value='';
    document.getElementById('emp-phone').value='';
    document.getElementById('emp-lang').value='English';
  }
}

function addEmployee(){
  var name=document.getElementById('emp-name').value.trim();
  if(!name)return;
  currentEmployees.push({
    id:uid(),
    name:name,
    role:document.getElementById('emp-role').value.trim(),
    phone:document.getElementById('emp-phone').value.trim(),
    language:document.getElementById('emp-lang').value
  });
  renderEmployeeList();
  toggleEmpForm();
}

function removeEmployee(idx){
  currentEmployees.splice(idx,1);
  renderEmployeeList();
}

// ===== PIPELINE =====
function renderPipeline(){
  renderFunnel();
  const activeStages=['Lead','Contacted','Replied','Call Scheduled','Proposal Sent','Closed','Lost'];
  document.getElementById('pipeline-board').innerHTML=activeStages.map(stage=>{
    const contacts=data.contacts.filter(c=>c.status===stage);
    return `
      <div class="pipe-col">
        <div class="pipe-col-head">
          <span style="color:var(--${STAGE_COLORS[stage]||'blue'})">${stage}</span>
          <span class="pipe-col-count">${contacts.length}</span>
        </div>
        ${contacts.map(c=>{
          const rev=contactRevenue(c);
          return `<div class="pipe-card" onclick="editContact('${c.id}')">
            <div class="pipe-card-company">${esc(c.company)}</div>
            <div class="pipe-card-owner">${esc(c.ownerName)}</div>
            <div class="pipe-card-crew">${c.crewSize||'?'} crew &middot; ${c.source||''}</div>
            ${rev?`<div class="pipe-card-rev">${formatMoney(rev)}/mo</div>`:''}
          </div>`;
        }).join('')}
      </div>
    `;
  }).join('');
}

// ===== ACTIVITY =====
function renderActivity(){
  const today=todayStr();
  const todayActs=data.activities.filter(a=>a.date===today);
  const actTotals={};
  todayActs.forEach(a=>{actTotals[a.type]=(actTotals[a.type]||0)+a.count});

  document.getElementById('activity-targets').innerHTML=Object.entries(DAILY_TARGETS).map(([type,goal])=>{
    const done=actTotals[type]||0;
    const pct=Math.min(100,Math.round((done/goal)*100));
    const color=pct>=100?'var(--green)':pct>=50?'var(--gold)':'var(--text-3)';
    return `<div class="target-card">
      <div class="target-current" style="color:${color}">${done}</div>
      <div class="target-goal">of ${goal} target</div>
      <div class="target-label">${type}</div>
      <div class="prog" style="margin-top:8px"><div class="prog-fill" style="width:${pct}%;background:${color}"></div></div>
    </div>`;
  }).join('');

  const recent=[...data.activities].sort((a,b)=>b.date.localeCompare(a.date)||(b.id||'').localeCompare(a.id||'')).slice(0,30);
  if(recent.length){
    document.getElementById('activity-list').innerHTML=recent.map(a=>`
      <div class="activity-row">
        <span class="activity-date">${formatDate(a.date)}</span>
        <span class="activity-type"><span class="tag tag-${a.type==='Cold Email'?'blue':a.type==='Call'?'green':a.type==='LinkedIn'?'contacted':a.type==='Meeting'?'gold':'teal'}">${a.type}</span></span>
        <span class="activity-notes">${esc(a.notes||'')}</span>
        <span class="activity-count">Ã—${a.count}</span>
        <button class="btn btn-ghost btn-sm" onclick="deleteActivity('${a.id}')" style="color:var(--red)">&times;</button>
      </div>
    `).join('');
  }else{
    document.getElementById('activity-list').innerHTML='<p style="color:var(--text-3);font-size:13px;padding:20px;text-align:center">No activity logged yet. Start tracking your daily outreach.</p>';
  }
}

function openActivityModal(){
  document.getElementById('act-type').value='Cold Email';
  document.getElementById('act-count').value=1;
  document.getElementById('act-notes').value='';
  document.getElementById('act-date').value=todayStr();
  openModal('activity-modal');
}

function saveActivity(){
  const count=parseInt(document.getElementById('act-count').value)||0;
  if(count<1)return;
  data.activities.push({
    id:uid(),
    type:document.getElementById('act-type').value,
    count,
    notes:document.getElementById('act-notes').value.trim(),
    date:document.getElementById('act-date').value||todayStr()
  });
  saveData(data);
  closeModal('activity-modal');
  renderActivity();
}

function deleteActivity(id){
  data.activities=data.activities.filter(a=>a.id!==id);
  saveData(data);
  renderActivity();
}

// ===== REVENUE =====
function renderRevenue(){
  const mrr=getMRR();
  const arr=mrr*12;
  const clients=closedContacts();
  const avgRev=clients.length?Math.round(mrr/clients.length):0;
  const goalMRR=17500;
  const pctGoal=Math.min(100,Math.round((mrr/goalMRR)*100));

  document.getElementById('revenue-kpis').innerHTML=`
    <div class="kpi"><div class="kpi-value" style="color:var(--green)">${formatMoney(mrr)}</div><div class="kpi-label">Monthly (MRR)</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--teal)">${formatMoney(arr)}</div><div class="kpi-label">Annual (ARR)</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--gold)">${formatMoney(avgRev)}</div><div class="kpi-label">Avg per Client</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--blue)">${Math.round(mrr*0.7)>0?formatMoney(Math.round(mrr*0.7)):'$0'}</div><div class="kpi-label">Est. Gross Profit</div><div class="kpi-sub">~70% margin</div></div>
  `;

  document.getElementById('revenue-goal').innerHTML=`
    <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px">
      <span>MRR Progress</span>
      <span style="font-weight:700;color:var(--green)">${formatMoney(mrr)} / ${formatMoney(goalMRR)}</span>
    </div>
    <div class="prog" style="height:14px"><div class="prog-fill" style="width:${pctGoal}%;background:linear-gradient(90deg,var(--green),var(--teal))"></div></div>
    <div style="font-size:12px;color:var(--text-3);margin-top:6px">${pctGoal}% of $17,500 target at 50 clients</div>
  `;

  if(clients.length){
    document.getElementById('revenue-clients').innerHTML=clients.sort((a,b)=>contactRevenue(b)-contactRevenue(a)).map(c=>{
      const rev=contactRevenue(c);
      return `<div class="client-row">
        <div>
          <div class="client-name">${esc(c.company)}</div>
          <div class="client-owner">${esc(c.ownerName)} &middot; ${c.crewSize} crew</div>
        </div>
        <div class="client-rev">${formatMoney(rev)}/mo</div>
      </div>`;
    }).join('');
  }else{
    document.getElementById('revenue-clients').innerHTML='<p style="color:var(--text-3);font-size:13px;text-align:center;padding:20px">No clients yet. Close your first deal!</p>';
  }
}

// ===== ACTIVE CLIENTS =====
function renderClients(){
  const clients=closedContacts();
  if(!clients.length){
    document.getElementById('clients-list').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-3)"><p>No active clients yet. Keep pushing the pipeline.</p></div>';
    return;
  }

  document.getElementById('clients-list').innerHTML=`
    <div class="kpi-grid" style="margin-bottom:20px">
      <div class="kpi"><div class="kpi-value" style="color:var(--green)">${clients.length}</div><div class="kpi-label">Active Clients</div></div>
      <div class="kpi"><div class="kpi-value" style="color:var(--teal)">${clients.reduce((s,c)=>s+(c.crewSize||0),0)}</div><div class="kpi-label">Total Crew</div></div>
      <div class="kpi"><div class="kpi-value" style="color:var(--gold)">${formatMoney(getMRR())}</div><div class="kpi-label">MRR</div></div>
    </div>
    ${clients.map(c=>{
      const rev=contactRevenue(c);
      return `<div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:15px;font-weight:600">${esc(c.company)}</div>
          <div style="font-size:12px;color:var(--text-2);margin-top:2px">${esc(c.ownerName)} &middot; ${c.crewSize} crew &middot; ${c.industry}</div>
          <div style="font-size:11px;color:var(--text-3);margin-top:2px">${c.email||''} ${c.phone?'&middot; '+c.phone:''}</div>
          ${c.notes?`<div style="font-size:12px;color:var(--text-3);margin-top:4px;font-style:italic">${esc(c.notes)}</div>`:''}
        </div>
        <div style="text-align:right">
          <div style="font-size:20px;font-weight:700;color:var(--green)">${formatMoney(rev)}/mo</div>
          <button class="btn btn-ghost btn-sm" onclick="editContact('${c.id}')" style="margin-top:6px">Edit</button>
        </div>
      </div>`;
    }).join('')}
  `;
}

// ===== ROADMAP =====
function renderRoadmap(){
  const clients=closedContacts().length;
  const daysLeft=Math.max(0,Math.ceil((TARGET_DATE-new Date())/(1000*60*60*24)));
  const pct=Math.min(100,Math.round((clients/50)*100));

  document.getElementById('roadmap-days').textContent=daysLeft+' days to August 31, 2026';
  document.getElementById('roadmap-current').textContent=clients;
  document.getElementById('roadmap-bar').style.width=pct+'%';

  const monthLabels=['','Month 1: Foundation','Month 2: Build Proof','Month 3: Content Engine','Month 4: Partnerships','Month 5: Optimize','Month 6: Hit 50'];
  const monthTargets=['','5 clients','10 clients','18 clients','28 clients','38 clients','50 clients'];

  const grouped={};
  (data.roadmapItems||[]).forEach(r=>{
    if(!grouped[r.month])grouped[r.month]=[];
    grouped[r.month].push(r);
  });

  document.getElementById('roadmap-list').innerHTML=[1,2,3,4,5,6].map(m=>{
    const items=grouped[m]||[];
    const done=items.filter(i=>i.done).length;
    const total=items.length;
    const mpct=total?Math.round((done/total)*100):0;
    return `<div class="roadmap-month">
      <h3>
        <span>${monthLabels[m]||'Month '+m}</span>
        <span style="font-size:11px;font-weight:500;color:var(--text-3);margin-left:auto">${done}/${total}</span>
      </h3>
      ${items.map(item=>`
        <div class="roadmap-item">
          <div class="roadmap-check ${item.done?'done':''}" onclick="toggleRoadmap('${item.id}')">&#10003;</div>
          <span style="${item.done?'text-decoration:line-through;color:var(--text-3)':''}">${esc(item.title)}</span>
        </div>
      `).join('')}
    </div>`;
  }).join('');
}

function toggleRoadmap(id){
  const item=(data.roadmapItems||[]).find(r=>r.id===id);
  if(item){item.done=!item.done;saveData(data);renderRoadmap();}
}

// ===== OUTREACH STREAK =====
function calcOutreachStreak(){
  // Count consecutive days where at least 2 of 3 core targets were hit (email, call, linkedin)
  let streak=0;
  const d=new Date();
  while(true){
    const ds=d.toISOString().split('T')[0];
    const dayActs=data.activities.filter(a=>a.date===ds);
    const totals={};
    dayActs.forEach(a=>{totals[a.type]=(totals[a.type]||0)+a.count});
    // Check if they hit at least 2 core targets at 50%+
    const coreHits=[
      (totals['Cold Email']||0)>=Math.floor(DAILY_TARGETS['Cold Email']*0.5),
      (totals['Call']||0)>=Math.floor(DAILY_TARGETS['Call']*0.5),
      (totals['LinkedIn']||0)>=Math.floor(DAILY_TARGETS['LinkedIn']*0.5)
    ].filter(Boolean).length;
    if(coreHits>=2){
      streak++;
      d.setDate(d.getDate()-1);
    }else{
      // If today and no activity yet, check yesterday
      if(streak===0&&ds===todayStr()){d.setDate(d.getDate()-1);continue;}
      break;
    }
  }
  return streak;
}

// ===== CONVERSION FUNNEL (on pipeline render) =====
function renderFunnel(){
  const funnelStages=['Lead','Contacted','Replied','Call Scheduled','Proposal Sent','Closed'];
  const funnelColors=['var(--blue)','var(--purple)','var(--teal)','var(--orange)','var(--gold)','var(--green)'];
  const counts=funnelStages.map(s=>data.contacts.filter(c=>STAGES.indexOf(c.status)>=STAGES.indexOf(s)&&c.status!=='Lost'&&c.status!=='Churned').length);
  // Actually, for a proper funnel, count how many contacts have EVER been in or past each stage
  // Since we don't track history, we'll count current contacts at or beyond each stage
  const maxCount=Math.max(...counts,1);

  document.getElementById('pipeline-funnel').innerHTML=funnelStages.map((stage,i)=>{
    const count=counts[i];
    const widthPct=Math.max(10,Math.round((count/maxCount)*100));
    const convPct=i>0&&counts[i-1]>0?Math.round((count/counts[i-1])*100):100;
    const funnelColor=convPct>=50?'var(--green)':'var(--red)';
    const funnelSpan=i>0?' <span class="funnel-pct" style="color:'+funnelColor+'">'+convPct+'%</span>':'';
    return `<div class="funnel-step">
      <div class="funnel-bar" style="width:${widthPct}%;background:${funnelColors[i]}">${count}</div>
      <div class="funnel-meta">${stage}${funnelSpan}</div>
    </div>`;
  }).join('');
}

// ===== WIN / LOSS =====
function renderWinLoss(){
  const wins=data.contacts.filter(c=>c.status==='Closed');
  const losses=data.contacts.filter(c=>c.status==='Lost'||c.status==='Churned');
  const total=wins.length+losses.length;
  const closeRate=total>0?Math.round((wins.length/total)*100):0;

  document.getElementById('wl-kpis').innerHTML=`
    <div class="kpi"><div class="kpi-value" style="color:var(--green)">${wins.length}</div><div class="kpi-label">Deals Won</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--red)">${losses.length}</div><div class="kpi-label">Deals Lost</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--blue)">${closeRate}%</div><div class="kpi-label">Close Rate</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--gold)">${total}</div><div class="kpi-label">Total Decisions</div></div>
  `;

  // Win reasons
  const winReasons={};
  wins.forEach(c=>{const r=c.closeReason||'Not documented';winReasons[r]=(winReasons[r]||0)+1});
  const winEntries=Object.entries(winReasons).sort((a,b)=>b[1]-a[1]);
  document.getElementById('wl-wins').innerHTML=winEntries.length?winEntries.map(([reason,count])=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:13px">${esc(reason)}</span>
      <span style="font-weight:700;color:var(--green);font-size:14px">${count}</span>
    </div>
  `).join(''):'<p style="color:var(--text-3);font-size:13px">No wins documented yet. When you close a deal, select why they said yes.</p>';

  // Loss reasons
  const lossReasons={};
  losses.forEach(c=>{const r=c.lossReason||'Not documented';lossReasons[r]=(lossReasons[r]||0)+1});
  const lossEntries=Object.entries(lossReasons).sort((a,b)=>b[1]-a[1]);
  document.getElementById('wl-losses').innerHTML=lossEntries.length?lossEntries.map(([reason,count])=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:13px">${esc(reason)}</span>
      <span style="font-weight:700;color:var(--red);font-size:14px">${count}</span>
    </div>
  `).join(''):'<p style="color:var(--text-3);font-size:13px">No losses documented yet. When you lose a deal, select why they said no.</p>';

  // All closed/lost deals
  const allDeals=[...wins.map(c=>({...c,outcome:'Won'})),...losses.map(c=>({...c,outcome:'Lost'}))].sort((a,b)=>(b.lastContact||'').localeCompare(a.lastContact||''));
  document.getElementById('wl-list').innerHTML=allDeals.length?allDeals.map(c=>{
    const isWin=c.outcome==='Won';
    const reason=isWin?c.closeReason:c.lossReason;
    return `<div class="wl-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <span style="font-weight:600;font-size:14px">${esc(c.company)}</span>
          <span style="font-size:12px;color:var(--text-2);margin-left:8px">${esc(c.ownerName)} &middot; ${c.crewSize||'?'} crew</span>
        </div>
        <span class="tag tag-${isWin?'closed':'lost'}">${c.outcome}</span>
      </div>
      ${reason?`<div style="margin-top:6px"><span class="wl-reason" style="background:${isWin?'rgba(76,175,80,.1);color:var(--green)':'rgba(239,68,68,.1);color:var(--red)'}">${esc(reason)}</span></div>`:''}
      ${c.notes?`<div style="margin-top:6px;font-size:12px;color:var(--text-3);font-style:italic">${esc(c.notes)}</div>`:''}
    </div>`;
  }).join(''):'<p style="color:var(--text-3);font-size:13px;text-align:center;padding:20px">No closed or lost deals yet.</p>';
}

// ===== WEEKLY REVIEW =====
function renderWeekly(){
  const reviews=[...(data.weeklyReviews||[])].sort((a,b)=>b.date.localeCompare(a.date));
  if(!reviews.length){
    document.getElementById('weekly-list').innerHTML=`<div style="text-align:center;padding:40px;color:var(--text-3)">
      <p style="font-size:14px;margin-bottom:8px">No weekly reviews yet.</p>
      <p style="font-size:12px">Do a review every Sunday night. Reflect on what worked, what didn't, and what you're changing. This is how you iterate faster than everyone else.</p>
    </div>`;
    return;
  }

  document.getElementById('weekly-list').innerHTML=reviews.map(r=>{
    const energyColor=r.energy>=7?'var(--green)':r.energy>=4?'var(--gold)':'var(--red)';
    const confColor=r.confidence>=7?'var(--green)':r.confidence>=4?'var(--gold)':'var(--red)';
    return `<div class="review-card">
      <div style="display:flex;align-items:flex-start;gap:12px">
        <div class="review-score" style="color:${energyColor}">${r.energy}<span style="font-size:12px;color:var(--text-3)">/10</span></div>
        <div style="flex:1">
          <div class="review-week">Week of ${formatDate(r.date)}</div>
          <div class="review-stats">
            <div class="review-stat">Energy: <strong style="color:${energyColor}">${r.energy}/10</strong></div>
            <div class="review-stat">Confidence: <strong style="color:${confColor}">${r.confidence}/10</strong></div>
          </div>
          ${r.worked?`<div style="margin-bottom:8px"><div style="font-size:11px;font-weight:700;color:var(--green);margin-bottom:2px">WHAT WORKED</div><div class="review-text">${esc(r.worked)}</div></div>`:''}
          ${r.didnt?`<div style="margin-bottom:8px"><div style="font-size:11px;font-weight:700;color:var(--red);margin-bottom:2px">WHAT DIDN'T</div><div class="review-text">${esc(r.didnt)}</div></div>`:''}
          ${r.changing?`<div><div style="font-size:11px;font-weight:700;color:var(--blue);margin-bottom:2px">CHANGING NEXT WEEK</div><div class="review-text">${esc(r.changing)}</div></div>`:''}
        </div>
        <button class="btn btn-ghost btn-sm" onclick="deleteReview('${r.id}')" style="color:var(--red)">&times;</button>
      </div>
    </div>`;
  }).join('');
}

function openReviewModal(){
  // Default to coming Sunday
  const today=new Date();
  const dayOfWeek=today.getDay();
  const nextSun=new Date(today);
  nextSun.setDate(today.getDate()+(7-dayOfWeek)%7);
  document.getElementById('rev-date').value=nextSun.toISOString().split('T')[0];
  document.getElementById('rev-worked').value='';
  document.getElementById('rev-didnt').value='';
  document.getElementById('rev-changing').value='';
  document.getElementById('rev-energy').value=7;
  document.getElementById('rev-confidence').value=7;
  openModal('review-modal');
}

function saveReview(){
  const date=document.getElementById('rev-date').value;
  if(!date)return;
  if(!data.weeklyReviews)data.weeklyReviews=[];
  data.weeklyReviews.push({
    id:uid(),
    date,
    worked:document.getElementById('rev-worked').value.trim(),
    didnt:document.getElementById('rev-didnt').value.trim(),
    changing:document.getElementById('rev-changing').value.trim(),
    energy:parseInt(document.getElementById('rev-energy').value)||5,
    confidence:parseInt(document.getElementById('rev-confidence').value)||5
  });
  saveData(data);
  closeModal('review-modal');
  renderWeekly();
}

function deleteReview(id){
  if(!confirm('Delete this review?'))return;
  data.weeklyReviews=(data.weeklyReviews||[]).filter(r=>r.id!==id);
  saveData(data);
  renderWeekly();
}

// ===== CONVERSION ANALYTICS =====
function renderAnalytics(){
  const contacts=data.contacts;
  const closed=contacts.filter(c=>c.status==='Closed');
  const lost=contacts.filter(c=>c.status==='Lost'||c.status==='Churned');
  const total=contacts.length;
  const replied=contacts.filter(c=>STAGES.indexOf(c.status)>=STAGES.indexOf('Replied')||c.status==='Closed'||c.status==='Lost');
  const callSched=contacts.filter(c=>STAGES.indexOf(c.status)>=STAGES.indexOf('Call Scheduled')||c.status==='Closed'||c.status==='Lost');

  // Response rate: contacted -> replied+
  const contacted=contacts.filter(c=>c.status!=='Lead');
  const responseRate=contacted.length?Math.round((replied.length/contacted.length)*100):0;

  // Call-to-close
  const hadCalls=contacts.filter(c=>STAGES.indexOf(c.status)>=STAGES.indexOf('Call Scheduled')||c.status==='Closed'||c.status==='Lost');
  const callToClose=hadCalls.length?Math.round((closed.length/hadCalls.length)*100):0;

  // Overall close rate
  const decisions=closed.length+lost.length;
  const closeRate=decisions?Math.round((closed.length/decisions)*100):0;

  // Avg deal cycle (days from createdAt to lastContact for closed deals)
  let avgCycle=0;
  if(closed.length){
    const cycles=closed.map(c=>{
      if(!c.createdAt||!c.lastContact)return 0;
      const start=new Date(c.createdAt+'T00:00:00');
      const end=new Date(c.lastContact+'T00:00:00');
      return Math.max(0,Math.round((end-start)/(1000*60*60*24)));
    }).filter(d=>d>0);
    avgCycle=cycles.length?Math.round(cycles.reduce((s,d)=>s+d,0)/cycles.length):0;
  }

  // Lost deal avg cycle
  let avgLostCycle=0;
  if(lost.length){
    const lc=lost.map(c=>{
      if(!c.createdAt||!c.lastContact)return 0;
      const start=new Date(c.createdAt+'T00:00:00');
      const end=new Date(c.lastContact+'T00:00:00');
      return Math.max(0,Math.round((end-start)/(1000*60*60*24)));
    }).filter(d=>d>0);
    avgLostCycle=lc.length?Math.round(lc.reduce((s,d)=>s+d,0)/lc.length):0;
  }

  document.getElementById('analytics-kpis').innerHTML=`
    <div class="kpi"><div class="kpi-value" style="color:var(--green)">${responseRate}%</div><div class="kpi-label">Response Rate</div><div class="kpi-sub">${replied.length} replied / ${contacted.length} contacted</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--teal)">${callToClose}%</div><div class="kpi-label">Call-to-Close</div><div class="kpi-sub">${closed.length} closed / ${hadCalls.length} calls</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--blue)">${closeRate}%</div><div class="kpi-label">Close Rate</div><div class="kpi-sub">${closed.length} won / ${decisions} decided</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--gold)">${avgCycle}d</div><div class="kpi-label">Avg Win Cycle</div><div class="kpi-sub">Days to close</div></div>
    <div class="kpi"><div class="kpi-value" style="color:var(--red)">${avgLostCycle}d</div><div class="kpi-label">Avg Loss Cycle</div><div class="kpi-sub">Days to lose</div></div>
  `;

  // Outreach-to-response: by activity type, how many contacts replied
  const totalActs=data.activities.reduce((s,a)=>s+a.count,0);
  const actsByType={};
  data.activities.forEach(a=>{actsByType[a.type]=(actsByType[a.type]||0)+a.count});
  const repliedCount=replied.length;
  document.getElementById('analytics-response').innerHTML=Object.entries(actsByType).length?`
    <div style="margin-bottom:12px;font-size:12px;color:var(--text-2)">${totalActs} total outreach actions &rarr; ${repliedCount} responses (${totalActs?Math.round((repliedCount/totalActs)*100*10):0}% per 10 actions)</div>
    ${Object.entries(actsByType).sort((a,b)=>b[1]-a[1]).map(([type,count])=>{
      const maxActs=Math.max(...Object.values(actsByType),1);
      const w=Math.max(5,Math.round((count/maxActs)*100));
      const color=type==='Cold Email'?'var(--blue)':type==='Call'?'var(--green)':type==='LinkedIn'?'var(--purple)':'var(--teal)';
      return '<div class="analytics-bar-row"><div class="analytics-bar-label">'+type+'</div><div class="analytics-bar-track"><div class="analytics-bar-fill" style="width:'+w+'%;background:'+color+'"></div></div><div class="analytics-bar-val" style="color:'+color+'">'+count+'</div></div>';
    }).join('')}
  `:'<p style="font-size:12px;color:var(--text-3)">Log outreach activity to see response rates.</p>';

  // Stage conversion rates
  const stageFlow=['Lead','Contacted','Replied','Call Scheduled','Proposal Sent','Closed'];
  document.getElementById('analytics-stages').innerHTML=stageFlow.map((stage,i)=>{
    if(i===0)return '';
    const prevStage=stageFlow[i-1];
    const atOrPast=contacts.filter(c=>{
      const ci=STAGES.indexOf(c.status);
      const si=STAGES.indexOf(stage);
      return ci>=si||(c.status==='Lost'&&STAGES.indexOf(prevStage)<STAGES.indexOf(stage));
    }).length;
    const wereAtPrev=contacts.filter(c=>{
      const ci=STAGES.indexOf(c.status);
      const pi=STAGES.indexOf(prevStage);
      return ci>=pi||c.status==='Lost'||c.status==='Closed';
    }).length;
    const convRate=wereAtPrev?Math.round((atOrPast/wereAtPrev)*100):0;
    const color=convRate>=50?'var(--green)':convRate>=25?'var(--gold)':'var(--red)';
    return '<div class="analytics-metric"><div class="analytics-metric-label">'+prevStage+' &rarr; '+stage+'</div><div class="analytics-metric-val" style="color:'+color+'">'+convRate+'%</div></div>';
  }).join('');

  // Deal velocity
  document.getElementById('analytics-velocity').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px">
      <div style="text-align:center">
        <div style="font-size:32px;font-weight:800;color:var(--green)">${avgCycle||'â€”'}</div>
        <div style="font-size:11px;color:var(--text-2);margin-top:2px">Days to Win</div>
        <div style="font-size:11px;color:var(--text-3)">avg across ${closed.length} deals</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:32px;font-weight:800;color:var(--red)">${avgLostCycle||'â€”'}</div>
        <div style="font-size:11px;color:var(--text-2);margin-top:2px">Days to Lose</div>
        <div style="font-size:11px;color:var(--text-3)">avg across ${lost.length} deals</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:32px;font-weight:800;color:var(--gold)">${total?Math.round((closed.length/total)*100):0}%</div>
        <div style="font-size:11px;color:var(--text-2);margin-top:2px">Overall Win Rate</div>
        <div style="font-size:11px;color:var(--text-3)">${closed.length} won / ${total} total</div>
      </div>
    </div>
    ${closed.length?'<div style="margin-top:16px;font-size:12px;color:var(--text-2)"><strong>Insight:</strong> '+(avgCycle>14?'Your deals take over 2 weeks to close. Consider following up faster or adding urgency to proposals.':avgCycle>7?'About a week to close â€” solid. Keep the pressure up between call and close.':'Fast closer. Keep doing what you\'re doing.')+'</div>':''}
  `;

  // Channel performance: which source produces the most closed deals
  const sourceWins={};
  const sourceTotals={};
  contacts.forEach(c=>{
    const src=c.source||'Unknown';
    sourceTotals[src]=(sourceTotals[src]||0)+1;
    if(c.status==='Closed') sourceWins[src]=(sourceWins[src]||0)+1;
  });
  const channels=Object.keys(sourceTotals).sort((a,b)=>(sourceWins[b]||0)-(sourceWins[a]||0));
  document.getElementById('analytics-channels').innerHTML=channels.length?`
    <table class="tbl">
      <thead><tr><th>Channel</th><th>Total Contacts</th><th>Deals Won</th><th>Win Rate</th><th>Revenue</th></tr></thead>
      <tbody>${channels.map(ch=>{
        const tot=sourceTotals[ch];
        const wins=sourceWins[ch]||0;
        const rate=tot?Math.round((wins/tot)*100):0;
        const rev=contacts.filter(c=>c.source===ch&&c.status==='Closed').reduce((s,c)=>s+contactRevenue(c),0);
        return '<tr><td style="font-weight:600">'+esc(ch)+'</td><td>'+tot+'</td><td style="color:var(--green);font-weight:600">'+wins+'</td><td style="color:'+(rate>=50?'var(--green)':rate>=25?'var(--gold)':'var(--text-3)')+'">'+rate+'%</td><td style="color:var(--green);font-weight:600">'+(rev?formatMoney(rev)+'/mo':'â€”')+'</td></tr>';
      }).join('')}</tbody>
    </table>
  `:'<p style="font-size:12px;color:var(--text-3)">Add contacts with sources to see channel performance.</p>';
}

// ===== CLIENT ONBOARDING =====
const OB_STEPS=['Welcome email sent','Service agreement signed','Crew list received','Interview schedule set','First interviews completed','First report delivered'];

function renderOnboarding(){
  const clients=closedContacts();
  if(!data.onboarding) data.onboarding={};
  if(!data.deliveryLog) data.deliveryLog=[];

  // KPIs
  const totalSteps=clients.length*OB_STEPS.length;
  let completedSteps=0;
  clients.forEach(c=>{
    const ob=data.onboarding[c.id]||{};
    OB_STEPS.forEach(s=>{if(ob[s])completedSteps++});
  });
  const fullyOnboarded=clients.filter(c=>{
    const ob=data.onboarding[c.id]||{};
    return OB_STEPS.every(s=>ob[s]);
  }).length;
  const thisMonth=todayStr().substring(0,7);
  const deliveredThisMonth=data.deliveryLog.filter(d=>d.month===thisMonth&&d.status==='delivered').length;

  document.getElementById('ob-kpis').innerHTML=
    '<div class="kpi"><div class="kpi-value" style="color:var(--green)">'+clients.length+'</div><div class="kpi-label">Active Clients</div></div>'+
    '<div class="kpi"><div class="kpi-value" style="color:var(--teal)">'+fullyOnboarded+'</div><div class="kpi-label">Fully Onboarded</div></div>'+
    '<div class="kpi"><div class="kpi-value" style="color:var(--gold)">'+(totalSteps?Math.round((completedSteps/totalSteps)*100):0)+'%</div><div class="kpi-label">Onboarding Progress</div></div>'+
    '<div class="kpi"><div class="kpi-value" style="color:var(--blue)">'+deliveredThisMonth+'</div><div class="kpi-label">Reports This Month</div></div>';

  if(!clients.length){
    document.getElementById('ob-clients').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-3)">No active clients yet. Close your first deal to start onboarding.</div>';
    return;
  }

  document.getElementById('ob-clients').innerHTML=clients.map(c=>{
    const ob=data.onboarding[c.id]||{};
    const doneCount=OB_STEPS.filter(s=>ob[s]).length;
    const allDone=doneCount===OB_STEPS.length;
    const pct=Math.round((doneCount/OB_STEPS.length)*100);

    // Monthly delivery tracking - show last 6 months
    const months=[];
    const now=new Date();
    for(let i=0;i<6;i++){
      const d=new Date(now.getFullYear(),now.getMonth()-i,1);
      const key=d.toISOString().substring(0,7);
      const label=d.toLocaleDateString('en-US',{month:'short',year:'2-digit'});
      const entry=data.deliveryLog.find(dl=>dl.clientId===c.id&&dl.month===key);
      months.push({key,label,status:entry?entry.status:'none'});
    }

    return '<div class="ob-client">'+
      '<div class="ob-client-head">'+
        '<h3>'+(allDone?'&#9989; ':'')+esc(c.company)+' <span style="font-size:12px;font-weight:400;color:var(--text-2)">'+esc(c.ownerName)+' &middot; '+c.crewSize+' crew</span></h3>'+
        '<span style="font-size:12px;font-weight:600;color:'+(allDone?'var(--green)':'var(--gold)')+'">'+pct+'% onboarded</span>'+
      '</div>'+
      '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-2);margin-bottom:6px">Onboarding Checklist</div>'+
      '<div class="ob-steps">'+
        OB_STEPS.map(s=>{
          const done=ob[s]?true:false;
          return '<div class="ob-step'+(done?' done':'')+'" onclick="toggleOnboarding(\''+c.id+'\',\''+s+'\')">'+
            '<div class="ob-check'+(done?' done':'')+'">&#10003;</div>'+
            '<span>'+s+'</span>'+
          '</div>';
        }).join('')+
      '</div>'+
      '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-2);margin-bottom:6px;margin-top:8px">Monthly Delivery</div>'+
      '<div class="ob-delivery">'+
        months.map(m=>{
          const cls=m.status==='delivered'?'delivered':m.status==='scheduled'?'scheduled':'';
          const icon=m.status==='delivered'?'&#9989;':m.status==='scheduled'?'&#128197;':'&#9711;';
          return '<div class="ob-month '+cls+'" onclick="cycleDelivery(\''+c.id+'\',\''+m.key+'\')">'+
            '<div class="ob-month-label">'+m.label+'</div>'+
            '<div>'+icon+'</div>'+
            '<div style="font-size:10px;color:var(--text-3)">'+
              (m.status==='delivered'?'Delivered':m.status==='scheduled'?'Scheduled':'Click to set')+
            '</div>'+
          '</div>';
        }).join('')+
      '</div>'+
    '</div>';
  }).join('');
}

function toggleOnboarding(clientId,step){
  if(!data.onboarding) data.onboarding={};
  if(!data.onboarding[clientId]) data.onboarding[clientId]={};
  data.onboarding[clientId][step]=!data.onboarding[clientId][step];
  saveData(data);
  renderOnboarding();
}

function cycleDelivery(clientId,month){
  if(!data.deliveryLog) data.deliveryLog=[];
  const idx=data.deliveryLog.findIndex(d=>d.clientId===clientId&&d.month===month);
  if(idx===-1){
    data.deliveryLog.push({id:uid(),clientId,month,status:'scheduled'});
  }else if(data.deliveryLog[idx].status==='scheduled'){
    data.deliveryLog[idx].status='delivered';
  }else{
    data.deliveryLog.splice(idx,1);
  }
  saveData(data);
  renderOnboarding();
}

// ===== SALES SCRIPTS =====
function renderScripts(){
  document.getElementById('scripts-content').innerHTML=
    '<div class="script-section">'+
      '<h3>&#128222; Discovery Call Script (15 min)</h3>'+
      '<div class="script-block"><strong>Opening (2 min):</strong><br>'+
        '"Hey [Name], thanks for taking the time. I know you\'re busy running crews, so I\'ll keep this tight. I just want to learn about your business, your team, and see if Crew Voice might be a fit. Sound good?"</div>'+
      '<div class="script-block"><strong>Discovery Questions (5 min):</strong><br>'+
        '1. "How many crew members do you have right now?"<br>'+
        '2. "How many are Spanish-speaking?"<br>'+
        '3. "What\'s turnover been like for you this past year?"<br>'+
        '4. "When someone quits, do you usually see it coming or does it blindside you?"<br>'+
        '5. "What\'s your biggest headache when it comes to keeping good people?"<br>'+
        '6. "Have you ever had a crew member you wish you could have saved?"</div>'+
      '<div class="script-block"><strong>Bridge to Solution (3 min):</strong><br>'+
        '"So here\'s what I hear from a lot of owners in your position: they care about their crew, they want to keep good people, but they don\'t have a consistent way to know how everyone\'s really feeling. Especially with a language barrier.<br><br>'+
        'That\'s exactly what Crew Voice does. Every month, we call each of your crew members one-on-one â€” in English or Spanish â€” and ask how things are going. Not a survey. A real conversation.<br><br>'+
        'Then we give you a one-page report: morale score, top concerns, and any retention risk flags. You read it in 5 minutes and know exactly where your team stands."</div>'+
      '<div class="script-block"><strong>Pricing & Close (3 min):</strong><br>'+
        '"For a team of [X], it\'s [PRICE]/month. Month-to-month, cancel anytime with 14 days notice. And the first month is guaranteed â€” if the report doesn\'t surface anything useful, full refund.<br><br>'+
        'If you want to get started, I can have your first interviews scheduled within a week. What do you think?"</div>'+
      '<div class="script-block"><strong>If Not Ready:</strong><br>'+
        '"Totally understand. No pressure. I\'ll send you a recap email with everything we talked about, and you can reach out whenever you\'re ready. Sound fair?"</div>'+
    '</div>'+

    '<div class="script-section">'+
      '<h3>&#128170; Objection Handling â€” Click to Expand</h3>'+
      buildObjCard('"I already talk to my guys."',
        '"That\'s great â€” it means you care. But here\'s the thing: crew members tell their boss what they think the boss wants to hear. They tell a neutral third party the truth. Especially when that person speaks their language. We\'re not replacing your conversations â€” we\'re giving you the full picture."')+
      buildObjCard('"I can\'t afford $299/month."',
        '"I get it. Let me ask â€” what did it cost you the last time you lost a crew member? Recruiting, training, the jobs that slip... most owners tell me $5,000-$10,000. One save pays for an entire year of Crew Voice. And the first month is guaranteed â€” if we don\'t surface anything useful, you don\'t pay."')+
      buildObjCard('"My crew won\'t open up to a stranger."',
        '"That\'s actually the biggest surprise. People who won\'t open up to their boss will absolutely talk to a neutral third party â€” especially one who speaks their language. We see it every single time. The barrier isn\'t that they don\'t want to talk. It\'s that they don\'t feel safe talking to the person who signs their paycheck."')+
      buildObjCard('"I\'m too small / not enough crew."',
        '"You\'re exactly the right size. Losing even one person on a 5-person team is devastating â€” that\'s 20% of your workforce. The smaller you are, the more each person matters. And at $299/month, the math works even for smaller teams."')+
      buildObjCard('"I don\'t have time for this."',
        '"You don\'t need time. We handle everything â€” scheduling, calling, reporting. You spend 5 minutes reading a one-page report once a month. That\'s it. The whole point is that we do the work so you don\'t have to."')+
      buildObjCard('"Can I think about it?"',
        '"Of course. Totally respect that. I\'ll send you a recap email with everything we talked about. The only thing I\'d say is â€” somewhere on your crew right now, someone is frustrated about something you don\'t know about. Every month you wait is another month without that visibility. But no pressure â€” I\'m here whenever you\'re ready."')+
      buildObjCard('"What if the feedback is negative?"',
        '"Then it\'s working. Negative feedback is the most valuable kind â€” it tells you what to fix before someone quits. Would you rather hear it from us, or find out when they walk? The owners who get the most value are the ones who act on the hard truths."')+
      buildObjCard('"My guys seem happy."',
        '"They might be. But \'seems happy\' is exactly how every owner describes the crew member who quit last month. People are good at hiding frustration, especially when there\'s a language barrier. Crew Voice gives you the data instead of the guessing."')+
    '</div>'+

    '<div class="script-section">'+
      '<h3>&#128176; Pricing Quick Reference</h3>'+
      '<div class="script-block">'+
        '<strong>Base Price:</strong> $299/month for teams of 5-8 crew members<br>'+
        '<strong>Additional Crew:</strong> $30 per person above 8<br>'+
        '<strong>Terms:</strong> Month-to-month, cancel anytime with 14 days notice<br>'+
        '<strong>Guarantee:</strong> First month guaranteed â€” full refund if report isn\'t useful<br><br>'+
        '<strong>Quick Price Calculator:</strong><br>'+
        '5-8 crew = $299/mo<br>'+
        '10 crew = $359/mo<br>'+
        '12 crew = $419/mo<br>'+
        '15 crew = $509/mo<br>'+
        '20 crew = $659/mo<br>'+
        '25 crew = $809/mo'+
      '</div>'+
    '</div>'+

    '<div class="script-section">'+
      '<h3>&#127919; Voicemail Script (30 seconds)</h3>'+
      '<div class="script-block">'+
        '"Hey [Name], this is Luke from Crew Voice. I work with lawn care owners on crew retention â€” we do monthly check-ins with your crew in English and Spanish and give you a report on morale and turnover risks. If you\'ve ever been blindsided by a good person quitting, give me a call back at 864-334-6982. Talk soon."'+
      '</div>'+
    '</div>';
}

function buildObjCard(question,answer){
  return '<div class="objection-card" onclick="this.classList.toggle(\'open\')">'+
    '<div class="objection-q">'+question+'</div>'+
    '<div class="objection-a">'+answer+'</div>'+
  '</div>';
}

// ===== PROPOSAL GENERATOR =====
function renderProposals(){
  if(!data.proposals) data.proposals=[];
  renderProposalsList();
}

function generateProposal(){
  const company=document.getElementById('prop-company').value.trim();
  const owner=document.getElementById('prop-owner').value.trim();
  const crew=parseInt(document.getElementById('prop-crew').value)||0;
  const industry=document.getElementById('prop-industry').value;
  const pain=document.getElementById('prop-pain').value;
  const notes=document.getElementById('prop-notes').value.trim();

  if(!company||!owner||!crew){
    alert('Please fill in company, owner, and crew size.');
    return;
  }

  const price=calcRevenue(crew);
  const annual=price*12;
  const costPerPerson=crew>0?Math.round(price/crew):0;
  const today=new Date();
  const dateStr=today.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});

  const proposal={
    id:uid(),
    company,owner,crew,industry,pain,notes,price,
    createdAt:todayStr()
  };

  if(!data.proposals) data.proposals=[];
  data.proposals.push(proposal);
  saveData(data);

  const html=
    '<div class="proposal-preview">'+
      '<div style="text-align:center;margin-bottom:16px">'+
        '<div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-3);margin-bottom:4px">Service Proposal</div>'+
        '<h2>Crew Voice for '+esc(company)+'</h2>'+
        '<div style="font-size:12px;color:var(--text-2)">Prepared for '+esc(owner)+' &middot; '+dateStr+'</div>'+
      '</div>'+

      '<div style="margin-bottom:16px">'+
        '<div style="font-size:12px;font-weight:700;color:var(--text-2);text-transform:uppercase;margin-bottom:6px">The Challenge</div>'+
        '<p style="color:var(--text-2)">'+esc(pain)+'. Without a consistent way to check in with your team, you\'re flying blind on morale, satisfaction, and retention risks.</p>'+
      '</div>'+

      '<div style="margin-bottom:16px">'+
        '<div style="font-size:12px;font-weight:700;color:var(--text-2);text-transform:uppercase;margin-bottom:6px">The Solution</div>'+
        '<p style="color:var(--text-2)">Crew Voice provides monthly one-on-one phone interviews with each of your '+crew+' crew members â€” in English and Spanish. After every round, you receive a concise report covering:</p>'+
        '<ul style="color:var(--text-2);margin:8px 0 0 16px">'+
          '<li>Overall morale score</li>'+
          '<li>Top concerns and frustrations</li>'+
          '<li>Retention risk flags</li>'+
          '<li>Actionable recommendations</li>'+
        '</ul>'+
      '</div>'+

      '<div class="price-box">'+
        '<div class="price-big">'+formatMoney(price)+'/mo</div>'+
        '<div class="price-sub">For your team of '+crew+' &middot; '+formatMoney(annual)+'/year</div>'+
        '<div style="font-size:12px;color:var(--text-3);margin-top:4px">Just '+formatMoney(costPerPerson)+' per crew member per month</div>'+
      '</div>'+

      '<div style="margin-bottom:16px">'+
        '<div style="font-size:12px;font-weight:700;color:var(--text-2);text-transform:uppercase;margin-bottom:6px">What\'s Included</div>'+
        '<ul style="color:var(--text-2);margin-left:16px">'+
          '<li>Monthly 1-on-1 phone interviews with all '+crew+' crew members</li>'+
          '<li>Bilingual service (English & Spanish)</li>'+
          '<li>One-page monthly report delivered to you</li>'+
          '<li>Retention risk alerts</li>'+
          '<li>Month-to-month â€” cancel anytime with 14 days notice</li>'+
        '</ul>'+
      '</div>'+

      '<div style="background:var(--surface-2);border-radius:8px;padding:14px;margin-bottom:16px;border-left:3px solid var(--green)">'+
        '<div style="font-size:12px;font-weight:700;color:var(--green);margin-bottom:4px">First Month Guarantee</div>'+
        '<div style="font-size:12px;color:var(--text-2)">If your first report doesn\'t surface anything useful or actionable, you get a full refund. No questions asked.</div>'+
      '</div>'+

      (notes?'<div style="margin-bottom:16px"><div style="font-size:12px;font-weight:700;color:var(--text-2);text-transform:uppercase;margin-bottom:6px">Notes</div><p style="color:var(--text-2)">'+esc(notes)+'</p></div>':'')+

      '<div style="text-align:center;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">'+
        '<div style="font-size:13px;font-weight:600">Luke Larsen</div>'+
        '<div style="font-size:12px;color:var(--text-2)">Founder, Crew Voice</div>'+
        '<div style="font-size:12px;color:var(--text-3)">(864) 334-6982 &middot; luke@mycrewvoice.com &middot; mycrewvoice.com</div>'+
      '</div>'+

      '<div style="margin-top:14px;text-align:center">'+
        '<button class="btn btn-primary" onclick="copyProposal()">Copy as Text</button>'+
      '</div>'+
    '</div>';

  document.getElementById('proposal-preview').innerHTML=html;
  renderProposalsList();
}

function copyProposal(){
  const el=document.getElementById('proposal-preview');
  if(!el) return;
  const text=el.innerText;
  navigator.clipboard.writeText(text).then(()=>{
    alert('Proposal copied to clipboard!');
  }).catch(()=>{
    // Fallback
    const ta=document.createElement('textarea');
    ta.value=text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('Proposal copied to clipboard!');
  });
}

function renderProposalsList(){
  const proposals=[...(data.proposals||[])].sort((a,b)=>b.createdAt.localeCompare(a.createdAt));
  if(!proposals.length){
    document.getElementById('proposals-list').innerHTML='<p style="font-size:12px;color:var(--text-3);text-align:center;padding:16px">No proposals generated yet.</p>';
    return;
  }
  document.getElementById('proposals-list').innerHTML=proposals.map(p=>{
    const price=calcRevenue(p.crew);
    return '<div class="proposal-saved">'+
      '<div style="flex:1">'+
        '<span style="font-weight:600">'+esc(p.company)+'</span>'+
        '<span style="color:var(--text-2);margin-left:8px;font-size:12px">'+esc(p.owner)+' &middot; '+p.crew+' crew</span>'+
      '</div>'+
      '<span style="font-weight:600;color:var(--green)">'+formatMoney(price)+'/mo</span>'+
      '<span style="font-size:11px;color:var(--text-3)">'+formatDate(p.createdAt)+'</span>'+
      '<button class="btn btn-ghost btn-sm" onclick="deleteProposal(\''+p.id+'\')" style="color:var(--red)">&times;</button>'+
    '</div>';
  }).join('');
}

function deleteProposal(id){
  if(!confirm('Delete this proposal?')) return;
  data.proposals=(data.proposals||[]).filter(p=>p.id!==id);
  saveData(data);
  renderProposalsList();
}

// ===== EMAIL CAMPAIGN TRACKER =====
const SEQUENCE_EMAILS={
  'Post-Call Follow-Up':['Same Day: The Recap','Day 3: Thinking It Over','Day 7: The Urgency','Day 14: The Nurture','Day 30: The Win-Back'],
  'Cold Outreach':['Email 1: Intro','Email 2: Value','Email 3: Social Proof'],
  'Nurture':['Check-in 1','Check-in 2','Check-in 3'],
  'Re-engagement':['Hey, still there?','New offer','Final reach-out']
};

function renderCampaigns(){
  if(!data.emailCampaigns) data.emailCampaigns=[];
  const camps=data.emailCampaigns;
  const active=camps.filter(c=>c.status==='Active'||c.status==='Paused');
  const done=camps.filter(c=>c.status!=='Active'&&c.status!=='Paused');

  // KPIs
  const converted=camps.filter(c=>c.status==='Converted').length;
  const completed=camps.filter(c=>c.status==='Completed').length;
  const convRate=(converted+completed)>0?Math.round((converted/(converted+completed))*100):0;

  document.getElementById('camp-kpis').innerHTML=
    '<div class="kpi"><div class="kpi-value" style="color:var(--blue)">'+active.length+'</div><div class="kpi-label">Active Sequences</div></div>'+
    '<div class="kpi"><div class="kpi-value" style="color:var(--green)">'+converted+'</div><div class="kpi-label">Converted</div></div>'+
    '<div class="kpi"><div class="kpi-value" style="color:var(--gold)">'+camps.length+'</div><div class="kpi-label">Total Tracked</div></div>'+
    '<div class="kpi"><div class="kpi-value" style="color:var(--teal)">'+convRate+'%</div><div class="kpi-label">Conversion Rate</div></div>';

  // Active sequences
  if(active.length){
    document.getElementById('camp-active').innerHTML=active.map(c=>renderCampRow(c)).join('');
  }else{
    document.getElementById('camp-active').innerHTML='<div style="text-align:center;padding:24px;color:var(--text-3);font-size:13px">No active email sequences. Add a prospect to start tracking.</div>';
  }

  // Done
  if(done.length){
    document.getElementById('camp-done').innerHTML=done.map(c=>renderCampRow(c)).join('');
  }else{
    document.getElementById('camp-done').innerHTML='<div style="text-align:center;padding:16px;color:var(--text-3);font-size:12px">No completed sequences yet.</div>';
  }
}

function renderCampRow(c){
  const emails=SEQUENCE_EMAILS[c.sequence]||['1','2','3','4','5'];
  const totalEmails=emails.length;
  const statusColor=c.status==='Active'?'var(--blue)':c.status==='Paused'?'var(--gold)':c.status==='Converted'?'var(--green)':c.status==='Opted Out'?'var(--red)':'var(--text-3)';

  return '<div class="camp-row" style="cursor:pointer" onclick="editCampaign(\''+c.id+'\')">'+
    '<div style="flex:1">'+
      '<div style="font-weight:600">'+esc(c.contactName||'Unknown')+'</div>'+
      '<div style="font-size:11px;color:var(--text-2)">'+esc(c.sequence)+' &middot; Started '+formatDate(c.startDate)+'</div>'+
    '</div>'+
    '<div class="camp-step-dots" title="Email progress">'+
      emails.map(function(email,i){
        var dotClass='camp-dot';
        if(i<c.currentEmail-1) dotClass+=' sent';
        else if(i===c.currentEmail-1) dotClass+=' current';
        return '<div class="'+dotClass+'" title="'+esc(email)+'">'+(i+1)+'</div>';
      }).join('')+
    '</div>'+
    '<span class="tag" style="background:rgba(0,0,0,.2);color:'+statusColor+';border:1px solid '+statusColor+'">'+c.status+'</span>'+
    (c.notes?'<span style="font-size:11px;color:var(--text-3);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+esc(c.notes)+'">'+esc(c.notes)+'</span>':'')+
  '</div>';
}

function openCampaignModal(campId){
  document.getElementById('camp-id').value=campId||'';

  // Populate contact dropdown
  const contactSelect=document.getElementById('camp-contact');
  const prospects=data.contacts.filter(c=>c.status!=='Closed');
  contactSelect.innerHTML=prospects.map(c=>'<option value="'+c.id+'">'+esc(c.company)+' â€” '+esc(c.ownerName)+'</option>').join('');
  if(!prospects.length) contactSelect.innerHTML='<option value="">No prospects available</option>';

  if(campId){
    const c=(data.emailCampaigns||[]).find(x=>x.id===campId);
    if(c){
      contactSelect.value=c.contactId||'';
      document.getElementById('camp-sequence').value=c.sequence||'Post-Call Follow-Up';
      document.getElementById('camp-start').value=c.startDate||'';
      document.getElementById('camp-current').value=c.currentEmail||1;
      document.getElementById('camp-status').value=c.status||'Active';
      document.getElementById('camp-notes').value=c.notes||'';
      document.getElementById('camp-delete-btn').style.display='inline-flex';
    }
  }else{
    document.getElementById('camp-sequence').value='Post-Call Follow-Up';
    document.getElementById('camp-start').value=todayStr();
    document.getElementById('camp-current').value=1;
    document.getElementById('camp-status').value='Active';
    document.getElementById('camp-notes').value='';
    document.getElementById('camp-delete-btn').style.display='none';
  }
  openModal('campaign-modal');
}

function editCampaign(id){openCampaignModal(id)}

function saveCampaign(){
  const contactId=document.getElementById('camp-contact').value;
  if(!contactId) return;
  const contact=data.contacts.find(c=>c.id===contactId);
  const id=document.getElementById('camp-id').value;

  const obj={
    contactId,
    contactName:contact?(contact.company+' â€” '+contact.ownerName):'Unknown',
    sequence:document.getElementById('camp-sequence').value,
    startDate:document.getElementById('camp-start').value||todayStr(),
    currentEmail:parseInt(document.getElementById('camp-current').value)||1,
    status:document.getElementById('camp-status').value,
    notes:document.getElementById('camp-notes').value.trim()
  };

  if(!data.emailCampaigns) data.emailCampaigns=[];
  if(id){
    const idx=data.emailCampaigns.findIndex(c=>c.id===id);
    if(idx>=0) data.emailCampaigns[idx]={...data.emailCampaigns[idx],...obj};
  }else{
    data.emailCampaigns.push({id:uid(),...obj});
  }
  saveData(data);
  closeModal('campaign-modal');
  renderCampaigns();
}

function deleteCampaign(){
  const id=document.getElementById('camp-id').value;
  if(!id||!confirm('Delete this campaign entry?')) return;
  data.emailCampaigns=(data.emailCampaigns||[]).filter(c=>c.id!==id);
  saveData(data);
  closeModal('campaign-modal');
  renderCampaigns();
}

// ===== SOCIAL MEDIA =====
var socialFilter='all';
var currentSocTab='tracker';
var socWeekOffset=0;

var CTA_FOOTER='\n\n---\nhttps://mycrewvoice.com\nluke@mycrewvoice.com\n(864) 334-6982';

var DAILY_SOCIAL_TASKS=[
  {id:'li-conn',platform:'LI',label:'Send 15 connection requests',category:'connect'},
  {id:'li-msg',platform:'LI',label:'Send 5 follow-up messages',category:'engage'},
  {id:'li-comment',platform:'LI',label:'Comment on 5 posts',category:'engage'},
  {id:'li-post',platform:'LI',label:'Post 1 piece of content',category:'post',days:[1,3,5]},
  {id:'fb-group',platform:'FB',label:'Post in 2 groups',category:'post'},
  {id:'fb-comment',platform:'FB',label:'Comment on 5 group posts',category:'engage'},
  {id:'fb-share',platform:'FB',label:'Share 1 post on profile/page',category:'post'},
  {id:'fb-friend',platform:'FB',label:'Send 5 friend requests to owners',category:'connect'},
  {id:'ig-post',platform:'IG',label:'Post 1 feed post or reel',category:'post'},
  {id:'ig-engage',platform:'IG',label:'Like + comment on 10 posts',category:'engage'},
  {id:'ig-follow',platform:'IG',label:'Follow 10 relevant accounts',category:'connect'},
  {id:'ig-story',platform:'IG',label:'Post 2 stories',category:'post'},
  {id:'nd-post',platform:'ND',label:'Post in 1 neighborhood',category:'post'},
  {id:'nd-comment',platform:'ND',label:'Comment on 3 local posts',category:'engage'}
];

var SOCIAL_POSTS=[
  {id:1,title:'The Hook',platforms:['LI','FB','IG'],img:'Photo of a crew truck with workers in the back, shot from behind. Text overlay: "They\'re talking. Just not to you."',
   body:'Your crew is talking. Just not to you.\n\nThey\'re talking to each other in the truck. They\'re talking to their wife at dinner. They\'re talking to the guy down the street who\'s offering $2 more an hour.\n\nThe only person they\'re NOT talking to? You.\n\nNot because they don\'t trust you. Because there\'s no system for it. No time. No structure. And if half your crew speaks Spanish, no common language.\n\nThat\'s the gap Crew Voice fills. Monthly phone interviews with every crew member \u2014 in English or Spanish \u2014 so you know what\'s going on before someone walks.\n\nYour crew is talking. Make sure you\'re listening.'+CTA_FOOTER},
  {id:2,title:'The $8,000 Problem',platforms:['LI','FB','IG'],img:'Bold text graphic on dark background: "$8,000" in large red text. Subtext: "The real cost of losing one crew member"',
   body:'Here\'s a number most lawn care owners don\'t want to think about:\n\n$8,000.\n\nThat\'s the average cost of replacing one crew member when you add up:\n\n- Posting the job and screening applicants\n- Training the new person for 2-4 weeks\n- Lost productivity while they get up to speed\n- The jobs that slip or get done poorly\n\nNow multiply that by however many people you\'ve lost this year.\n\nWhat if you could see it coming?\n\nWhat if someone told you "hey, your best foreman is frustrated about X and thinking about leaving" \u2014 BEFORE he handed in his notice?\n\nThat\'s what we do at Crew Voice. $299/month. Way cheaper than one resignation.'+CTA_FOOTER},
  {id:3,title:'The Language Barrier',platforms:['FB','IG','ND'],img:'Split image: left side shows a frustrated worker looking away, right side shows a smiling worker on the phone. Text: "Same crew. Different conversation."',
   body:'Honest question for owners with Spanish-speaking crews:\n\nWhen was the last time you sat down with your crew and asked them \u2014 in their language \u2014 how they\'re really feeling about the job?\n\nNot "are we good?" in passing. A real conversation about what\'s working, what\'s frustrating them, and whether they see themselves here next season.\n\nIf you can\'t have that conversation, you\'ve got a blind spot. And blind spots cost you people.\n\nWe do bilingual crew check-ins every month. Real conversations, not surveys. DM me if you want to know more.'+CTA_FOOTER},
  {id:4,title:'7 Warning Signs',platforms:['LI','IG'],img:'Carousel post: Each slide = one warning sign with a number and icon. Dark background, green accent text.',
   body:'7 warning signs your best crew member is about to quit:\n\n1. They stop volunteering for extra work\n2. They\'re suddenly "busy" every time you need overtime\n3. They\'ve been quieter than usual\n4. They start showing up exactly on time (no more early arrivals)\n5. They\'ve been on their phone more during breaks\n6. Other crew members seem awkward around them\n7. They asked about their last paycheck details\n\nBy the time you notice #7, it\'s usually too late.\n\nThe fix? Don\'t wait for signs. Ask them directly \u2014 every month. That\'s what Crew Voice does.'+CTA_FOOTER},
  {id:5,title:'Retention vs. Turnover',platforms:['FB','LI','IG'],img:'Side-by-side comparison graphic. Left: "$299/mo - Crew Voice" in green. Right: "$8,000 - One resignation" in red.',
   body:'"I can\'t afford $299/month for crew interviews."\n\nCool. Can you afford $8,000 to replace your lead foreman?\n\nCan you afford 3 weeks of sloppy work while the new guy learns your routes?\n\nCan you afford losing the client who complains because the new crew left clippings on the driveway?\n\nRetention isn\'t expensive. Turnover is.'+CTA_FOOTER},
  {id:6,title:'Reel: The Most Expensive Employee',platforms:['R','IG'],img:'REEL: Film yourself talking to camera on a job site or in a truck. Quick cuts. Captions on screen.',
   body:'[REEL SCRIPT \u2014 SPEAK TO CAMERA]\n\n"The most expensive employee isn\'t the one you pay the most. It\'s the one who quits without warning.\n\n$5,000 to $10,000 \u2014 that\'s what it costs to replace a single crew member in lawn care.\n\nAnd you know what\'s crazy? Most of the time, there were signs for weeks. They were frustrated. They felt overlooked. They were already talking to another company.\n\nBut nobody asked.\n\nCrew Voice asks. Every month. In English and Spanish. So you know who\'s happy, who\'s frustrated, and who\'s about to walk \u2014 before they do.\n\nLink in bio."'+CTA_FOOTER},
  {id:7,title:'Friday Afternoon Quit',platforms:['FB','IG','ND'],img:'Photo of an empty spot in a crew lineup, or a hard hat left on a tailgate. Text: "He didn\'t say anything. He just left."',
   body:'Raise your hand if this has happened to you:\n\nYour best guy walks up on a Friday afternoon and says "hey, next week\'s my last week."\n\nAnd you\'re standing there thinking \u2014 WHAT? Since when? What happened?\n\nTurns out he\'d been frustrated for months. About the schedule, about a coworker, about not getting the raise he asked about in March that you forgot about.\n\nHe didn\'t say anything because... that\'s not how it works. Crew members don\'t complain to the boss. They just leave.\n\nUnless someone else asks them. That\'s literally what Crew Voice does.'+CTA_FOOTER},
  {id:8,title:'The Spouse Test',platforms:['LI'],img:'Simple text graphic: "His wife knows he\'s about to quit. Do you?" \u2014 white text on dark green background.',
   body:'Here\'s a test:\n\nYour crew member\'s wife knows more about how he feels about his job than you do.\n\nShe knows he\'s frustrated. She knows he\'s been looking at other options. She knows the exact conversation with his foreman that made him start checking Indeed.\n\nYou? You thought everything was fine.\n\nThis isn\'t a knock on you. It\'s just the reality of running crews. You\'re busy. They\'re busy. Real conversations don\'t happen organically on a job site.\n\nCrew Voice creates the space for those conversations. Monthly. Bilingual. Reported back to you.'+CTA_FOOTER},
  {id:9,title:'"I Had No Idea"',platforms:['LI','FB','IG'],img:'Quote graphic: Large quotation marks with "I had NO IDEA that was an issue." \u2014 Lawn care business owner',
   body:'Something I hear from every lawn care owner I talk to:\n\n"I had NO IDEA that was an issue."\n\nIt\'s not that the problems are hidden. It\'s that nobody\'s asking the right questions, in the right language, at the right time.\n\nA 15-minute phone conversation once a month uncovers things that a year of "how\'s it going?" never will.\n\nThat\'s the whole idea behind Crew Voice. We ask so you don\'t have to guess.'+CTA_FOOTER},
  {id:10,title:'Objection Buster',platforms:['FB','IG'],img:'Bold text: "My guys won\'t talk to a stranger." Then below in green: "That\'s what every owner says... before they try it."',
   body:'"My guys won\'t talk to a stranger on the phone."\n\nThat\'s what every owner says before they try it.\n\nHere\'s what actually happens: crew members WANT to be heard. They want to feel like someone cares enough to ask. Especially when the person calling speaks their language.\n\nWe\'ve seen guys who are stone-silent with their boss open up for 20 minutes with our interviewer. Because it\'s different when a neutral third party asks.\n\nYour crew wants to talk. They just need the right person to ask.'+CTA_FOOTER},
  {id:11,title:'Retention Secret',platforms:['LI','IG'],img:'Minimal text post: "The #1 reason crew members leave isn\'t money. It\'s feeling invisible." Dark background.',
   body:'Retention tip for lawn care owners:\n\nThe #1 reason crew members leave isn\'t money. It\'s feeling invisible.\n\nThey show up every day. They do hard work in the heat. And nobody asks them how they\'re doing.\n\nYou don\'t need a big HR program. You need a system for listening.\n\nThat\'s it. That\'s the whole secret.'+CTA_FOOTER},
  {id:12,title:'Sample Report Breakdown',platforms:['LI','IG','R'],img:'Mockup of a Crew Voice report page with sections highlighted. Clean, professional graphic.',
   body:'What a Crew Voice report actually looks like:\n\n- Overall Morale: High / Medium / Low\n- Top 3 Positives: What your crew appreciates most\n- Top 3 Concerns: What\'s frustrating them right now\n- Retention Risk Flags: Who might be thinking about leaving (and why)\n- Suggested Focus Areas: What to address this month\n\nOne page. No fluff. Delivered monthly.\n\nYou read it in 5 minutes and know exactly where your team stands.\n\n$299/month for up to 8 crew members. Month-to-month. Full refund if the first report isn\'t useful.'+CTA_FOOTER},
  {id:13,title:'30% Turnover Rate',platforms:['FB','LI','IG'],img:'Infographic: "10 crew members" with 3 highlighted in red. "Statistically, 3 won\'t be here next year. Do you know which 3?"',
   body:'The lawn care industry has a turnover rate north of 30%.\n\nThat means if you\'ve got 10 crew members, statistically 3 of them won\'t be here next year.\n\nThe question is: do you know which 3?\n\nAnd more importantly \u2014 do you know why?\n\nBecause if you did, you could probably keep at least 1 or 2 of them. And at $8K per replacement, that\'s $8,000\u2013$16,000 you keep in your pocket.\n\nMonthly crew interviews. $299/month. The math isn\'t complicated.'+CTA_FOOTER},
  {id:14,title:'The Bilingual Advantage',platforms:['FB','IG','ND'],img:'Photo of diverse lawn care crew working together. Overlay: "Your crew is talking. In both languages. Are you listening?"',
   body:'If 60% of your crew speaks Spanish and you don\'t \u2014 you\'re running your business with a major blind spot.\n\nNot on the work. Your crews know what to do.\n\nOn the people side. The morale. The frustrations. The "I\'m thinking about leaving" conversations that happen in Spanish on the ride home.\n\nYou can\'t fix what you can\'t hear. And you can\'t hear it if it\'s in a language you don\'t speak.\n\nThat\'s why Crew Voice uses bilingual interviewers. Fluent in English and Spanish. So every crew member can speak in the language they\'re comfortable in.\n\nYour crew is talking. In both languages. We make sure you hear it.'+CTA_FOOTER},
  {id:15,title:'Direct Offer',platforms:['LI','FB','IG'],img:'Clean graphic with pricing: "$299/mo for up to 8 crew. First month guaranteed." Green CTA button style.',
   body:'If you run a lawn care company with 5+ crew members, here\'s what I\'ll do for you:\n\nEvery month, I\'ll have someone call each of your crew members \u2014 in English or Spanish \u2014 for a 15-minute check-in.\n\nWe\'ll ask about morale, frustrations, equipment, management, and whether they see themselves staying long-term.\n\nThen I\'ll send you a one-page report with everything you need to know: who\'s happy, who\'s frustrated, and who might be about to leave.\n\n$299/month for up to 8 crew members. $30/each above that. Month-to-month. Cancel anytime.\n\nFirst month guaranteed \u2014 if we don\'t surface anything useful, you don\'t pay.'+CTA_FOOTER},
  {id:16,title:'Nextdoor: Local Intro',platforms:['ND'],img:'Friendly photo of you or your logo. Keep it local and personal.',
   body:'Hey neighbors! I run a service called Crew Voice that helps local lawn care and landscaping companies take better care of their teams.\n\nEvery month, we check in with crew members \u2014 in English and Spanish \u2014 and give the business owner a report on how their team is doing. Think of it as an early warning system so nobody quits without warning.\n\nIf you own a service business or know someone who does, I\'d love to chat. Always happy to support local businesses.'+CTA_FOOTER},
  {id:17,title:'Reel: 3 Questions',platforms:['R','IG'],img:'REEL: Quick selfie-style video. Hold up 3 fingers and count down. Add captions.',
   body:'[REEL SCRIPT]\n\n"3 questions every lawn care owner should ask their crew this week:\n\n1. What\'s one thing that would make your job easier?\n2. Is there anything frustrating you that I don\'t know about?\n3. Do you see yourself here next season?\n\nIf you can\'t ask these in Spanish \u2014 you\'re missing half the answers.\n\nThat\'s why Crew Voice exists. We ask the hard questions for you. Every month. In both languages.\n\nLink in bio."'+CTA_FOOTER},
  {id:18,title:'Reel: $299 vs $8,000',platforms:['R','IG'],img:'REEL: Show $299 on screen, then dramatically show $8,000. Use trending audio. Keep it under 30 seconds.',
   body:'[REEL SCRIPT \u2014 30 SECONDS]\n\n"$299 a month. That\'s what Crew Voice costs.\n\n$8,000. That\'s what it costs to replace ONE crew member.\n\nWe call your crew every month. English and Spanish. Find out who\'s happy, who\'s frustrated, who\'s about to leave.\n\nYou get a one-page report. Read it in 5 minutes.\n\nPrevent ONE quit per year and you just saved yourself 20x what you paid.\n\nThe math is easy. Link in bio."'+CTA_FOOTER}
];

function renderSocial(){
  renderSocWeekTracker();
  renderSocContent();
  renderSocEngage();
  renderSocStrategy();
}

// --- Tab switching ---
function switchSocTab(tab){
  currentSocTab=tab;
  ['tracker','content','engage','strategy'].forEach(function(t){
    document.getElementById('soc-tab-'+t).style.display=t===tab?'block':'none';
  });
  document.querySelectorAll('.soc-tab').forEach(function(b){b.classList.remove('active')});
  document.querySelectorAll('.soc-tab').forEach(function(b){
    var map={tracker:'Weekly Tracker',content:'Content Library',engage:'Engagement Log',strategy:'Strategy Guide'};
    if(b.textContent===map[tab]) b.classList.add('active');
  });
}

// --- Weekly Tracker ---
function getWeekDates(offset){
  var now=new Date();
  var day=now.getDay();
  var mon=new Date(now);
  mon.setDate(now.getDate()-(day===0?6:day-1)+(offset*7));
  var dates=[];
  for(var i=0;i<7;i++){
    var d=new Date(mon);
    d.setDate(mon.getDate()+i);
    dates.push(d.toISOString().slice(0,10));
  }
  return dates;
}

function renderSocWeekTracker(){
  if(!data.socialChecks) data.socialChecks={};
  var dates=getWeekDates(socWeekOffset);
  var dayNames=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

  // Week nav
  var start=new Date(dates[0]+'T00:00:00');
  var end=new Date(dates[6]+'T00:00:00');
  var fmt=function(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric'})};
  document.getElementById('soc-week-nav').innerHTML='<button onclick="socWeekOffset--;renderSocWeekTracker()">&larr;</button>'
    +'<span>'+fmt(start)+' \u2013 '+fmt(end)+'</span>'
    +'<button onclick="socWeekOffset++;renderSocWeekTracker()">&rarr;</button>'
    +(socWeekOffset!==0?'<button onclick="socWeekOffset=0;renderSocWeekTracker()" style="margin-left:8px;font-size:11px">Today</button>':'');

  // Streak
  var totalChecked=0;var totalPossible=0;
  dates.forEach(function(dt){
    var dayNum=new Date(dt+'T00:00:00').getDay();
    DAILY_SOCIAL_TASKS.forEach(function(t){
      if(t.days&&t.days.indexOf(dayNum)<0)return;
      if(dayNum===0||dayNum===6)return;
      totalPossible++;
      var key=dt+'_'+t.id;
      if(data.socialChecks[key]) totalChecked++;
    });
  });
  var weekPct=totalPossible?Math.round((totalChecked/totalPossible)*100):0;
  var streak=calcSocStreak();
  document.getElementById('soc-streak').innerHTML='<div class="soc-streak-card"><div class="soc-streak-val" style="color:var(--green)">'+weekPct+'%</div><div class="soc-streak-lbl">This Week</div></div>'
    +'<div class="soc-streak-card"><div class="soc-streak-val" style="color:var(--gold)">'+streak+'</div><div class="soc-streak-lbl">Day Streak</div></div>'
    +'<div class="soc-streak-card"><div class="soc-streak-val" style="color:var(--blue)">'+totalChecked+'</div><div class="soc-streak-lbl">Tasks Done</div></div>'
    +'<div class="soc-streak-card"><div class="soc-streak-val" style="color:var(--purple)">'+(data.socialEngagement||[]).length+'</div><div class="soc-streak-lbl">Responses</div></div>';

  // Days grid
  document.getElementById('soc-week').innerHTML=dates.map(function(dt,di){
    var dayNum=new Date(dt+'T00:00:00').getDay();
    var isWeekend=dayNum===0||dayNum===6;
    var tasks=DAILY_SOCIAL_TASKS.filter(function(t){
      if(isWeekend)return false;
      if(t.days&&t.days.indexOf(dayNum)<0)return false;
      return true;
    });
    var done=tasks.filter(function(t){return data.socialChecks[dt+'_'+t.id]}).length;
    var pct=tasks.length?Math.round((done/tasks.length)*100):0;
    var pctColor=pct>=100?'var(--green)':pct>=50?'var(--gold)':'var(--text-3)';
    var isToday=dt===todayStr();
    var borderStyle=isToday?'border-color:var(--green)':'';
    var platIcons={LI:'li',FB:'fb',IG:'ig',ND:'nd'};
    return '<div class="soc-day" style="'+borderStyle+'">'
      +'<div class="soc-day-head"><span>'+dayNames[di]+(isToday?' *':'')+'</span>'+(tasks.length?'<span class="soc-day-pct" style="background:'+pctColor+';color:#fff">'+pct+'%</span>':'')+'</div>'
      +(isWeekend?'<div style="font-size:11px;color:var(--text-3);text-align:center;padding:8px 0">Rest day</div>':
        tasks.map(function(t){
          var key=dt+'_'+t.id;
          var isDone=data.socialChecks[key];
          return '<div class="soc-task'+(isDone?' done':'')+'" onclick="toggleSocCheck(\''+key+'\')">'
            +'<div class="soc-check">'+(isDone?'\u2713':'')+'</div>'
            +'<div class="soc-plat-icon '+platIcons[t.platform]+'">'+t.platform.charAt(0)+'</div>'
            +'<div class="soc-task-label">'+t.label+'</div>'
            +'</div>';
        }).join(''))
      +'</div>';
  }).join('');
}

function toggleSocCheck(key){
  if(!data.socialChecks) data.socialChecks={};
  data.socialChecks[key]=!data.socialChecks[key];
  saveData(data);
  renderSocWeekTracker();
}

function calcSocStreak(){
  var streak=0;
  var d=new Date();
  for(var i=0;i<365;i++){
    d.setDate(d.getDate()-(i===0?0:1));
    var dt=d.toISOString().slice(0,10);
    var dayNum=d.getDay();
    if(dayNum===0||dayNum===6){continue;}
    var tasks=DAILY_SOCIAL_TASKS.filter(function(t){
      if(t.days&&t.days.indexOf(dayNum)<0)return false;
      return true;
    });
    var done=tasks.filter(function(t){return data.socialChecks&&data.socialChecks[dt+'_'+t.id]}).length;
    if(done>=Math.ceil(tasks.length*0.5)){streak++;}
    else{break;}
  }
  return streak;
}

// --- Content Library ---
function renderSocContent(){
  var posts=SOCIAL_POSTS;
  if(socialFilter!=='all'){
    posts=posts.filter(function(p){return p.platforms.indexOf(socialFilter)>=0});
  }
  document.getElementById('social-posts').innerHTML=posts.map(function(p){
    var platMap={LI:{cls:'social-plat-li',label:'LinkedIn'},FB:{cls:'social-plat-fb',label:'Facebook'},IG:{cls:'social-plat-ig',label:'Instagram'},ND:{cls:'social-plat-nd',label:'Nextdoor'},R:{cls:'social-plat-r',label:'Reels'}};
    var platHtml=p.platforms.map(function(pl){
      var m=platMap[pl]||{cls:'',label:pl};
      return '<span class="social-plat '+m.cls+'">'+m.label+'</span>';
    }).join('');
    return '<div class="social-card" id="social-card-'+p.id+'">'
      +'<div class="social-card-head" onclick="toggleSocialCard('+p.id+')">'
      +'<span class="social-card-title">#'+p.id+' \u2014 '+esc(p.title)+'</span>'
      +'<div class="social-card-platforms">'+platHtml+'</div>'
      +'</div>'
      +'<div class="social-card-body">'
      +(p.img?'<div class="social-img-hint">IMAGE IDEA: '+esc(p.img)+'</div>':'')
      +'<div class="social-post-text" id="social-text-'+p.id+'">'+esc(p.body)+'</div>'
      +'<div class="social-copy-bar">'
      +'<button class="btn btn-primary btn-sm" onclick="copySocialPost('+p.id+')">Copy Post</button>'
      +'</div>'
      +'</div></div>';
  }).join('');
}

function filterSocial(filter){
  socialFilter=filter;
  document.querySelectorAll('.social-filter').forEach(function(b){b.classList.remove('active')});
  document.querySelectorAll('.social-filter').forEach(function(b){
    var map={'All':'all','LinkedIn':'LI','Facebook':'FB','Instagram':'IG','Nextdoor':'ND','Reels':'R'};
    if(map[b.textContent]===filter) b.classList.add('active');
  });
  renderSocContent();
}

function toggleSocialCard(id){document.getElementById('social-card-'+id).classList.toggle('open')}

function copySocialPost(id){
  var el=document.getElementById('social-text-'+id);
  if(!el)return;
  navigator.clipboard.writeText(el.textContent);
  showCopyToast('Post copied!');
}

// --- Engagement Log ---
function openEngageModal(){
  document.getElementById('eng-platform').value='LinkedIn';
  document.getElementById('eng-type').value='Connection Accepted';
  document.getElementById('eng-detail').value='';
  document.getElementById('eng-date').value=todayStr();
  document.getElementById('eng-result').value='Positive';
  openModal('engage-modal');
}

function saveEngagement(){
  if(!data.socialEngagement) data.socialEngagement=[];
  data.socialEngagement.push({
    id:uid(),
    platform:document.getElementById('eng-platform').value,
    type:document.getElementById('eng-type').value,
    detail:document.getElementById('eng-detail').value.trim(),
    date:document.getElementById('eng-date').value||todayStr(),
    result:document.getElementById('eng-result').value
  });
  saveData(data);
  closeModal('engage-modal');
  renderSocEngage();
}

function deleteEngagement(id){
  if(!data.socialEngagement)return;
  data.socialEngagement=data.socialEngagement.filter(function(e){return e.id!==id});
  saveData(data);
  renderSocEngage();
}

function renderSocEngage(){
  var eng=data.socialEngagement||[];
  // KPIs
  var byPlat={};var byType={};
  eng.forEach(function(e){
    byPlat[e.platform]=(byPlat[e.platform]||0)+1;
    byType[e.type]=(byType[e.type]||0)+1;
  });
  var leads=eng.filter(function(e){return e.type==='Lead Generated'}).length;
  var thisWeek=eng.filter(function(e){var d=getWeekDates(0);return e.date>=d[0]&&e.date<=d[6]}).length;
  document.getElementById('soc-engage-kpis').innerHTML='<div class="kpi"><div class="kpi-value" style="color:var(--green)">'+eng.length+'</div><div class="kpi-label">Total Responses</div></div>'
    +'<div class="kpi"><div class="kpi-value" style="color:var(--blue)">'+thisWeek+'</div><div class="kpi-label">This Week</div></div>'
    +'<div class="kpi"><div class="kpi-value" style="color:var(--gold)">'+leads+'</div><div class="kpi-label">Leads Generated</div></div>'
    +'<div class="kpi"><div class="kpi-value" style="color:var(--purple)">'+(byPlat.LinkedIn||0)+'</div><div class="kpi-label">LinkedIn</div></div>'
    +'<div class="kpi"><div class="kpi-value" style="color:var(--orange)">'+(byPlat.Facebook||0)+'</div><div class="kpi-label">Facebook</div></div>';

  // Log
  var recent=eng.slice().sort(function(a,b){return(b.date||'').localeCompare(a.date||'')}).slice(0,30);
  if(!recent.length){
    document.getElementById('soc-engage-log').innerHTML='<div style="color:var(--text-3);font-size:12px;text-align:center;padding:20px">No engagement logged yet. Start tracking responses to see what\'s working.</div>';
    return;
  }
  var platIcon={LinkedIn:'li',Facebook:'fb',Instagram:'ig',Nextdoor:'nd'};
  document.getElementById('soc-engage-log').innerHTML=recent.map(function(e){
    var rColor=e.result==='Positive'?'var(--green)':e.result==='Negative'?'var(--red)':'var(--text-3)';
    return '<div class="soc-engage-row">'
      +'<span class="eng-date">'+formatDate(e.date)+'</span>'
      +'<span class="eng-plat"><div class="soc-plat-icon '+(platIcon[e.platform]||'li')+'" style="width:18px;height:18px;font-size:9px">'+e.platform.charAt(0)+'</div></span>'
      +'<span class="eng-type">'+esc(e.type)+'</span>'
      +'<span class="eng-detail">'+esc(e.detail)+'</span>'
      +'<span class="eng-result" style="color:'+rColor+'">'+e.result+'</span>'
      +'<button class="btn btn-ghost btn-sm" onclick="deleteEngagement(\''+e.id+'\')" style="color:var(--red);padding:2px 4px">&times;</button>'
      +'</div>';
  }).join('');
}

// --- Strategy Guide ---
function renderSocStrategy(){
  document.getElementById('soc-strategy-content').innerHTML=''
    +'<div class="soc-strategy-card"><h4><div class="soc-plat-icon li" style="width:20px;height:20px;font-size:10px">L</div> LinkedIn \u2014 Connection Machine</h4>'
    +'<ul><li><strong>Primary goal:</strong> Send 15 targeted connection requests per day to lawn care / landscaping business owners</li>'
    +'<li><strong>Follow-up:</strong> 24-48 hours after they accept, send a value-first message (not a pitch)</li>'
    +'<li><strong>Content:</strong> Post 3x/week \u2014 thought leadership, stats, and tips. Use the Content Library.</li>'
    +'<li><strong>Comments:</strong> Comment on 5 posts daily BEFORE posting your own \u2014 this builds visibility</li>'
    +'<li><strong>Profile tip:</strong> Headline should say "Helping Lawn Care Owners Keep Their Best Crew Members" not just "Founder"</li>'
    +'<li><strong>Best time to post:</strong> 7-8 AM weekdays</li></ul></div>'

    +'<div class="soc-strategy-card"><h4><div class="soc-plat-icon fb" style="width:20px;height:20px;font-size:10px">F</div> Facebook \u2014 Groups + Authority</h4>'
    +'<ul><li><strong>Primary goal:</strong> Post in 2 lawn care owner groups per day + comment on 5 group posts</li>'
    +'<li><strong>Groups to join:</strong> Lawn care business owner groups, landscaping entrepreneur groups, NALP groups, local business groups</li>'
    +'<li><strong>Friend requests:</strong> YES \u2014 send 5/day to owners you interact with in groups. This is how you build your network. Don\'t send cold friend requests with no context \u2014 comment on their posts first, then send the request.</li>'
    +'<li><strong>Page vs. Profile:</strong> Post from your personal profile in groups (more trust). Share to your business page too.</li>'
    +'<li><strong>Best time:</strong> 6-7 AM or 8-9 PM</li></ul></div>'

    +'<div class="soc-strategy-card"><h4><div class="soc-plat-icon ig" style="width:20px;height:20px;font-size:10px">I</div> Instagram \u2014 Reels + Following</h4>'
    +'<ul><li><strong>Primary goal:</strong> Post 1 reel or feed post daily. Reels get 3-5x more reach than static posts.</li>'
    +'<li><strong>Following:</strong> Follow 10 lawn care owners/accounts per day. Like and comment on their posts. Many will follow back and check your profile.</li>'
    +'<li><strong>Stories:</strong> Post 2 stories/day \u2014 behind the scenes, quick tips, polls ("biggest crew challenge?"). Stories keep you top of mind.</li>'
    +'<li><strong>Hashtags:</strong> Use 5-10 per post: #lawncare #landscaping #crewretention #lawncarebusiness #landscapinglife #crewvoice #employeeretention</li>'
    +'<li><strong>Bio:</strong> "Helping lawn care owners keep their best crew members. Monthly bilingual interviews + reports." + link to mycrewvoice.com</li>'
    +'<li><strong>Reels tips:</strong> Hook in first 2 seconds. Use captions (most watch without sound). Keep under 60 seconds. Trending audio helps.</li></ul></div>'

    +'<div class="soc-strategy-card"><h4><div class="soc-plat-icon nd" style="width:20px;height:20px;font-size:10px">N</div> Nextdoor \u2014 Local Trust</h4>'
    +'<ul><li><strong>Primary goal:</strong> Post 1x/day in your neighborhood. Nextdoor is hyperlocal \u2014 people trust neighbors.</li>'
    +'<li><strong>Approach:</strong> Be helpful first. Answer questions, recommend local businesses, share lawn care tips. Build credibility before promoting.</li>'
    +'<li><strong>Business posts:</strong> Nextdoor allows business posts \u2014 introduce Crew Voice as a local service helping local companies.</li>'
    +'<li><strong>Referrals:</strong> Ask satisfied clients to recommend you on Nextdoor \u2014 neighbor recommendations carry massive weight.</li></ul></div>'

    +'<div class="soc-strategy-card"><h4>General Tips</h4>'
    +'<ul><li><strong>Every post should include:</strong> your website (mycrewvoice.com), email (luke@mycrewvoice.com), and phone ((864) 334-6982)</li>'
    +'<li><strong>Images matter:</strong> Posts with images get 2-3x more engagement. Use the IMAGE IDEA hints in the Content Library for each post.</li>'
    +'<li><strong>80/20 rule:</strong> 80% value content (tips, stats, stories), 20% direct promotion. People unfollow accounts that only sell.</li>'
    +'<li><strong>Consistency beats perfection:</strong> A mediocre post every day beats a perfect post once a month. Just show up.</li>'
    +'<li><strong>Engage before you post:</strong> Spend 10-15 minutes engaging with others\' content before posting your own. The algorithms reward activity.</li>'
    +'<li><strong>Track everything:</strong> Use the Engagement Log tab to track responses. Double down on what\'s working. Cut what isn\'t.</li></ul></div>';
}

// ===== SEARCHABLE DROPDOWN =====
function getSearchContacts(){
  return data.contacts.map(function(c){
    return {id:c.id,company:c.company||'',owner:c.ownerName||'',stage:c.status||'',crew:c.crewSize||0};
  });
}

function openSearchSelect(prefix){
  var ss=document.getElementById(prefix+'-ss');
  ss.classList.add('open');
  filterSearchSelect(prefix);
}

function closeSearchSelect(prefix){
  setTimeout(function(){
    var ss=document.getElementById(prefix+'-ss');
    if(ss) ss.classList.remove('open');
  },200);
}

function filterSearchSelect(prefix){
  var input=document.getElementById(prefix+'-search');
  var query=(input.value||'').toLowerCase();
  var list=document.getElementById(prefix+'-list');
  var contacts=getSearchContacts();
  var filtered=contacts.filter(function(c){
    return (c.company+' '+c.owner).toLowerCase().indexOf(query)>=0;
  });
  if(!filtered.length){
    list.innerHTML='<div class="search-select-none">No contacts found</div>';
    return;
  }
  list.innerHTML=filtered.slice(0,15).map(function(c){
    return '<div class="search-select-item" onmousedown="selectSearchItem(\''+prefix+'\',\''+c.id+'\')">'
      +'<span class="ss-company">'+esc(c.company)+'</span>'
      +'<span class="ss-owner">'+esc(c.owner)+'</span>'
      +'<span class="ss-stage">'+esc(c.status)+'</span>'
      +'</div>';
  }).join('');
}

function selectSearchItem(prefix,contactId){
  var c=data.contacts.find(function(x){return x.id===contactId});
  if(!c)return;
  document.getElementById(prefix+'-search').value=c.company+' \u2014 '+c.ownerName;
  // Set the hidden select value by convention: prefix + '-select'
  var selectEl=document.getElementById(prefix+'-select');
  if(!selectEl){
    // Fallback for send modal
    selectEl=document.getElementById('send-contact');
  }
  if(selectEl) selectEl.value=contactId;
  var ss=document.getElementById(prefix+'-ss');
  if(ss) ss.classList.remove('open');
  // Trigger re-render for template personalization
  if(prefix==='tpl-contact') tplContactChanged();
}

// Close dropdowns when clicking outside
document.addEventListener('click',function(e){
  document.querySelectorAll('.search-select').forEach(function(ss){
    if(!ss.contains(e.target)) ss.classList.remove('open');
  });
});

// ===== EMAIL TEMPLATES =====
var currentTplTab='cold';

var COLD_EMAILS=[
  {id:'cold1',title:'Email 1 â€” The Wake-Up Call',timing:'Day 1',
   subjects:['{{FirstName}}, do you know what your crew is saying about you?','The $8,000 problem hiding in your crew right now'],
   body:'Hi {{FirstName}},\n\nQuick question \u2014 when was the last time one of your crew members quit and you didn\'t see it coming?\n\nIf you\'re like most lawn care owners I talk to, the answer is \u201ctoo recently.\u201d\n\nHere\'s the thing: replacing a single crew member costs $5,000\u2013$10,000 when you add up recruiting, training, and the jobs that slip while you\'re short-handed. And most owners have no idea there\'s a problem until someone walks.\n\nThat\'s what Crew Voice fixes. Every month, we call each of your crew members \u2014 in English or Spanish \u2014 and give you a clear report on morale, frustrations, and who might be thinking about leaving.\n\nIt\'s like having an early warning system for your team. No surveys. No apps. Just real conversations.\n\nFor a small monthly investment, we handle everything \u2014 and if the first report doesn\'t surface anything useful, you don\'t pay.\n\nWorth a 15-minute call to see if it\'s a fit?\n\n\u2014 Luke Larsen\nFounder, Crew Voice\n(864) 334-6982\nhttps://mycrewvoice.com'},
  {id:'cold2',title:'Email 2 â€” The Language Gap',timing:'Day 3',
   subjects:['Your Spanish-speaking crew has something to tell you','What your crew says when you can\'t understand them'],
   body:'Hi {{FirstName}},\n\nI reached out a couple days ago and wanted to follow up with something specific.\n\nIf any of your crew at {{CompanyName}} speaks primarily Spanish, you\'ve probably felt this: there\'s a gap between what you know and what\'s actually going on.\n\nIt\'s not that you don\'t care. It\'s that conversations about frustrations, pay, and whether someone\'s thinking about leaving don\'t happen through Google Translate.\n\nThat\'s the core of what Crew Voice does. We assign a bilingual interviewer to your team \u2014 someone who speaks fluent Spanish and English \u2014 and they have real 1-on-1 phone conversations with every crew member each month.\n\nYou get a report that tells you:\n\u2022 Overall team morale (High / Medium / Low)\n\u2022 The top 3 things your crew appreciates\n\u2022 The top 3 things frustrating them\n\u2022 Who might be a flight risk \u2014 before they hand in notice\n\nWould 15 minutes be worth it to see if this could work for {{CompanyName}}?\n\n\u2014 Luke Larsen\nFounder, Crew Voice\n(864) 334-6982\nhttps://mycrewvoice.com'},
  {id:'cold3',title:'Email 3 â€” The Math',timing:'Day 7',
   subjects:['$299/mo vs. $8,000 to replace one guy','Last note \u2014 then I\'ll leave you alone, {{FirstName}}'],
   body:'Hi {{FirstName}},\n\nLast email from me on this \u2014 I know you\'re busy running crews.\n\nHere\'s the simple math on Crew Voice:\n\nLosing one crew member costs you:\n\u2022 $2,000+ in recruiting and hiring\n\u2022 $3,000+ in training a replacement\n\u2022 $3,000+ in lost productivity and delayed jobs\n\u2022 Total: $5,000\u2013$10,000 per turnover event\n\nCrew Voice costs:\n\u2022 Starting at $299/month for a crew of 8\n\u2022 That\'s less than $38 per person\n\u2022 Month-to-month \u2014 cancel anytime with 14 days notice\n\u2022 First month guarantee: if the report doesn\'t surface anything useful, you pay nothing\n\nPreventing even one resignation per year more than pays for itself.\n\nWe handle everything: scheduling, calling your crew (in English or Spanish), writing up the report, and delivering it to you. You don\'t have to do anything except read it.\n\nIf you\'re open to a quick call, I\'d love to show you exactly what a Crew Voice report looks like.\n\nEither way, I appreciate your time, {{FirstName}}. Keep building.\n\n\u2014 Luke Larsen\nFounder, Crew Voice\n(864) 334-6982\nhttps://mycrewvoice.com'},
  {id:'cold4',title:'Email 4 â€” The Spring Rush',timing:'Seasonal / Anytime',
   subjects:['Your crew this spring','Quick question about your mowers','Communication out in the field','Turnover / English & Spanish','Keeping your best guys'],
   body:'Hey {{FirstName}},\n\nLosing a reliable guy on the mowers right as the season ramps up is a nightmare, especially when language barriers make it hard to know they were unhappy in the first place.\n\nWe do monthly, bilingual (English & Spanish) check-ins with your guys to catch those frustrations and keep your team dialed in. It starts at $299/mo and easily pays for itself by saving just one trained worker from walking.\n\nAre you open to a quick chat to see if this makes sense for your crew?\n\nBest,\nLuke\nCrew Voice | (864) 334-6982\nhttps://mycrewvoice.com'},
  {id:'cold5',title:'Email 5 â€” Equipment & Rookies',timing:'Anytime',
   subjects:['Your crew this spring','Quick question about your mowers','Communication out in the field','Turnover / English & Spanish','Keeping your best guys'],
   body:'Hey {{FirstName}},\n\nHigh turnover in landscaping usually means constantly training rookies who work half as fast and are harder on the equipment.\n\nWe help stop the revolving door for teams of 3 to 25 workers. We handle monthly, bilingual check-ins with your guys in the field to find out exactly what\'s hurting morale before they leave for another company.\n\nOur starter package is $299/mo. Mind if I send over a quick breakdown of how the reporting works?\n\nThanks,\nLuke\nCrew Voice | (864) 334-6982\nhttps://mycrewvoice.com'},
  {id:'cold6',title:'Email 6 â€” The 2-Sentence Direct Pitch',timing:'Anytime (mobile-optimized)',
   subjects:['Your crew this spring','Quick question about your mowers','Communication out in the field','Turnover / English & Spanish','Keeping your best guys'],
   body:'Hey {{FirstName}},\n\nWe run monthly, bilingual (English & Spanish) interviews for landscaping teams to catch flight risks before they quit.\n\nIs keeping your best guys a big enough headache right now that you\'d be open to seeing how it works?\n\nBest,\nLuke\nCrew Voice | (864) 334-6982\nhttps://mycrewvoice.com'}
];

var FOLLOWUP_EMAILS=[
  {id:'fu1',title:'Email 1 â€” The Recap',timing:'Same day (within 2 hours)',
   subjects:['Great talking today, {{FirstName}}'],
   body:'Hi {{FirstName}},\n\nReally enjoyed our conversation today. It\'s clear you care about your crew at {{CompanyName}}, and that says a lot about you as an owner.\n\nHere\'s a quick recap of what we talked about:\n\nThe problem: {{PainPoint}} \u2014 and not having a consistent way to know how your crew is really feeling.\n\nHow Crew Voice helps:\n\u2022 Monthly 1-on-1 phone interviews with each crew member (English & Spanish)\n\u2022 1-page report with morale score, top concerns, and retention risk flags\n\u2022 You read it in 5 minutes and know exactly where your team stands\n\nWhat it costs:\n\u2022 {{MonthlyPrice}}/month for your team of {{CrewSize}}\n\u2022 Month-to-month \u2014 cancel anytime with 14 days notice\n\u2022 First month guaranteed \u2014 if we don\'t surface anything actionable, full refund\n\nNext step: If you\'re ready to go, just reply \u201cI\'m in\u201d and I\'ll send over the service agreement. We can have your first interviews scheduled within a week.\n\nIf you have any questions, just reply to this email or call me at (864) 334-6982.\n\nTalk soon,\n\nLuke Larsen\nFounder, Crew Voice\nhttps://mycrewvoice.com'},
  {id:'fu2',title:'Email 2 â€” Thinking It Over',timing:'Day 3',
   subjects:['Quick thought about {{CompanyName}}\'s crew'],
   body:'Hi {{FirstName}},\n\nI\'ve been thinking about our conversation and wanted to share something.\n\nMost owners I talk to are in one of two spots:\n\n1. \u201cI know I need this, I just need to pull the trigger.\u201d \u2014 If that\'s you, I totally get it. Just reply and I\'ll make it easy. We can start next week.\n\n2. \u201cI\'m not sure it\'ll work for MY crew.\u201d \u2014 Fair concern. Here\'s what I can tell you: crew members who won\'t open up to their boss will talk to a neutral third party. Especially one who speaks their language. We see it every time.\n\nEither way, the first month is guaranteed. If the report doesn\'t give you anything useful, you don\'t pay. There\'s genuinely no risk in trying.\n\nWorth giving it a shot?\n\n\u2014 Luke\n(864) 334-6982\nhttps://mycrewvoice.com'},
  {id:'fu3',title:'Email 3 â€” The Urgency',timing:'Day 7',
   subjects:['Before your next guy walks, {{FirstName}}'],
   body:'Hi {{FirstName}},\n\nWanted to check in one more time.\n\nHere\'s the reality: somewhere on your crew right now, someone is frustrated about something you don\'t know about. Maybe it\'s the schedule. Maybe it\'s a coworker. Maybe they got a better offer and they\'re weighing it.\n\nYou won\'t know until they quit. Unless someone asks.\n\nThat\'s all Crew Voice is. Someone asking \u2014 every month \u2014 so you\'re never blindsided.\n\n{{MonthlyPrice}}/month. First month guaranteed. We handle everything.\n\nIf you want to get started, just reply or grab a time on my calendar.\n\nNo pressure either way, {{FirstName}}. I\'m here when you\'re ready.\n\n\u2014 Luke\n(864) 334-6982\nhttps://mycrewvoice.com'},
  {id:'fu4',title:'Email 4 â€” The Nurture',timing:'Day 14',
   subjects:['No rush \u2014 but wanted to share this'],
   body:'Hi {{FirstName}},\n\nI know the timing might not be right, and that\'s totally fine.\n\nI wanted to pass along something that might be helpful regardless of whether we work together:\n\nThe 3 cheapest ways to reduce crew turnover:\n\n1. Ask one real question per week. Not \u201chow\'s it going?\u201d Something specific: \u201cWhat\'s one thing that would make your day easier?\u201d You\'d be surprised what people say when you actually ask.\n\n2. Recognize someone publicly once a week. In front of the crew. Doesn\'t have to be a big deal \u2014 \u201cMiguel crushed it on the Johnson property yesterday.\u201d People stay where they feel seen.\n\n3. Fix one small thing. That broken trimmer everyone complains about? The truck AC that doesn\'t work? Fix it. It signals that you listen and you care.\n\nThese cost almost nothing and they work.\n\nWhen you\'re ready to go deeper \u2014 consistent monthly check-ins, bilingual interviews, real retention intelligence \u2014 Crew Voice is here.\n\nNo expiration on our conversation. Just reach out anytime.\n\n\u2014 Luke\nCrew Voice | https://mycrewvoice.com'},
  {id:'fu5',title:'Email 5 â€” The Win-Back',timing:'Day 30',
   subjects:['Still thinking about {{CompanyName}}\'s crew'],
   body:'Hi {{FirstName}},\n\nIt\'s been about a month since we talked, and I wanted to reach out one last time.\n\nI\'ll be honest \u2014 a lot can change in 30 days. You might have lost someone. You might have had a near-miss. Or things might be going great and retention isn\'t top of mind.\n\nEither way, here\'s where I\'ll leave it:\n\nCrew Voice is $299/month for up to 8 crew members. We call each person monthly, in English or Spanish, and give you a one-page report on morale, frustrations, and retention risks.\n\nIf your first report doesn\'t surface something useful, you don\'t pay.\n\nThe offer stands whenever you\'re ready. No expiration. Just reply to this email or call (864) 334-6982.\n\nI appreciate your time, {{FirstName}}. Keep building that team.\n\n\u2014 Luke Larsen\nFounder, Crew Voice\nhttps://mycrewvoice.com'}
];

var LINKEDIN_TEMPLATES=[
  {id:'li-conn',title:'Connection Requests',timing:'300 char limit',
   variants:[
     {label:'A \u2014 Mutual Interest',body:'Hi {{FirstName}} \u2014 I work with lawn care owners on crew retention and saw we\'re in the same space. Always looking to connect with people building real teams. Would love to link up.'},
     {label:'B \u2014 Specific Compliment',body:'{{FirstName}} \u2014 saw {{CompanyName}} is doing great work in {{City}}. I help landscaping owners keep their best crew members around longer. Would be great to connect.'},
     {label:'C \u2014 Group-Based',body:'Hi {{FirstName}} \u2014 noticed we\'re both in [Group Name]. I focus on crew retention for lawn care companies. Always good to connect with owners who invest in their people.'}
   ]},
  {id:'li-follow',title:'Follow-Up After Connection',timing:'Send 24\u201348 hours after they accept',
   variants:[
     {label:'A \u2014 Soft Opener',body:'Thanks for connecting, {{FirstName}}! Quick question \u2014 what\'s your biggest headache when it comes to keeping good crew members?\n\nI\'ve been talking to a lot of lawn care owners lately and turnover keeps coming up as the #1 issue. Curious if it\'s the same for you at {{CompanyName}}.\n\nNo pitch \u2014 just genuinely curious.'},
     {label:'B \u2014 Value-First',body:'Appreciate the connection, {{FirstName}}!\n\nI put together a quick breakdown of the 7 warning signs that a crew member is about to quit \u2014 pulled from real conversations with landscaping teams. Would you want me to send it over?\n\nEither way, great to be connected.'},
     {label:'C \u2014 Direct',body:'Thanks for connecting! I run Crew Voice \u2014 we do monthly phone check-ins with lawn care crews (in English and Spanish) and report back to the owner on morale, frustrations, and retention risks.\n\nIf that sounds interesting, I\'d love to tell you more. If not, no worries at all \u2014 glad to be in your network.'}
   ]},
  {id:'li-inmail',title:'InMail \u2014 Cold Outreach',timing:'For prospects you\'re not connected with',
   subjects:['Your crew has something to tell you'],
   body:'Hi {{FirstName}},\n\nI know this is a cold message, so I\'ll keep it short.\n\nI run a service called Crew Voice. Every month, we call each of your crew members \u2014 in English or Spanish \u2014 and give you a report on how they\'re feeling, what\'s frustrating them, and whether anyone\'s thinking about leaving.\n\nThink of it as an early warning system for your team.\n\nMost lawn care owners I talk to have lost a key person in the last year and didn\'t see it coming. For $299/month, we make sure that doesn\'t happen again.\n\nIf you\'ve got 15 minutes this week, I\'d love to walk you through how it works and show you a sample report.\n\nEither way \u2014 respect the hustle, {{FirstName}}. Keep building.\n\n\u2014 Luke\nCrew Voice | https://mycrewvoice.com'},
  {id:'li-comment',title:'Comment Templates',timing:'Adapt to the specific post',
   variants:[
     {label:'Lost an employee',body:'This is one of the most expensive things in our industry and nobody talks about it. I\'ve seen the numbers \u2014 $5K\u2013$10K to replace a single crew member when you factor in recruiting, training, and the jobs that slip. The real question is: did you see it coming? Usually the signs are there weeks before they quit.'},
     {label:'Managing Spanish crews',body:'The language barrier is real and it goes beyond just giving instructions. The conversations about how someone\'s feeling, whether they\'re happy, whether they\'re thinking about leaving \u2014 those just don\'t happen when there\'s a language gap. That\'s a blind spot most owners don\'t realize they have until it\'s too late.'},
     {label:'Growth / hiring',body:'Congrats on the growth! One thing I\'d keep an eye on \u2014 as you scale, it gets harder to stay connected to how your crew is really feeling. The owners I work with who retain the best say the secret is consistent check-ins, not just annual reviews or waiting until someone\'s already got one foot out the door.'},
     {label:'Win / milestone',body:'Love seeing this, {{FirstName}}. Growth like this doesn\'t happen without a solid crew behind you. The companies that keep winning are the ones that invest in keeping their people, not just finding new ones.'}
   ]}
];

function renderTemplates(){
  renderTplContent();
}

function tplContactChanged(){renderTplContent()}

function switchTplTab(tab){
  currentTplTab=tab;
  document.querySelectorAll('.tpl-tab').forEach(function(t){t.classList.remove('active')});
  document.querySelectorAll('.tpl-tab').forEach(function(t){
    if(t.textContent.toLowerCase().indexOf(tab==='cold'?'cold':tab==='followup'?'follow':tab)>=0) t.classList.add('active');
  });
  renderTplContent();
}

function getTplVars(){
  var contactId=document.getElementById('tpl-contact-select').value;
  var c=contactId?data.contacts.find(function(x){return x.id===contactId}):null;
  var pain=document.getElementById('tpl-pain').value.trim();
  var price=c?'$'+contactRevenue(c):'$299';
  return {
    '{{FirstName}}':c?esc(c.ownerName.split(' ')[0]):'{{FirstName}}',
    '{{CompanyName}}':c?esc(c.company):'{{CompanyName}}',
    '{{CrewSize}}':c?(c.crewSize||'{{CrewSize}}').toString():'{{CrewSize}}',
    '{{MonthlyPrice}}':c?price:'{{MonthlyPrice}}',
    '{{PainPoint}}':pain||'{{PainPoint}}',
    '{{City}}':c&&c.state?esc(c.state):'{{City}}'
  };
}

function cleanEmptyFirstName(text){
  text=text.replace(/(Hi|Hey) \{\{FirstName\}\},/g,'$1 there,');
  text=text.replace(/(Hi|Hey) \{\{FirstName\}\} â€”/g,'$1 there â€”');
  text=text.replace(/^\{\{FirstName\}\} â€” (\w)/gm,function(m,c){return c.toUpperCase()});
  text=text.replace(/, \{\{FirstName\}\}([.!?])/g,'$1');
  text=text.replace(/, \{\{FirstName\}\}\s*$/gm,'');
  text=text.replace(/^\{\{FirstName\}\}, (\w)/gm,function(m,c){return c.toUpperCase()});
  text=text.split('{{FirstName}}').join('');
  text=text.replace(/  +/g,' ');
  return text;
}

function fillTemplate(text){
  var vars=getTplVars();
  var firstName=vars['{{FirstName}}'];
  for(var key in vars){
    if(key==='{{FirstName}}') continue;
    text=text.split(key).join(vars[key]);
  }
  if(firstName==='{{FirstName}}'){
    // No contact selected â€” leave placeholder visible
  } else if(firstName){
    text=text.split('{{FirstName}}').join(firstName);
  } else {
    text=cleanEmptyFirstName(text);
  }
  return text;
}

function renderTplContent(){
  var html='';
  if(currentTplTab==='cold'){
    COLD_EMAILS.forEach(function(e){html+=buildEmailCard(e)});
  }else if(currentTplTab==='followup'){
    FOLLOWUP_EMAILS.forEach(function(e){html+=buildEmailCard(e)});
  }else{
    LINKEDIN_TEMPLATES.forEach(function(e){html+=buildLinkedInCard(e)});
  }
  document.getElementById('tpl-content').innerHTML=html;
}

function buildEmailCard(e){
  var subjects=e.subjects.map(function(s){return fillTemplate(s)});
  var body=fillTemplate(e.body);
  var labels='ABCDE';
  var subjectHtml=subjects.map(function(s,i){
    var label=subjects.length>1?'Subject '+labels[i]:'Subject';
    return '<div class="tpl-subject">'
      +'<span class="tpl-subject-label">'+label+'</span>'
      +'<span class="tpl-subject-text">'+esc(s)+'</span>'
      +'<button class="btn btn-ghost btn-sm" onclick="copyTplText(this,\'subject\',\''+e.id+'-'+i+'\')">Copy</button>'
      +'</div>'
      +'<textarea class="tpl-hidden-text" id="tpl-subj-'+e.id+'-'+i+'" style="display:none">'+esc(s)+'</textarea>';
  }).join('');
  // Subject picker for Send Email
  var subjectPicker='';
  if(subjects.length>1){
    subjectPicker='<select id="tpl-send-subj-'+e.id+'" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:12px;margin-right:6px">'
      +subjects.map(function(s,i){return'<option value="'+i+'">'+labels[i]+': '+esc(s)+'</option>'}).join('')
      +'</select>';
  }
  return '<div class="tpl-card" id="tpl-card-'+e.id+'">'
    +'<div class="tpl-card-head" onclick="toggleTplCard(\''+e.id+'\')">'
    +'<span class="tpl-card-title">'+esc(e.title)+'</span>'
    +'<span class="tpl-card-timing">'+esc(e.timing)+'</span>'
    +'</div>'
    +'<div class="tpl-card-body">'
    +subjectHtml
    +'<div class="tpl-body-text" id="tpl-body-'+e.id+'">'+esc(body)+'</div>'
    +'<div class="tpl-copy-bar">'
    +'<button class="btn btn-gold btn-sm" onclick="logSendFromCard(this)" data-tpl="'+esc(e.title)+'" style="margin-right:auto">Log Send</button>'
    +subjectPicker
    +'<button class="btn btn-ghost btn-sm" onclick="sendEmailMailto(\''+e.id+'\')">&#9993; Send Email</button>'
    +'<button class="btn btn-ghost btn-sm" onclick="copyTplBody(\''+e.id+'\')">Copy Body</button>'
    +'<button class="btn btn-primary btn-sm" onclick="copyTplFull(\''+e.id+'\')">Copy Full Email</button>'
    +'</div>'
    +'</div></div>';
}

function buildLinkedInCard(e){
  var inner='';
  if(e.variants){
    e.variants.forEach(function(v,i){
      var body=fillTemplate(v.body);
      inner+='<div style="margin-bottom:10px">'
        +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">'
        +'<span style="font-size:12px;font-weight:600;color:var(--text-2)">'+esc(v.label)+'</span>'
        +'<button class="btn btn-ghost btn-sm" onclick="copyTplEl(\'tpl-li-'+e.id+'-'+i+'\')">Copy</button>'
        +'</div>'
        +'<div class="tpl-body-text" id="tpl-li-'+e.id+'-'+i+'" style="max-height:150px">'+esc(body)+'</div>'
        +'</div>';
    });
  }else{
    if(e.subjects){
      e.subjects.forEach(function(s){
        var subj=fillTemplate(s);
        inner+='<div class="tpl-subject">'
          +'<span class="tpl-subject-label">Subject</span>'
          +'<span class="tpl-subject-text">'+esc(subj)+'</span>'
          +'<button class="btn btn-ghost btn-sm" onclick="copyTplEl(\'tpl-li-subj-'+e.id+'\')">Copy</button>'
          +'</div>'
          +'<textarea id="tpl-li-subj-'+e.id+'" style="display:none">'+esc(subj)+'</textarea>';
      });
    }
    var body=fillTemplate(e.body);
    inner+='<div class="tpl-body-text" id="tpl-li-body-'+e.id+'">'+esc(body)+'</div>'
      +'<div class="tpl-copy-bar"><button class="btn btn-primary btn-sm" onclick="copyTplEl(\'tpl-li-body-'+e.id+'\')">Copy</button></div>';
  }
  return '<div class="tpl-card" id="tpl-card-'+e.id+'">'
    +'<div class="tpl-card-head" onclick="toggleTplCard(\''+e.id+'\')">'
    +'<span class="tpl-card-title">'+esc(e.title)+'</span>'
    +'<span class="tpl-card-timing">'+esc(e.timing)+'</span>'
    +'</div>'
    +'<div class="tpl-card-body">'+inner+'</div></div>';
}

function toggleTplCard(id){
  document.getElementById('tpl-card-'+id).classList.toggle('open');
}

function copyTplText(btn,type,key){
  var el=document.getElementById('tpl-subj-'+key);
  if(el){
    navigator.clipboard.writeText(el.value);
    showCopyToast('Subject copied!');
  }
}

function copyTplBody(id){
  var el=document.getElementById('tpl-body-'+id);
  if(el){
    navigator.clipboard.writeText(el.textContent);
    showCopyToast('Email body copied!');
  }
}

function copyTplFull(id){
  // Find the first subject
  var subj='';
  var subjEl=document.getElementById('tpl-subj-'+id+'-0');
  if(subjEl) subj=subjEl.value;
  var bodyEl=document.getElementById('tpl-body-'+id);
  var body=bodyEl?bodyEl.textContent:'';
  var full=subj?'Subject: '+subj+'\n\n'+body:body;
  navigator.clipboard.writeText(full);
  showCopyToast('Full email copied!');
}

function sendEmailMailto(id){
  // Get selected contact email
  var contactId=document.getElementById('tpl-contact-select').value;
  var c=contactId?data.contacts.find(function(x){return x.id===contactId}):null;
  var toEmail=c&&c.email?c.email:'';
  if(!toEmail){showCopyToast('Select a contact with an email first');return}

  // Get subject from picker or default to first
  var subjIdx=0;
  var picker=document.getElementById('tpl-send-subj-'+id);
  if(picker)subjIdx=parseInt(picker.value)||0;
  var subjEl=document.getElementById('tpl-subj-'+id+'-'+subjIdx);
  var subj=subjEl?subjEl.value:'';

  // Get body
  var bodyEl=document.getElementById('tpl-body-'+id);
  var body=bodyEl?bodyEl.textContent:'';

  // Build mailto link
  var mailto='mailto:'+encodeURIComponent(toEmail)+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body);
  window.open(mailto,'_blank');
}

function copyTplEl(id){
  var el=document.getElementById(id);
  if(!el)return;
  var text=el.tagName==='TEXTAREA'?el.value:el.textContent;
  navigator.clipboard.writeText(text);
  showCopyToast('Copied!');
}

function showCopyToast(msg){
  var toast=document.getElementById('copied-toast');
  toast.textContent=msg;
  toast.style.opacity='1';
  clearTimeout(toast._t);
  toast._t=setTimeout(function(){toast.style.opacity='0'},1500);
}

// ===== SEND TRACKING =====
function logSendFromCard(btn){
  var tpl=btn.getAttribute('data-tpl')||'';
  openSendModal(tpl);
}

function openSendModal(templateName){
  // Pre-fill contact from template bar if one is chosen
  var tplContactId=document.getElementById('tpl-contact-select').value;
  var searchInput=document.getElementById('send-contact-search');
  var hiddenInput=document.getElementById('send-contact');
  if(tplContactId){
    var c=data.contacts.find(function(x){return x.id===tplContactId});
    if(c){
      searchInput.value=c.company+' \u2014 '+c.ownerName;
      hiddenInput.value=tplContactId;
    }
  }else{
    searchInput.value='';
    hiddenInput.value='';
  }
  // Try to match the template name to a select option
  var tplSel=document.getElementById('send-template');
  var matched=false;
  if(templateName){
    for(var i=0;i<tplSel.options.length;i++){
      if(tplSel.options[i].value.indexOf(templateName.replace(/Email \d+ â€” /,''))>=0||templateName.indexOf(tplSel.options[i].value)>=0){
        tplSel.value=tplSel.options[i].value;matched=true;break;
      }
    }
  }
  if(!matched) tplSel.selectedIndex=1;
  document.getElementById('send-date').value=todayStr();
  document.getElementById('send-replied').value='no';
  document.getElementById('send-notes').value='';
  openModal('send-modal');
}

function saveSend(){
  var contactId=document.getElementById('send-contact').value;
  if(!contactId){alert('Select a contact.');return;}
  var contact=data.contacts.find(function(c){return c.id===contactId});
  if(!data.emailSends) data.emailSends=[];
  data.emailSends.push({
    id:uid(),
    contactId:contactId,
    contactName:contact?contact.company:'',
    template:document.getElementById('send-template').value,
    date:document.getElementById('send-date').value||todayStr(),
    replied:document.getElementById('send-replied').value==='yes',
    notes:document.getElementById('send-notes').value.trim()
  });
  // Auto-advance Lead â†’ Contacted
  if(contact&&contact.status==='Lead'){
    contact.status='Contacted';
    contact.lastContact=new Date().toISOString().split('T')[0];
  }
  saveData(data);
  closeModal('send-modal');
  renderTemplates();
}

function toggleSendReply(sendId){
  if(!data.emailSends)return;
  var s=data.emailSends.find(function(x){return x.id===sendId});
  if(s){
    s.replied=!s.replied;
    // Auto-advance contact to Replied when marking as replied
    if(s.replied&&s.contactId){
      var contact=data.contacts.find(function(c){return c.id===s.contactId});
      if(contact&&(contact.status==='Lead'||contact.status==='Contacted')){
        contact.status='Replied';
        contact.lastContact=new Date().toISOString().split('T')[0];
      }
    }
    saveData(data);
    renderTemplates();
  }
}

function deleteSend(sendId){
  if(!data.emailSends)return;
  data.emailSends=data.emailSends.filter(function(x){return x.id!==sendId});
  saveData(data);
  renderTemplates();
}

var tplStatsFilter=null;

function filterByTemplate(name){
  tplStatsFilter=tplStatsFilter===name?null:name;
  renderTplStats();
}

function renderTplStats(){
  // Clean up previous detail panel
  var oldPanel=document.getElementById('tpl-detail-panel');
  if(oldPanel)oldPanel.remove();

  var sends=data.emailSends||[];
  if(!sends.length){
    document.getElementById('tpl-stats').innerHTML='<div style="color:var(--text-3);font-size:12px">No sends logged yet. Use the copy buttons above, then log your sends to track performance.</div>';
    document.getElementById('tpl-send-log').innerHTML='';
    return;
  }
  // Group by template
  var byTemplate={};
  sends.forEach(function(s){
    if(!byTemplate[s.template]) byTemplate[s.template]={sent:0,replied:0};
    byTemplate[s.template].sent++;
    if(s.replied) byTemplate[s.template].replied++;
  });
  var sorted=Object.keys(byTemplate).sort(function(a,b){
    var rateA=byTemplate[a].sent?byTemplate[a].replied/byTemplate[a].sent:0;
    var rateB=byTemplate[b].sent?byTemplate[b].replied/byTemplate[b].sent:0;
    return rateB-rateA;
  });
  document.getElementById('tpl-stats').innerHTML=sorted.map(function(name){
    var t=byTemplate[name];
    var rate=t.sent?Math.round((t.replied/t.sent)*100):0;
    var barColor=rate>=40?'var(--green)':rate>=20?'var(--gold)':'var(--text-3)';
    var isActive=tplStatsFilter===name;
    return '<div class="tpl-stat" style="cursor:pointer;'+(isActive?'border-color:var(--green);background:rgba(76,175,80,.06)':'')+'" onclick="filterByTemplate(\''+esc(name).replace(/'/g,"\\'")+'\')">'
      +'<div class="tpl-stat-name">'+esc(name)+'</div>'
      +'<div class="tpl-stat-row"><span>Sent</span><strong>'+t.sent+'</strong></div>'
      +'<div class="tpl-stat-row"><span>Replied</span><strong style="color:var(--green)">'+t.replied+'</strong></div>'
      +'<div class="tpl-stat-row"><span>Reply Rate</span><strong style="color:'+barColor+'">'+rate+'%</strong></div>'
      +'<div class="prog" style="margin-top:6px"><div class="prog-fill" style="width:'+rate+'%;background:'+barColor+'"></div></div>'
      +'</div>';
  }).join('');

  // Template detail panel - shows all leads who got the selected template
  if(tplStatsFilter){
    var tplSends=sends.filter(function(s){return s.template===tplStatsFilter});
    tplSends.sort(function(a,b){return(b.date||'').localeCompare(a.date||'')});
    var detailHtml='<div style="margin-top:12px;padding:12px;background:var(--surface);border:1px solid var(--green);border-radius:8px">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
      +'<div style="font-size:13px;font-weight:700;color:var(--green)">'+esc(tplStatsFilter)+' â€” '+tplSends.length+' leads</div>'
      +'<button class="btn btn-ghost btn-sm" onclick="tplStatsFilter=null;renderTplStats()">Close</button></div>';
    tplSends.forEach(function(s){
      var c=data.contacts.find(function(x){return x.id===s.contactId});
      var name=c?(c.company+' â€” '+c.ownerName):(s.contactName||'Unknown');
      var stage=c?c.status:'â€”';
      var stageColor=c?STAGE_COLORS[c.status]||'blue':'blue';
      detailHtml+='<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;margin-bottom:3px;font-size:12px">'
        +'<span style="font-weight:600;flex:1">'+esc(name)+'</span>'
        +(c&&c.email?'<span style="color:var(--text-3)">'+esc(c.email)+'</span>':'')
        +'<span class="tag tag-'+stageColor+'" style="font-size:10px">'+stage+'</span>'
        +'<span style="color:var(--text-3)">'+s.date+'</span>'
        +'<span class="tpl-reply-badge '+(s.replied?'replied':'no-reply')+'" onclick="toggleSendReply(\''+s.id+'\')" style="cursor:pointer;font-size:10px">'+(s.replied?'&#10003; Replied':'No Reply')+'</span>'
        +'</div>';
    });
    detailHtml+='</div>';
    document.getElementById('tpl-stats').insertAdjacentHTML('afterend','<div id="tpl-detail-panel">'+detailHtml+'</div>');
  }

  // Recent sends with search
  var searchVal=(document.getElementById('send-log-search').value||'').toLowerCase();
  var recent=sends.slice().sort(function(a,b){return(b.date||'').localeCompare(a.date||'')});

  // Resolve contact names (local map, don't pollute data)
  var contactNames={};
  recent.forEach(function(s){
    var c=data.contacts.find(function(x){return x.id===s.contactId});
    contactNames[s.id]=c?(c.company+' â€” '+c.ownerName):(s.contactName||'Unknown');
  });

  if(searchVal){
    recent=recent.filter(function(s){
      return contactNames[s.id].toLowerCase().indexOf(searchVal)>=0||
        (s.template||'').toLowerCase().indexOf(searchVal)>=0;
    });
  }

  recent=recent.slice(0,30);
  document.getElementById('tpl-send-log').innerHTML=recent.length?recent.map(function(s){
    return '<div class="tpl-send-row">'
      +'<span class="send-date">'+formatDate(s.date)+'</span>'
      +'<span class="send-contact" style="font-weight:600;flex:1">'+esc(contactNames[s.id])+'</span>'
      +'<span class="send-tpl">'+esc(s.template)+'</span>'
      +'<span class="tpl-reply-badge '+(s.replied?'replied':'no-reply')+'" onclick="toggleSendReply(\''+s.id+'\')" style="cursor:pointer" title="Click to toggle">'+(s.replied?'&#10003; Replied':'No Reply')+'</span>'
      +'<button class="btn btn-ghost btn-sm" onclick="deleteSend(\''+s.id+'\')" style="color:var(--red);padding:2px 4px">&times;</button>'
      +'</div>';
  }).join(''):'<div style="text-align:center;padding:16px;color:var(--text-3);font-size:12px">No sends match your search.</div>';
}

// Override renderTemplates to also render stats
var _origRenderTemplates=renderTemplates;
renderTemplates=function(){
  _origRenderTemplates();
  renderTplStats();
};

// ===== BATCH SEND =====
var batchQueue=[];
var batchIdx=0;
var batchSentCount=0;
var batchTemplateId='';
var batchSubjectIdx=0;
var batchTemplateName='';
var batchSelectedIds=[];

function getAllEmailTemplates(){
  var list=[];
  COLD_EMAILS.forEach(function(e){list.push({id:e.id,title:e.title,subjects:e.subjects,body:e.body,group:'cold'})});
  FOLLOWUP_EMAILS.forEach(function(e){list.push({id:e.id,title:e.title,subjects:e.subjects,body:e.body,group:'followup'})});
  return list;
}

function fillTemplateForContact(text,contact){
  var name=contact.ownerName||'';
  var firstName=name.split(' ')[0]||'';
  var price='$'+contactRevenue(contact);
  var vars={
    '{{CompanyName}}':esc(contact.company||''),
    '{{CrewSize}}':(contact.crewSize||'').toString(),
    '{{MonthlyPrice}}':price,
    '{{PainPoint}}':'',
    '{{City}}':contact.state?esc(contact.state):''
  };
  for(var key in vars){text=text.split(key).join(vars[key])}
  if(firstName){
    text=text.split('{{FirstName}}').join(esc(firstName));
  } else {
    text=cleanEmptyFirstName(text);
  }
  return text;
}

function openBatchSend(){
  batchQueue=[];batchIdx=0;batchSentCount=0;
  // Populate contact list
  var contacts=data.contacts.filter(function(c){return !c.badEmail && c.status!=='Lost' && c.status!=='Churned'});
  contacts.sort(function(a,b){return(a.company||'').localeCompare(b.company||'')});
  var html='';
  var industries={};
  contacts.forEach(function(c){
    var ind=c.industry||'Other';
    industries[ind]=true;
    var hasEmail=c.email&&c.email.trim();
    html+='<div class="batch-contact-item'+(hasEmail?'':' no-email')+'" data-id="'+c.id+'" data-industry="'+esc(ind)+'" data-status="'+esc(c.status)+'" data-search="'+(esc(c.company)+' '+esc(c.ownerName)+' '+(c.email||'')).toLowerCase()+'">'
      +'<input type="checkbox" '+(hasEmail?'':'disabled')+' onchange="updateBatchCount()">'
      +'<span class="bc-name">'+esc(c.company)+'</span>'
      +'<span class="bc-email">'+(hasEmail?esc(c.email):'No email')+'</span>'
      +'<span class="bc-stage tag tag-'+(STAGE_COLORS[c.status]||'blue')+'">'+c.status+'</span>'
      +'</div>';
  });
  document.getElementById('batch-contact-list').innerHTML=html||'<div style="padding:16px;text-align:center;color:var(--text-3)">No contacts found</div>';
  // Populate industry filter from actual data
  var indSelect=document.getElementById('batch-filter-industry');
  indSelect.innerHTML='<option value="all">All Industries</option>'+Object.keys(industries).sort().map(function(i){return '<option value="'+esc(i)+'">'+esc(i)+'</option>'}).join('');
  document.getElementById('batch-filter-status').value='all';
  document.getElementById('batch-search').value='';
  document.getElementById('batch-select-all').checked=false;
  updateBatchCount();
  // Populate template dropdown
  var tplSelect=document.getElementById('batch-template');
  var tpls=getAllEmailTemplates();
  var coldGroup='<optgroup label="Cold Emails">';
  var fuGroup='<optgroup label="Post-Call Follow-Up">';
  tpls.forEach(function(t){
    var opt='<option value="'+t.id+'">'+esc(t.title)+'</option>';
    if(t.group==='cold') coldGroup+=opt;
    else fuGroup+=opt;
  });
  tplSelect.innerHTML=coldGroup+'</optgroup>'+fuGroup+'</optgroup>';
  tplSelect.onchange=function(){updateBatchSubjects()};
  updateBatchSubjects();
  // Show step 1
  showBatchStep(1);
  openModal('batch-send-modal');
}

function updateBatchSubjects(){
  var tplId=document.getElementById('batch-template').value;
  var tpls=getAllEmailTemplates();
  var tpl=tpls.find(function(t){return t.id===tplId});
  var subjSelect=document.getElementById('batch-subject');
  if(!tpl){subjSelect.innerHTML='<option>No subjects</option>';return}
  var labels='ABCDE';
  subjSelect.innerHTML=tpl.subjects.map(function(s,i){
    var label=tpl.subjects.length>1?'Subject '+labels[i]+': ':'';
    return '<option value="'+i+'">'+label+esc(s)+'</option>';
  }).join('');
}

function filterBatchContacts(){
  var query=(document.getElementById('batch-search').value||'').toLowerCase();
  var industry=document.getElementById('batch-filter-industry').value;
  var status=document.getElementById('batch-filter-status').value;
  var items=document.querySelectorAll('.batch-contact-item');
  items.forEach(function(item){
    var search=item.getAttribute('data-search')||'';
    var ind=item.getAttribute('data-industry')||'';
    var st=item.getAttribute('data-status')||'';
    var matchText=!query||search.indexOf(query)>=0;
    var matchInd=industry==='all'||ind===industry;
    var matchSt=status==='all'||st===status;
    item.style.display=(matchText&&matchInd&&matchSt)?'':'none';
  });
  // Uncheck hidden items & uncheck select-all
  items.forEach(function(item){
    if(item.style.display==='none'){
      var cb=item.querySelector('input[type="checkbox"]');
      if(cb) cb.checked=false;
    }
  });
  document.getElementById('batch-select-all').checked=false;
  updateBatchCount();
}

function toggleBatchAll(){
  var checked=document.getElementById('batch-select-all').checked;
  var items=document.querySelectorAll('.batch-contact-item:not(.no-email)');
  items.forEach(function(item){
    if(item.style.display!=='none'){
      item.querySelector('input[type="checkbox"]').checked=checked;
    }
  });
  updateBatchCount();
}

function updateBatchCount(){
  var checked=document.querySelectorAll('.batch-contact-item:not(.no-email) input[type="checkbox"]:checked');
  document.getElementById('batch-count').textContent=checked.length+' selected';
}

function getSelectedBatchContactIds(){
  var ids=[];
  document.querySelectorAll('.batch-contact-item:not(.no-email) input[type="checkbox"]:checked').forEach(function(cb){
    ids.push(cb.closest('.batch-contact-item').getAttribute('data-id'));
  });
  return ids;
}

function batchStep2(){
  var ids=getSelectedBatchContactIds();
  if(!ids.length){showCopyToast('Select at least one contact');return}
  batchSelectedIds=ids;
  showBatchStep(2);
}

function batchBackTo1(){
  showBatchStep(1);
}

function showBatchStep(n){
  document.getElementById('batch-step-1').style.display=n===1?'':'none';
  document.getElementById('batch-step-2').style.display=n===2?'':'none';
  document.getElementById('batch-step-3').style.display=n===3?'':'none';
  for(var i=1;i<=3;i++){
    var dot=document.getElementById('batch-dot-'+i);
    dot.className='batch-step-dot'+(i===n?' active':i<n?' done':'');
  }
}

function batchStart(){
  try{
  var ids=batchSelectedIds;
  if(!ids.length){showCopyToast('No contacts selected');return}
  var tplId=document.getElementById('batch-template').value;
  var subjIdx=parseInt(document.getElementById('batch-subject').value)||0;
  var tpls=getAllEmailTemplates();
  var tpl=tpls.find(function(t){return t.id===tplId});
  if(!tpl){showCopyToast('Select a template');return}
  batchTemplateId=tplId;
  batchSubjectIdx=subjIdx;
  batchTemplateName=tpl.title;
  // Build queue
  batchQueue=[];
  ids.forEach(function(id){
    var c=data.contacts.find(function(x){return x.id===id});
    if(!c||!c.email)return;
    var subj=fillTemplateForContact(tpl.subjects[subjIdx]||tpl.subjects[0],c);
    var body=fillTemplateForContact(tpl.body,c);
    batchQueue.push({contactId:c.id,company:c.company,ownerName:c.ownerName||'',email:c.email,subject:subj,body:body,status:c.status});
  });
  if(!batchQueue.length){showCopyToast('No valid contacts');return}
  batchIdx=0;
  batchSentCount=0;
  showBatchStep(3);
  document.getElementById('batch-done-area').style.display='none';
  document.getElementById('batch-current-area').style.display='';
  batchRenderCurrent();
  }catch(err){alert('Batch send error: '+err.message)}
}

function batchRenderCurrent(){
  if(batchIdx>=batchQueue.length){
    batchShowDone();return;
  }
  var item=batchQueue[batchIdx];
  var total=batchQueue.length;
  var pct=Math.round(batchIdx/total*100);
  document.getElementById('batch-prog-label').textContent=(batchIdx+1)+' of '+total;
  document.getElementById('batch-prog-pct').textContent=pct+'%';
  document.getElementById('batch-prog-fill').style.width=pct+'%';
  document.getElementById('batch-current-area').innerHTML=
    '<div class="batch-current">'
    +'<div class="batch-current-name">'+esc(item.company)+' â€” '+esc(item.ownerName)+'</div>'
    +'<div class="batch-current-email">'+esc(item.email)+'</div>'
    +'<div class="batch-current-subj">Subject: '+esc(item.subject)+'</div>'
    +'<div class="batch-current-preview">'+esc(item.body)+'</div>'
    +'</div>'
    +'<div class="batch-actions">'
    +'<button class="btn btn-ghost" onclick="batchSkip()">Skip</button>'
    +'<button class="btn btn-blue" onclick="batchOpenMailto()">&#9993; Open in Outlook</button>'
    +'<button class="btn btn-primary" onclick="batchSentNext()">Sent &mdash; Next &rarr;</button>'
    +'</div>';
}

function batchOpenMailto(){
  var item=batchQueue[batchIdx];
  if(!item)return;
  var mailto='mailto:'+encodeURIComponent(item.email)+'?subject='+encodeURIComponent(item.subject)+'&body='+encodeURIComponent(item.body);
  window.open(mailto,'_blank');
}

function batchSentNext(){
  var item=batchQueue[batchIdx];
  if(!item)return;
  // Log send
  if(!data.emailSends) data.emailSends=[];
  data.emailSends.push({
    id:uid(),
    contactId:item.contactId,
    contactName:item.company,
    template:batchTemplateName,
    date:todayStr(),
    replied:false,
    notes:'Batch send'
  });
  // Auto-advance Lead â†’ Contacted
  var contact=data.contacts.find(function(c){return c.id===item.contactId});
  if(contact&&contact.status==='Lead'){
    contact.status='Contacted';
    contact.lastContact=todayStr();
  }else if(contact){
    contact.lastContact=todayStr();
  }
  saveData(data);
  batchSentCount++;
  batchIdx++;
  batchRenderCurrent();
}

function batchSkip(){
  batchIdx++;
  batchRenderCurrent();
}

function batchShowDone(){
  document.getElementById('batch-prog-label').textContent=batchQueue.length+' of '+batchQueue.length;
  document.getElementById('batch-prog-pct').textContent='100%';
  document.getElementById('batch-prog-fill').style.width='100%';
  document.getElementById('batch-current-area').style.display='none';
  document.getElementById('batch-done-area').style.display='';
  document.getElementById('batch-done-area').innerHTML=
    '<div class="batch-done-screen">'
    +'<div class="done-icon">&#10003;</div>'
    +'<div class="done-text">'+batchSentCount+' email'+(batchSentCount!==1?'s':'')+' sent!</div>'
    +'<div class="done-sub">'+(batchQueue.length-batchSentCount>0?(batchQueue.length-batchSentCount)+' skipped':'All contacts emailed')+'</div>'
    +'<div style="margin-top:16px"><button class="btn btn-primary" onclick="closeBatchSend()">Done</button></div>'
    +'</div>';
}

function closeBatchSend(){
  closeModal('batch-send-modal');
  renderTemplates();
}

// ===== CLAUDE CHAT =====
var chatHistory=[];
var chatSending=false;

function toggleChat(){
  var panel=document.getElementById('chat-panel');
  var overlay=document.getElementById('chat-overlay');
  var isOpen=panel.classList.contains('open');
  panel.classList.toggle('open');
  overlay.classList.toggle('open');
  if(!isOpen) checkApiKey();
}

function checkApiKey(){
  var key=localStorage.getItem('claude_api_key')||'';
  var setup=document.getElementById('chat-key-setup');
  var body=document.getElementById('chat-body');
  if(key){
    setup.style.display='none';
    body.style.display='flex';
    if(!chatHistory.length) addSystemMsg('Claude is ready. Ask about your pipeline, leads, outreach strategy, or anything else.');
  }else{
    setup.style.display='flex';
    body.style.display='none';
  }
}

function saveApiKey(){
  var key=document.getElementById('chat-api-key').value.trim();
  if(!key){alert('Please enter your API key.');return;}
  localStorage.setItem('claude_api_key',key);
  checkApiKey();
}

function chatSettings(){
  var current=localStorage.getItem('claude_api_key')||'';
  var key=prompt('Enter your Claude API key:',current);
  if(key===null)return;
  if(key.trim()){
    localStorage.setItem('claude_api_key',key.trim());
  }else{
    localStorage.removeItem('claude_api_key');
  }
  checkApiKey();
}

function clearChat(){
  chatHistory=[];
  document.getElementById('chat-messages').innerHTML='';
  addSystemMsg('New conversation started.');
}

function addSystemMsg(text){
  var div=document.createElement('div');
  div.className='chat-msg system';
  div.textContent=text;
  document.getElementById('chat-messages').appendChild(div);
  scrollChat();
}

function addChatMsg(role,text){
  var div=document.createElement('div');
  div.className='chat-msg '+role;
  div.innerHTML=formatChatMsg(text);
  document.getElementById('chat-messages').appendChild(div);
  scrollChat();
}

function formatChatMsg(text){
  // Basic markdown: bold, code, line breaks
  return esc(text)
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/`(.*?)`/g,'<code>$1</code>')
    .replace(/\n/g,'<br>');
}

function scrollChat(){
  var el=document.getElementById('chat-messages');
  el.scrollTop=el.scrollHeight;
}

function chatKeydown(e){
  if(e.key==='Enter'&&!e.shiftKey){
    e.preventDefault();
    sendChat();
  }
}

function buildCRMContext(){
  var contacts=data.contacts;
  var closed=contacts.filter(function(c){return c.status==='Closed'});
  var pipeline=contacts.filter(function(c){return c.status!=='Closed'&&c.status!=='Lost'&&c.status!=='Churned'});
  var mrr=closed.reduce(function(s,c){return s+contactRevenue(c)},0);
  var pipeVal=pipeline.reduce(function(s,c){return s+contactRevenue(c)},0);

  var summary='Current CRM snapshot:\n';
  summary+='- Total contacts: '+contacts.length+'\n';
  summary+='- Active clients (Closed): '+closed.length+' â€” MRR: $'+mrr+'\n';
  summary+='- Pipeline contacts: '+pipeline.length+' â€” Potential MRR: $'+pipeVal+'\n';
  summary+='- Goal: 50 clients by Aug 2026, $17,500 MRR\n\n';

  if(contacts.length){
    summary+='Contact list:\n';
    contacts.forEach(function(c){
      summary+='- '+c.company+' ('+c.ownerName+') â€” Stage: '+c.status+', Crew: '+(c.crewSize||'?');
      if(c.state) summary+=', Location: '+c.state;
      if(c.industry) summary+=', Industry: '+c.industry;
      if(c.customPrice) summary+=', Price: $'+c.customPrice+'/mo';
      if(c.notes) summary+=', Notes: '+c.notes;
      summary+='\n';
    });
  }
  return summary;
}

function getSystemPrompt(){
  return 'You are Claude, an AI assistant embedded in the Crew Voice HQ business command center. Crew Voice is a service that provides monthly bilingual (English & Spanish) employee interviews and retention intelligence reports for service businesses, primarily lawn care and landscaping companies.\n\n'
    +'Business details:\n'
    +'- Pricing: $299/mo for teams of 5-8 crew members, +$30 per additional member (owners can set custom pricing)\n'
    +'- Founded by Luke Larsen, phone: (864) 334-6982, email: luke@mycrewvoice.com\n'
    +'- Value prop: Monthly 1-on-1 phone interviews with each crew member, delivered as a 1-page report with morale score, concerns, and retention risk flags\n'
    +'- First month guaranteed â€” if the report doesn\'t surface anything actionable, full refund\n'
    +'- Month-to-month, cancel anytime with 14 days notice\n\n'
    +buildCRMContext()+'\n'
    +'Help Luke with sales strategy, outreach ideas, email drafts, objection handling, pipeline analysis, and growing Crew Voice to 50 clients. Be concise and actionable. When referencing contacts, use their actual names and details from the CRM data above.';
}

function sendChat(){
  if(chatSending)return;
  var input=document.getElementById('chat-input');
  var text=input.value.trim();
  if(!text)return;
  input.value='';
  input.style.height='40px';
  addChatMsg('user',text);
  chatHistory.push({role:'user',content:text});

  chatSending=true;
  document.getElementById('chat-send-btn').disabled=true;

  // Show typing indicator
  var typing=document.createElement('div');
  typing.className='chat-typing';
  typing.id='chat-typing';
  typing.innerHTML='<span>.</span><span>.</span><span>.</span>';
  document.getElementById('chat-messages').appendChild(typing);
  scrollChat();

  var key=localStorage.getItem('claude_api_key');
  fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key':key,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:JSON.stringify({
      model:'claude-sonnet-4-5-20250929',
      max_tokens:1024,
      system:getSystemPrompt(),
      messages:chatHistory.slice(-20)
    })
  })
  .then(function(r){
    if(!r.ok) return r.json().then(function(e){throw new Error(e.error&&e.error.message||'API error '+r.status)});
    return r.json();
  })
  .then(function(res){
    var el=document.getElementById('chat-typing');
    if(el)el.remove();
    var reply=res.content&&res.content[0]&&res.content[0].text||'No response';
    chatHistory.push({role:'assistant',content:reply});
    addChatMsg('assistant',reply);
  })
  .catch(function(err){
    var el=document.getElementById('chat-typing');
    if(el)el.remove();
    addChatMsg('assistant','Error: '+err.message);
    // Remove the failed exchange from history
    if(chatHistory.length&&chatHistory[chatHistory.length-1].role==='user') chatHistory.pop();
  })
  .finally(function(){
    chatSending=false;
    document.getElementById('chat-send-btn').disabled=false;
  });
}

// Auto-resize textarea
document.getElementById('chat-input').addEventListener('input',function(){
  this.style.height='40px';
  this.style.height=Math.min(this.scrollHeight,120)+'px';
});

// ===== QUICK EMAIL =====
var qeContactId=null;
var qeTab='cold';
var qeSelectedTpl=null;

function openQuickEmail(contactId){
  qeContactId=contactId;
  qeTab='cold';
  qeSelectedTpl=null;
  document.getElementById('qe-pain').value='';
  var c=data.contacts.find(function(x){return x.id===contactId});
  if(!c)return;
  document.getElementById('qe-contact-info').innerHTML=
    '<div><div class="qe-contact-name">'+esc(c.ownerName)+'</div><div class="qe-contact-company">'+esc(c.company)+(c.crewSize?' â€” '+c.crewSize+' crew':'')+'</div></div>'
    +'<div style="margin-left:auto;display:flex;align-items:center;gap:8px">'
    +(c.email?'<button class="btn btn-ghost btn-sm" onclick="qeCopyEmail()" style="font-size:11px">&#9993; '+esc(c.email)+'</button>':'')
    +'<span class="tag tag-'+STAGE_COLORS[c.status]+'">'+c.status+'</span></div>';
  renderQuickEmailTabs();
  renderQuickEmailList();
  openModal('quick-email-modal');
}

function renderQuickEmailTabs(){
  var tabs=[{id:'cold',label:'Cold Emails'},{id:'followup',label:'Follow-Up'},{id:'linkedin',label:'LinkedIn'}];
  var html='';
  tabs.forEach(function(t){
    html+='<button class="qe-tab'+(qeTab===t.id?' active':'')+'" onclick="qeTab=\''+t.id+'\';qeSelectedTpl=null;renderQuickEmailList()">'+t.label+'</button>';
  });
  document.getElementById('qe-tabs').innerHTML=html;
}

function qeFillText(text){
  var c=data.contacts.find(function(x){return x.id===qeContactId});
  if(!c)return text;
  var pain=document.getElementById('qe-pain').value.trim();
  var price='$'+contactRevenue(c);
  var firstName=c.ownerName?c.ownerName.split(' ')[0]:'';
  text=text
    .split('{{CompanyName}}').join(esc(c.company))
    .split('{{CrewSize}}').join((c.crewSize||'').toString())
    .split('{{MonthlyPrice}}').join(price)
    .split('{{PainPoint}}').join(pain||'[pain point]')
    .split('{{City}}').join(c.state?esc(c.state):'[city]');
  if(firstName){
    text=text.split('{{FirstName}}').join(esc(firstName));
  } else {
    text=cleanEmptyFirstName(text);
  }
  return text;
}

function renderQuickEmailList(){
  renderQuickEmailTabs();
  var templates=qeTab==='cold'?COLD_EMAILS:qeTab==='followup'?FOLLOWUP_EMAILS:LINKEDIN_TEMPLATES;
  var html='';
  templates.forEach(function(t){
    var isSelected=qeSelectedTpl===t.id;
    html+='<div class="qe-card'+(isSelected?' selected':'')+'" onclick="qeSelectedTpl=\''+t.id+'\';renderQuickEmailList()">'
      +'<div class="qe-card-title">'+esc(t.title)+'</div>'
      +'<div class="qe-card-timing">'+esc(t.timing||'')+'</div></div>';
  });
  document.getElementById('qe-template-list').innerHTML=html;
  renderQuickEmailPreview();
}

function renderQuickEmailPreview(){
  if(!qeSelectedTpl){
    document.getElementById('qe-preview-area').innerHTML='';
    return;
  }
  var allTemplates=COLD_EMAILS.concat(FOLLOWUP_EMAILS).concat(LINKEDIN_TEMPLATES);
  var tpl=allTemplates.find(function(t){return t.id===qeSelectedTpl});
  if(!tpl){document.getElementById('qe-preview-area').innerHTML='';return;}

  var html='<div class="qe-preview">';

  // Handle LinkedIn templates with variants
  if(tpl.variants){
    tpl.variants.forEach(function(v,i){
      var body=qeFillText(v.body);
      html+='<div style="margin-bottom:12px"><div style="font-size:12px;font-weight:600;color:var(--text-2);margin-bottom:4px">'+esc(v.label)+'</div>'
        +'<div class="qe-preview-body" id="qe-li-'+i+'">'+esc(body)+'</div>'
        +'<div style="display:flex;gap:6px;margin-top:6px"><button class="btn btn-primary btn-sm" onclick="qeCopy(\'qe-li-'+i+'\')">Copy</button><button class="btn btn-gold btn-sm qe-log-btn" onclick="qeLogSend()">Log Send</button></div></div>';
    });
  }else{
    // Regular email with subjects
    if(tpl.subjects){
      html+='<div class="qe-preview-subject">';
      tpl.subjects.forEach(function(s,i){
        var subj=qeFillText(s);
        html+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">'
          +'<span style="font-size:12px;color:var(--text-2)">Subject '+(i+1)+':</span>'
          +'<span style="flex:1" id="qe-subj-'+i+'">'+esc(subj)+'</span>'
          +'<button class="btn btn-ghost btn-sm" onclick="qeCopyText(\''+esc(subj).replace(/'/g,"\\'")+'\')">Copy</button></div>';
      });
      html+='</div>';
    }
    if(tpl.body){
      var body=qeFillText(tpl.body);
      html+='<div class="qe-preview-body" id="qe-body">'+esc(body)+'</div>';
      html+='<div class="qe-copy-bar">'
        +'<button class="btn btn-primary btn-sm" onclick="qeCopy(\'qe-body\')">Copy Body</button>'
        +'<button class="btn btn-gold btn-sm" onclick="qeCopyFull()">Copy Full Email</button>'
        +'<button class="btn btn-ghost btn-sm qe-log-btn" style="margin-left:auto;border-color:var(--green);color:var(--green)" onclick="qeLogSend()">Log Send</button>'
        +'</div>';
    }
  }
  html+='</div>';
  document.getElementById('qe-preview-area').innerHTML=html;
}

function qeCopy(elId){
  var el=document.getElementById(elId);
  if(!el)return;
  navigator.clipboard.writeText(el.textContent);
  showToast('Copied!');
}

function qeCopyEmail(){
  var c=data.contacts.find(function(x){return x.id===qeContactId});
  if(!c||!c.email)return;
  navigator.clipboard.writeText(c.email);
  showToast('Email copied: '+c.email);
}

function qeCopyText(text){
  navigator.clipboard.writeText(text);
  showToast('Subject copied!');
}

function qeCopyFull(){
  var subj='';
  var subjEl=document.getElementById('qe-subj-0');
  if(subjEl)subj=subjEl.textContent;
  var bodyEl=document.getElementById('qe-body');
  var body=bodyEl?bodyEl.textContent:'';
  var full=subj?'Subject: '+subj+'\n\n'+body:body;
  navigator.clipboard.writeText(full);
  showToast('Full email copied!');
}

function qeLogSend(){
  if(!qeContactId||!qeSelectedTpl)return;
  var allTemplates=COLD_EMAILS.concat(FOLLOWUP_EMAILS).concat(LINKEDIN_TEMPLATES);
  var tpl=allTemplates.find(function(t){return t.id===qeSelectedTpl});
  if(!tpl)return;
  if(!data.emailSends)data.emailSends=[];
  data.emailSends.push({
    id:uid(),
    contactId:qeContactId,
    template:tpl.title,
    date:new Date().toISOString().split('T')[0],
    replied:false
  });
  // Auto-advance Lead â†’ Contacted
  var contact=data.contacts.find(function(c){return c.id===qeContactId});
  if(contact&&contact.status==='Lead'){
    contact.status='Contacted';
    contact.lastContact=new Date().toISOString().split('T')[0];
  }
  save();
  showToast(contact&&contact.status==='Contacted'?'Send logged â€” moved to Contacted':'Send logged!');
  // Turn all log send buttons green
  document.querySelectorAll('.qe-log-btn').forEach(function(btn){
    btn.style.background='var(--green)';
    btn.style.borderColor='var(--green)';
    btn.style.color='#fff';
    btn.textContent='Logged âœ“';
  });
}

// ===== DAILY BATTLE PLAN =====
var bpCurrentDate=new Date().toISOString().split('T')[0];

function bpPrevDay(){var d=new Date(bpCurrentDate);d.setDate(d.getDate()-1);bpCurrentDate=d.toISOString().split('T')[0];renderBattlePlan();}
function bpNextDay(){var d=new Date(bpCurrentDate);d.setDate(d.getDate()+1);bpCurrentDate=d.toISOString().split('T')[0];renderBattlePlan();}
function bpToday(){bpCurrentDate=new Date().toISOString().split('T')[0];renderBattlePlan();}

function renderBattlePlan(){
  var today=bpCurrentDate;
  var isToday=today===new Date().toISOString().split('T')[0];
  var d=new Date(today+'T12:00:00');
  document.getElementById('bp-date').textContent=d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})+(isToday?' â€” TODAY':'');

  if(!data.battlePlan)data.battlePlan={};
  if(!data.battlePlan[today])data.battlePlan[today]={tasks:[],customTasks:[]};
  var bp=data.battlePlan[today];

  // Auto-generate tasks from CRM data
  var autoTasks=[];

  // Overdue follow-ups
  data.contacts.forEach(function(c){
    if(c.followUpDate && c.followUpDate<=today && c.status!=='Closed' && c.status!=='Lost' && c.status!=='Churned'){
      var isOverdue=c.followUpDate<today;
      autoTasks.push({id:'fu_'+c.id,text:'Follow up with '+esc(c.company)+' ('+esc(c.ownerName)+')',tag:isOverdue?'overdue':'followup',tagLabel:isOverdue?'OVERDUE':'Follow-up',done:bp.tasks.indexOf('fu_'+c.id)>=0});
    }
  });

  // Pipeline actions
  data.contacts.forEach(function(c){
    if(c.status==='Replied'){
      autoTasks.push({id:'pipe_'+c.id,text:'Schedule call with '+esc(c.company),tag:'pipeline',tagLabel:'Pipeline',done:bp.tasks.indexOf('pipe_'+c.id)>=0});
    }else if(c.status==='Call Scheduled'){
      autoTasks.push({id:'call_'+c.id,text:'Prepare for call with '+esc(c.company),tag:'pipeline',tagLabel:'Call Prep',done:bp.tasks.indexOf('call_'+c.id)>=0});
    }else if(c.status==='Proposal Sent'){
      autoTasks.push({id:'prop_'+c.id,text:'Follow up on proposal for '+esc(c.company),tag:'pipeline',tagLabel:'Proposal',done:bp.tasks.indexOf('prop_'+c.id)>=0});
    }
  });

  // Daily outreach targets
  var outreach=[
    {id:'out_email',text:'Send 50 cold emails',tag:'outreach',tagLabel:'Outreach'},
    {id:'out_call',text:'Make 20 calls',tag:'outreach',tagLabel:'Outreach'},
    {id:'out_linkedin',text:'Send 15 LinkedIn connection requests',tag:'outreach',tagLabel:'Outreach'},
    {id:'out_social',text:'Complete social media daily tasks',tag:'outreach',tagLabel:'Social'}
  ];
  outreach.forEach(function(t){t.done=bp.tasks.indexOf(t.id)>=0});
  autoTasks=autoTasks.concat(outreach);

  // Calculate completion
  var customTasks=bp.customTasks||[];
  var allTasks=autoTasks.concat(customTasks.map(function(ct){return{id:ct.id,text:esc(ct.text),tag:'custom',tagLabel:'Custom',done:ct.done}}));
  var totalTasks=allTasks.length;
  var doneTasks=allTasks.filter(function(t){return t.done}).length;
  var pct=totalTasks?Math.round(doneTasks/totalTasks*100):0;

  // Score ring
  var circumf=2*Math.PI*28;
  var offset=circumf-(pct/100)*circumf;
  var color=pct>=80?'var(--green)':pct>=50?'var(--gold)':'var(--red)';
  document.getElementById('bp-score').innerHTML=
    '<div class="bp-score-ring"><svg width="64" height="64" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="none" stroke="var(--border)" stroke-width="5"/><circle cx="32" cy="32" r="28" fill="none" stroke="'+color+'" stroke-width="5" stroke-dasharray="'+circumf+'" stroke-dashoffset="'+offset+'" stroke-linecap="round"/></svg><div class="bp-score-pct" style="color:'+color+'">'+pct+'%</div></div>'
    +'<div><div style="font-size:18px;font-weight:800">'+doneTasks+' / '+totalTasks+' tasks completed</div>'
    +'<div style="font-size:12px;color:var(--text-2);margin-top:2px">'+(pct>=80?'Crushing it today!':pct>=50?'Good progress â€” keep pushing!':'Time to get after it!')+'</div></div>';

  // Render auto tasks grouped
  var html='';
  var overdueTasks=autoTasks.filter(function(t){return t.tag==='overdue'});
  var followupTasks=autoTasks.filter(function(t){return t.tag==='followup'});
  var pipelineTasks=autoTasks.filter(function(t){return t.tag==='pipeline'});
  var outreachTasks=autoTasks.filter(function(t){return t.tag==='outreach'});

  function renderBpGroup(title,tasks,tagClass){
    if(!tasks.length)return '';
    var s='<div class="bp-section"><div class="bp-section-title">'+title+' <span class="bp-count">'+tasks.length+'</span></div>';
    tasks.forEach(function(t){
      s+='<div class="bp-task'+(t.done?' done':'')+'" onclick="toggleBpTask(\''+t.id+'\')">'
        +'<div class="bp-check">'+(t.done?'&#10003;':'')+'</div>'
        +'<span>'+t.text+'</span>'
        +'<span class="bp-tag bp-tag-'+tagClass+'">'+t.tagLabel+'</span></div>';
    });
    s+='</div>';
    return s;
  }

  html+=renderBpGroup('Overdue Follow-Ups',overdueTasks,'overdue');
  html+=renderBpGroup('Today\'s Follow-Ups',followupTasks,'followup');
  html+=renderBpGroup('Pipeline Actions',pipelineTasks,'pipeline');
  html+=renderBpGroup('Daily Outreach',outreachTasks,'outreach');
  document.getElementById('bp-content').innerHTML=html;

  // Custom tasks
  var chtml='';
  customTasks.forEach(function(ct){
    chtml+='<div class="bp-task'+(ct.done?' done':'')+'" onclick="toggleBpCustom(\''+ct.id+'\')">'
      +'<div class="bp-check">'+(ct.done?'&#10003;':'')+'</div>'
      +'<span>'+esc(ct.text)+'</span>'
      +'<span class="bp-tag bp-tag-custom">Custom</span>'
      +'<button class="btn btn-ghost" style="padding:2px 6px;font-size:10px;margin-left:4px" onclick="event.stopPropagation();removeBpTask(\''+ct.id+'\')">&times;</button></div>';
  });
  document.getElementById('bp-custom').innerHTML=chtml;
}

function toggleBpTask(taskId){
  var today=bpCurrentDate;
  if(!data.battlePlan[today])data.battlePlan[today]={tasks:[],customTasks:[]};
  var bp=data.battlePlan[today];
  var idx=bp.tasks.indexOf(taskId);
  if(idx>=0)bp.tasks.splice(idx,1);else bp.tasks.push(taskId);
  save();renderBattlePlan();
}
function toggleBpCustom(taskId){
  var today=bpCurrentDate;
  var bp=data.battlePlan[today];
  if(!bp)return;
  var ct=bp.customTasks.find(function(t){return t.id===taskId});
  if(ct){ct.done=!ct.done;save();renderBattlePlan();}
}
function addBpTask(){
  var input=document.getElementById('bp-new-task');
  var text=input.value.trim();
  if(!text)return;
  var today=bpCurrentDate;
  if(!data.battlePlan[today])data.battlePlan[today]={tasks:[],customTasks:[]};
  data.battlePlan[today].customTasks.push({id:uid(),text:text,done:false});
  input.value='';save();renderBattlePlan();
}
function removeBpTask(taskId){
  var today=bpCurrentDate;
  var bp=data.battlePlan[today];
  if(!bp)return;
  bp.customTasks=bp.customTasks.filter(function(t){return t.id!==taskId});
  save();renderBattlePlan();
}

// ===== TIME AUDIT =====
var TA_CATEGORIES=[
  {id:'prospecting',name:'Prospecting',icon:'&#128232;',color:'#4CAF50'},
  {id:'calls',name:'Sales Calls',icon:'&#128222;',color:'#2196F3'},
  {id:'followups',name:'Follow-Ups',icon:'&#128172;',color:'#9C27B0'},
  {id:'social',name:'Social Media',icon:'&#128241;',color:'#FF7043'},
  {id:'delivery',name:'Client Delivery',icon:'&#127919;',color:'#00BCD4'},
  {id:'admin',name:'Admin',icon:'&#128221;',color:'#78909C'},
  {id:'learning',name:'Learning',icon:'&#128218;',color:'#D4930D'},
  {id:'meetings',name:'Meetings',icon:'&#129309;',color:'#E91E63'},
  {id:'planning',name:'Planning',icon:'&#128736;',color:'#673AB7'},
  {id:'break',name:'Break',icon:'&#9749;',color:'#607D8B'}
];

var taTimerInterval=null;
var taStartTime=null;
var taActiveCat=null;

function renderTimeAudit(){
  if(!data.timeEntries)data.timeEntries=[];
  var today=new Date().toISOString().split('T')[0];
  var todayEntries=data.timeEntries.filter(function(e){return e.date===today});

  // Category totals for today
  var catTotals={};
  TA_CATEGORIES.forEach(function(cat){catTotals[cat.id]=0;});
  todayEntries.forEach(function(e){catTotals[e.category]=(catTotals[e.category]||0)+e.minutes;});
  var totalMinutes=todayEntries.reduce(function(s,e){return s+e.minutes},0);

  // Category grid
  var chtml='';
  TA_CATEGORIES.forEach(function(cat){
    var mins=catTotals[cat.id]||0;
    var hrs=Math.floor(mins/60);
    var m=mins%60;
    var timeStr=hrs>0?hrs+'h '+m+'m':m+'m';
    chtml+='<div class="ta-cat'+(taActiveCat===cat.id?' active':'')+'" onclick="taSelectCat(\''+cat.id+'\')" style="'+(taActiveCat===cat.id?'border-color:'+cat.color:'')+'"><div class="ta-cat-icon">'+cat.icon+'</div><div class="ta-cat-name">'+cat.name+'</div><div class="ta-cat-time">'+(mins>0?timeStr:'â€”')+'</div></div>';
  });
  document.getElementById('ta-categories').innerHTML=chtml;

  // Timer display
  if(taActiveCat){
    var catObj=TA_CATEGORIES.find(function(c){return c.id===taActiveCat});
    document.getElementById('ta-active-cat').textContent='Tracking: '+catObj.name;
  }else{
    document.getElementById('ta-active-cat').textContent='Select a category to start tracking';
  }

  // Time bar
  var barHtml='';
  if(totalMinutes>0){
    barHtml='<div class="ta-bar">';
    TA_CATEGORIES.forEach(function(cat){
      var mins=catTotals[cat.id]||0;
      if(mins>0){
        var pct=(mins/totalMinutes*100).toFixed(1);
        barHtml+='<div class="ta-bar-seg" style="width:'+pct+'%;background:'+cat.color+'" title="'+cat.name+': '+Math.floor(mins/60)+'h '+mins%60+'m ('+pct+'%)"></div>';
      }
    });
    barHtml+='</div>';
  }
  document.getElementById('ta-bar-container').innerHTML=barHtml;

  // KPIs
  var totalHrs=(totalMinutes/60).toFixed(1);
  var productiveMin=todayEntries.filter(function(e){return e.category!=='break'&&e.category!=='admin'}).reduce(function(s,e){return s+e.minutes},0);
  var productivePct=totalMinutes?Math.round(productiveMin/totalMinutes*100):0;
  document.getElementById('ta-kpis').innerHTML=
    '<div class="kpi-card"><div class="kpi-value">'+totalHrs+'h</div><div class="kpi-label">Total Tracked</div></div>'
    +'<div class="kpi-card"><div class="kpi-value">'+productivePct+'%</div><div class="kpi-label">Productive Time</div></div>'
    +'<div class="kpi-card"><div class="kpi-value">'+todayEntries.length+'</div><div class="kpi-label">Time Blocks</div></div>';

  // History
  var allEntries=data.timeEntries.slice().reverse().slice(0,30);
  var hhtml='';
  allEntries.forEach(function(e){
    var cat=TA_CATEGORIES.find(function(c){return c.id===e.category})||{icon:'?',name:e.category,color:'#666'};
    var hrs=Math.floor(e.minutes/60);var m=e.minutes%60;
    hhtml+='<div class="ta-history-row"><span>'+cat.icon+'</span><span style="color:'+cat.color+';font-weight:600">'+cat.name+'</span><span style="flex:1;color:var(--text-2)">'+esc(e.note||'')+'</span><span style="font-weight:600">'+(hrs>0?hrs+'h ':'')+m+'m</span><span style="color:var(--text-3)">'+e.date+'</span><button class="btn btn-ghost" style="padding:2px 6px;font-size:10px" onclick="taDeleteEntry(\''+e.id+'\')">&times;</button></div>';
  });
  document.getElementById('ta-history').innerHTML=hhtml||'<div style="text-align:center;padding:20px;color:var(--text-3)">No time logged yet. Select a category and start the timer!</div>';
}

function taSelectCat(catId){
  taActiveCat=catId;
  renderTimeAudit();
}

function taToggle(){
  if(taTimerInterval){
    // Pause
    clearInterval(taTimerInterval);taTimerInterval=null;
    document.getElementById('ta-start-btn').textContent='Resume';
  }else{
    if(!taActiveCat){showToast('Select a category first');return;}
    if(!taStartTime)taStartTime=Date.now();
    taTimerInterval=setInterval(taUpdateDisplay,1000);
    document.getElementById('ta-start-btn').textContent='Pause';
  }
}

function taUpdateDisplay(){
  if(!taStartTime)return;
  var elapsed=Math.floor((Date.now()-taStartTime)/1000);
  var h=Math.floor(elapsed/3600);var m=Math.floor((elapsed%3600)/60);var s=elapsed%60;
  document.getElementById('ta-display').textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}

function taStop(){
  if(!taStartTime||!taActiveCat){showToast('Nothing to log');return;}
  clearInterval(taTimerInterval);taTimerInterval=null;
  var elapsed=Math.floor((Date.now()-taStartTime)/1000);
  var minutes=Math.max(1,Math.round(elapsed/60));
  if(!data.timeEntries)data.timeEntries=[];
  data.timeEntries.push({id:uid(),category:taActiveCat,minutes:minutes,date:new Date().toISOString().split('T')[0],note:'',createdAt:new Date().toISOString()});
  taStartTime=null;taActiveCat=null;
  document.getElementById('ta-display').textContent='00:00:00';
  document.getElementById('ta-start-btn').textContent='Start';
  save();renderTimeAudit();showToast('Time logged!');
}

function taDeleteEntry(id){
  data.timeEntries=data.timeEntries.filter(function(e){return e.id!==id});
  save();renderTimeAudit();
}

// ===== MILESTONES =====
function renderMilestones(){
  var closed=data.contacts.filter(function(c){return c.status==='Closed'});
  var clientCount=closed.length;
  var mrr=closed.reduce(function(s,c){return s+contactRevenue(c)},0);

  var milestones=[
    {emoji:'&#127942;',title:'First Client',sub:'Land your very first paying client',target:1,current:clientCount,type:'clients'},
    {emoji:'&#9989;',title:'5 Clients',sub:'Build a base â€” proof of concept',target:5,current:clientCount,type:'clients'},
    {emoji:'&#128200;',title:'10 Clients',sub:'Double digits â€” real business',target:10,current:clientCount,type:'clients'},
    {emoji:'&#128176;',title:'$5,000 MRR',sub:'Meaningful monthly revenue',target:5000,current:mrr,type:'revenue'},
    {emoji:'&#127775;',title:'25 Clients',sub:'Halfway to the big goal',target:25,current:clientCount,type:'clients'},
    {emoji:'&#128293;',title:'$10,000 MRR',sub:'Five-figure monthly recurring',target:10000,current:mrr,type:'revenue'},
    {emoji:'&#127881;',title:'50 Clients',sub:'THE goal â€” August 2026',target:50,current:clientCount,type:'clients'},
    {emoji:'&#128081;',title:'$17,500 MRR',sub:'Full target revenue achieved',target:17500,current:mrr,type:'revenue'}
  ];

  // Top stats
  var nextMs=milestones.find(function(m){return m.current<m.target});
  var achieved=milestones.filter(function(m){return m.current>=m.target}).length;
  document.getElementById('ms-topline').innerHTML=
    '<div class="ms-bigstat"><div class="ms-bigstat-num">'+clientCount+'</div><div class="ms-bigstat-label">Current Clients</div></div>'
    +'<div class="ms-bigstat"><div class="ms-bigstat-num">$'+mrr.toLocaleString()+'</div><div class="ms-bigstat-label">Current MRR</div></div>'
    +'<div class="ms-bigstat"><div class="ms-bigstat-num">'+achieved+'/'+milestones.length+'</div><div class="ms-bigstat-label">Milestones Hit</div></div>'
    +'<div class="ms-bigstat"><div class="ms-bigstat-num">'+(nextMs?(nextMs.target-nextMs.current):'0')+'</div><div class="ms-bigstat-label">'+(nextMs?'To Next Milestone':'All Done!')+'</div></div>';

  // Cards
  var ghtml='';
  milestones.forEach(function(m){
    var isAchieved=m.current>=m.target;
    var pct=Math.min(100,Math.round(m.current/m.target*100));
    var remaining=m.target-m.current;
    ghtml+='<div class="ms-card'+(isAchieved?' achieved':'')+'">'
      +'<div class="ms-emoji">'+m.emoji+'</div>'
      +'<h3>'+m.title+'</h3>'
      +'<div class="ms-sub">'+m.sub+'</div>'
      +'<div class="ms-number">'+(isAchieved?'ACHIEVED':m.type==='revenue'?'$'+m.current.toLocaleString()+' / $'+m.target.toLocaleString():m.current+' / '+m.target)+'</div>'
      +'<div class="ms-remaining">'+(isAchieved?'Milestone completed!':(m.type==='revenue'?'$'+remaining.toLocaleString()+' to go':remaining+' more to go')+' ('+pct+'%)')+'</div>'
      +'<div class="ms-progress-bg"><div class="ms-progress-fill" style="width:'+pct+'%"></div></div></div>';
  });
  document.getElementById('ms-grid').innerHTML=ghtml;
}

// ===== VISION BOARD =====
var VB_QUOTES=[
  {text:'The only way to do great work is to love what you do.',author:'Steve Jobs'},
  {text:'Success is not final, failure is not fatal: it is the courage to continue that counts.',author:'Winston Churchill'},
  {text:'The best time to plant a tree was 20 years ago. The second best time is now.',author:'Chinese Proverb'},
  {text:'Don\'t watch the clock; do what it does. Keep going.',author:'Sam Levenson'},
  {text:'Your limitation â€” it\'s only your imagination.',author:'Unknown'},
  {text:'The harder you work for something, the greater you\'ll feel when you achieve it.',author:'Unknown'},
  {text:'Dream bigger. Start smaller. Act now.',author:'Robin Sharma'},
  {text:'Discipline is choosing between what you want now and what you want most.',author:'Abraham Lincoln'},
  {text:'Revenue is vanity, profit is sanity, but cash is king.',author:'Unknown'},
  {text:'50 clients by August 2026. Every call gets you closer.',author:'You'}
];

var VB_CAT_COLORS={Revenue:'var(--green)',Lifestyle:'var(--blue)',Growth:'var(--purple)',Personal:'var(--teal)',Legacy:'var(--gold)'};

function renderVision(){
  if(!data.visionItems)data.visionItems=[];
  // Quote of the day
  var dayIdx=Math.floor(Date.now()/(1000*60*60*24))%VB_QUOTES.length;
  var q=VB_QUOTES[dayIdx];
  document.getElementById('vb-quote').innerHTML='"'+q.text+'"<div class="vb-quote-author">â€” '+q.author+'</div>';

  var ghtml='';
  data.visionItems.forEach(function(v){
    var catColor=VB_CAT_COLORS[v.category]||'var(--text-2)';
    ghtml+='<div class="vb-card"><div class="vb-actions"><button class="btn btn-ghost" style="padding:2px 6px;font-size:10px" onclick="editVision(\''+v.id+'\')">Edit</button><button class="btn btn-ghost" style="padding:2px 6px;font-size:10px" onclick="deleteVision(\''+v.id+'\')">&times;</button></div>'
      +'<div class="vb-card-cat" style="color:'+catColor+'">'+esc(v.category)+'</div>'
      +'<h3>'+esc(v.title)+'</h3>'
      +'<p>'+esc(v.description)+'</p>'
      +(v.targetDate?'<div class="vb-target">Target: '+new Date(v.targetDate+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+'</div>':'')
      +'</div>';
  });
  document.getElementById('vb-grid').innerHTML=ghtml||'<div style="text-align:center;padding:40px;color:var(--text-3)">Your vision board is empty. Add your goals, dreams, and motivations to keep them front and center.</div>';
}

function openVisionModal(id){
  var v=id?data.visionItems.find(function(x){return x.id===id}):null;
  document.getElementById('vision-modal-title').textContent=v?'Edit Vision':'Add to Vision Board';
  document.getElementById('vb-id').value=v?v.id:'';
  document.getElementById('vb-title').value=v?v.title:'';
  document.getElementById('vb-desc').value=v?v.description:'';
  document.getElementById('vb-category').value=v?v.category:'Revenue';
  document.getElementById('vb-target').value=v?v.targetDate||'':'';
  openModal('vision-modal');
}
function editVision(id){openVisionModal(id);}
function saveVision(){
  var id=document.getElementById('vb-id').value;
  var item={
    id:id||uid(),
    title:document.getElementById('vb-title').value.trim(),
    description:document.getElementById('vb-desc').value.trim(),
    category:document.getElementById('vb-category').value,
    targetDate:document.getElementById('vb-target').value,
    createdAt:new Date().toISOString()
  };
  if(!item.title){showToast('Title is required');return;}
  if(!data.visionItems)data.visionItems=[];
  if(id){var idx=data.visionItems.findIndex(function(x){return x.id===id});if(idx>=0)data.visionItems[idx]=item;}
  else data.visionItems.push(item);
  save();closeModal('vision-modal');renderVision();
}
function deleteVision(id){
  data.visionItems=data.visionItems.filter(function(x){return x.id!==id});
  save();renderVision();
}

// ===== DECISION JOURNAL =====
function renderDecisions(){
  if(!data.decisions)data.decisions=[];
  var total=data.decisions.length;
  var good=data.decisions.filter(function(d){return d.outcome==='good'}).length;
  var bad=data.decisions.filter(function(d){return d.outcome==='bad'}).length;
  var pending=data.decisions.filter(function(d){return d.outcome==='pending'}).length;
  var needsReview=data.decisions.filter(function(d){
    if(d.outcome!=='pending')return false;
    var reviewDate=new Date(d.date);reviewDate.setDate(reviewDate.getDate()+parseInt(d.reviewDays||30));
    return reviewDate<=new Date();
  }).length;

  document.getElementById('dj-kpis').innerHTML=
    '<div class="kpi-card"><div class="kpi-value">'+total+'</div><div class="kpi-label">Total Decisions</div></div>'
    +'<div class="kpi-card"><div class="kpi-value" style="color:var(--green)">'+good+'</div><div class="kpi-label">Good Calls</div></div>'
    +'<div class="kpi-card"><div class="kpi-value" style="color:var(--red)">'+bad+'</div><div class="kpi-label">Bad Calls</div></div>'
    +'<div class="kpi-card"><div class="kpi-value" style="color:var(--gold)">'+needsReview+'</div><div class="kpi-label">Needs Review</div></div>';

  var sorted=data.decisions.slice().sort(function(a,b){return b.date>a.date?1:-1});
  var html='';
  sorted.forEach(function(d){
    var outcomeClass=d.outcome==='good'?'dj-outcome-good':d.outcome==='bad'?'dj-outcome-bad':'dj-outcome-pending';
    var outcomeLabel=d.outcome==='good'?'Good Decision':d.outcome==='bad'?'Bad Decision':'Pending Review';
    html+='<div class="dj-card" onclick="this.classList.toggle(\'expanded\')">'
      +'<div class="dj-card-header"><h3>'+esc(d.title)+'</h3><div style="display:flex;align-items:center;gap:8px"><span class="dj-outcome '+outcomeClass+'">'+outcomeLabel+'</span><span class="dj-date">'+d.date+'</span></div></div>'
      +'<div class="dj-context">'+esc(d.context)+'</div>'
      +'<div class="dj-detail">'
        +'<div class="dj-label">Options Considered</div><div class="dj-text">'+esc(d.options)+'</div>'
        +'<div class="dj-label">Decision Made</div><div class="dj-text">'+esc(d.decision)+'</div>'
        +(d.outcomeNotes?'<div class="dj-label">Outcome Notes</div><div class="dj-text">'+esc(d.outcomeNotes)+'</div>':'')
        +'<div style="margin-top:8px;display:flex;gap:6px"><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();editDecision(\''+d.id+'\')">Edit</button><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteDecision(\''+d.id+'\')">&times; Delete</button></div>'
      +'</div></div>';
  });
  document.getElementById('dj-list').innerHTML=html||'<div style="text-align:center;padding:40px;color:var(--text-3)">No decisions logged yet. Start tracking your thinking to sharpen your judgment over time.</div>';
}

function openDecisionModal(id){
  var d=id?data.decisions.find(function(x){return x.id===id}):null;
  document.getElementById('decision-modal-title').textContent=d?'Edit Decision':'Log Decision';
  document.getElementById('dj-id').value=d?d.id:'';
  document.getElementById('dj-title').value=d?d.title:'';
  document.getElementById('dj-context').value=d?d.context:'';
  document.getElementById('dj-options').value=d?d.options:'';
  document.getElementById('dj-decision').value=d?d.decision:'';
  document.getElementById('dj-date').value=d?d.date:new Date().toISOString().split('T')[0];
  document.getElementById('dj-review').value=d?d.reviewDays||'30':'30';
  document.getElementById('dj-outcome').value=d?d.outcome:'pending';
  document.getElementById('dj-outcome-notes').value=d?d.outcomeNotes||'':'';
  openModal('decision-modal');
}
function editDecision(id){openDecisionModal(id);}
function saveDecision(){
  var id=document.getElementById('dj-id').value;
  var item={
    id:id||uid(),
    title:document.getElementById('dj-title').value.trim(),
    context:document.getElementById('dj-context').value.trim(),
    options:document.getElementById('dj-options').value.trim(),
    decision:document.getElementById('dj-decision').value.trim(),
    date:document.getElementById('dj-date').value,
    reviewDays:document.getElementById('dj-review').value,
    outcome:document.getElementById('dj-outcome').value,
    outcomeNotes:document.getElementById('dj-outcome-notes').value.trim()
  };
  if(!item.title){showToast('Title is required');return;}
  if(!data.decisions)data.decisions=[];
  if(id){var idx=data.decisions.findIndex(function(x){return x.id===id});if(idx>=0)data.decisions[idx]=item;}
  else data.decisions.push(item);
  save();closeModal('decision-modal');renderDecisions();
}
function deleteDecision(id){
  data.decisions=data.decisions.filter(function(x){return x.id!==id});
  save();renderDecisions();
}

// ===== WEEKLY CEO REVIEW =====
function renderCeoReview(){
  if(!data.ceoReviews)data.ceoReviews=[];
  var total=data.ceoReviews.length;
  var grades={A:0,B:0,C:0,D:0,F:0};
  data.ceoReviews.forEach(function(r){grades[r.grade]=(grades[r.grade]||0)+1;});
  var avgScore=0;
  if(total>0){
    var scoreMap={A:4,B:3,C:2,D:1,F:0};
    var totalScore=data.ceoReviews.reduce(function(s,r){return s+(scoreMap[r.grade]||0)},0);
    avgScore=(totalScore/total).toFixed(1);
  }
  var lastReview=data.ceoReviews.length?data.ceoReviews[data.ceoReviews.length-1]:null;

  document.getElementById('ceo-kpis').innerHTML=
    '<div class="kpi-card"><div class="kpi-value">'+total+'</div><div class="kpi-label">Reviews Done</div></div>'
    +'<div class="kpi-card"><div class="kpi-value">'+avgScore+'</div><div class="kpi-label">Avg Score (4.0 = A)</div></div>'
    +'<div class="kpi-card"><div class="kpi-value" style="color:var(--green)">'+grades.A+'</div><div class="kpi-label">A Weeks</div></div>'
    +'<div class="kpi-card"><div class="kpi-value">'+(lastReview?lastReview.grade:'â€”')+'</div><div class="kpi-label">Last Grade</div></div>';

  var sorted=data.ceoReviews.slice().sort(function(a,b){return b.weekOf>a.weekOf?1:-1});
  var html='';
  sorted.forEach(function(r){
    html+='<div class="ceo-card">'
      +'<div style="display:flex;justify-content:space-between;align-items:flex-start"><div><h3>Week of '+new Date(r.weekOf+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+'</h3><div class="ceo-date">Reviewed '+r.weekOf+'</div></div><div style="display:flex;gap:4px"><button class="btn btn-ghost btn-sm" onclick="editCeoReview(\''+r.id+'\')">Edit</button><button class="btn btn-ghost btn-sm" onclick="deleteCeoReview(\''+r.id+'\')">&times;</button></div></div>'
      +'<div class="ceo-grade ceo-grade-'+r.grade+'">'+r.grade+'</div>'
      +'<div class="ceo-section"><div class="ceo-section-title">Wins</div><div class="ceo-section-text">'+esc(r.wins)+'</div></div>'
      +'<div class="ceo-section"><div class="ceo-section-title">Losses / Challenges</div><div class="ceo-section-text">'+esc(r.losses)+'</div></div>'
      +'<div class="ceo-section"><div class="ceo-section-title">Lessons Learned</div><div class="ceo-section-text">'+esc(r.lessons)+'</div></div>'
      +'<div class="ceo-section"><div class="ceo-section-title">Next Week\'s Focus</div><div class="ceo-section-text">'+esc(r.focus)+'</div></div>'
      +'</div>';
  });
  document.getElementById('ceo-list').innerHTML=html||'<div style="text-align:center;padding:40px;color:var(--text-3)">No reviews yet. Start your first weekly review to build the habit.</div>';
}

function openCeoModal(id){
  var r=id?data.ceoReviews.find(function(x){return x.id===id}):null;
  document.getElementById('ceo-modal-title').textContent=r?'Edit Review':'Weekly CEO Review';
  document.getElementById('ceo-id').value=r?r.id:'';
  // Default to current Monday
  var now=new Date();var day=now.getDay();var diff=now.getDate()-day+(day===0?-6:1);
  var monday=new Date(now.setDate(diff)).toISOString().split('T')[0];
  document.getElementById('ceo-week').value=r?r.weekOf:monday;
  document.getElementById('ceo-grade').value=r?r.grade:'B';
  document.getElementById('ceo-wins').value=r?r.wins:'';
  document.getElementById('ceo-losses').value=r?r.losses:'';
  document.getElementById('ceo-lessons').value=r?r.lessons:'';
  document.getElementById('ceo-focus').value=r?r.focus:'';
  openModal('ceo-modal');
}
function editCeoReview(id){openCeoModal(id);}
function saveCeoReview(){
  var id=document.getElementById('ceo-id').value;
  var item={
    id:id||uid(),
    weekOf:document.getElementById('ceo-week').value,
    grade:document.getElementById('ceo-grade').value,
    wins:document.getElementById('ceo-wins').value.trim(),
    losses:document.getElementById('ceo-losses').value.trim(),
    lessons:document.getElementById('ceo-lessons').value.trim(),
    focus:document.getElementById('ceo-focus').value.trim()
  };
  if(!item.weekOf){showToast('Select a week');return;}
  if(!data.ceoReviews)data.ceoReviews=[];
  if(id){var idx=data.ceoReviews.findIndex(function(x){return x.id===id});if(idx>=0)data.ceoReviews[idx]=item;}
  else data.ceoReviews.push(item);
  save();closeModal('ceo-modal');renderCeoReview();
}
function deleteCeoReview(id){
  data.ceoReviews=data.ceoReviews.filter(function(x){return x.id!==id});
  save();renderCeoReview();
}

// ===== IDEA CAPTURE =====
var ideaFilter='All';
function renderIdeas(){
  if(!data.ideas)data.ideas=[];
  var categories=['All','Business','Marketing','Product','Partnership','Content','Other'];
  var chtml='';
  categories.forEach(function(cat){
    var count=cat==='All'?data.ideas.length:data.ideas.filter(function(i){return i.category===cat}).length;
    chtml+='<button class="idea-cat-btn'+(ideaFilter===cat?' active':'')+'" onclick="ideaFilter=\''+cat+'\';renderIdeas()">'+cat+(count?' ('+count+')':'')+'</button>';
  });
  document.getElementById('idea-cats').innerHTML=chtml;

  var filtered=ideaFilter==='All'?data.ideas:data.ideas.filter(function(i){return i.category===ideaFilter});
  filtered=filtered.slice().sort(function(a,b){
    var pOrder={high:0,medium:1,low:2};
    return (pOrder[a.priority]||1)-(pOrder[b.priority]||1);
  });

  var html='';
  filtered.forEach(function(idea){
    html+='<div class="idea-card"><div class="idea-actions"><button class="btn btn-ghost" style="padding:2px 6px;font-size:10px" onclick="editIdea(\''+idea.id+'\')">Edit</button><button class="btn btn-ghost" style="padding:2px 6px;font-size:10px" onclick="deleteIdea(\''+idea.id+'\')">&times;</button></div>'
      +'<h3>'+esc(idea.title)+'</h3>'
      +'<p>'+esc(idea.description)+'</p>'
      +'<div class="idea-meta"><span class="idea-priority idea-priority-'+idea.priority+'">'+idea.priority.toUpperCase()+'</span><span>'+esc(idea.category)+'</span><span>'+new Date(idea.createdAt).toLocaleDateString()+'</span></div>'
      +'</div>';
  });
  document.getElementById('idea-list').innerHTML=html||'<div style="text-align:center;padding:40px;color:var(--text-3)">No ideas captured yet. When inspiration strikes, hit the button above!</div>';
}

function openIdeaModal(id){
  var idea=id?data.ideas.find(function(x){return x.id===id}):null;
  document.getElementById('idea-modal-title').textContent=idea?'Edit Idea':'Capture Idea';
  document.getElementById('idea-id').value=idea?idea.id:'';
  document.getElementById('idea-title').value=idea?idea.title:'';
  document.getElementById('idea-desc').value=idea?idea.description:'';
  document.getElementById('idea-category').value=idea?idea.category:'Business';
  document.getElementById('idea-priority').value=idea?idea.priority:'medium';
  openModal('idea-modal');
}
function editIdea(id){openIdeaModal(id);}
function saveIdea(){
  var id=document.getElementById('idea-id').value;
  var item={
    id:id||uid(),
    title:document.getElementById('idea-title').value.trim(),
    description:document.getElementById('idea-desc').value.trim(),
    category:document.getElementById('idea-category').value,
    priority:document.getElementById('idea-priority').value,
    createdAt:id?(data.ideas.find(function(x){return x.id===id})||{}).createdAt||new Date().toISOString():new Date().toISOString()
  };
  if(!item.title){showToast('Title is required');return;}
  if(!data.ideas)data.ideas=[];
  if(id){var idx=data.ideas.findIndex(function(x){return x.id===id});if(idx>=0)data.ideas[idx]=item;}
  else data.ideas.push(item);
  save();closeModal('idea-modal');renderIdeas();
}
function deleteIdea(id){
  data.ideas=data.ideas.filter(function(x){return x.id!==id});
  save();renderIdeas();
}

// ===== CLIENT RESULTS =====
function renderResults(){
  if(!data.clientResults)data.clientResults=[];
  var total=data.clientResults.length;
  var categories={};
  data.clientResults.forEach(function(r){categories[r.category]=(categories[r.category]||0)+1;});
  var topCat=Object.keys(categories).sort(function(a,b){return categories[b]-categories[a]})[0]||'â€”';

  document.getElementById('cr-highlight').innerHTML=
    '<div class="cr-big">'+total+'</div><div class="cr-sub">Client Results Logged â€” Your Proof Library</div>';

  var sorted=data.clientResults.slice().sort(function(a,b){return b.date>a.date?1:-1});
  var html='';
  sorted.forEach(function(r){
    var client=data.contacts.find(function(c){return c.id===r.contactId});
    html+='<div class="cr-card"><div class="cr-actions"><button class="btn btn-ghost" style="padding:2px 6px;font-size:10px" onclick="editResult(\''+r.id+'\')">Edit</button><button class="btn btn-ghost" style="padding:2px 6px;font-size:10px" onclick="deleteResult(\''+r.id+'\')">&times;</button></div>'
      +'<h3>'+esc(r.title)+'</h3>'
      +'<div class="cr-client">'+(client?esc(client.company):'Unknown Client')+'</div>'
      +'<div class="cr-desc">'+esc(r.description)+'</div>'
      +'<div class="cr-meta"><span>'+esc(r.category)+'</span>'
      +(r.metric?'<span>'+esc(r.metric)+': '+esc(r.value)+'</span>':'')
      +'<span>'+r.date+'</span></div></div>';
  });
  document.getElementById('cr-list').innerHTML=html||'<div style="text-align:center;padding:40px;color:var(--text-3)">No results logged yet. When Russell\'s first report uncovers something, log it here!</div>';
}

function openResultModal(id){
  var r=id?data.clientResults.find(function(x){return x.id===id}):null;
  document.getElementById('result-modal-title').textContent=r?'Edit Result':'Log Client Result';
  document.getElementById('cr-id').value=r?r.id:'';
  document.getElementById('cr-title').value=r?r.title:'';
  document.getElementById('cr-desc').value=r?r.description:'';
  document.getElementById('cr-category').value=r?r.category:'Retention Save';
  document.getElementById('cr-date').value=r?r.date:new Date().toISOString().split('T')[0];
  document.getElementById('cr-metric').value=r?r.metric||'':'';
  document.getElementById('cr-value').value=r?r.value||'':'';
  document.getElementById('cr-contact-search').value='';
  document.getElementById('cr-contact-select').value=r?r.contactId||'':'';
  if(r&&r.contactId){
    var c=data.contacts.find(function(x){return x.id===r.contactId});
    if(c)document.getElementById('cr-contact-search').value=c.company+' â€” '+c.ownerName;
  }
  openModal('result-modal');
}
function editResult(id){openResultModal(id);}
function saveResult(){
  var id=document.getElementById('cr-id').value;
  var item={
    id:id||uid(),
    contactId:document.getElementById('cr-contact-select').value,
    title:document.getElementById('cr-title').value.trim(),
    description:document.getElementById('cr-desc').value.trim(),
    category:document.getElementById('cr-category').value,
    date:document.getElementById('cr-date').value,
    metric:document.getElementById('cr-metric').value.trim(),
    value:document.getElementById('cr-value').value.trim()
  };
  if(!item.title){showToast('Title is required');return;}
  if(!data.clientResults)data.clientResults=[];
  if(id){var idx=data.clientResults.findIndex(function(x){return x.id===id});if(idx>=0)data.clientResults[idx]=item;}
  else data.clientResults.push(item);
  save();closeModal('result-modal');renderResults();
}
function deleteResult(id){
  data.clientResults=data.clientResults.filter(function(x){return x.id!==id});
  save();renderResults();
}

// ===== MENTOR LOG =====
function renderMentors(){
  if(!data.mentorLog)data.mentorLog=[];
  var total=data.mentorLog.length;
  var people={};
  data.mentorLog.forEach(function(m){people[m.name]=true;});
  var uniquePeople=Object.keys(people).length;
  var withActions=data.mentorLog.filter(function(m){return m.nextAction&&m.nextAction.trim()}).length;

  document.getElementById('ml-kpis').innerHTML=
    '<div class="kpi-card"><div class="kpi-value">'+total+'</div><div class="kpi-label">Conversations</div></div>'
    +'<div class="kpi-card"><div class="kpi-value">'+uniquePeople+'</div><div class="kpi-label">People in Network</div></div>'
    +'<div class="kpi-card"><div class="kpi-value">'+withActions+'</div><div class="kpi-label">With Action Items</div></div>';

  var sorted=data.mentorLog.slice().sort(function(a,b){return b.date>a.date?1:-1});
  var html='';
  sorted.forEach(function(m){
    html+='<div class="ml-card" onclick="this.classList.toggle(\'expanded\')">'
      +'<div class="ml-actions"><button class="btn btn-ghost" style="padding:2px 6px;font-size:10px" onclick="event.stopPropagation();editMentor(\''+m.id+'\')">Edit</button><button class="btn btn-ghost" style="padding:2px 6px;font-size:10px" onclick="event.stopPropagation();deleteMentor(\''+m.id+'\')">&times;</button></div>'
      +'<h3>'+esc(m.name)+'</h3>'
      +'<div class="ml-role">'+esc(m.role)+'</div>'
      +'<div class="ml-topic">'+esc(m.topic)+'</div>'
      +'<div class="ml-detail">'
        +'<div class="dj-label">Key Takeaways</div><div class="ml-takeaway">'+esc(m.takeaway)+'</div>'
        +(m.nextAction?'<div class="ml-next">Next: '+esc(m.nextAction)+'</div>':'')
        +'<div class="ml-date">'+m.date+'</div>'
      +'</div></div>';
  });
  document.getElementById('ml-list').innerHTML=html||'<div style="text-align:center;padding:40px;color:var(--text-3)">No conversations logged yet. Your network is your net worth â€” start tracking every valuable conversation.</div>';
}

function openMentorModal(id){
  var m=id?data.mentorLog.find(function(x){return x.id===id}):null;
  document.getElementById('mentor-modal-title').textContent=m?'Edit Conversation':'Log Conversation';
  document.getElementById('ml-id').value=m?m.id:'';
  document.getElementById('ml-name').value=m?m.name:'';
  document.getElementById('ml-role').value=m?m.role:'';
  document.getElementById('ml-topic').value=m?m.topic:'';
  document.getElementById('ml-takeaway').value=m?m.takeaway:'';
  document.getElementById('ml-next').value=m?m.nextAction||'':'';
  document.getElementById('ml-date').value=m?m.date:new Date().toISOString().split('T')[0];
  openModal('mentor-modal');
}
function editMentor(id){openMentorModal(id);}
function saveMentor(){
  var id=document.getElementById('ml-id').value;
  var item={
    id:id||uid(),
    name:document.getElementById('ml-name').value.trim(),
    role:document.getElementById('ml-role').value.trim(),
    topic:document.getElementById('ml-topic').value.trim(),
    takeaway:document.getElementById('ml-takeaway').value.trim(),
    nextAction:document.getElementById('ml-next').value.trim(),
    date:document.getElementById('ml-date').value
  };
  if(!item.name){showToast('Name is required');return;}
  if(!data.mentorLog)data.mentorLog=[];
  if(id){var idx=data.mentorLog.findIndex(function(x){return x.id===id});if(idx>=0)data.mentorLog[idx]=item;}
  else data.mentorLog.push(item);
  save();closeModal('mentor-modal');renderMentors();
}
function deleteMentor(id){
  data.mentorLog=data.mentorLog.filter(function(x){return x.id!==id});
  save();renderMentors();
}

// ===== INIT =====
renderDashboard();
</script>
</body>
</html>
