<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Life & Business Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0f0f1a;
  --surface: #1a1a2e;
  --surface-hover: #22223a;
  --border: #2a2a4a;
  --border-light: #3a3a5a;
  --text: #e8e8f0;
  --text-secondary: #9898b0;
  --text-muted: #6868880;
  --cat-business: #4CAF50;
  --cat-financial: #D4930D;
  --cat-golf: #00BCD4;
  --cat-networking: #9C27B0;
  --cat-learning: #2196F3;
  --cat-religion: #FF7043;
  --cat-gym: #E91E63;
  --danger: #ef4444;
  --danger-hover: #dc2626;
  --sidebar-width: 240px;
}

body {
  font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
}

/* Sidebar */
.sidebar {
  width: var(--sidebar-width);
  background: var(--surface);
  border-right: 1px solid var(--border);
  position: fixed;
  top: 0; left: 0; bottom: 0;
  display: flex;
  flex-direction: column;
  z-index: 100;
  transition: transform 0.3s;
}

.sidebar-header {
  padding: 24px 20px;
  border-bottom: 1px solid var(--border);
}

.sidebar-header h1 {
  font-size: 18px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--cat-business), var(--cat-learning));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.sidebar-header p {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.sidebar-nav {
  flex: 1;
  padding: 12px 0;
  overflow-y: auto;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 500;
  border-left: 3px solid transparent;
}

.nav-item:hover {
  background: var(--surface-hover);
  color: var(--text);
}

.nav-item.active {
  color: var(--text);
  background: rgba(33, 150, 243, 0.08);
  border-left-color: var(--cat-learning);
}

.nav-item svg {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

.mobile-toggle {
  display: none;
  position: fixed;
  top: 16px; left: 16px;
  z-index: 200;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  width: 44px; height: 44px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 20px;
  align-items: center;
  justify-content: center;
}

/* Main */
.main {
  margin-left: var(--sidebar-width);
  flex: 1;
  min-height: 100vh;
  padding: 32px;
  max-width: 1100px;
}

.view { display: none; }
.view.active { display: block; }

/* Cards */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 16px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.card-header h2 {
  font-size: 16px;
  font-weight: 600;
}

.section-title {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 24px;
}

/* Stats row */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background: var(--cat-learning);
  color: #fff;
}
.btn-primary:hover { background: #1976D2; }

.btn-success {
  background: var(--cat-business);
  color: #fff;
}
.btn-success:hover { opacity: 0.9; }

.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.btn-ghost:hover { background: var(--surface-hover); color: var(--text); }

.btn-danger {
  background: var(--danger);
  color: #fff;
}
.btn-danger:hover { background: var(--danger-hover); }

.btn-sm { padding: 5px 10px; font-size: 12px; }

/* Tags */
.tag {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.tag-business { background: rgba(76,175,80,0.15); color: var(--cat-business); }
.tag-financial { background: rgba(212,147,13,0.15); color: var(--cat-financial); }
.tag-golf { background: rgba(0,188,212,0.15); color: var(--cat-golf); }
.tag-networking { background: rgba(156,39,176,0.15); color: var(--cat-networking); }
.tag-learning { background: rgba(33,150,243,0.15); color: var(--cat-learning); }
.tag-religion { background: rgba(255,112,67,0.15); color: var(--cat-religion); }
.tag-gym { background: rgba(233,30,99,0.15); color: var(--cat-gym); }

/* Progress bar */
.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 8px;
}

.progress-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.4s ease;
}

/* Forms */
.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--text-secondary);
}

.form-control {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: inherit;
  font-size: 14px;
  transition: border-color 0.2s;
}

.form-control:focus {
  outline: none;
  border-color: var(--cat-learning);
}

select.form-control {
  cursor: pointer;
}

textarea.form-control {
  resize: vertical;
  min-height: 80px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 500;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 28px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal h3 {
  font-size: 18px;
  margin-bottom: 20px;
}

.modal-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 20px;
  overflow-x: auto;
  padding-bottom: 4px;
}

.tab {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}

.tab:hover { background: var(--surface-hover); color: var(--text); }

.tab.active {
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
}

/* Goal card */
.goal-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 12px;
  transition: border-color 0.2s;
}

.goal-card:hover { border-color: var(--border-light); }

.goal-card.completed { opacity: 0.6; }

.goal-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 4px;
}

.goal-target {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.goal-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 12px;
}

.goal-actions {
  display: flex;
  gap: 6px;
  margin-top: 12px;
}

/* Yearly Grid */
.yearly-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 12px;
}

.month-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  min-height: 120px;
}

.month-card h3 {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text-secondary);
}

.milestone-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  margin-bottom: 6px;
  padding: 4px 0;
}

.milestone-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.milestone-remove {
  margin-left: auto;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.2s;
}

.milestone-item:hover .milestone-remove { opacity: 1; }

.add-milestone-btn {
  background: none;
  border: 1px dashed var(--border);
  border-radius: 6px;
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 12px;
  padding: 6px;
  width: 100%;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.2s;
}

.add-milestone-btn:hover {
  border-color: var(--cat-learning);
  color: var(--cat-learning);
}

/* Weekly View */
.week-nav {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

.week-nav h2 {
  font-size: 16px;
  font-weight: 600;
  min-width: 200px;
  text-align: center;
}

.week-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}

.day-column {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
  min-height: 200px;
}

.day-column.today {
  border-color: var(--cat-learning);
}

.day-header {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.day-date {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
}

.day-task {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  font-size: 13px;
  padding: 6px;
  border-radius: 6px;
  margin-bottom: 4px;
  transition: background 0.2s;
}

.day-task:hover { background: var(--surface-hover); }

.day-task.completed span { text-decoration: line-through; color: var(--text-secondary); }

.day-task input[type="checkbox"] {
  margin-top: 2px;
  accent-color: var(--cat-business);
  cursor: pointer;
}

.day-task .task-remove {
  margin-left: auto;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.2s;
  flex-shrink: 0;
}

.day-task:hover .task-remove { opacity: 1; }

.add-task-day {
  background: none;
  border: 1px dashed var(--border);
  border-radius: 6px;
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 12px;
  padding: 6px;
  width: 100%;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.2s;
}

.add-task-day:hover { border-color: var(--cat-learning); color: var(--cat-learning); }

/* Daily Focus */
.daily-date {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 4px;
}

.daily-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 24px;
}

.priority-list {
  list-style: none;
  margin-bottom: 24px;
}

.priority-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 8px;
  font-size: 15px;
}

.priority-number {
  width: 28px;
  height: 28px;
  background: var(--cat-learning);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
  flex-shrink: 0;
}

.priority-item.completed span { text-decoration: line-through; color: var(--text-secondary); }

.priority-item input[type="checkbox"] {
  accent-color: var(--cat-business);
  cursor: pointer;
}

/* Financial */
.fin-subtabs{display:flex;gap:4px;margin-bottom:20px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:4px}
.fin-subtab{flex:1;padding:8px 12px;border-radius:8px;border:none;background:transparent;color:var(--text-secondary);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all .2s}
.fin-subtab:hover{color:var(--text);background:var(--surface-hover)}
.fin-subtab.active{background:var(--cat-financial);color:#fff}
.fin-subview{display:none}.fin-subview.active{display:block}

.fin-kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px}
.fin-kpi{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center}
.fin-kpi-val{font-size:24px;font-weight:800;margin-bottom:2px}
.fin-kpi-label{font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}
.fin-kpi-sub{font-size:11px;color:var(--text-muted);margin-top:2px}

.fin-cashflow{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
.fin-cashflow-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px}
.fin-cashflow-card h3{font-size:13px;font-weight:600;margin-bottom:12px}

.fin-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:12px}
.fin-bar-label{width:70px;color:var(--text-secondary);flex-shrink:0}
.fin-bar-track{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden}
.fin-bar-fill{height:100%;border-radius:4px;transition:width .4s}
.fin-bar-val{width:80px;text-align:right;font-weight:600;flex-shrink:0}

.fin-goal-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:12px}
.fin-goal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.fin-amounts{font-size:13px;color:var(--text-secondary);margin-bottom:4px}
.fin-amount-current{font-size:22px;font-weight:700;color:var(--cat-financial)}
.fin-entries{margin-top:16px;border-top:1px solid var(--border);padding-top:12px}
.fin-entry{display:flex;justify-content:space-between;align-items:center;font-size:13px;padding:6px 0;border-bottom:1px solid rgba(42,42,74,0.5)}
.fin-entry:last-child{border-bottom:none}
.fin-entry-amount{font-weight:600}
.fin-entry-amount.income{color:var(--cat-business)}
.fin-entry-amount.expense{color:var(--danger)}
.fin-entry-amount.saving{color:var(--cat-financial)}

.txn-row{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:13px;transition:background .2s}
.txn-row:hover{background:var(--surface-hover)}
.txn-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.txn-icon.income{background:rgba(76,175,80,.12)}
.txn-icon.expense{background:rgba(239,68,68,.12)}
.txn-details{flex:1;min-width:0}
.txn-desc{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.txn-meta{font-size:11px;color:var(--text-secondary);margin-top:1px}
.txn-amount{font-weight:700;font-size:14px;text-align:right;flex-shrink:0}
.txn-amount.income{color:var(--cat-business)}
.txn-amount.expense{color:var(--danger)}

.budget-row{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:8px}
.budget-row-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.budget-cat{font-size:13px;font-weight:600}
.budget-nums{font-size:12px;color:var(--text-secondary)}
.budget-nums strong{color:var(--text)}
.budget-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden}
.budget-bar-fill{height:100%;border-radius:4px;transition:width .4s}
.budget-pct{font-size:11px;color:var(--text-secondary);margin-top:3px}

.fin-month-nav{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:16px}
.fin-month-nav h3{font-size:14px;font-weight:600;min-width:140px;text-align:center}

.fin-recent-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.fin-recent-head h3{font-size:14px;font-weight:600}

/* Achievement */
.achievement-item {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  padding: 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 10px;
}

.achievement-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}

.achievement-content { flex: 1; }

.achievement-title {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 2px;
}

.achievement-desc {
  font-size: 13px;
  color: var(--text-secondary);
}

.achievement-date {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
}

/* Dashboard category progress */
.cat-progress-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}

.cat-progress-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
}

.cat-progress-label {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.cat-progress-ring {
  position: relative;
  width: 70px;
  height: 70px;
  margin: 0 auto 8px;
}

.cat-progress-ring svg {
  transform: rotate(-90deg);
}

.cat-progress-ring .ring-text {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 700;
}

.cat-progress-count {
  font-size: 12px;
  color: var(--text-secondary);
}

/* Today's focus on dashboard */
.focus-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  background: var(--bg);
  border-radius: 8px;
  margin-bottom: 6px;
  font-size: 14px;
}

.focus-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
}

.empty-state svg {
  width: 48px;
  height: 48px;
  margin-bottom: 12px;
  opacity: 0.4;
}

.empty-state p {
  font-size: 14px;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* Responsive */
@media (max-width: 900px) {
  .sidebar {
    transform: translateX(-100%);
  }
  .sidebar.open { transform: translateX(0); }
  .mobile-toggle { display: flex; }
  .main { margin-left: 0; padding: 24px 16px; padding-top: 72px; }
  .week-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
  .yearly-grid { grid-template-columns: 1fr 1fr; }
}

@media (max-width: 600px) {
  .yearly-grid { grid-template-columns: 1fr; }
  .stats-row { grid-template-columns: 1fr 1fr; }
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Reward card styles */
.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Hourly Planner */
.hourly-nav {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

.hourly-nav h2 {
  font-size: 16px;
  font-weight: 600;
  min-width: 220px;
  text-align: center;
}

.hour-grid {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.hour-row {
  display: flex;
  align-items: stretch;
  min-height: 48px;
  border-radius: 8px;
  transition: background 0.15s;
}

.hour-row:hover {
  background: var(--surface-hover);
}

.hour-row.current-hour {
  border-left: 3px solid var(--cat-learning);
}

.hour-label {
  width: 70px;
  padding: 12px 8px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  flex-shrink: 0;
  display: flex;
  align-items: center;
}

.hour-content {
  flex: 1;
  display: flex;
  align-items: center;
  padding: 6px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  min-height: 48px;
  transition: border-color 0.2s;
}

.hour-content:hover {
  border-color: var(--border-light);
}

.hour-content.filled {
  border-left: 3px solid var(--cat-business);
}

.hour-block-title {
  font-size: 13px;
  font-weight: 500;
}

.hour-block-cat {
  margin-left: auto;
  flex-shrink: 0;
}

.hour-empty {
  font-size: 12px;
  color: var(--text-secondary);
  opacity: 0;
  transition: opacity 0.2s;
}

.hour-content:hover .hour-empty {
  opacity: 1;
}

/* Habit Tracker */
.habit-grid {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.habit-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  transition: border-color 0.2s;
}

.habit-card:hover {
  border-color: var(--border-light);
}

.habit-check {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  font-size: 14px;
  color: transparent;
}

.habit-check.done {
  border-color: var(--cat-business);
  background: var(--cat-business);
  color: #fff;
}

.habit-name {
  font-size: 14px;
  font-weight: 500;
  flex: 1;
}

.habit-streak {
  font-size: 12px;
  font-weight: 600;
  padding: 2px 10px;
  border-radius: 12px;
  background: rgba(212,147,13,0.15);
  color: var(--cat-financial);
}

.habit-actions {
  display: flex;
  gap: 4px;
}

.habit-week-dots {
  display: flex;
  gap: 4px;
  margin-left: auto;
  margin-right: 12px;
}

.habit-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 1px solid var(--border);
}

.habit-dot.done {
  border-color: var(--cat-business);
  background: var(--cat-business);
}

.habit-dot-label {
  font-size: 8px;
  text-align: center;
  color: var(--text-secondary);
  margin-top: 2px;
}

/* Scoreboard */
.score-display {
  text-align: center;
  padding: 32px;
}

.score-big {
  font-size: 72px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 8px;
}

.score-label {
  font-size: 14px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.score-breakdown {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 24px;
}

.score-item {
  background: var(--bg);
  border-radius: 10px;
  padding: 16px;
  text-align: center;
}

.score-item-value {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
}

.score-item-label {
  font-size: 11px;
  color: var(--text-secondary);
  text-transform: uppercase;
}

.score-history {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.score-history-row {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
}

.score-history-date {
  width: 140px;
  color: var(--text-secondary);
}

.score-history-bar {
  flex: 1;
  height: 8px;
  background: var(--border);
  border-radius: 4px;
  margin: 0 12px;
  overflow: hidden;
}

.score-history-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.4s ease;
}

.score-history-value {
  width: 50px;
  text-align: right;
  font-weight: 700;
}

.grade-s { color: var(--cat-financial); }
.grade-a { color: var(--cat-business); }
.grade-b { color: var(--cat-learning); }
.grade-c { color: var(--cat-financial); }
.grade-d { color: var(--cat-gym); }
.grade-f { color: var(--danger); }

/* Daily Ritual */
.ritual-section{margin-bottom:20px}
.ritual-section h3{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.ritual-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:13px;transition:all .2s}
.ritual-item.done{opacity:.5}
.ritual-item.done .ritual-text{text-decoration:line-through}
.ritual-check{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;font-size:11px;color:transparent}
.ritual-check.checked{border-color:var(--cat-business);background:var(--cat-business);color:#fff}
.ritual-text{flex:1}
.ritual-time{font-size:11px;color:var(--text-secondary);width:60px;flex-shrink:0}
.ritual-progress{display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(135deg,rgba(76,175,80,.08),rgba(212,147,13,.08));border:1px solid var(--border);border-radius:10px;margin-bottom:16px}
.ritual-progress-ring{width:48px;height:48px;flex-shrink:0}
.ritual-progress-text{font-size:13px}
.ritual-streak{font-size:12px;color:var(--text-secondary);margin-top:2px}
.ritual-actions{display:flex;gap:8px;flex-shrink:0}

/* Book Tracker */
.book-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px;transition:border-color .2s}
.book-card:hover{border-color:var(--border-light)}
.book-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.book-title{font-size:15px;font-weight:600}
.book-author{font-size:12px;color:var(--text-secondary)}
.book-meta{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;font-size:11px;color:var(--text-secondary)}
.book-takeaway{margin-top:10px;padding:10px 12px;background:var(--bg);border-radius:8px;font-size:12px;line-height:1.5;color:var(--text-secondary);border-left:3px solid var(--cat-learning)}
.book-status{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;text-transform:uppercase}
.book-status.reading{background:rgba(33,150,243,.12);color:var(--cat-learning)}
.book-status.completed{background:rgba(76,175,80,.12);color:var(--cat-business)}
.book-status.queued{background:rgba(152,152,176,.12);color:var(--text-secondary)}
.book-implemented{margin-top:8px;padding:6px 10px;background:rgba(76,175,80,.08);border-radius:6px;font-size:11px;color:var(--cat-business);display:flex;align-items:center;gap:6px}
.book-kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px}
.book-kpi{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.book-kpi-val{font-size:22px;font-weight:800}
.book-kpi-label{font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}

/* Content Calendar */
.content-week{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:20px}
.content-day{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px;min-height:120px}
.content-day-head{font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text-secondary);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.content-day-date{font-size:10px;color:var(--text-muted)}
.content-post{padding:6px 8px;background:var(--bg);border-radius:6px;margin-bottom:4px;font-size:11px;cursor:pointer;border-left:3px solid var(--cat-learning);transition:background .2s}
.content-post:hover{background:var(--surface-hover)}
.content-post.linkedin{border-left-color:var(--cat-learning)}
.content-post.facebook{border-left-color:var(--cat-networking)}
.content-post.instagram{border-left-color:var(--cat-gym)}
.content-post.twitter{border-left-color:var(--cat-golf)}
.content-post.tiktok{border-left-color:var(--cat-religion)}
.content-post.published{opacity:.6}
.content-add-btn{width:100%;padding:4px;background:none;border:1px dashed var(--border);border-radius:4px;color:var(--text-secondary);font-size:16px;cursor:pointer;transition:all .2s}
.content-add-btn:hover{border-color:var(--cat-learning);color:var(--cat-learning)}
.content-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px}
.content-stat{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.content-stat-val{font-size:20px;font-weight:800}
.content-stat-label{font-size:10px;color:var(--text-secondary);text-transform:uppercase}

/* Decision Journal */
.decision-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px}
.decision-card.reviewed{border-left:3px solid var(--cat-business)}
.decision-card.pending{border-left:3px solid var(--cat-financial)}
.decision-title{font-size:15px;font-weight:600;margin-bottom:4px}
.decision-meta{font-size:11px;color:var(--text-secondary);display:flex;gap:12px;margin-bottom:8px}
.decision-field{margin-top:8px;padding:8px 10px;background:var(--bg);border-radius:6px;font-size:12px;line-height:1.5}
.decision-field-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:2px}

/* Networking */
.network-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:14px}
.network-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;flex-shrink:0}
.network-info{flex:1;min-width:0}
.network-name{font-size:14px;font-weight:600}
.network-sub{font-size:11px;color:var(--text-secondary)}
.network-overdue{color:var(--danger);font-weight:600}

/* Golf */
.golf-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.golf-score{font-size:28px;font-weight:800}
.golf-diff{font-size:14px;font-weight:600;margin-left:4px}

/* Gratitude */
.gratitude-today{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.gratitude-entry{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px}
.gratitude-date{font-size:12px;font-weight:600;color:var(--cat-financial);margin-bottom:6px}
.gratitude-item{font-size:13px;padding:3px 0;color:var(--text-secondary)}
.gratitude-item::before{content:'âœ¦ ';color:var(--cat-financial)}
.gratitude-win{color:var(--cat-business);font-weight:500}
.gratitude-lesson{color:var(--cat-learning);font-style:italic}

/* Focus Timer */
.timer-display{text-align:center;padding:40px 20px}
.timer-time{font-size:72px;font-weight:800;font-variant-numeric:tabular-nums;letter-spacing:-2px}
.timer-label{font-size:14px;color:var(--text-secondary);margin-top:4px}
.timer-controls{display:flex;gap:10px;justify-content:center;margin-top:20px}
.timer-btn{padding:10px 24px;border-radius:10px;border:none;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.timer-sessions{display:flex;gap:6px;justify-content:center;margin-top:16px;flex-wrap:wrap}
.timer-dot{width:12px;height:12px;border-radius:50%;background:var(--border)}
.timer-dot.done{background:var(--cat-business)}
.timer-dot.active{background:var(--cat-financial);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* Accountability Mirror */
.mirror-section{margin-bottom:20px}
.mirror-section h3{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.mirror-item{padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:14px;display:flex;align-items:center;gap:12px}
.mirror-item.identity{border-left:3px solid var(--cat-business);font-weight:600}
.mirror-item.standard{border-left:3px solid var(--cat-financial)}
.mirror-item.truth{border-left:3px solid var(--danger)}
.mirror-item.excuse{border-left:3px solid var(--cat-networking);text-decoration:line-through;opacity:.7}

/* Health */
.health-tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:8px}
.health-tab{padding:6px 14px;border-radius:6px 6px 0 0;font-size:12px;font-weight:600;cursor:pointer;color:var(--text-secondary);background:transparent;border:none;font-family:inherit;transition:all .2s}
.health-tab:hover{color:var(--text);background:var(--surface)}
.health-tab.active{color:var(--cat-gym);background:var(--surface);border-bottom:2px solid var(--cat-gym)}
.health-view{display:none}.health-view.active{display:block}
.health-kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.health-kpi{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center}
.health-kpi-val{font-size:24px;font-weight:800;margin-bottom:2px}
.health-kpi-label{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary)}
.health-kpi-sub{font-size:10px;color:var(--text-muted);margin-top:2px}
.weight-chart{display:flex;align-items:flex-end;gap:3px;height:120px;padding:10px 0}
.weight-bar{flex:1;background:var(--cat-gym);border-radius:3px 3px 0 0;min-width:8px;max-width:24px;position:relative;transition:height .3s}
.weight-bar:hover::after{content:attr(data-label);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--surface-hover);padding:2px 6px;border-radius:4px;font-size:10px;white-space:nowrap;color:var(--text)}
.water-dots{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.water-glass{width:36px;height:36px;border-radius:8px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;transition:all .2s}
.water-glass.filled{border-color:#4FC3F7;background:rgba(79,195,247,.15)}
.water-glass:hover{border-color:#4FC3F7}
.meal-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:6px;display:flex;align-items:center;gap:12px}
.meal-type{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;width:70px;flex-shrink:0}
.meal-desc{flex:1;font-size:13px;color:var(--text-secondary)}
.meal-cal{font-weight:600;font-size:13px;color:var(--cat-financial)}
.supp-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;font-size:13px;cursor:pointer;transition:all .2s}
.supp-item:hover{border-color:var(--border-light)}
.supp-item.taken{opacity:.6}
.supp-check{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;color:transparent;flex-shrink:0;transition:all .2s}
.supp-check.done{border-color:var(--cat-business);background:var(--cat-business);color:#fff}
.workout-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px}
.workout-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.workout-type{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--cat-gym)}
.workout-date{font-size:11px;color:var(--text-secondary)}
.workout-details{font-size:13px;color:var(--text-secondary);line-height:1.5}
.macro-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.macro-ring{text-align:center;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 8px}
.macro-ring svg{width:80px;height:80px;margin-bottom:6px}
.macro-ring-label{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:2px}
.macro-ring-val{font-size:16px;font-weight:700}
.macro-ring-sub{font-size:10px;color:var(--text-muted)}
.routine-day{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px}
.routine-day.today{border-color:var(--cat-gym);box-shadow:0 0 0 1px var(--cat-gym)}
.routine-day-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.routine-day-head h3{font-size:14px;font-weight:700}
.routine-day-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:2px 8px;border-radius:4px}
.exercise-row{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bg);border-radius:6px;margin-bottom:4px;font-size:13px}
.exercise-row:hover{background:var(--surface-hover)}
.exercise-check{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;color:transparent;flex-shrink:0;cursor:pointer;transition:all .2s}
.exercise-check.done{border-color:var(--cat-business);background:var(--cat-business);color:#fff}
.exercise-name{font-weight:600;flex:1}
.exercise-meta{font-size:11px;color:var(--text-secondary)}
.progress-exercise{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px}
.progress-exercise h3{font-size:14px;font-weight:600;margin-bottom:10px}
.progress-bars{display:flex;align-items:flex-end;gap:3px;height:80px;margin-bottom:4px}
.progress-bar-col{flex:1;display:flex;flex-direction:column;align-items:center;min-width:0}
.progress-bar-fill{width:100%;border-radius:3px 3px 0 0;transition:height .3s;min-height:2px;max-width:28px;margin:0 auto}
.progress-bar-date{font-size:9px;color:var(--text-muted);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.progress-bar-wt{font-size:10px;font-weight:600;margin-top:1px}
.pr-badge{display:inline-block;padding:1px 6px;border-radius:10px;font-size:9px;font-weight:700;background:rgba(76,175,80,.15);color:var(--cat-business);margin-left:6px}

/* Energy Tracker */
.energy-today{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.energy-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.energy-label{width:80px;font-size:12px;font-weight:600;color:var(--text-secondary);flex-shrink:0}
.energy-dots{display:flex;gap:4px}
.energy-dot{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--text-secondary)}
.energy-dot.active{color:#fff}
.energy-dot:hover{border-color:var(--cat-financial)}
.energy-history{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
.energy-day{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:12px}
.energy-day-date{font-weight:600;margin-bottom:4px;font-size:11px;color:var(--text-secondary)}
.energy-bar-mini{display:flex;align-items:center;gap:4px;margin-bottom:2px}
.energy-bar-mini-label{width:20px;font-size:10px;color:var(--text-secondary)}
.energy-bar-mini-track{flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.energy-bar-mini-fill{height:100%;border-radius:2px}

@media(max-width:900px){
  .content-week{grid-template-columns:1fr 1fr}
  .fin-cashflow{grid-template-columns:1fr}
  .energy-history{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<!-- Mobile toggle -->
<button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">&#9776;</button>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>Life Planner</h1>
    <p>Plan. Track. Achieve.</p>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-item active" data-view="dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </div>
    <div class="nav-item" data-view="goals">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
      Goals
    </div>
    <div class="nav-item" data-view="achievements">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      Achievements
    </div>
    <div class="nav-item" data-view="financial">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      Financial
    </div>
    <div class="nav-item" data-view="yearly">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Yearly Plan
    </div>
    <div class="nav-item" data-view="weekly">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Weekly View
    </div>
    <div class="nav-item" data-view="daily">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Daily Focus
    </div>
    <div class="nav-item" data-view="hourly">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
      Hourly Planner
    </div>
    <div class="nav-item" data-view="habits">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      Habits
    </div>
    <div class="nav-item" data-view="scoreboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
      Scoreboard
    </div>
    <div class="nav-item" data-view="rewards">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6"/><path d="M2 8h20v4H2z"/><path d="M12 2c-1.5 0-3 1.5-3 3h6c0-1.5-1.5-3-3-3z"/><line x1="12" y1="8" x2="12" y2="20"/></svg>
      Rewards
    </div>
    <div class="nav-item" data-view="ritual">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Daily Ritual
    </div>
    <div class="nav-item" data-view="books">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
      Books / Learning
    </div>
    <div class="nav-item" data-view="content">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      Content Calendar
    </div>
    <div class="nav-item" data-view="decisions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
      Decision Journal
    </div>
    <div class="nav-item" data-view="network">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
      Network
    </div>
    <div class="nav-item" data-view="golf">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="18" r="3"/><line x1="12" y1="2" x2="12" y2="15"/><path d="M12 2l7 4-7 4"/></svg>
      Golf
    </div>
    <div class="nav-item" data-view="gratitude">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
      Gratitude
    </div>
    <div class="nav-item" data-view="focus">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 10"/></svg>
      Focus Timer
    </div>
    <div class="nav-item" data-view="mirror">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg>
      Mirror
    </div>
    <div class="nav-item" data-view="energy">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
      Energy
    </div>
    <div class="nav-item" data-view="health">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
      Health
    </div>
  </nav>
  <div style="padding:12px 16px;border-top:1px solid var(--border)">
    <div style="font-size:10px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Backup</div>
    <button onclick="exportData()" style="width:100%;padding:8px;margin-bottom:6px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:12px;font-weight:600;cursor:pointer">&#11123; Export Backup</button>
    <button onclick="document.getElementById('importFile').click()" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:12px;font-weight:600;cursor:pointer">&#11121; Import Backup</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
  </div>
</aside>

<!-- Main Content -->
<main class="main">

  <!-- DASHBOARD -->
  <div id="view-dashboard" class="view active">
    <h1 class="section-title" id="dash-greeting"></h1>
    <div class="stats-row" id="dash-stats"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
      <div class="card">
        <div class="card-header"><h2>Today's Focus</h2></div>
        <div id="dash-focus"></div>
      </div>
      <div class="card">
        <div class="card-header"><h2>Recent Achievements</h2></div>
        <div id="dash-achievements"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h2>Goal Progress by Category</h2></div>
      <div class="cat-progress-grid" id="dash-cat-progress"></div>
    </div>
  </div>

  <!-- GOALS -->
  <div id="view-goals" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h1 class="section-title" style="margin-bottom:0">Goals</h1>
      <button class="btn btn-primary" onclick="openGoalModal()">+ Add Goal</button>
    </div>
    <div class="tabs" id="goal-tabs"></div>
    <div id="goals-list"></div>
  </div>

  <!-- ACHIEVEMENTS -->
  <div id="view-achievements" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h1 class="section-title" style="margin-bottom:0">Achievements</h1>
      <button class="btn btn-primary" onclick="openAchievementModal()">+ Add Achievement</button>
    </div>
    <div class="tabs" id="achievement-tabs"></div>
    <div id="achievements-list"></div>
  </div>

  <!-- FINANCIAL -->
  <div id="view-financial" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="section-title" style="margin-bottom:0">Financial Tracker</h1>
      <div style="display:flex;gap:8px" id="fin-action-btns"></div>
    </div>
    <div class="fin-subtabs">
      <button class="fin-subtab active" onclick="switchFinTab('overview')">Overview</button>
      <button class="fin-subtab" onclick="switchFinTab('transactions')">Transactions</button>
      <button class="fin-subtab" onclick="switchFinTab('budget')">Budget</button>
      <button class="fin-subtab" onclick="switchFinTab('savings')">Savings Goals</button>
    </div>
    <div class="fin-subview active" id="fin-overview">
      <div class="fin-kpi-grid" id="fin-kpis"></div>
      <div class="fin-cashflow" id="fin-cashflow"></div>
      <div>
        <div class="fin-recent-head">
          <h3>Recent Transactions</h3>
          <button class="btn btn-ghost btn-sm" onclick="switchFinTab('transactions')">View All</button>
        </div>
        <div id="fin-recent-txns"></div>
      </div>
    </div>
    <div class="fin-subview" id="fin-transactions">
      <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
        <select class="form-control" id="txn-filter-type" onchange="renderTransactions()" style="width:130px">
          <option value="all">All Types</option>
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>
        <select class="form-control" id="txn-filter-cat" onchange="renderTransactions()" style="width:150px">
          <option value="all">All Categories</option>
        </select>
        <input type="month" class="form-control" id="txn-filter-month" onchange="renderTransactions()" style="width:170px">
      </div>
      <div id="txn-summary" style="margin-bottom:14px"></div>
      <div id="txn-list"></div>
    </div>
    <div class="fin-subview" id="fin-budget">
      <div class="fin-month-nav">
        <button class="btn btn-ghost btn-sm" onclick="changeBudgetMonth(-1)">&larr;</button>
        <h3 id="budget-month-label"></h3>
        <button class="btn btn-ghost btn-sm" onclick="changeBudgetMonth(1)">&rarr;</button>
      </div>
      <div id="budget-summary" style="margin-bottom:14px"></div>
      <div id="budget-list"></div>
    </div>
    <div class="fin-subview" id="fin-savings">
      <div id="savings-list"></div>
    </div>
  </div>

  <!-- YEARLY PLAN -->
  <div id="view-yearly" class="view">
    <h1 class="section-title">Yearly Plan <span id="yearly-year" style="color:var(--text-secondary)"></span></h1>
    <div class="yearly-grid" id="yearly-grid"></div>
  </div>

  <!-- WEEKLY VIEW -->
  <div id="view-weekly" class="view">
    <div class="week-nav">
      <button class="btn btn-ghost btn-sm" onclick="changeWeek(-1)">&larr; Prev</button>
      <h2 id="week-label"></h2>
      <button class="btn btn-ghost btn-sm" onclick="changeWeek(1)">Next &rarr;</button>
      <button class="btn btn-ghost btn-sm" onclick="currentWeekOffset=0;renderWeekly()">Today</button>
    </div>
    <div class="week-grid" id="week-grid"></div>
  </div>

  <!-- HOURLY PLANNER -->
  <div id="view-hourly" class="view">
    <h1 class="section-title" style="margin-bottom:16px">Hourly Planner</h1>
    <div class="hourly-nav">
      <button class="btn btn-ghost btn-sm" onclick="changeHourlyDay(-1)">&larr; Prev</button>
      <h2 id="hourly-date-label"></h2>
      <button class="btn btn-ghost btn-sm" onclick="changeHourlyDay(1)">Next &rarr;</button>
      <button class="btn btn-ghost btn-sm" onclick="hourlyDayOffset=0;renderHourly()">Today</button>
    </div>
    <div class="card" style="padding:12px">
      <div class="hour-grid" id="hourly-grid"></div>
    </div>
  </div>

  <!-- HABITS -->
  <div id="view-habits" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h1 class="section-title" style="margin-bottom:0">Habit Tracker</h1>
      <button class="btn btn-primary" onclick="openHabitModal()">+ Add Habit</button>
    </div>
    <div class="card" style="margin-bottom:20px">
      <div class="card-header">
        <h2>Today's Habits</h2>
        <div id="habits-today-score" style="font-size:14px;font-weight:600"></div>
      </div>
      <div class="habit-grid" id="habits-list"></div>
    </div>
  </div>

  <!-- SCOREBOARD -->
  <div id="view-scoreboard" class="view">
    <h1 class="section-title">Scoreboard</h1>
    <div class="card">
      <div class="score-display">
        <div class="score-big" id="score-today-value">0</div>
        <div class="score-label">Today's Productivity Score</div>
        <div id="score-grade" style="font-size:32px;font-weight:700;margin-top:8px"></div>
      </div>
      <div class="score-breakdown" id="score-breakdown"></div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="card-header"><h2>Last 14 Days</h2></div>
      <div class="score-history" id="score-history"></div>
    </div>
  </div>

  <!-- REWARDS -->
  <div id="view-rewards" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h1 class="section-title" style="margin-bottom:0">Rewards</h1>
      <button class="btn btn-primary" onclick="openRewardModal()">+ Add Reward</button>
    </div>
    <div class="card" style="margin-bottom:20px">
      <div class="card-header"><h2>Your Points</h2></div>
      <div style="display:flex;align-items:center;gap:24px">
        <div>
          <div style="font-size:48px;font-weight:700;color:var(--cat-financial)" id="reward-points">0</div>
          <div style="font-size:13px;color:var(--text-secondary)">Points available to redeem</div>
        </div>
        <div style="flex:1;font-size:13px;color:var(--text-secondary);line-height:1.6">
          Earn points by completing goals:<br>
          <span style="color:var(--text)">+10 points</span> per goal completed
        </div>
      </div>
    </div>
    <h2 style="font-size:16px;margin-bottom:12px">Available Rewards</h2>
    <div id="rewards-available"></div>
    <h2 style="font-size:16px;margin:24px 0 12px">Redeemed Rewards</h2>
    <div id="rewards-redeemed"></div>
  </div>

  <!-- DAILY FOCUS -->
  <div id="view-daily" class="view">
    <div class="daily-date" id="daily-date"></div>
    <div class="daily-subtitle" id="daily-subtitle"></div>

    <div class="card">
      <div class="card-header">
        <h2>Top Priorities</h2>
      </div>
      <div id="daily-priorities"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="card-header">
        <h2>All Tasks</h2>
        <button class="btn btn-primary btn-sm" onclick="openDailyTaskModal()">+ Add Task</button>
      </div>
      <div id="daily-tasks"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="card-header">
        <h2>Notes / Journal</h2>
      </div>
      <textarea class="form-control" id="daily-notes" placeholder="Write your thoughts for today..." rows="5" oninput="saveDailyNote()"></textarea>
    </div>
  </div>

  <!-- DAILY RITUAL -->
  <div id="view-ritual" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="section-title" style="margin-bottom:0">Daily Ritual</h1>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" onclick="openRitualModal()">+ Add Step</button>
        <button class="btn btn-ghost" onclick="resetRitualToday()">Reset Today</button>
      </div>
    </div>
    <div id="ritual-progress"></div>
    <div id="ritual-morning"></div>
    <div id="ritual-evening"></div>
  </div>

  <!-- BOOKS / LEARNING -->
  <div id="view-books" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="section-title" style="margin-bottom:0">Books & Learning</h1>
      <button class="btn btn-primary" onclick="openBookModal()">+ Add Book</button>
    </div>
    <div class="book-kpi-grid" id="book-kpis"></div>
    <div class="tabs" style="margin-bottom:16px">
      <button class="tab active" onclick="filterBooks('all',this)">All</button>
      <button class="tab" onclick="filterBooks('reading',this)">Reading</button>
      <button class="tab" onclick="filterBooks('completed',this)">Completed</button>
      <button class="tab" onclick="filterBooks('queued',this)">Queue</button>
    </div>
    <div id="book-list"></div>
  </div>

  <!-- CONTENT CALENDAR -->
  <div id="view-content" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="section-title" style="margin-bottom:0">Content Calendar</h1>
      <button class="btn btn-primary" onclick="openContentModal()">+ Plan Post</button>
    </div>
    <div class="content-stats" id="content-stats"></div>
    <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:16px">
      <button class="btn btn-ghost btn-sm" onclick="changeContentWeek(-1)">&larr; Prev</button>
      <h3 id="content-week-label" style="font-size:14px;min-width:200px;text-align:center"></h3>
      <button class="btn btn-ghost btn-sm" onclick="changeContentWeek(1)">Next &rarr;</button>
    </div>
    <div class="content-week" id="content-calendar"></div>
  </div>

  <!-- DECISION JOURNAL -->
  <div id="view-decisions" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="section-title" style="margin-bottom:0">Decision Journal</h1>
      <button class="btn btn-primary" onclick="openDecisionModal()">+ Log Decision</button>
    </div>
    <div class="tabs" style="margin-bottom:14px">
      <button class="tab active" onclick="filterDecisions('all',this)">All</button>
      <button class="tab" onclick="filterDecisions('pending',this)">Needs Review</button>
      <button class="tab" onclick="filterDecisions('reviewed',this)">Reviewed</button>
    </div>
    <div id="decision-list"></div>
  </div>

  <!-- NETWORKING -->
  <div id="view-network" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="section-title" style="margin-bottom:0">Network</h1>
      <button class="btn btn-primary" onclick="openNetworkModal()">+ Add Person</button>
    </div>
    <div class="tabs" style="margin-bottom:14px">
      <button class="tab active" onclick="filterNetwork('all',this)">All</button>
      <button class="tab" onclick="filterNetwork('overdue',this)">Reach Out</button>
      <button class="tab" onclick="filterNetwork('mentor',this)">Mentors</button>
      <button class="tab" onclick="filterNetwork('peer',this)">Peers</button>
    </div>
    <div id="network-list"></div>
  </div>

  <!-- GOLF -->
  <div id="view-golf" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="section-title" style="margin-bottom:0">Golf Scorecard</h1>
      <button class="btn btn-primary" onclick="openGolfModal()">+ Log Round</button>
    </div>
    <div class="book-kpi-grid" id="golf-kpis"></div>
    <div id="golf-list"></div>
  </div>

  <!-- GRATITUDE -->
  <div id="view-gratitude" class="view">
    <h1 class="section-title">Gratitude & Reflection</h1>
    <div class="gratitude-today" id="gratitude-today"></div>
    <h3 style="font-size:13px;font-weight:600;margin-bottom:10px;color:var(--text-secondary)">History</h3>
    <div id="gratitude-list"></div>
  </div>

  <!-- FOCUS TIMER -->
  <div id="view-focus" class="view">
    <h1 class="section-title">Focus Timer</h1>
    <div class="card">
      <div class="timer-display">
        <div class="timer-time" id="timer-display">25:00</div>
        <div class="timer-label" id="timer-status">Ready to focus</div>
        <div class="timer-controls">
          <button class="timer-btn" style="background:var(--cat-business);color:#fff" id="timer-start-btn" onclick="toggleTimer()">Start</button>
          <button class="timer-btn" style="background:var(--border);color:var(--text)" onclick="resetTimer()">Reset</button>
          <button class="timer-btn" style="background:var(--surface);color:var(--text);border:1px solid var(--border)" onclick="skipTimer()">Skip</button>
        </div>
        <div class="timer-sessions" id="timer-sessions"></div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="setTimerDuration(15)">15 min</button>
      <button class="btn btn-ghost btn-sm" onclick="setTimerDuration(25)" style="border-color:var(--cat-business)">25 min</button>
      <button class="btn btn-ghost btn-sm" onclick="setTimerDuration(45)">45 min</button>
      <button class="btn btn-ghost btn-sm" onclick="setTimerDuration(60)">60 min</button>
    </div>
    <div class="card" style="margin-top:14px">
      <div class="card-header"><h2>Today's Sessions</h2></div>
      <div id="focus-history"></div>
    </div>
  </div>

  <!-- ACCOUNTABILITY MIRROR -->
  <div id="view-mirror" class="view">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="section-title" style="margin-bottom:0">Accountability Mirror</h1>
      <button class="btn btn-primary" onclick="openMirrorModal()">+ Add</button>
    </div>
    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Read this every morning. Be honest with yourself. This is between you and the mirror.</p>
    <div id="mirror-identity"></div>
    <div id="mirror-standards"></div>
    <div id="mirror-truths"></div>
    <div id="mirror-excuses"></div>
  </div>

  <!-- ENERGY TRACKER -->
  <div id="view-energy" class="view">
    <h1 class="section-title">Energy & Sleep</h1>
    <div class="energy-today" id="energy-today"></div>
    <div class="book-kpi-grid" id="energy-kpis"></div>
    <h3 style="font-size:13px;font-weight:600;margin-bottom:10px;color:var(--text-secondary)">Last 14 Days</h3>
    <div class="energy-history" id="energy-history"></div>
  </div>

  <!-- HEALTH -->
  <div id="view-health" class="view">
    <h1 class="section-title">Health</h1>
    <div class="health-tabs">
      <button class="health-tab active" onclick="switchHealthTab('overview')">Overview</button>
      <button class="health-tab" onclick="switchHealthTab('weight')">Weight</button>
      <button class="health-tab" onclick="switchHealthTab('water')">Water</button>
      <button class="health-tab" onclick="switchHealthTab('meals')">Meals</button>
      <button class="health-tab" onclick="switchHealthTab('supplements')">Supplements</button>
      <button class="health-tab" onclick="switchHealthTab('workouts')">Workouts</button>
      <button class="health-tab" onclick="switchHealthTab('routine')">Routine</button>
      <button class="health-tab" onclick="switchHealthTab('progress')">Progress</button>
    </div>
    <div class="health-view active" id="health-overview"></div>
    <div class="health-view" id="health-weight"></div>
    <div class="health-view" id="health-water"></div>
    <div class="health-view" id="health-meals"></div>
    <div class="health-view" id="health-supplements"></div>
    <div class="health-view" id="health-workouts"></div>
    <div class="health-view" id="health-routine"></div>
    <div class="health-view" id="health-progress"></div>
  </div>

</main>

<!-- MODALS -->

<!-- Goal Modal -->
<div class="modal-overlay" id="goal-modal">
  <div class="modal">
    <h3 id="goal-modal-title">Add Goal</h3>
    <input type="hidden" id="goal-id">
    <div class="form-group">
      <label>Title</label>
      <input type="text" class="form-control" id="goal-title" placeholder="e.g., Launch Crew Voice">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" id="goal-category">
          <option value="business">Business</option>
          <option value="financial">Financial</option>
          <option value="golf">Golf</option>
          <option value="networking">Networking</option>
          <option value="learning">Learning</option>
          <option value="religion">Religion</option>
          <option value="gym">Gym</option>
        </select>
      </div>
      <div class="form-group">
        <label>Deadline</label>
        <input type="date" class="form-control" id="goal-deadline">
      </div>
    </div>
    <div class="form-group">
      <label>Target / Description</label>
      <textarea class="form-control" id="goal-target" placeholder="What does success look like?"></textarea>
    </div>
    <div class="form-group">
      <label>Progress (0â€“100%)</label>
      <input type="number" class="form-control" id="goal-progress" min="0" max="100" value="0">
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea class="form-control" id="goal-notes" placeholder="Additional notes..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('goal-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGoal()">Save Goal</button>
    </div>
  </div>
</div>

<!-- Achievement Modal -->
<div class="modal-overlay" id="achievement-modal">
  <div class="modal">
    <h3>Add Achievement</h3>
    <div class="form-group">
      <label>Title</label>
      <input type="text" class="form-control" id="ach-title" placeholder="What did you accomplish?">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" id="ach-category">
          <option value="business">Business</option>
          <option value="financial">Financial</option>
          <option value="golf">Golf</option>
          <option value="networking">Networking</option>
          <option value="learning">Learning</option>
          <option value="religion">Religion</option>
          <option value="gym">Gym</option>
        </select>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" class="form-control" id="ach-date">
      </div>
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea class="form-control" id="ach-desc" placeholder="Details..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('achievement-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAchievement()">Save</button>
    </div>
  </div>
</div>

<!-- Transaction Modal -->
<div class="modal-overlay" id="txn-modal">
  <div class="modal">
    <h3 id="txn-modal-title">Add Transaction</h3>
    <input type="hidden" id="txn-id">
    <div class="form-row">
      <div class="form-group">
        <label>Type</label>
        <select class="form-control" id="txn-type" onchange="updateTxnCategories()">
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>
      </div>
      <div class="form-group">
        <label>Amount ($)</label>
        <input type="number" class="form-control" id="txn-amount" min="0" step="0.01" placeholder="0.00">
      </div>
    </div>
    <div class="form-group">
      <label>Category</label>
      <select class="form-control" id="txn-category"></select>
    </div>
    <div class="form-group">
      <label>Description</label>
      <input type="text" class="form-control" id="txn-description" placeholder="What is this for?">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Date</label>
        <input type="date" class="form-control" id="txn-date">
      </div>
      <div class="form-group">
        <label>Recurring?</label>
        <select class="form-control" id="txn-recurring">
          <option value="">One-time</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="txn-delete-btn" onclick="deleteTxn()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('txn-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTxn()">Save</button>
    </div>
  </div>
</div>

<!-- Budget Modal -->
<div class="modal-overlay" id="budget-modal">
  <div class="modal">
    <h3>Set Monthly Budget</h3>
    <div class="form-group">
      <label>Category</label>
      <select class="form-control" id="budget-category"></select>
    </div>
    <div class="form-group">
      <label>Monthly Limit ($)</label>
      <input type="number" class="form-control" id="budget-limit" min="0" step="1" placeholder="500">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('budget-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveBudget()">Save</button>
    </div>
  </div>
</div>

<!-- Savings Goal Modal -->
<div class="modal-overlay" id="fin-goal-modal">
  <div class="modal">
    <h3 id="fin-goal-modal-title">Add Savings Goal</h3>
    <input type="hidden" id="fin-goal-id">
    <div class="form-group">
      <label>Goal Name</label>
      <input type="text" class="form-control" id="fin-goal-title" placeholder="e.g., Emergency Fund">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Target Amount ($)</label>
        <input type="number" class="form-control" id="fin-goal-target" min="0" step="0.01" placeholder="10000">
      </div>
      <div class="form-group">
        <label>Starting Balance ($)</label>
        <input type="number" class="form-control" id="fin-goal-current" min="0" step="0.01" placeholder="0">
      </div>
    </div>
    <div class="form-group">
      <label>Deadline</label>
      <input type="date" class="form-control" id="fin-goal-deadline">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('fin-goal-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveFinGoal()">Save</button>
    </div>
  </div>
</div>

<!-- Savings Entry Modal -->
<div class="modal-overlay" id="fin-entry-modal">
  <div class="modal">
    <h3>Add to Savings</h3>
    <div class="form-group">
      <label>Savings Goal</label>
      <select class="form-control" id="fin-entry-goal"></select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Type</label>
        <select class="form-control" id="fin-entry-type">
          <option value="saving">Deposit</option>
          <option value="expense">Withdrawal</option>
        </select>
      </div>
      <div class="form-group">
        <label>Amount ($)</label>
        <input type="number" class="form-control" id="fin-entry-amount" min="0" step="0.01">
      </div>
    </div>
    <div class="form-group">
      <label>Description</label>
      <input type="text" class="form-control" id="fin-entry-desc" placeholder="What is this for?">
    </div>
    <div class="form-group">
      <label>Date</label>
      <input type="date" class="form-control" id="fin-entry-date">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('fin-entry-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveFinEntry()">Save</button>
    </div>
  </div>
</div>

<!-- Ritual Step Modal -->
<div class="modal-overlay" id="ritual-modal">
  <div class="modal">
    <h3 id="ritual-modal-title">Add Ritual Step</h3>
    <input type="hidden" id="ritual-id">
    <div class="form-group">
      <label>What do you do?</label>
      <input type="text" class="form-control" id="ritual-text" placeholder="e.g., Read for 20 minutes">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>When</label>
        <select class="form-control" id="ritual-when">
          <option value="morning">Morning</option>
          <option value="evening">Evening</option>
        </select>
      </div>
      <div class="form-group">
        <label>Duration (minutes)</label>
        <input type="number" class="form-control" id="ritual-duration" min="1" value="15" placeholder="15">
      </div>
    </div>
    <div class="form-group">
      <label>Order (lower = earlier)</label>
      <input type="number" class="form-control" id="ritual-order" min="1" value="1">
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="ritual-delete-btn" onclick="deleteRitualStep()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('ritual-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveRitualStep()">Save</button>
    </div>
  </div>
</div>

<!-- Book Modal -->
<div class="modal-overlay" id="book-modal">
  <div class="modal">
    <h3 id="book-modal-title">Add Book</h3>
    <input type="hidden" id="book-id">
    <div class="form-group">
      <label>Title</label>
      <input type="text" class="form-control" id="book-title" placeholder="e.g., $100M Leads">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Author</label>
        <input type="text" class="form-control" id="book-author" placeholder="e.g., Alex Hormozi">
      </div>
      <div class="form-group">
        <label>Type</label>
        <select class="form-control" id="book-type">
          <option value="book">Book</option>
          <option value="audiobook">Audiobook</option>
          <option value="podcast">Podcast</option>
          <option value="course">Course</option>
          <option value="video">Video/YouTube</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Status</label>
        <select class="form-control" id="book-status">
          <option value="queued">Queued</option>
          <option value="reading">Reading Now</option>
          <option value="completed">Completed</option>
        </select>
      </div>
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" id="book-category">
          <option value="business">Business</option>
          <option value="financial">Financial</option>
          <option value="networking">Networking</option>
          <option value="learning">Learning</option>
          <option value="religion">Religion</option>
          <option value="gym">Gym / Health</option>
          <option value="golf">Golf</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Key Takeaway (the ONE thing)</label>
      <textarea class="form-control" id="book-takeaway" placeholder="What's the single most important lesson? What will you actually do differently?"></textarea>
    </div>
    <div class="form-group">
      <label>Implemented?</label>
      <select class="form-control" id="book-implemented">
        <option value="">Not yet</option>
        <option value="yes">Yes â€” applied it</option>
      </select>
    </div>
    <div class="form-group">
      <label>Implementation Notes</label>
      <input type="text" class="form-control" id="book-impl-notes" placeholder="What specifically did you do?">
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="book-delete-btn" onclick="deleteBook()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('book-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveBook()">Save</button>
    </div>
  </div>
</div>

<!-- Content Post Modal -->
<div class="modal-overlay" id="content-modal">
  <div class="modal">
    <h3 id="content-modal-title">Plan Content</h3>
    <input type="hidden" id="content-id">
    <input type="hidden" id="content-date-val">
    <div class="form-row">
      <div class="form-group">
        <label>Platform</label>
        <select class="form-control" id="content-platform">
          <option value="linkedin">LinkedIn</option>
          <option value="facebook">Facebook</option>
          <option value="instagram">Instagram</option>
          <option value="twitter">Twitter/X</option>
          <option value="tiktok">TikTok</option>
        </select>
      </div>
      <div class="form-group">
        <label>Type</label>
        <select class="form-control" id="content-type">
          <option value="text">Text Post</option>
          <option value="image">Image Post</option>
          <option value="video">Video/Reel</option>
          <option value="carousel">Carousel</option>
          <option value="story">Story</option>
          <option value="comment">Comment/Engage</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Topic / Hook</label>
      <input type="text" class="form-control" id="content-topic" placeholder="e.g., Why your best crew member is about to quit">
    </div>
    <div class="form-group">
      <label>Notes / Draft</label>
      <textarea class="form-control" id="content-notes" placeholder="Draft the post or outline key points..."></textarea>
    </div>
    <div class="form-group">
      <label>Date</label>
      <input type="date" class="form-control" id="content-date">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Status</label>
        <select class="form-control" id="content-status">
          <option value="planned">Planned</option>
          <option value="drafted">Drafted</option>
          <option value="published">Published</option>
        </select>
      </div>
      <div class="form-group">
        <label>CTA</label>
        <select class="form-control" id="content-cta">
          <option value="">None</option>
          <option value="dm">DM me</option>
          <option value="link">Link in bio/comment</option>
          <option value="call">Book a call</option>
          <option value="engage">Comment below</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="content-delete-btn" onclick="deleteContentPost()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('content-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveContentPost()">Save</button>
    </div>
  </div>
</div>

<!-- Decision Modal -->
<div class="modal-overlay" id="decision-modal">
  <div class="modal">
    <h3 id="decision-modal-title">Log Decision</h3>
    <input type="hidden" id="dec-id">
    <div class="form-group"><label>Decision</label><input type="text" class="form-control" id="dec-title" placeholder="What are you deciding?"></div>
    <div class="form-group"><label>Context</label><textarea class="form-control" id="dec-context" placeholder="What's the situation? What are the options?"></textarea></div>
    <div class="form-group"><label>Reasoning</label><textarea class="form-control" id="dec-reasoning" placeholder="Why are you choosing this option?"></textarea></div>
    <div class="form-group"><label>Expected Outcome</label><textarea class="form-control" id="dec-expected" placeholder="What do you think will happen?"></textarea></div>
    <div class="form-row">
      <div class="form-group"><label>Date</label><input type="date" class="form-control" id="dec-date"></div>
      <div class="form-group"><label>Review In (days)</label><input type="number" class="form-control" id="dec-review-days" value="30" min="1"></div>
    </div>
    <div class="form-group"><label>Actual Outcome (fill in later)</label><textarea class="form-control" id="dec-actual" placeholder="What actually happened?"></textarea></div>
    <div class="form-group"><label>Lesson Learned</label><input type="text" class="form-control" id="dec-lesson" placeholder="What did you learn?"></div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="dec-delete-btn" onclick="deleteDecision()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('decision-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDecision()">Save</button>
    </div>
  </div>
</div>

<!-- Network Modal -->
<div class="modal-overlay" id="network-modal">
  <div class="modal">
    <h3 id="network-modal-title">Add Person</h3>
    <input type="hidden" id="net-id">
    <div class="form-row">
      <div class="form-group"><label>Name</label><input type="text" class="form-control" id="net-name" placeholder="John Smith"></div>
      <div class="form-group"><label>Company/Role</label><input type="text" class="form-control" id="net-company" placeholder="CEO at Acme"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Relationship</label>
        <select class="form-control" id="net-relationship">
          <option value="mentor">Mentor</option><option value="peer">Peer</option><option value="prospect">Prospect</option>
          <option value="partner">Partner</option><option value="friend">Friend</option><option value="family">Family</option>
        </select>
      </div>
      <div class="form-group"><label>Reach Out Every (days)</label><input type="number" class="form-control" id="net-frequency" value="30" min="1"></div>
    </div>
    <div class="form-group"><label>How can you help them?</label><input type="text" class="form-control" id="net-give" placeholder="What value can you provide?"></div>
    <div class="form-group"><label>How can they help you?</label><input type="text" class="form-control" id="net-get" placeholder="What could they offer?"></div>
    <div class="form-group"><label>Last Contact Date</label><input type="date" class="form-control" id="net-last-contact"></div>
    <div class="form-group"><label>Notes</label><textarea class="form-control" id="net-notes" placeholder="Context, interests, last conversation..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="net-delete-btn" onclick="deleteNetworkContact()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('network-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveNetworkContact()">Save</button>
    </div>
  </div>
</div>

<!-- Golf Modal -->
<div class="modal-overlay" id="golf-modal">
  <div class="modal">
    <h3 id="golf-modal-title">Log Round</h3>
    <input type="hidden" id="golf-id">
    <div class="form-row">
      <div class="form-group"><label>Course</label><input type="text" class="form-control" id="golf-course" placeholder="Pebble Beach"></div>
      <div class="form-group"><label>Date</label><input type="date" class="form-control" id="golf-date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Score</label><input type="number" class="form-control" id="golf-score" placeholder="85"></div>
      <div class="form-group"><label>Par</label><input type="number" class="form-control" id="golf-par" value="72"></div>
    </div>
    <div class="form-group"><label>Notes</label><textarea class="form-control" id="golf-notes" placeholder="What went well? What to work on?"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="golf-delete-btn" onclick="deleteGolfRound()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('golf-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGolfRound()">Save</button>
    </div>
  </div>
</div>

<!-- Mirror Modal -->
<div class="modal-overlay" id="mirror-modal">
  <div class="modal">
    <h3>Add to Mirror</h3>
    <input type="hidden" id="mirror-id">
    <div class="form-group"><label>Type</label>
      <select class="form-control" id="mirror-type">
        <option value="identity">I AM... (identity statement)</option>
        <option value="standard">My Standard (non-negotiable)</option>
        <option value="truth">Hard Truth (face it)</option>
        <option value="excuse">Excuse I'm Killing</option>
      </select>
    </div>
    <div class="form-group"><label>Statement</label><input type="text" class="form-control" id="mirror-text" placeholder="e.g., I am someone who does the work even when I don't feel like it"></div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="mirror-delete-btn" onclick="deleteMirrorItem()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('mirror-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveMirrorItem()">Save</button>
    </div>
  </div>
</div>

<!-- Milestone Modal -->
<div class="modal-overlay" id="milestone-modal">
  <div class="modal">
    <h3>Add Milestone</h3>
    <input type="hidden" id="milestone-month">
    <div class="form-group">
      <label>Title</label>
      <input type="text" class="form-control" id="milestone-title" placeholder="e.g., Launch beta">
    </div>
    <div class="form-group">
      <label>Category</label>
      <select class="form-control" id="milestone-category">
        <option value="business">Business</option>
        <option value="financial">Financial</option>
        <option value="golf">Golf</option>
        <option value="networking">Networking</option>
        <option value="learning">Learning</option>
        <option value="religion">Religion</option>
        <option value="gym">Gym</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('milestone-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveMilestone()">Save</button>
    </div>
  </div>
</div>

<!-- Reward Modal -->
<div class="modal-overlay" id="reward-modal">
  <div class="modal">
    <h3 id="reward-modal-title">Add Reward</h3>
    <input type="hidden" id="reward-id">
    <div class="form-group">
      <label>Reward Name</label>
      <input type="text" class="form-control" id="reward-title" placeholder="e.g., New golf club, Nice dinner out">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea class="form-control" id="reward-desc" placeholder="Details about this reward..."></textarea>
    </div>
    <div class="form-group">
      <label>Points Cost</label>
      <input type="number" class="form-control" id="reward-cost" min="1" value="10" placeholder="10">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('reward-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveReward()">Save</button>
    </div>
  </div>
</div>

<!-- Hourly Block Modal -->
<div class="modal-overlay" id="hourly-modal">
  <div class="modal">
    <h3 id="hourly-modal-title">Schedule Block</h3>
    <input type="hidden" id="hourly-block-date">
    <input type="hidden" id="hourly-block-hour">
    <input type="hidden" id="hourly-block-id">
    <div class="form-group">
      <label>What are you doing this hour?</label>
      <input type="text" class="form-control" id="hourly-block-title" placeholder="e.g., Deep work on Crew Voice, Gym, Sales calls">
    </div>
    <div class="form-group">
      <label>Category</label>
      <select class="form-control" id="hourly-block-category">
        <option value="business">Business</option>
        <option value="financial">Financial</option>
        <option value="golf">Golf</option>
        <option value="networking">Networking</option>
        <option value="learning">Learning</option>
        <option value="religion">Religion</option>
        <option value="gym">Gym</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="hourly-delete-btn" onclick="deleteHourlyBlock()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('hourly-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveHourlyBlock()">Save</button>
    </div>
  </div>
</div>

<!-- Habit Modal -->
<div class="modal-overlay" id="habit-modal">
  <div class="modal">
    <h3>Add Daily Habit</h3>
    <div class="form-group">
      <label>Habit Name</label>
      <input type="text" class="form-control" id="habit-name" placeholder="e.g., Wake up at 5:30 AM, Read 30 min, Cold shower">
    </div>
    <div class="form-group">
      <label>Category</label>
      <select class="form-control" id="habit-category">
        <option value="business">Business</option>
        <option value="financial">Financial</option>
        <option value="golf">Golf</option>
        <option value="networking">Networking</option>
        <option value="learning">Learning</option>
        <option value="religion">Religion</option>
        <option value="gym">Gym</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('habit-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveHabit()">Save</button>
    </div>
  </div>
</div>

<!-- Weekly Task Modal -->
<div class="modal-overlay" id="week-task-modal">
  <div class="modal">
    <h3>Add Task</h3>
    <input type="hidden" id="week-task-date">
    <div class="form-group">
      <label>Task</label>
      <input type="text" class="form-control" id="week-task-title" placeholder="What needs to be done?">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" id="week-task-category">
          <option value="business">Business</option>
          <option value="financial">Financial</option>
          <option value="golf">Golf</option>
          <option value="networking">Networking</option>
          <option value="learning">Learning</option>
          <option value="religion">Religion</option>
          <option value="gym">Gym</option>
        </select>
      </div>
      <div class="form-group">
        <label>Priority</label>
        <select class="form-control" id="week-task-priority">
          <option value="false">Normal</option>
          <option value="true">High (Top 3)</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('week-task-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveWeekTask()">Save</button>
    </div>
  </div>
</div>

<!-- Weight Modal -->
<div class="modal-overlay" id="weight-modal">
  <div class="modal">
    <h3>Log Weight</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Weight (lbs)</label>
        <input type="number" class="form-control" id="weight-val" step="0.1" placeholder="185.0">
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" class="form-control" id="weight-date">
      </div>
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <input type="text" class="form-control" id="weight-notes" placeholder="After workout, morning, etc.">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('weight-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveWeight()">Save</button>
    </div>
  </div>
</div>

<!-- Meal Modal -->
<div class="modal-overlay" id="meal-modal">
  <div class="modal">
    <h3>Log Meal</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Meal Type</label>
        <select class="form-control" id="meal-type">
          <option value="Breakfast">Breakfast</option>
          <option value="Lunch">Lunch</option>
          <option value="Dinner">Dinner</option>
          <option value="Snack">Snack</option>
        </select>
      </div>
      <div class="form-group">
        <label>Calories (approx)</label>
        <input type="number" class="form-control" id="meal-cal" placeholder="500">
      </div>
    </div>
    <div class="form-group">
      <label>What did you eat?</label>
      <input type="text" class="form-control" id="meal-desc" placeholder="Chicken, rice, broccoli">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Protein (g)</label>
        <input type="number" class="form-control" id="meal-protein" placeholder="40">
      </div>
      <div class="form-group">
        <label>Carbs (g)</label>
        <input type="number" class="form-control" id="meal-carbs" placeholder="60">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Fats (g)</label>
        <input type="number" class="form-control" id="meal-fats" placeholder="15">
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" class="form-control" id="meal-date">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('meal-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveMeal()">Save</button>
    </div>
  </div>
</div>

<!-- Supplement Modal -->
<div class="modal-overlay" id="supp-modal">
  <div class="modal">
    <h3>Add Supplement</h3>
    <div class="form-group">
      <label>Supplement Name</label>
      <input type="text" class="form-control" id="supp-name" placeholder="e.g., Creatine, Fish Oil, Vitamin D">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Dosage</label>
        <input type="text" class="form-control" id="supp-dose" placeholder="e.g., 5g, 1000mg, 2 pills">
      </div>
      <div class="form-group">
        <label>Time of Day</label>
        <select class="form-control" id="supp-time">
          <option value="Morning">Morning</option>
          <option value="Afternoon">Afternoon</option>
          <option value="Evening">Evening</option>
          <option value="With meals">With meals</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('supp-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSupplement()">Save</button>
    </div>
  </div>
</div>

<!-- Workout Modal -->
<div class="modal-overlay" id="workout-modal">
  <div class="modal">
    <h3>Log Workout</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Workout Type</label>
        <select class="form-control" id="workout-type">
          <option value="Weight Training">Weight Training</option>
          <option value="Cardio">Cardio</option>
          <option value="HIIT">HIIT</option>
          <option value="Yoga / Stretching">Yoga / Stretching</option>
          <option value="Sports">Sports</option>
          <option value="Golf">Golf</option>
          <option value="Walking">Walking</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Duration (min)</label>
        <input type="number" class="form-control" id="workout-duration" placeholder="45">
      </div>
    </div>
    <div class="form-group">
      <label>Details</label>
      <textarea class="form-control" id="workout-details" placeholder="Exercises, sets, reps, distance..."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Calories Burned (est)</label>
        <input type="number" class="form-control" id="workout-cal" placeholder="300">
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" class="form-control" id="workout-date">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('workout-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveWorkout()">Save</button>
    </div>
  </div>
</div>

<!-- Exercise Modal (Routine Builder) -->
<div class="modal-overlay" id="exercise-modal">
  <div class="modal">
    <h3 id="exercise-modal-title">Add Exercise</h3>
    <input type="hidden" id="ex-day">
    <input type="hidden" id="ex-id">
    <div class="form-group">
      <label>Exercise Name</label>
      <input type="text" class="form-control" id="ex-name" placeholder="e.g., Bench Press, Squats, Deadlifts">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Sets</label>
        <input type="number" class="form-control" id="ex-sets" placeholder="4" min="1">
      </div>
      <div class="form-group">
        <label>Reps</label>
        <input type="text" class="form-control" id="ex-reps" placeholder="8-12">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Weight (lbs)</label>
        <input type="text" class="form-control" id="ex-weight" placeholder="135">
      </div>
      <div class="form-group">
        <label>Rest (seconds)</label>
        <input type="number" class="form-control" id="ex-rest" placeholder="90">
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <input type="text" class="form-control" id="ex-notes" placeholder="Tempo, form cues, superset with...">
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-sm" id="ex-delete-btn" onclick="deleteExercise()" style="margin-right:auto;display:none">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('exercise-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExercise()">Save</button>
    </div>
  </div>
</div>

<!-- Log Set Modal -->
<div class="modal-overlay" id="logset-modal">
  <div class="modal">
    <h3 id="logset-title">Log Exercise</h3>
    <input type="hidden" id="ls-exid">
    <input type="hidden" id="ls-exname">
    <div class="form-row">
      <div class="form-group">
        <label>Weight (lbs)</label>
        <input type="text" class="form-control" id="ls-weight" placeholder="135">
      </div>
      <div class="form-group">
        <label>Sets Completed</label>
        <input type="number" class="form-control" id="ls-sets" placeholder="4" min="1">
      </div>
    </div>
    <div class="form-group">
      <label>Reps per Set (e.g., 10,10,8,8)</label>
      <input type="text" class="form-control" id="ls-reps" placeholder="10, 10, 8, 8">
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <input type="text" class="form-control" id="ls-notes" placeholder="Felt strong, increased weight, form notes...">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('logset-modal')">Cancel</button>
      <button class="btn btn-danger btn-sm" onclick="unlogExercise()" style="margin-right:auto">Unlog</button>
      <button class="btn btn-primary" onclick="saveLogSet()">Log It</button>
    </div>
  </div>
</div>

<!-- Routine Day Label Modal -->
<div class="modal-overlay" id="routine-label-modal">
  <div class="modal">
    <h3 id="routine-label-title">Set Day Label</h3>
    <input type="hidden" id="rl-day">
    <div class="form-group">
      <label>Day Focus (e.g., Chest & Triceps, Leg Day, Rest)</label>
      <input type="text" class="form-control" id="rl-label" placeholder="e.g., Push Day, Pull Day, Legs, Upper Body">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('routine-label-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveRoutineLabel()">Save</button>
    </div>
  </div>
</div>

<script>
// ===== DATA LAYER =====
const STORAGE_KEY = 'lifePlanner';
const CATEGORIES = ['business', 'financial', 'golf', 'networking', 'learning', 'religion', 'gym'];
const CAT_COLORS = {
  business: '#4CAF50',
  financial: '#D4930D',
  golf: '#00BCD4',
  networking: '#9C27B0',
  learning: '#2196F3',
  religion: '#FF7043',
  gym: '#E91E63'
};
const CAT_ICONS = {
  business: 'ðŸ’¼',
  financial: 'ðŸ’°',
  golf: 'â›³',
  networking: 'ðŸ¤',
  learning: 'ðŸ“š',
  religion: 'â›ª',
  gym: 'ðŸ’ª'
};
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

function defaultData() {
  return {
    goals: [],
    achievements: [],
    financialGoals: [],
    financialEntries: [],
    transactions: [],
    monthlyBudgets: {},
    startingBalance: 0,
    ritualSteps: [],
    ritualLog: {},
    books: [],
    contentPosts: [],
    decisions: [],
    networkContacts: [],
    golfRounds: [],
    gratitudeEntries: [],
    focusSessions: [],
    mirrorItems: [],
    energyLog: [],
    yearlyMilestones: [],
    weeklyTasks: [],
    dailyNotes: {},
    rewards: [],
    rewardPoints: 0,
    hourlyBlocks: [],
    habits: [],
    habitLog: {},
    scoreHistory: [],
    weightLog: [],
    waterLog: {},
    meals: [],
    supplements: [],
    suppLog: {},
    workouts: [],
    weightGoal: 0,
    macroGoals: { calories: 0, protein: 0, carbs: 0, fats: 0 },
    workoutRoutine: {},
    routineLabels: {},
    routineLog: {},
    exerciseHistory: []
  };
}

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return defaultData();
    const d = JSON.parse(raw);
    const def = defaultData();
    // Ensure all default keys exist without overwriting saved data
    Object.keys(def).forEach(function(k){
      if(d[k]===undefined||d[k]===null) d[k]=def[k];
      else if(Array.isArray(def[k])&&!Array.isArray(d[k])) d[k]=def[k];
    });
    return d;
  } catch { return defaultData(); }
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function exportData(){
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='planner-backup-'+new Date().toISOString().slice(0,10)+'.json';
  a.click();URL.revokeObjectURL(a.href);
}
function importData(e){
  var file=e.target.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(ev){
    try{
      var imported=JSON.parse(ev.target.result);
      if(!imported||typeof imported!=='object'){alert('Invalid backup file.');return}
      if(!confirm('This will REPLACE all current data with the backup. Are you sure?'))return;
      data=imported;saveData(data);location.reload();
    }catch(err){alert('Error reading backup file: '+err.message)}
  };
  reader.readAsText(file);
  e.target.value='';
}

let data = loadData();
let currentGoalTab = 'all';
let currentAchTab = 'all';
let currentWeekOffset = 0;
let hourlyDayOffset = 0;

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

function todayStr() {
  return new Date().toISOString().split('T')[0];
}

function formatDate(str) {
  if (!str) return '';
  const d = new Date(str + 'T00:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function catColor(cat) { return CAT_COLORS[cat] || '#888'; }

// ===== NAVIGATION =====
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    const view = item.dataset.view;
    switchView(view);
    document.querySelector('.sidebar').classList.remove('open');
  });
});

function switchView(view) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelector(`.nav-item[data-view="${view}"]`).classList.add('active');
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + view).classList.add('active');

  if (view === 'dashboard') renderDashboard();
  else if (view === 'goals') renderGoals();
  else if (view === 'achievements') renderAchievements();
  else if (view === 'financial') renderFinancial();
  else if (view === 'yearly') renderYearly();
  else if (view === 'weekly') renderWeekly();
  else if (view === 'daily') renderDaily();
  else if (view === 'rewards') renderRewards();
  else if (view === 'hourly') renderHourly();
  else if (view === 'habits') renderHabits();
  else if (view === 'scoreboard') renderScoreboard();
  else if (view === 'ritual') renderRitual();
  else if (view === 'books') renderBooks();
  else if (view === 'content') renderContent();
  else if (view === 'decisions') renderDecisions();
  else if (view === 'network') renderNetwork();
  else if (view === 'golf') renderGolf();
  else if (view === 'gratitude') renderGratitude();
  else if (view === 'focus') renderFocus();
  else if (view === 'mirror') renderMirror();
  else if (view === 'energy') renderEnergy();
  else if (view === 'health') renderHealth();
}

// ===== MODAL HELPERS =====
function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

function openModal(id) {
  document.getElementById(id).classList.add('active');
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(ov => {
  ov.addEventListener('click', e => {
    if (e.target === ov) ov.classList.remove('active');
  });
});

// ===== DASHBOARD =====
function renderDashboard() {
  const today = new Date();
  const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
  const dateStr = today.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  document.getElementById('dash-greeting').textContent = `Good ${getGreeting()}, Luke`;

  const totalGoals = data.goals.length;
  const completedGoals = data.goals.filter(g => g.completed).length;
  const todayTasks = data.weeklyTasks.filter(t => t.date === todayStr());
  const remainingTasks = todayTasks.filter(t => !t.completed).length;

  document.getElementById('dash-stats').innerHTML = `
    <div class="stat-card">
      <div class="stat-value" style="color:var(--cat-learning)">${totalGoals}</div>
      <div class="stat-label">Total Goals</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color:var(--cat-business)">${completedGoals}</div>
      <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color:var(--cat-financial)">${remainingTasks}</div>
      <div class="stat-label">Tasks Today</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color:var(--cat-networking)">${data.achievements.length}</div>
      <div class="stat-label">Achievements</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="switchView('rewards')">
      <div class="stat-value" style="color:var(--cat-financial)">${data.rewardPoints || 0}</div>
      <div class="stat-label">Reward Points</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="switchView('scoreboard')">
      <div class="stat-value" style="color:${getScoreColor(calcDayScore(todayStr()).total)}">${calcDayScore(todayStr()).total}</div>
      <div class="stat-label">Today's Score</div>
    </div>
  `;

  // Today's focus
  const priorities = todayTasks.filter(t => t.priority).slice(0, 3);
  const focusHTML = priorities.length ? priorities.map(t => `
    <div class="focus-item">
      <div class="focus-dot" style="background:${catColor(t.category)}"></div>
      <span style="${t.completed ? 'text-decoration:line-through;color:var(--text-secondary)' : ''}">${esc(t.title)}</span>
    </div>
  `).join('') : '<p style="color:var(--text-secondary);font-size:13px">No priorities set for today. Add tasks in the Weekly or Daily view.</p>';
  document.getElementById('dash-focus').innerHTML = focusHTML;

  // Recent achievements
  const recent = [...data.achievements].sort((a,b) => b.date.localeCompare(a.date)).slice(0, 5);
  document.getElementById('dash-achievements').innerHTML = recent.length ? recent.map(a => `
    <div class="focus-item">
      <div class="focus-dot" style="background:${catColor(a.category)}"></div>
      <span>${esc(a.title)}</span>
      <span style="margin-left:auto;font-size:11px;color:var(--text-secondary)">${formatDate(a.date)}</span>
    </div>
  `).join('') : '<p style="color:var(--text-secondary);font-size:13px">No achievements yet. Keep pushing!</p>';

  // Category progress
  document.getElementById('dash-cat-progress').innerHTML = CATEGORIES.map(cat => {
    const catGoals = data.goals.filter(g => g.category === cat);
    const total = catGoals.length;
    const avgProgress = total ? Math.round(catGoals.reduce((s,g) => s + (g.progress || 0), 0) / total) : 0;
    const circumference = 2 * Math.PI * 28;
    const offset = circumference - (avgProgress / 100) * circumference;
    return `
      <div class="cat-progress-card">
        <div class="cat-progress-label" style="color:${catColor(cat)}">${cap(cat)}</div>
        <div class="cat-progress-ring">
          <svg width="70" height="70" viewBox="0 0 70 70">
            <circle cx="35" cy="35" r="28" fill="none" stroke="var(--border)" stroke-width="5"/>
            <circle cx="35" cy="35" r="28" fill="none" stroke="${catColor(cat)}" stroke-width="5"
              stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round"/>
          </svg>
          <div class="ring-text">${avgProgress}%</div>
        </div>
        <div class="cat-progress-count">${total} goal${total !== 1 ? 's' : ''}</div>
      </div>
    `;
  }).join('');
}

function getGreeting() {
  const h = new Date().getHours();
  if (h < 12) return 'morning';
  if (h < 17) return 'afternoon';
  return 'evening';
}

function cap(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ===== GOALS =====
function renderGoals() {
  const tabsEl = document.getElementById('goal-tabs');
  tabsEl.innerHTML = `
    <button class="tab ${currentGoalTab === 'all' ? 'active' : ''}" onclick="currentGoalTab='all';renderGoals()">All</button>
    ${CATEGORIES.map(c => `<button class="tab ${currentGoalTab === c ? 'active' : ''}" onclick="currentGoalTab='${c}';renderGoals()">${cap(c)}</button>`).join('')}
  `;

  let goals = currentGoalTab === 'all' ? data.goals : data.goals.filter(g => g.category === currentGoalTab);
  goals = [...goals].sort((a,b) => (a.completed ? 1 : 0) - (b.completed ? 1 : 0));

  if (!goals.length) {
    document.getElementById('goals-list').innerHTML = `<div class="empty-state"><p>No goals yet. Click "+ Add Goal" to get started.</p></div>`;
    return;
  }

  document.getElementById('goals-list').innerHTML = goals.map(g => `
    <div class="goal-card ${g.completed ? 'completed' : ''}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="goal-title">${esc(g.title)}</div>
          <div class="goal-target">${esc(g.target || '')}</div>
        </div>
        <span class="tag tag-${g.category}">${cap(g.category)}</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width:${g.progress || 0}%;background:${catColor(g.category)}"></div>
      </div>
      <div class="goal-meta">
        <span>${g.progress || 0}% complete</span>
        ${g.deadline ? `<span>Due: ${formatDate(g.deadline)}</span>` : ''}
        ${g.notes ? `<span title="${esc(g.notes)}">ðŸ“ Notes</span>` : ''}
      </div>
      <div class="goal-actions">
        ${!g.completed ? `<button class="btn btn-success btn-sm" onclick="completeGoal('${g.id}')">âœ“ Complete</button>` : ''}
        <button class="btn btn-ghost btn-sm" onclick="editGoal('${g.id}')">Edit</button>
        <button class="btn btn-ghost btn-sm" onclick="deleteGoal('${g.id}')" style="color:var(--danger)">Delete</button>
      </div>
    </div>
  `).join('');
}

function openGoalModal(goalId) {
  document.getElementById('goal-modal-title').textContent = goalId ? 'Edit Goal' : 'Add Goal';
  document.getElementById('goal-id').value = goalId || '';
  if (goalId) {
    const g = data.goals.find(x => x.id === goalId);
    if (!g) return;
    document.getElementById('goal-title').value = g.title;
    document.getElementById('goal-category').value = g.category;
    document.getElementById('goal-deadline').value = g.deadline || '';
    document.getElementById('goal-target').value = g.target || '';
    document.getElementById('goal-progress').value = g.progress || 0;
    document.getElementById('goal-notes').value = g.notes || '';
  } else {
    document.getElementById('goal-title').value = '';
    document.getElementById('goal-category').value = 'business';
    document.getElementById('goal-deadline').value = '';
    document.getElementById('goal-target').value = '';
    document.getElementById('goal-progress').value = 0;
    document.getElementById('goal-notes').value = '';
  }
  openModal('goal-modal');
}

function saveGoal() {
  const title = document.getElementById('goal-title').value.trim();
  if (!title) return;
  const id = document.getElementById('goal-id').value;
  const goalData = {
    title,
    category: document.getElementById('goal-category').value,
    deadline: document.getElementById('goal-deadline').value,
    target: document.getElementById('goal-target').value.trim(),
    progress: parseInt(document.getElementById('goal-progress').value) || 0,
    notes: document.getElementById('goal-notes').value.trim()
  };

  if (id) {
    const idx = data.goals.findIndex(g => g.id === id);
    if (idx >= 0) data.goals[idx] = { ...data.goals[idx], ...goalData };
  } else {
    data.goals.push({ id: uid(), ...goalData, completed: false, createdAt: todayStr() });
  }

  saveData(data);
  closeModal('goal-modal');
  renderGoals();
}

function editGoal(id) { openGoalModal(id); }

function deleteGoal(id) {
  if (!confirm('Delete this goal?')) return;
  data.goals = data.goals.filter(g => g.id !== id);
  saveData(data);
  renderGoals();
}

function completeGoal(id) {
  const goal = data.goals.find(g => g.id === id);
  if (!goal) return;
  goal.completed = true;
  goal.progress = 100;
  data.achievements.push({
    id: uid(),
    title: goal.title,
    category: goal.category,
    description: 'Goal completed: ' + (goal.target || goal.title),
    date: todayStr()
  });
  // Award points
  data.rewardPoints = (data.rewardPoints || 0) + 10;
  saveData(data);
  renderGoals();
  showPointsToast('+10 points earned!');
}

function showPointsToast(msg) {
  const toast = document.createElement('div');
  toast.textContent = msg;
  toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:var(--cat-financial);color:#fff;padding:12px 24px;border-radius:10px;font-weight:600;font-size:14px;z-index:1000;animation:fadeInUp 0.3s ease;';
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; }, 2000);
  setTimeout(() => toast.remove(), 2300);
}

// ===== ACHIEVEMENTS =====
function renderAchievements() {
  const tabsEl = document.getElementById('achievement-tabs');
  tabsEl.innerHTML = `
    <button class="tab ${currentAchTab === 'all' ? 'active' : ''}" onclick="currentAchTab='all';renderAchievements()">All</button>
    ${CATEGORIES.map(c => `<button class="tab ${currentAchTab === c ? 'active' : ''}" onclick="currentAchTab='${c}';renderAchievements()">${cap(c)}</button>`).join('')}
  `;

  let achs = currentAchTab === 'all' ? data.achievements : data.achievements.filter(a => a.category === currentAchTab);
  achs = [...achs].sort((a,b) => b.date.localeCompare(a.date));

  // Counts
  const counts = CATEGORIES.map(c => {
    const n = data.achievements.filter(a => a.category === c).length;
    return `<span class="tag tag-${c}" style="margin-right:6px">${cap(c)}: ${n}</span>`;
  }).join('');

  if (!achs.length) {
    document.getElementById('achievements-list').innerHTML = `<div style="margin-bottom:16px">${counts}</div><div class="empty-state"><p>No achievements yet.</p></div>`;
    return;
  }

  document.getElementById('achievements-list').innerHTML = `
    <div style="margin-bottom:16px">${counts}</div>
    ${achs.map(a => `
      <div class="achievement-item">
        <div class="achievement-icon" style="background:${catColor(a.category)}20;color:${catColor(a.category)}">${CAT_ICONS[a.category] || 'â­'}</div>
        <div class="achievement-content">
          <div class="achievement-title">${esc(a.title)}</div>
          <div class="achievement-desc">${esc(a.description || '')}</div>
          <div class="achievement-date">${formatDate(a.date)} &middot; ${cap(a.category)}</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="deleteAchievement('${a.id}')" style="color:var(--danger);flex-shrink:0">&times;</button>
      </div>
    `).join('')}
  `;
}

function openAchievementModal() {
  document.getElementById('ach-title').value = '';
  document.getElementById('ach-category').value = 'business';
  document.getElementById('ach-date').value = todayStr();
  document.getElementById('ach-desc').value = '';
  openModal('achievement-modal');
}

function saveAchievement() {
  const title = document.getElementById('ach-title').value.trim();
  if (!title) return;
  data.achievements.push({
    id: uid(),
    title,
    category: document.getElementById('ach-category').value,
    date: document.getElementById('ach-date').value || todayStr(),
    description: document.getElementById('ach-desc').value.trim()
  });
  saveData(data);
  closeModal('achievement-modal');
  renderAchievements();
}

function deleteAchievement(id) {
  data.achievements = data.achievements.filter(a => a.id !== id);
  saveData(data);
  renderAchievements();
}

// ===== FINANCIAL =====
const INCOME_CATS = ['Crew Voice Revenue','Salary/Job','Side Income','Freelance','Investments','Gifts','Other Income'];
const EXPENSE_CATS = ['Business','Software/Tools','Marketing/Ads','Food/Dining','Transportation/Gas','Housing/Rent','Utilities','Subscriptions','Entertainment','Health/Gym','Education','Golf','Giving/Tithing','Clothing','Insurance','Phone/Internet','Other'];
let currentFinTab = 'overview';
let budgetMonth = new Date().toISOString().slice(0,7);

function fmtMoney(n) {
  const abs = Math.abs(n);
  const str = abs.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  return (n<0?'-':'')+'$'+str;
}

function getTxns() { return data.transactions || []; }

function getTxnsByMonth(ym) {
  return getTxns().filter(t => t.date && t.date.startsWith(ym));
}

function getMonthIncome(ym) {
  return getTxnsByMonth(ym).filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
}

function getMonthExpenses(ym) {
  return getTxnsByMonth(ym).filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
}

function getTotalBalance() {
  const totalIncome = getTxns().filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const totalExpense = getTxns().filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  return (data.startingBalance||0) + totalIncome - totalExpense;
}

function switchFinTab(tab) {
  currentFinTab = tab;
  document.querySelectorAll('.fin-subtab').forEach((el,i)=>{
    el.classList.toggle('active',['overview','transactions','budget','savings'][i]===tab);
  });
  document.querySelectorAll('.fin-subview').forEach(el=>el.classList.remove('active'));
  const viewMap = {overview:'fin-overview',transactions:'fin-transactions',budget:'fin-budget',savings:'fin-savings'};
  document.getElementById(viewMap[tab]).classList.add('active');

  const btns = document.getElementById('fin-action-btns');
  if (tab==='overview'||tab==='transactions') {
    btns.innerHTML='<button class="btn btn-primary" onclick="openTxnModal()">+ Transaction</button>';
  } else if (tab==='budget') {
    btns.innerHTML='<button class="btn btn-primary" onclick="openBudgetModal()">+ Set Budget</button>';
  } else if (tab==='savings') {
    btns.innerHTML='<button class="btn btn-primary" onclick="openFinGoalModal()">+ Savings Goal</button><button class="btn btn-ghost" onclick="openFinEntryModal()">+ Deposit</button>';
  }

  if (tab==='overview') renderFinOverview();
  else if (tab==='transactions') renderTransactions();
  else if (tab==='budget') renderBudget();
  else if (tab==='savings') renderSavings();
}

function renderFinancial() {
  switchFinTab(currentFinTab);
}

// --- OVERVIEW ---
function renderFinOverview() {
  const ym = todayStr().slice(0,7);
  const income = getMonthIncome(ym);
  const expenses = getMonthExpenses(ym);
  const net = income - expenses;
  const balance = getTotalBalance();
  const savingsRate = income > 0 ? Math.round(((income - expenses) / income) * 100) : 0;

  // Last month comparison
  const lastD = new Date(); lastD.setMonth(lastD.getMonth()-1);
  const lym = lastD.toISOString().slice(0,7);
  const lastIncome = getMonthIncome(lym);
  const lastExpenses = getMonthExpenses(lym);

  function trend(curr,prev){ if(!prev)return ''; const d=curr-prev; const p=prev?Math.round((d/prev)*100):0; return d>=0?'<span style="color:var(--cat-business);font-size:11px">+'+p+'%</span>':'<span style="color:var(--danger);font-size:11px">'+p+'%</span>'; }

  document.getElementById('fin-kpis').innerHTML = `
    <div class="fin-kpi">
      <div class="fin-kpi-val" style="color:var(--cat-financial)">${fmtMoney(balance)}</div>
      <div class="fin-kpi-label">Balance</div>
    </div>
    <div class="fin-kpi">
      <div class="fin-kpi-val" style="color:var(--cat-business)">${fmtMoney(income)}</div>
      <div class="fin-kpi-label">Income</div>
      <div class="fin-kpi-sub">${trend(income,lastIncome)} vs last mo</div>
    </div>
    <div class="fin-kpi">
      <div class="fin-kpi-val" style="color:var(--danger)">${fmtMoney(expenses)}</div>
      <div class="fin-kpi-label">Expenses</div>
      <div class="fin-kpi-sub">${trend(expenses,lastExpenses)} vs last mo</div>
    </div>
    <div class="fin-kpi">
      <div class="fin-kpi-val" style="color:${net>=0?'var(--cat-business)':'var(--danger)'}">${fmtMoney(net)}</div>
      <div class="fin-kpi-label">Net This Month</div>
    </div>
    <div class="fin-kpi">
      <div class="fin-kpi-val" style="color:${savingsRate>=20?'var(--cat-business)':savingsRate>=0?'var(--cat-financial)':'var(--danger)'}">${savingsRate}%</div>
      <div class="fin-kpi-label">Savings Rate</div>
      <div class="fin-kpi-sub">${savingsRate>=20?'On track':'Aim for 20%+'}</div>
    </div>
  `;

  // Cash flow: income by category + expense by category
  const incByCat = {};
  const expByCat = {};
  getTxnsByMonth(ym).forEach(t => {
    if (t.type==='income') incByCat[t.category] = (incByCat[t.category]||0) + t.amount;
    else expByCat[t.category] = (expByCat[t.category]||0) + t.amount;
  });
  const incEntries = Object.entries(incByCat).sort((a,b)=>b[1]-a[1]);
  const expEntries = Object.entries(expByCat).sort((a,b)=>b[1]-a[1]);
  const maxInc = incEntries.length ? incEntries[0][1] : 1;
  const maxExp = expEntries.length ? expEntries[0][1] : 1;

  document.getElementById('fin-cashflow').innerHTML = `
    <div class="fin-cashflow-card">
      <h3 style="color:var(--cat-business)">Income Breakdown</h3>
      ${incEntries.length ? incEntries.map(([cat,amt])=>{
        const w = Math.max(5,Math.round((amt/maxInc)*100));
        return '<div class="fin-bar-row"><div class="fin-bar-label">'+esc(cat.replace('Crew Voice Revenue','CV Rev'))+'</div><div class="fin-bar-track"><div class="fin-bar-fill" style="width:'+w+'%;background:var(--cat-business)"></div></div><div class="fin-bar-val" style="color:var(--cat-business)">'+fmtMoney(amt)+'</div></div>';
      }).join('') : '<p style="font-size:12px;color:var(--text-secondary)">No income this month</p>'}
    </div>
    <div class="fin-cashflow-card">
      <h3 style="color:var(--danger)">Expense Breakdown</h3>
      ${expEntries.length ? expEntries.map(([cat,amt])=>{
        const w = Math.max(5,Math.round((amt/maxExp)*100));
        return '<div class="fin-bar-row"><div class="fin-bar-label">'+esc(cat)+'</div><div class="fin-bar-track"><div class="fin-bar-fill" style="width:'+w+'%;background:var(--danger)"></div></div><div class="fin-bar-val" style="color:var(--danger)">'+fmtMoney(amt)+'</div></div>';
      }).join('') : '<p style="font-size:12px;color:var(--text-secondary)">No expenses this month</p>'}
    </div>
  `;

  // Recent transactions
  const recent = [...getTxns()].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,8);
  document.getElementById('fin-recent-txns').innerHTML = recent.length ? recent.map(t => txnRowHTML(t)).join('') : '<div class="empty-state"><p>No transactions yet. Click "+ Transaction" to start tracking your money.</p></div>';
}

function txnRowHTML(t) {
  const icon = t.type==='income' ? '&#8593;' : '&#8595;';
  return '<div class="txn-row" style="cursor:pointer" onclick="editTxn(\''+t.id+'\')"><div class="txn-icon '+t.type+'">'+icon+'</div><div class="txn-details"><div class="txn-desc">'+esc(t.description||t.category)+'</div><div class="txn-meta">'+esc(t.category)+' &middot; '+formatDate(t.date)+(t.recurring?' &middot; '+cap(t.recurring):'')+'</div></div><div class="txn-amount '+t.type+'">'+(t.type==='income'?'+':'-')+fmtMoney(t.amount)+'</div></div>';
}

// --- TRANSACTIONS ---
function renderTransactions() {
  const filterType = document.getElementById('txn-filter-type').value;
  const filterCat = document.getElementById('txn-filter-cat').value;
  const filterMonth = document.getElementById('txn-filter-month').value;

  // Populate category filter
  const allCats = [...new Set(getTxns().map(t=>t.category))].sort();
  const catSelect = document.getElementById('txn-filter-cat');
  const curCatVal = catSelect.value;
  catSelect.innerHTML = '<option value="all">All Categories</option>' + allCats.map(c=>'<option value="'+esc(c)+'"'+(c===curCatVal?' selected':'')+'>'+esc(c)+'</option>').join('');

  let list = [...getTxns()];
  if (filterType!=='all') list = list.filter(t=>t.type===filterType);
  if (filterCat!=='all') list = list.filter(t=>t.category===filterCat);
  if (filterMonth) list = list.filter(t=>t.date&&t.date.startsWith(filterMonth));
  list.sort((a,b)=>b.date.localeCompare(a.date));

  const totalInc = list.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const totalExp = list.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  document.getElementById('txn-summary').innerHTML = `
    <div class="fin-kpi-grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="fin-kpi"><div class="fin-kpi-val" style="color:var(--cat-business);font-size:18px">${fmtMoney(totalInc)}</div><div class="fin-kpi-label">Income</div></div>
      <div class="fin-kpi"><div class="fin-kpi-val" style="color:var(--danger);font-size:18px">${fmtMoney(totalExp)}</div><div class="fin-kpi-label">Expenses</div></div>
      <div class="fin-kpi"><div class="fin-kpi-val" style="color:${totalInc-totalExp>=0?'var(--cat-business)':'var(--danger)'};font-size:18px">${fmtMoney(totalInc-totalExp)}</div><div class="fin-kpi-label">Net</div></div>
    </div>
  `;

  document.getElementById('txn-list').innerHTML = list.length ? list.map(t=>txnRowHTML(t)).join('') : '<div class="empty-state"><p>No transactions match your filters.</p></div>';
}

// --- BUDGET ---
function changeBudgetMonth(delta) {
  const d = new Date(budgetMonth+'-01');
  d.setMonth(d.getMonth()+delta);
  budgetMonth = d.toISOString().slice(0,7);
  renderBudget();
}

function renderBudget() {
  const d = new Date(budgetMonth+'-01');
  document.getElementById('budget-month-label').textContent = d.toLocaleDateString('en-US',{month:'long',year:'numeric'});

  const budgets = data.monthlyBudgets || {};
  const monthTxns = getTxnsByMonth(budgetMonth).filter(t=>t.type==='expense');
  const spentByCat = {};
  monthTxns.forEach(t=>{spentByCat[t.category]=(spentByCat[t.category]||0)+t.amount});

  // Merge budget categories with spent categories
  const allCats = [...new Set([...Object.keys(budgets),...Object.keys(spentByCat)])].sort();
  const totalBudgeted = Object.values(budgets).reduce((s,v)=>s+v,0);
  const totalSpent = monthTxns.reduce((s,t)=>s+t.amount,0);
  const totalPct = totalBudgeted>0 ? Math.round((totalSpent/totalBudgeted)*100) : 0;

  document.getElementById('budget-summary').innerHTML = `
    <div class="fin-kpi-grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="fin-kpi"><div class="fin-kpi-val" style="color:var(--cat-financial);font-size:18px">${fmtMoney(totalBudgeted)}</div><div class="fin-kpi-label">Budgeted</div></div>
      <div class="fin-kpi"><div class="fin-kpi-val" style="color:${totalSpent>totalBudgeted?'var(--danger)':'var(--text)'};font-size:18px">${fmtMoney(totalSpent)}</div><div class="fin-kpi-label">Spent</div></div>
      <div class="fin-kpi"><div class="fin-kpi-val" style="color:${totalBudgeted-totalSpent>=0?'var(--cat-business)':'var(--danger)'};font-size:18px">${fmtMoney(totalBudgeted-totalSpent)}</div><div class="fin-kpi-label">Remaining</div></div>
    </div>
  `;

  if (!allCats.length) {
    document.getElementById('budget-list').innerHTML = '<div class="empty-state"><p>No budgets set. Click "+ Set Budget" to create spending limits by category.</p></div>';
    return;
  }

  document.getElementById('budget-list').innerHTML = allCats.map(cat => {
    const limit = budgets[cat] || 0;
    const spent = spentByCat[cat] || 0;
    const pct = limit > 0 ? Math.min(100,Math.round((spent/limit)*100)) : (spent>0?100:0);
    const color = pct >= 100 ? 'var(--danger)' : pct >= 75 ? 'var(--cat-financial)' : 'var(--cat-business)';
    return '<div class="budget-row"><div class="budget-row-head"><div class="budget-cat">'+esc(cat)+'</div><div class="budget-nums"><strong>'+fmtMoney(spent)+'</strong>'+(limit?' / '+fmtMoney(limit):'')+'</div></div>'+(limit?'<div class="budget-bar"><div class="budget-bar-fill" style="width:'+pct+'%;background:'+color+'"></div></div><div class="budget-pct" style="color:'+color+'">'+pct+'% used'+(pct>=100?' â€” Over budget!':'')+'</div>':'<div style="font-size:11px;color:var(--text-secondary)">No budget set</div>')+'</div>';
  }).join('');
}

// --- SAVINGS GOALS ---
function renderSavings() {
  if (!data.financialGoals.length) {
    document.getElementById('savings-list').innerHTML = '<div class="empty-state"><p>No savings goals yet. Click "+ Savings Goal" to start saving toward something.</p></div>';
    return;
  }

  document.getElementById('savings-list').innerHTML = data.financialGoals.map(fg => {
    const entries = data.financialEntries.filter(e => e.goalId === fg.id);
    const current = entries.reduce((sum, e) => {
      if (e.type === 'saving' || e.type === 'income') return sum + e.amount;
      if (e.type === 'expense') return sum - e.amount;
      return sum;
    }, fg.currentAmount || 0);
    const pct = fg.targetAmount > 0 ? Math.min(100, Math.round((current / fg.targetAmount) * 100)) : 0;
    const remaining = Math.max(0, fg.targetAmount - current);
    let monthsLeft = '';
    if (fg.deadline) {
      const dl = new Date(fg.deadline+'T00:00:00');
      const now = new Date();
      const ml = (dl.getFullYear()-now.getFullYear())*12 + dl.getMonth()-now.getMonth();
      if (ml > 0 && remaining > 0) monthsLeft = fmtMoney(Math.ceil(remaining/ml))+'/mo needed';
    }

    return '<div class="fin-goal-card"><div class="fin-goal-header"><div><div class="goal-title">'+esc(fg.title)+'</div>'+(fg.deadline?'<div style="font-size:12px;color:var(--text-secondary)">Deadline: '+formatDate(fg.deadline)+(monthsLeft?' &middot; '+monthsLeft:'')+'</div>':'')+'</div><div style="display:flex;gap:6px"><button class="btn btn-ghost btn-sm" onclick="editFinGoal(\''+fg.id+'\')">Edit</button><button class="btn btn-ghost btn-sm" onclick="deleteFinGoal(\''+fg.id+'\')" style="color:var(--danger)">Delete</button></div></div><div class="fin-amounts"><span class="fin-amount-current">'+fmtMoney(current)+'</span><span> / '+fmtMoney(fg.targetAmount)+'</span><span style="margin-left:8px;font-size:12px;color:var(--text-secondary)">'+fmtMoney(remaining)+' to go</span></div><div class="progress-bar" style="height:10px"><div class="progress-fill" style="width:'+pct+'%;background:var(--cat-financial)"></div></div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">'+pct+'% of goal</div>'+(entries.length?'<div class="fin-entries">'+[...entries].reverse().slice(0,10).map(e=>'<div class="fin-entry"><div><div>'+esc(e.description||cap(e.type))+'</div><div style="font-size:11px;color:var(--text-secondary)">'+formatDate(e.date)+'</div></div><div style="display:flex;align-items:center;gap:8px"><span class="fin-entry-amount '+e.type+'">'+(e.type==='expense'?'-':'+')+fmtMoney(e.amount)+'</span><button onclick="deleteFinEntry(\''+e.id+'\')" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:14px">&times;</button></div></div>').join('')+'</div>':'')+'</div>';
  }).join('');
}

// --- TRANSACTION MODAL ---
function updateTxnCategories() {
  const type = document.getElementById('txn-type').value;
  const cats = type === 'income' ? INCOME_CATS : EXPENSE_CATS;
  document.getElementById('txn-category').innerHTML = cats.map(c=>'<option value="'+c+'">'+c+'</option>').join('');
}

function openTxnModal(txnId) {
  document.getElementById('txn-modal-title').textContent = txnId ? 'Edit Transaction' : 'Add Transaction';
  document.getElementById('txn-id').value = txnId || '';
  if (txnId) {
    const t = getTxns().find(x=>x.id===txnId);
    if (!t) return;
    document.getElementById('txn-type').value = t.type;
    updateTxnCategories();
    document.getElementById('txn-category').value = t.category;
    document.getElementById('txn-amount').value = t.amount;
    document.getElementById('txn-description').value = t.description || '';
    document.getElementById('txn-date').value = t.date;
    document.getElementById('txn-recurring').value = t.recurring || '';
    document.getElementById('txn-delete-btn').style.display = 'inline-flex';
  } else {
    document.getElementById('txn-type').value = 'expense';
    updateTxnCategories();
    document.getElementById('txn-amount').value = '';
    document.getElementById('txn-description').value = '';
    document.getElementById('txn-date').value = todayStr();
    document.getElementById('txn-recurring').value = '';
    document.getElementById('txn-delete-btn').style.display = 'none';
  }
  openModal('txn-modal');
}

function editTxn(id) { openTxnModal(id); }

function saveTxn() {
  const amount = parseFloat(document.getElementById('txn-amount').value);
  if (isNaN(amount) || amount <= 0) return;
  const id = document.getElementById('txn-id').value;
  const obj = {
    type: document.getElementById('txn-type').value,
    category: document.getElementById('txn-category').value,
    amount,
    description: document.getElementById('txn-description').value.trim(),
    date: document.getElementById('txn-date').value || todayStr(),
    recurring: document.getElementById('txn-recurring').value
  };
  if (!data.transactions) data.transactions = [];
  if (id) {
    const idx = data.transactions.findIndex(t=>t.id===id);
    if (idx>=0) data.transactions[idx] = {...data.transactions[idx],...obj};
  } else {
    data.transactions.push({id:uid(),...obj});
  }
  saveData(data);
  closeModal('txn-modal');
  renderFinancial();
}

function deleteTxn() {
  const id = document.getElementById('txn-id').value;
  if (!id || !confirm('Delete this transaction?')) return;
  data.transactions = (data.transactions||[]).filter(t=>t.id!==id);
  saveData(data);
  closeModal('txn-modal');
  renderFinancial();
}

// --- BUDGET MODAL ---
function openBudgetModal() {
  const budgets = data.monthlyBudgets || {};
  const cats = EXPENSE_CATS.filter(c=>!budgets[c]);
  if (!cats.length) { alert('All categories have budgets set. Edit amounts by deleting and re-adding.'); return; }
  document.getElementById('budget-category').innerHTML = cats.map(c=>'<option value="'+c+'">'+c+'</option>').join('');
  document.getElementById('budget-limit').value = '';
  openModal('budget-modal');
}

function saveBudget() {
  const cat = document.getElementById('budget-category').value;
  const limit = parseFloat(document.getElementById('budget-limit').value);
  if (!cat || isNaN(limit) || limit <= 0) return;
  if (!data.monthlyBudgets) data.monthlyBudgets = {};
  data.monthlyBudgets[cat] = limit;
  saveData(data);
  closeModal('budget-modal');
  renderBudget();
}

// --- SAVINGS GOAL MODALS (kept & improved) ---
function openFinGoalModal(goalId) {
  document.getElementById('fin-goal-modal-title').textContent = goalId ? 'Edit Savings Goal' : 'Add Savings Goal';
  document.getElementById('fin-goal-id').value = goalId || '';
  if (goalId) {
    const fg = data.financialGoals.find(x => x.id === goalId);
    if (!fg) return;
    document.getElementById('fin-goal-title').value = fg.title;
    document.getElementById('fin-goal-target').value = fg.targetAmount;
    document.getElementById('fin-goal-current').value = fg.currentAmount || 0;
    document.getElementById('fin-goal-deadline').value = fg.deadline || '';
  } else {
    document.getElementById('fin-goal-title').value = '';
    document.getElementById('fin-goal-target').value = '';
    document.getElementById('fin-goal-current').value = '';
    document.getElementById('fin-goal-deadline').value = '';
  }
  openModal('fin-goal-modal');
}

function saveFinGoal() {
  const title = document.getElementById('fin-goal-title').value.trim();
  const target = parseFloat(document.getElementById('fin-goal-target').value);
  if (!title || isNaN(target)) return;
  const id = document.getElementById('fin-goal-id').value;
  const currentAmt = parseFloat(document.getElementById('fin-goal-current').value) || 0;
  if (id) {
    const idx = data.financialGoals.findIndex(g => g.id === id);
    if (idx >= 0) {
      data.financialGoals[idx].title = title;
      data.financialGoals[idx].targetAmount = target;
      data.financialGoals[idx].currentAmount = currentAmt;
      data.financialGoals[idx].deadline = document.getElementById('fin-goal-deadline').value;
    }
  } else {
    data.financialGoals.push({
      id: uid(), title, targetAmount: target, currentAmount: currentAmt,
      deadline: document.getElementById('fin-goal-deadline').value
    });
  }
  saveData(data);
  closeModal('fin-goal-modal');
  renderFinancial();
}

function editFinGoal(id) { openFinGoalModal(id); }

function deleteFinGoal(id) {
  if (!confirm('Delete this savings goal and its entries?')) return;
  data.financialGoals = data.financialGoals.filter(g => g.id !== id);
  data.financialEntries = data.financialEntries.filter(e => e.goalId !== id);
  saveData(data);
  renderFinancial();
}

function openFinEntryModal() {
  if (!data.financialGoals.length) { alert('Create a savings goal first.'); return; }
  document.getElementById('fin-entry-goal').innerHTML = data.financialGoals.map(g =>
    '<option value="'+g.id+'">'+esc(g.title)+'</option>'
  ).join('');
  document.getElementById('fin-entry-type').value = 'saving';
  document.getElementById('fin-entry-amount').value = '';
  document.getElementById('fin-entry-desc').value = '';
  document.getElementById('fin-entry-date').value = todayStr();
  openModal('fin-entry-modal');
}

function saveFinEntry() {
  const amount = parseFloat(document.getElementById('fin-entry-amount').value);
  if (isNaN(amount) || amount <= 0) return;
  data.financialEntries.push({
    id: uid(),
    goalId: document.getElementById('fin-entry-goal').value,
    type: document.getElementById('fin-entry-type').value,
    amount,
    description: document.getElementById('fin-entry-desc').value.trim(),
    date: document.getElementById('fin-entry-date').value || todayStr()
  });
  saveData(data);
  closeModal('fin-entry-modal');
  renderFinancial();
}

function deleteFinEntry(id) {
  data.financialEntries = data.financialEntries.filter(e => e.id !== id);
  saveData(data);
  renderFinancial();
}

// ===== YEARLY PLAN =====
function renderYearly() {
  const year = new Date().getFullYear();
  document.getElementById('yearly-year').textContent = year;

  document.getElementById('yearly-grid').innerHTML = MONTHS.map((m, i) => {
    const milestones = data.yearlyMilestones.filter(ms => ms.month === i);
    return `
      <div class="month-card">
        <h3>${m}</h3>
        ${milestones.map(ms => `
          <div class="milestone-item">
            <div class="milestone-dot" style="background:${catColor(ms.category)}"></div>
            <span>${esc(ms.title)}</span>
            <button class="milestone-remove" onclick="deleteMilestone('${ms.id}')">&times;</button>
          </div>
        `).join('')}
        <button class="add-milestone-btn" onclick="openMilestoneModal(${i})">+ Add</button>
      </div>
    `;
  }).join('');
}

function openMilestoneModal(month) {
  document.getElementById('milestone-month').value = month;
  document.getElementById('milestone-title').value = '';
  document.getElementById('milestone-category').value = 'business';
  openModal('milestone-modal');
}

function saveMilestone() {
  const title = document.getElementById('milestone-title').value.trim();
  if (!title) return;
  data.yearlyMilestones.push({
    id: uid(),
    month: parseInt(document.getElementById('milestone-month').value),
    title,
    category: document.getElementById('milestone-category').value
  });
  saveData(data);
  closeModal('milestone-modal');
  renderYearly();
}

function deleteMilestone(id) {
  data.yearlyMilestones = data.yearlyMilestones.filter(m => m.id !== id);
  saveData(data);
  renderYearly();
}

// ===== WEEKLY VIEW =====
function getWeekDates(offset) {
  const today = new Date();
  const dayOfWeek = today.getDay();
  const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
  const monday = new Date(today);
  monday.setDate(today.getDate() + mondayOffset + (offset * 7));

  const dates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    dates.push(d);
  }
  return dates;
}

function renderWeekly() {
  const dates = getWeekDates(currentWeekOffset);
  const start = dates[0];
  const end = dates[6];
  document.getElementById('week-label').textContent =
    `${start.toLocaleDateString('en-US', {month:'short',day:'numeric'})} â€” ${end.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'})}`;

  const todayString = todayStr();

  document.getElementById('week-grid').innerHTML = dates.map((d, i) => {
    const dateStr = d.toISOString().split('T')[0];
    const isToday = dateStr === todayString;
    const tasks = data.weeklyTasks.filter(t => t.date === dateStr);
    const sortedTasks = [...tasks].sort((a,b) => (b.priority ? 1 : 0) - (a.priority ? 1 : 0));

    return `
      <div class="day-column ${isToday ? 'today' : ''}">
        <div class="day-header">${DAYS[i]}</div>
        <div class="day-date">${d.getDate()}</div>
        ${sortedTasks.map(t => `
          <div class="day-task ${t.completed ? 'completed' : ''}">
            <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleWeekTask('${t.id}')">
            <span style="border-left:2px solid ${catColor(t.category)};padding-left:6px;flex:1">${esc(t.title)}</span>
            <button class="task-remove" onclick="deleteWeekTask('${t.id}')">&times;</button>
          </div>
        `).join('')}
        <button class="add-task-day" onclick="openWeekTaskModal('${dateStr}')">+ Task</button>
      </div>
    `;
  }).join('');
}

function changeWeek(dir) {
  currentWeekOffset += dir;
  renderWeekly();
}

function openWeekTaskModal(dateStr) {
  document.getElementById('week-task-date').value = dateStr;
  document.getElementById('week-task-title').value = '';
  document.getElementById('week-task-category').value = 'business';
  document.getElementById('week-task-priority').value = 'false';
  openModal('week-task-modal');
}

function saveWeekTask() {
  const title = document.getElementById('week-task-title').value.trim();
  if (!title) return;
  data.weeklyTasks.push({
    id: uid(),
    date: document.getElementById('week-task-date').value,
    title,
    category: document.getElementById('week-task-category').value,
    priority: document.getElementById('week-task-priority').value === 'true',
    completed: false
  });
  saveData(data);
  closeModal('week-task-modal');
  renderWeekly();
  if (document.getElementById('view-daily').classList.contains('active')) renderDaily();
}

function toggleWeekTask(id) {
  const task = data.weeklyTasks.find(t => t.id === id);
  if (task) { task.completed = !task.completed; saveData(data); }
  renderWeekly();
  if (document.getElementById('view-daily').classList.contains('active')) renderDaily();
}

function deleteWeekTask(id) {
  data.weeklyTasks = data.weeklyTasks.filter(t => t.id !== id);
  saveData(data);
  renderWeekly();
  if (document.getElementById('view-daily').classList.contains('active')) renderDaily();
}

// ===== DAILY FOCUS =====
function renderDaily() {
  const today = new Date();
  const dateStr = todayStr();
  document.getElementById('daily-date').textContent = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  document.getElementById('daily-subtitle').textContent = `Day ${getDayOfYear(today)} of ${isLeapYear(today.getFullYear()) ? 366 : 365}`;

  const tasks = data.weeklyTasks.filter(t => t.date === dateStr);
  const priorities = tasks.filter(t => t.priority);

  // Priorities
  if (priorities.length) {
    document.getElementById('daily-priorities').innerHTML = priorities.map((t, i) => `
      <div class="priority-item ${t.completed ? 'completed' : ''}">
        <div class="priority-number" style="background:${catColor(t.category)}">${i + 1}</div>
        <span style="flex:1">${esc(t.title)}</span>
        <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleWeekTask('${t.id}');renderDaily()">
      </div>
    `).join('');
  } else {
    document.getElementById('daily-priorities').innerHTML = '<p style="color:var(--text-secondary);font-size:13px">No priorities set. Add high-priority tasks in the Weekly view.</p>';
  }

  // All tasks
  const normalTasks = tasks.filter(t => !t.priority);
  const allItems = [...normalTasks];
  if (allItems.length || priorities.length) {
    document.getElementById('daily-tasks').innerHTML = [...tasks].sort((a,b) => (a.completed ? 1 : 0) - (b.completed ? 1 : 0)).map(t => `
      <div class="day-task ${t.completed ? 'completed' : ''}" style="padding:10px">
        <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleWeekTask('${t.id}');renderDaily()">
        <span class="tag tag-${t.category}" style="font-size:10px">${cap(t.category)}</span>
        <span style="flex:1">${esc(t.title)}</span>
        ${t.priority ? '<span style="font-size:10px;color:var(--cat-financial)">â˜… Priority</span>' : ''}
      </div>
    `).join('');
  } else {
    document.getElementById('daily-tasks').innerHTML = '<p style="color:var(--text-secondary);font-size:13px">No tasks for today.</p>';
  }

  // Notes
  document.getElementById('daily-notes').value = data.dailyNotes[dateStr] || '';
}

function saveDailyNote() {
  const dateStr = todayStr();
  data.dailyNotes[dateStr] = document.getElementById('daily-notes').value;
  saveData(data);
}

function openDailyTaskModal() {
  openWeekTaskModal(todayStr());
}

function getDayOfYear(date) {
  const start = new Date(date.getFullYear(), 0, 0);
  const diff = date - start;
  return Math.floor(diff / (1000 * 60 * 60 * 24));
}

function isLeapYear(year) {
  return ((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0);
}

// ===== HOURLY PLANNER =====
const HOURS = [];
for (let h = 5; h <= 23; h++) HOURS.push(h);

function getHourlyDate() {
  const d = new Date();
  d.setDate(d.getDate() + hourlyDayOffset);
  return d;
}

function getHourlyDateStr() {
  return getHourlyDate().toISOString().split('T')[0];
}

function formatHour(h) {
  if (h === 0) return '12 AM';
  if (h < 12) return h + ' AM';
  if (h === 12) return '12 PM';
  return (h - 12) + ' PM';
}

function renderHourly() {
  const d = getHourlyDate();
  const dateStr = getHourlyDateStr();
  const isToday = dateStr === todayStr();
  const currentHour = new Date().getHours();

  document.getElementById('hourly-date-label').textContent =
    d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

  if (!data.hourlyBlocks) data.hourlyBlocks = [];
  const dayBlocks = data.hourlyBlocks.filter(b => b.date === dateStr);

  document.getElementById('hourly-grid').innerHTML = HOURS.map(h => {
    const block = dayBlocks.find(b => b.hour === h);
    const isCurrent = isToday && h === currentHour;
    return `
      <div class="hour-row ${isCurrent ? 'current-hour' : ''}">
        <div class="hour-label">${formatHour(h)}</div>
        <div class="hour-content ${block ? 'filled' : ''}" style="${block ? 'border-left-color:' + catColor(block.category) : ''}" onclick="openHourlyModal('${dateStr}', ${h})">
          ${block ? `
            <span class="hour-block-title">${esc(block.title)}</span>
            <span class="hour-block-cat"><span class="tag tag-${block.category}" style="font-size:10px">${cap(block.category)}</span></span>
          ` : `
            <span class="hour-empty">+ Add block</span>
          `}
        </div>
      </div>
    `;
  }).join('');
}

function changeHourlyDay(dir) {
  hourlyDayOffset += dir;
  renderHourly();
}

function openHourlyModal(dateStr, hour) {
  if (!data.hourlyBlocks) data.hourlyBlocks = [];
  const existing = data.hourlyBlocks.find(b => b.date === dateStr && b.hour === hour);
  document.getElementById('hourly-block-date').value = dateStr;
  document.getElementById('hourly-block-hour').value = hour;
  document.getElementById('hourly-modal-title').textContent = formatHour(hour) + ' Block';

  if (existing) {
    document.getElementById('hourly-block-id').value = existing.id;
    document.getElementById('hourly-block-title').value = existing.title;
    document.getElementById('hourly-block-category').value = existing.category;
    document.getElementById('hourly-delete-btn').style.display = 'inline-flex';
  } else {
    document.getElementById('hourly-block-id').value = '';
    document.getElementById('hourly-block-title').value = '';
    document.getElementById('hourly-block-category').value = 'business';
    document.getElementById('hourly-delete-btn').style.display = 'none';
  }
  openModal('hourly-modal');
}

function saveHourlyBlock() {
  const title = document.getElementById('hourly-block-title').value.trim();
  if (!title) return;
  if (!data.hourlyBlocks) data.hourlyBlocks = [];
  const dateStr = document.getElementById('hourly-block-date').value;
  const hour = parseInt(document.getElementById('hourly-block-hour').value);
  const existingId = document.getElementById('hourly-block-id').value;

  if (existingId) {
    const idx = data.hourlyBlocks.findIndex(b => b.id === existingId);
    if (idx >= 0) {
      data.hourlyBlocks[idx].title = title;
      data.hourlyBlocks[idx].category = document.getElementById('hourly-block-category').value;
    }
  } else {
    // Remove any existing block at that slot first
    data.hourlyBlocks = data.hourlyBlocks.filter(b => !(b.date === dateStr && b.hour === hour));
    data.hourlyBlocks.push({
      id: uid(),
      date: dateStr,
      hour,
      title,
      category: document.getElementById('hourly-block-category').value
    });
  }
  saveData(data);
  closeModal('hourly-modal');
  renderHourly();
}

function deleteHourlyBlock() {
  const id = document.getElementById('hourly-block-id').value;
  if (!id) return;
  data.hourlyBlocks = (data.hourlyBlocks || []).filter(b => b.id !== id);
  saveData(data);
  closeModal('hourly-modal');
  renderHourly();
}

// ===== HABIT TRACKER =====
function renderHabits() {
  if (!data.habits) data.habits = [];
  if (!data.habitLog) data.habitLog = {};
  const dateStr = todayStr();
  const todayLog = data.habitLog[dateStr] || [];
  const completed = todayLog.length;
  const total = data.habits.length;
  const pct = total ? Math.round((completed / total) * 100) : 0;

  document.getElementById('habits-today-score').innerHTML =
    total ? `<span style="color:${pct === 100 ? 'var(--cat-business)' : pct >= 50 ? 'var(--cat-financial)' : 'var(--danger)'}">${completed}/${total} (${pct}%)</span>` : '';

  if (!data.habits.length) {
    document.getElementById('habits-list').innerHTML = '<div class="empty-state"><p>No habits defined. Add daily habits you want to build consistency on.</p></div>';
    return;
  }

  // Get last 7 days for dots
  const last7 = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    last7.push(d.toISOString().split('T')[0]);
  }
  const dayLabels = last7.map(ds => {
    const d = new Date(ds + 'T00:00:00');
    return ['S','M','T','W','T','F','S'][d.getDay()];
  });

  document.getElementById('habits-list').innerHTML = data.habits.map(h => {
    const isDone = todayLog.includes(h.id);
    const streak = getHabitStreak(h.id);

    return `
      <div class="habit-card">
        <div class="habit-check ${isDone ? 'done' : ''}" onclick="toggleHabit('${h.id}')">&#10003;</div>
        <div class="habit-name" style="${isDone ? 'text-decoration:line-through;color:var(--text-secondary)' : ''}">
          ${esc(h.name)}
          <span class="tag tag-${h.category}" style="font-size:9px;margin-left:6px">${cap(h.category)}</span>
        </div>
        <div class="habit-week-dots">
          ${last7.map((ds, i) => {
            const log = data.habitLog[ds] || [];
            const done = log.includes(h.id);
            return `<div style="text-align:center"><div class="habit-dot ${done ? 'done' : ''}"></div><div class="habit-dot-label">${dayLabels[i]}</div></div>`;
          }).join('')}
        </div>
        ${streak > 0 ? `<div class="habit-streak">${streak}d streak</div>` : ''}
        <button class="btn btn-ghost btn-sm" onclick="deleteHabit('${h.id}')" style="color:var(--danger)">&times;</button>
      </div>
    `;
  }).join('');
}

function getHabitStreak(habitId) {
  let streak = 0;
  const d = new Date();
  while (true) {
    const ds = d.toISOString().split('T')[0];
    const log = (data.habitLog || {})[ds] || [];
    if (log.includes(habitId)) {
      streak++;
      d.setDate(d.getDate() - 1);
    } else {
      break;
    }
  }
  return streak;
}

function toggleHabit(habitId) {
  const dateStr = todayStr();
  if (!data.habitLog) data.habitLog = {};
  if (!data.habitLog[dateStr]) data.habitLog[dateStr] = [];
  const idx = data.habitLog[dateStr].indexOf(habitId);
  if (idx >= 0) {
    data.habitLog[dateStr].splice(idx, 1);
  } else {
    data.habitLog[dateStr].push(habitId);
  }
  saveData(data);
  renderHabits();
}

function openHabitModal() {
  document.getElementById('habit-name').value = '';
  document.getElementById('habit-category').value = 'business';
  openModal('habit-modal');
}

function saveHabit() {
  const name = document.getElementById('habit-name').value.trim();
  if (!name) return;
  if (!data.habits) data.habits = [];
  data.habits.push({
    id: uid(),
    name,
    category: document.getElementById('habit-category').value
  });
  saveData(data);
  closeModal('habit-modal');
  renderHabits();
}

function deleteHabit(id) {
  if (!confirm('Delete this habit?')) return;
  data.habits = (data.habits || []).filter(h => h.id !== id);
  saveData(data);
  renderHabits();
}

// ===== SCOREBOARD =====
function calcDayScore(dateStr) {
  // Tasks: up to 40 points
  const tasks = data.weeklyTasks.filter(t => t.date === dateStr);
  const totalTasks = tasks.length;
  const completedTasks = tasks.filter(t => t.completed).length;
  const taskScore = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 40) : 0;

  // Habits: up to 40 points
  const totalHabits = (data.habits || []).length;
  const completedHabits = ((data.habitLog || {})[dateStr] || []).length;
  const habitScore = totalHabits > 0 ? Math.round((completedHabits / totalHabits) * 40) : 0;

  // Hourly blocks: up to 20 points (% of available hours filled)
  const blocks = (data.hourlyBlocks || []).filter(b => b.date === dateStr);
  const blockScore = Math.min(20, Math.round((blocks.length / HOURS.length) * 20));

  return {
    total: taskScore + habitScore + blockScore,
    taskScore,
    habitScore,
    blockScore,
    completedTasks,
    totalTasks,
    completedHabits,
    totalHabits,
    blockedHours: blocks.length
  };
}

function getGrade(score) {
  if (score >= 90) return { letter: 'S', class: 'grade-s', label: 'ELITE' };
  if (score >= 75) return { letter: 'A', class: 'grade-a', label: 'GREAT' };
  if (score >= 60) return { letter: 'B', class: 'grade-b', label: 'SOLID' };
  if (score >= 40) return { letter: 'C', class: 'grade-c', label: 'OK' };
  if (score >= 20) return { letter: 'D', class: 'grade-d', label: 'WEAK' };
  return { letter: 'F', class: 'grade-f', label: 'STEP UP' };
}

function getScoreColor(score) {
  if (score >= 90) return 'var(--cat-financial)';
  if (score >= 75) return 'var(--cat-business)';
  if (score >= 60) return 'var(--cat-learning)';
  if (score >= 40) return 'var(--cat-financial)';
  if (score >= 20) return 'var(--cat-gym)';
  return 'var(--danger)';
}

function renderScoreboard() {
  const dateStr = todayStr();
  const today = calcDayScore(dateStr);
  const grade = getGrade(today.total);
  const color = getScoreColor(today.total);

  document.getElementById('score-today-value').style.color = color;
  document.getElementById('score-today-value').textContent = today.total;
  document.getElementById('score-grade').innerHTML = `<span class="${grade.class}">${grade.letter}</span> <span style="font-size:14px;color:var(--text-secondary)">${grade.label}</span>`;

  document.getElementById('score-breakdown').innerHTML = `
    <div class="score-item">
      <div class="score-item-value" style="color:var(--cat-business)">${today.taskScore}/40</div>
      <div class="score-item-label">Tasks (${today.completedTasks}/${today.totalTasks})</div>
    </div>
    <div class="score-item">
      <div class="score-item-value" style="color:var(--cat-learning)">${today.habitScore}/40</div>
      <div class="score-item-label">Habits (${today.completedHabits}/${today.totalHabits})</div>
    </div>
    <div class="score-item">
      <div class="score-item-value" style="color:var(--cat-financial)">${today.blockScore}/20</div>
      <div class="score-item-label">Time Blocked (${today.blockedHours}h)</div>
    </div>
  `;

  // Last 14 days
  const history = [];
  for (let i = 0; i < 14; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const ds = d.toISOString().split('T')[0];
    const score = calcDayScore(ds);
    history.push({ date: ds, ...score });
  }

  document.getElementById('score-history').innerHTML = history.map(h => {
    const g = getGrade(h.total);
    const c = getScoreColor(h.total);
    const d = new Date(h.date + 'T00:00:00');
    const label = h.date === todayStr() ? 'Today' : d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    return `
      <div class="score-history-row">
        <span class="score-history-date">${label}</span>
        <div class="score-history-bar">
          <div class="score-history-fill" style="width:${h.total}%;background:${c}"></div>
        </div>
        <span class="score-history-value ${g.class}">${h.total}</span>
      </div>
    `;
  }).join('');
}

// ===== REWARDS =====
function renderRewards() {
  document.getElementById('reward-points').textContent = data.rewardPoints || 0;

  const available = (data.rewards || []).filter(r => !r.redeemed);
  const redeemed = (data.rewards || []).filter(r => r.redeemed);

  if (available.length) {
    document.getElementById('rewards-available').innerHTML = available.map(r => `
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:16px;font-weight:600">${esc(r.title)}</div>
          ${r.description ? `<div style="font-size:13px;color:var(--text-secondary);margin-top:2px">${esc(r.description)}</div>` : ''}
          <div style="font-size:13px;color:var(--cat-financial);margin-top:4px;font-weight:600">${r.cost} points</div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-success btn-sm" onclick="redeemReward('${r.id}')" ${(data.rewardPoints || 0) < r.cost ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}>Redeem</button>
          <button class="btn btn-ghost btn-sm" onclick="editReward('${r.id}')">Edit</button>
          <button class="btn btn-ghost btn-sm" onclick="deleteReward('${r.id}')" style="color:var(--danger)">Delete</button>
        </div>
      </div>
    `).join('');
  } else {
    document.getElementById('rewards-available').innerHTML = '<div class="empty-state"><p>No rewards set up yet. Add a reward to motivate yourself!</p></div>';
  }

  if (redeemed.length) {
    document.getElementById('rewards-redeemed').innerHTML = redeemed.map(r => `
      <div class="card" style="display:flex;justify-content:space-between;align-items:center;opacity:0.7">
        <div>
          <div style="font-size:16px;font-weight:600">${esc(r.title)}</div>
          ${r.description ? `<div style="font-size:13px;color:var(--text-secondary);margin-top:2px">${esc(r.description)}</div>` : ''}
          <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Redeemed ${formatDate(r.redeemedDate)} &middot; ${r.cost} pts</div>
        </div>
        <span style="color:var(--cat-business);font-size:20px">&#10003;</span>
      </div>
    `).join('');
  } else {
    document.getElementById('rewards-redeemed').innerHTML = '<p style="color:var(--text-secondary);font-size:13px">No rewards redeemed yet. Complete goals to earn points!</p>';
  }
}

function openRewardModal(rewardId) {
  document.getElementById('reward-modal-title').textContent = rewardId ? 'Edit Reward' : 'Add Reward';
  document.getElementById('reward-id').value = rewardId || '';
  if (rewardId) {
    const r = (data.rewards || []).find(x => x.id === rewardId);
    if (!r) return;
    document.getElementById('reward-title').value = r.title;
    document.getElementById('reward-desc').value = r.description || '';
    document.getElementById('reward-cost').value = r.cost;
  } else {
    document.getElementById('reward-title').value = '';
    document.getElementById('reward-desc').value = '';
    document.getElementById('reward-cost').value = 10;
  }
  openModal('reward-modal');
}

function saveReward() {
  const title = document.getElementById('reward-title').value.trim();
  const cost = parseInt(document.getElementById('reward-cost').value);
  if (!title || isNaN(cost) || cost < 1) return;
  const id = document.getElementById('reward-id').value;
  if (!data.rewards) data.rewards = [];
  if (id) {
    const idx = data.rewards.findIndex(r => r.id === id);
    if (idx >= 0) {
      data.rewards[idx].title = title;
      data.rewards[idx].description = document.getElementById('reward-desc').value.trim();
      data.rewards[idx].cost = cost;
    }
  } else {
    data.rewards.push({
      id: uid(),
      title,
      description: document.getElementById('reward-desc').value.trim(),
      cost,
      redeemed: false
    });
  }
  saveData(data);
  closeModal('reward-modal');
  renderRewards();
}

function editReward(id) { openRewardModal(id); }

function deleteReward(id) {
  if (!confirm('Delete this reward?')) return;
  data.rewards = (data.rewards || []).filter(r => r.id !== id);
  saveData(data);
  renderRewards();
}

function redeemReward(id) {
  const reward = (data.rewards || []).find(r => r.id === id);
  if (!reward) return;
  if ((data.rewardPoints || 0) < reward.cost) {
    alert('Not enough points!');
    return;
  }
  if (!confirm(`Redeem "${reward.title}" for ${reward.cost} points?`)) return;
  data.rewardPoints -= reward.cost;
  reward.redeemed = true;
  reward.redeemedDate = todayStr();
  saveData(data);
  renderRewards();
  showPointsToast(`Redeemed: ${reward.title}`);
}

// ===== DAILY RITUAL =====
function getRitualLog(date) {
  if (!data.ritualLog) data.ritualLog = {};
  return data.ritualLog[date] || [];
}

function toggleRitualCheck(stepId) {
  const today = todayStr();
  if (!data.ritualLog) data.ritualLog = {};
  if (!data.ritualLog[today]) data.ritualLog[today] = [];
  const idx = data.ritualLog[today].indexOf(stepId);
  if (idx >= 0) data.ritualLog[today].splice(idx, 1);
  else data.ritualLog[today].push(stepId);
  saveData(data);
  renderRitual();
}

function calcRitualStreak() {
  let streak = 0;
  const steps = (data.ritualSteps || []);
  if (!steps.length) return 0;
  const d = new Date();
  d.setDate(d.getDate() - 1); // start from yesterday
  while (true) {
    const ds = d.toISOString().split('T')[0];
    const log = getRitualLog(ds);
    const pct = steps.length > 0 ? log.length / steps.length : 0;
    if (pct >= 0.8) { streak++; d.setDate(d.getDate() - 1); }
    else break;
  }
  return streak;
}

function renderRitual() {
  const steps = (data.ritualSteps || []).sort((a, b) => (a.order || 0) - (b.order || 0));
  const today = todayStr();
  const checked = getRitualLog(today);
  const morningSteps = steps.filter(s => s.when === 'morning');
  const eveningSteps = steps.filter(s => s.when === 'evening');
  const totalDone = checked.length;
  const totalSteps = steps.length;
  const pct = totalSteps > 0 ? Math.round((totalDone / totalSteps) * 100) : 0;
  const streak = calcRitualStreak();

  const r = 20;
  const circ = 2 * Math.PI * r;
  const offset = circ - (pct / 100) * circ;
  const ringColor = pct >= 100 ? 'var(--cat-business)' : pct >= 50 ? 'var(--cat-financial)' : 'var(--danger)';

  document.getElementById('ritual-progress').innerHTML = totalSteps ? `
    <div class="ritual-progress">
      <svg class="ritual-progress-ring" viewBox="0 0 48 48">
        <circle cx="24" cy="24" r="${r}" fill="none" stroke="var(--border)" stroke-width="4"/>
        <circle cx="24" cy="24" r="${r}" fill="none" stroke="${ringColor}" stroke-width="4" stroke-linecap="round" stroke-dasharray="${circ}" stroke-dashoffset="${offset}" transform="rotate(-90 24 24)"/>
        <text x="24" y="27" text-anchor="middle" fill="${ringColor}" font-size="11" font-weight="700">${pct}%</text>
      </svg>
      <div>
        <div class="ritual-progress-text"><strong>${totalDone}/${totalSteps}</strong> steps completed today</div>
        <div class="ritual-streak">${streak > 0 ? streak + ' day streak (80%+ completion)' : 'Complete 80%+ daily to build a streak'}</div>
      </div>
    </div>
  ` : '';

  function renderSection(title, icon, items) {
    if (!items.length) return '';
    return '<div class="ritual-section"><h3>' + icon + ' ' + title + '</h3>' + items.map(s => {
      const isDone = checked.includes(s.id);
      return '<div class="ritual-item' + (isDone ? ' done' : '') + '"><div class="ritual-check' + (isDone ? ' checked' : '') + '" onclick="toggleRitualCheck(\'' + s.id + '\')">&#10003;</div><div class="ritual-text">' + esc(s.text) + '</div><div class="ritual-time">' + (s.duration || '') + ' min</div><div class="ritual-actions"><button class="btn btn-ghost btn-sm" onclick="editRitualStep(\'' + s.id + '\')">Edit</button></div></div>';
    }).join('') + '</div>';
  }

  document.getElementById('ritual-morning').innerHTML = renderSection('Morning Routine', '&#9728;', morningSteps) || '<div class="empty-state"><p>No morning routine set. Click "+ Add Step" to build your non-negotiable morning.</p></div>';
  document.getElementById('ritual-evening').innerHTML = renderSection('Evening Routine', '&#9790;', eveningSteps);
}

function openRitualModal(stepId) {
  document.getElementById('ritual-modal-title').textContent = stepId ? 'Edit Step' : 'Add Ritual Step';
  document.getElementById('ritual-id').value = stepId || '';
  if (stepId) {
    const s = (data.ritualSteps || []).find(x => x.id === stepId);
    if (!s) return;
    document.getElementById('ritual-text').value = s.text;
    document.getElementById('ritual-when').value = s.when;
    document.getElementById('ritual-duration').value = s.duration || 15;
    document.getElementById('ritual-order').value = s.order || 1;
    document.getElementById('ritual-delete-btn').style.display = 'inline-flex';
  } else {
    document.getElementById('ritual-text').value = '';
    document.getElementById('ritual-when').value = 'morning';
    document.getElementById('ritual-duration').value = 15;
    const existing = (data.ritualSteps || []).length;
    document.getElementById('ritual-order').value = existing + 1;
    document.getElementById('ritual-delete-btn').style.display = 'none';
  }
  openModal('ritual-modal');
}

function editRitualStep(id) { openRitualModal(id); }

function saveRitualStep() {
  const text = document.getElementById('ritual-text').value.trim();
  if (!text) return;
  if (!data.ritualSteps) data.ritualSteps = [];
  const id = document.getElementById('ritual-id').value;
  const obj = {
    text,
    when: document.getElementById('ritual-when').value,
    duration: parseInt(document.getElementById('ritual-duration').value) || 15,
    order: parseInt(document.getElementById('ritual-order').value) || 1
  };
  if (id) {
    const idx = data.ritualSteps.findIndex(s => s.id === id);
    if (idx >= 0) data.ritualSteps[idx] = { ...data.ritualSteps[idx], ...obj };
  } else {
    data.ritualSteps.push({ id: uid(), ...obj });
  }
  saveData(data);
  closeModal('ritual-modal');
  renderRitual();
}

function deleteRitualStep() {
  const id = document.getElementById('ritual-id').value;
  if (!id || !confirm('Delete this ritual step?')) return;
  data.ritualSteps = (data.ritualSteps || []).filter(s => s.id !== id);
  saveData(data);
  closeModal('ritual-modal');
  renderRitual();
}

function resetRitualToday() {
  if (!confirm('Reset all checkmarks for today?')) return;
  if (!data.ritualLog) data.ritualLog = {};
  data.ritualLog[todayStr()] = [];
  saveData(data);
  renderRitual();
}

// ===== BOOKS / LEARNING =====
let bookFilter = 'all';

function filterBooks(status, btn) {
  bookFilter = status;
  if (btn) {
    document.querySelectorAll('#view-books .tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
  }
  renderBooks();
}

function renderBooks() {
  const books = data.books || [];
  const completed = books.filter(b => b.status === 'completed');
  const reading = books.filter(b => b.status === 'reading');
  const implemented = completed.filter(b => b.implemented === 'yes');

  document.getElementById('book-kpis').innerHTML = `
    <div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-learning)">${books.length}</div><div class="book-kpi-label">Total</div></div>
    <div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-business)">${completed.length}</div><div class="book-kpi-label">Completed</div></div>
    <div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-learning)">${reading.length}</div><div class="book-kpi-label">Reading</div></div>
    <div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-financial)">${implemented.length}</div><div class="book-kpi-label">Implemented</div></div>
    <div class="book-kpi"><div class="book-kpi-val" style="color:${implemented.length>=completed.length&&completed.length>0?'var(--cat-business)':'var(--danger)'}">${completed.length?Math.round((implemented.length/completed.length)*100):0}%</div><div class="book-kpi-label">Impl. Rate</div></div>
  `;

  let list = [...books];
  if (bookFilter !== 'all') list = list.filter(b => b.status === bookFilter);
  list.sort((a, b) => {
    const statusOrder = { reading: 0, queued: 1, completed: 2 };
    return (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
  });

  if (!list.length) {
    document.getElementById('book-list').innerHTML = '<div class="empty-state"><p>' + (bookFilter === 'all' ? 'No books yet. Start tracking what you read.' : 'No books in this category.') + '</p></div>';
    return;
  }

  document.getElementById('book-list').innerHTML = list.map(b => {
    const typeIcon = { book: '&#128214;', audiobook: '&#127911;', podcast: '&#127897;', course: '&#127891;', video: '&#9654;' };
    return '<div class="book-card"><div class="book-header"><div><div class="book-title">' + esc(b.title) + '</div><div class="book-author">' + esc(b.author || '') + '</div></div><div style="display:flex;gap:6px;align-items:center"><span class="book-status ' + b.status + '">' + cap(b.status) + '</span><button class="btn btn-ghost btn-sm" onclick="editBook(\'' + b.id + '\')">Edit</button></div></div><div class="book-meta"><span>' + (typeIcon[b.type] || '') + ' ' + cap(b.type || 'book') + '</span><span class="tag tag-' + (b.category || 'learning') + '">' + cap(b.category || 'learning') + '</span>' + (b.dateCompleted ? '<span>Finished ' + formatDate(b.dateCompleted) + '</span>' : '') + '</div>' + (b.takeaway ? '<div class="book-takeaway"><strong>Key Takeaway:</strong> ' + esc(b.takeaway) + '</div>' : '') + (b.implemented === 'yes' ? '<div class="book-implemented">&#10003; Implemented' + (b.implNotes ? ' â€” ' + esc(b.implNotes) : '') + '</div>' : '') + '</div>';
  }).join('');
}

function openBookModal(bookId) {
  document.getElementById('book-modal-title').textContent = bookId ? 'Edit Book' : 'Add Book';
  document.getElementById('book-id').value = bookId || '';
  if (bookId) {
    const b = (data.books || []).find(x => x.id === bookId);
    if (!b) return;
    document.getElementById('book-title').value = b.title;
    document.getElementById('book-author').value = b.author || '';
    document.getElementById('book-type').value = b.type || 'book';
    document.getElementById('book-status').value = b.status || 'queued';
    document.getElementById('book-category').value = b.category || 'business';
    document.getElementById('book-takeaway').value = b.takeaway || '';
    document.getElementById('book-implemented').value = b.implemented || '';
    document.getElementById('book-impl-notes').value = b.implNotes || '';
    document.getElementById('book-delete-btn').style.display = 'inline-flex';
  } else {
    ['book-title', 'book-author', 'book-takeaway', 'book-impl-notes'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('book-type').value = 'book';
    document.getElementById('book-status').value = 'reading';
    document.getElementById('book-category').value = 'business';
    document.getElementById('book-implemented').value = '';
    document.getElementById('book-delete-btn').style.display = 'none';
  }
  openModal('book-modal');
}

function editBook(id) { openBookModal(id); }

function saveBook() {
  const title = document.getElementById('book-title').value.trim();
  if (!title) return;
  if (!data.books) data.books = [];
  const id = document.getElementById('book-id').value;
  const status = document.getElementById('book-status').value;
  const obj = {
    title,
    author: document.getElementById('book-author').value.trim(),
    type: document.getElementById('book-type').value,
    status,
    category: document.getElementById('book-category').value,
    takeaway: document.getElementById('book-takeaway').value.trim(),
    implemented: document.getElementById('book-implemented').value,
    implNotes: document.getElementById('book-impl-notes').value.trim()
  };
  if (status === 'completed' && !obj.dateCompleted) obj.dateCompleted = todayStr();
  if (id) {
    const idx = data.books.findIndex(b => b.id === id);
    if (idx >= 0) {
      const prev = data.books[idx];
      if (prev.status !== 'completed' && status === 'completed') obj.dateCompleted = todayStr();
      else obj.dateCompleted = prev.dateCompleted || '';
      data.books[idx] = { ...prev, ...obj };
    }
  } else {
    data.books.push({ id: uid(), ...obj, dateAdded: todayStr() });
  }
  saveData(data);
  closeModal('book-modal');
  renderBooks();
}

function deleteBook() {
  const id = document.getElementById('book-id').value;
  if (!id || !confirm('Delete this book?')) return;
  data.books = (data.books || []).filter(b => b.id !== id);
  saveData(data);
  closeModal('book-modal');
  renderBooks();
}

// ===== CONTENT CALENDAR =====
let contentWeekStart = getMonday(new Date());

function getMonday(d) {
  const dt = new Date(d);
  const day = dt.getDay();
  const diff = dt.getDate() - day + (day === 0 ? -6 : 1);
  dt.setDate(diff);
  dt.setHours(0, 0, 0, 0);
  return dt;
}

function changeContentWeek(delta) {
  contentWeekStart.setDate(contentWeekStart.getDate() + delta * 7);
  renderContent();
}

function renderContent() {
  const posts = data.contentPosts || [];
  const thisWeekDates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(contentWeekStart);
    d.setDate(d.getDate() + i);
    thisWeekDates.push(d.toISOString().split('T')[0]);
  }

  const weekEnd = new Date(contentWeekStart);
  weekEnd.setDate(weekEnd.getDate() + 6);
  document.getElementById('content-week-label').textContent = formatDate(contentWeekStart.toISOString().split('T')[0]) + ' â€” ' + formatDate(weekEnd.toISOString().split('T')[0]);

  // Week stats
  const weekPosts = posts.filter(p => thisWeekDates.includes(p.date));
  const published = weekPosts.filter(p => p.status === 'published').length;
  const planned = weekPosts.length;
  const byPlatform = {};
  weekPosts.forEach(p => { byPlatform[p.platform] = (byPlatform[p.platform] || 0) + 1; });

  document.getElementById('content-stats').innerHTML = `
    <div class="content-stat"><div class="content-stat-val" style="color:var(--cat-learning)">${planned}</div><div class="content-stat-label">Planned</div></div>
    <div class="content-stat"><div class="content-stat-val" style="color:var(--cat-business)">${published}</div><div class="content-stat-label">Published</div></div>
    <div class="content-stat"><div class="content-stat-val" style="color:${planned>=3?'var(--cat-business)':'var(--danger)'}">${planned >= 3 ? 'On Track' : planned + '/3'}</div><div class="content-stat-label">Weekly Goal</div></div>
  `;

  const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  document.getElementById('content-calendar').innerHTML = thisWeekDates.map((dateStr, i) => {
    const dayPosts = posts.filter(p => p.date === dateStr).sort((a, b) => (a.platform || '').localeCompare(b.platform || ''));
    const isToday = dateStr === todayStr();
    return '<div class="content-day" style="' + (isToday ? 'border-color:var(--cat-learning)' : '') + '"><div class="content-day-head"><span>' + dayNames[i] + '</span><span class="content-day-date">' + formatDate(dateStr) + '</span></div>' + dayPosts.map(p => '<div class="content-post ' + (p.platform || '') + (p.status === 'published' ? ' published' : '') + '" onclick="editContentPost(\'' + p.id + '\')">' + cap(p.platform || '') + ': ' + esc(p.topic || p.type || 'Post') + (p.status === 'published' ? ' &#10003;' : '') + '</div>').join('') + '<button class="content-add-btn" onclick="openContentModal(\'' + dateStr + '\')">+</button></div>';
  }).join('');
}

function openContentModal(dateOrId) {
  const existing = (data.contentPosts || []).find(p => p.id === dateOrId);
  if (existing) {
    document.getElementById('content-modal-title').textContent = 'Edit Post';
    document.getElementById('content-id').value = existing.id;
    document.getElementById('content-platform').value = existing.platform || 'linkedin';
    document.getElementById('content-type').value = existing.type || 'text';
    document.getElementById('content-topic').value = existing.topic || '';
    document.getElementById('content-notes').value = existing.notes || '';
    document.getElementById('content-date').value = existing.date || '';
    document.getElementById('content-status').value = existing.status || 'planned';
    document.getElementById('content-cta').value = existing.cta || '';
    document.getElementById('content-delete-btn').style.display = 'inline-flex';
  } else {
    document.getElementById('content-modal-title').textContent = 'Plan Post';
    document.getElementById('content-id').value = '';
    document.getElementById('content-platform').value = 'linkedin';
    document.getElementById('content-type').value = 'text';
    document.getElementById('content-topic').value = '';
    document.getElementById('content-notes').value = '';
    document.getElementById('content-date').value = dateOrId || todayStr();
    document.getElementById('content-status').value = 'planned';
    document.getElementById('content-cta').value = '';
    document.getElementById('content-delete-btn').style.display = 'none';
  }
  openModal('content-modal');
}

function editContentPost(id) { openContentModal(id); }

function saveContentPost() {
  const topic = document.getElementById('content-topic').value.trim();
  if (!topic) return;
  if (!data.contentPosts) data.contentPosts = [];
  const id = document.getElementById('content-id').value;
  const obj = {
    platform: document.getElementById('content-platform').value,
    type: document.getElementById('content-type').value,
    topic,
    notes: document.getElementById('content-notes').value.trim(),
    date: document.getElementById('content-date').value || todayStr(),
    status: document.getElementById('content-status').value,
    cta: document.getElementById('content-cta').value
  };
  if (id) {
    const idx = data.contentPosts.findIndex(p => p.id === id);
    if (idx >= 0) data.contentPosts[idx] = { ...data.contentPosts[idx], ...obj };
  } else {
    data.contentPosts.push({ id: uid(), ...obj });
  }
  saveData(data);
  closeModal('content-modal');
  renderContent();
}

function deleteContentPost() {
  const id = document.getElementById('content-id').value;
  if (!id || !confirm('Delete this post?')) return;
  data.contentPosts = (data.contentPosts || []).filter(p => p.id !== id);
  saveData(data);
  closeModal('content-modal');
  renderContent();
}

// ===== DECISION JOURNAL =====
let decisionFilter = 'all';
function filterDecisions(f, btn) {
  decisionFilter = f;
  if (btn) { document.querySelectorAll('#view-decisions .tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); }
  renderDecisions();
}
function renderDecisions() {
  let list = [...(data.decisions || [])];
  const today = todayStr();
  if (decisionFilter === 'pending') list = list.filter(d => !d.actualOutcome);
  else if (decisionFilter === 'reviewed') list = list.filter(d => d.actualOutcome);
  list.sort((a, b) => b.date.localeCompare(a.date));
  if (!list.length) { document.getElementById('decision-list').innerHTML = '<div class="empty-state"><p>No decisions logged. Track important decisions to improve your judgment over time.</p></div>'; return; }
  document.getElementById('decision-list').innerHTML = list.map(d => {
    const reviewed = !!d.actualOutcome;
    const reviewDate = d.reviewDate || '';
    const needsReview = !reviewed && reviewDate && reviewDate <= today;
    return '<div class="decision-card ' + (reviewed ? 'reviewed' : 'pending') + '" style="cursor:pointer" onclick="editDecision(\'' + d.id + '\')"><div class="decision-title">' + esc(d.title) + '</div><div class="decision-meta"><span>' + formatDate(d.date) + '</span>' + (needsReview ? '<span style="color:var(--danger);font-weight:600">REVIEW DUE</span>' : reviewed ? '<span style="color:var(--cat-business)">Reviewed</span>' : '<span>Review: ' + formatDate(reviewDate) + '</span>') + '</div>' + (d.reasoning ? '<div class="decision-field"><div class="decision-field-label">Reasoning</div>' + esc(d.reasoning) + '</div>' : '') + (d.expectedOutcome ? '<div class="decision-field"><div class="decision-field-label">Expected Outcome</div>' + esc(d.expectedOutcome) + '</div>' : '') + (d.actualOutcome ? '<div class="decision-field" style="border-left:3px solid var(--cat-business)"><div class="decision-field-label">Actual Outcome</div>' + esc(d.actualOutcome) + '</div>' : '') + (d.lesson ? '<div style="margin-top:6px;font-size:12px;color:var(--cat-learning)"><strong>Lesson:</strong> ' + esc(d.lesson) + '</div>' : '') + '</div>';
  }).join('');
}
function openDecisionModal(id) {
  document.getElementById('decision-modal-title').textContent = id ? 'Edit Decision' : 'Log Decision';
  document.getElementById('dec-id').value = id || '';
  if (id) {
    const d = (data.decisions || []).find(x => x.id === id); if (!d) return;
    document.getElementById('dec-title').value = d.title; document.getElementById('dec-context').value = d.context || '';
    document.getElementById('dec-reasoning').value = d.reasoning || ''; document.getElementById('dec-expected').value = d.expectedOutcome || '';
    document.getElementById('dec-date').value = d.date; document.getElementById('dec-review-days').value = 30;
    document.getElementById('dec-actual').value = d.actualOutcome || ''; document.getElementById('dec-lesson').value = d.lesson || '';
    document.getElementById('dec-delete-btn').style.display = 'inline-flex';
  } else {
    ['dec-title','dec-context','dec-reasoning','dec-expected','dec-actual','dec-lesson'].forEach(x => document.getElementById(x).value = '');
    document.getElementById('dec-date').value = todayStr(); document.getElementById('dec-review-days').value = 30;
    document.getElementById('dec-delete-btn').style.display = 'none';
  }
  openModal('decision-modal');
}
function editDecision(id) { openDecisionModal(id); }
function saveDecision() {
  const title = document.getElementById('dec-title').value.trim(); if (!title) return;
  if (!data.decisions) data.decisions = [];
  const id = document.getElementById('dec-id').value;
  const date = document.getElementById('dec-date').value || todayStr();
  const reviewDays = parseInt(document.getElementById('dec-review-days').value) || 30;
  const rd = new Date(date + 'T00:00:00'); rd.setDate(rd.getDate() + reviewDays);
  const obj = { title, context: document.getElementById('dec-context').value.trim(), reasoning: document.getElementById('dec-reasoning').value.trim(), expectedOutcome: document.getElementById('dec-expected').value.trim(), date, reviewDate: rd.toISOString().split('T')[0], actualOutcome: document.getElementById('dec-actual').value.trim(), lesson: document.getElementById('dec-lesson').value.trim() };
  if (id) { const idx = data.decisions.findIndex(d => d.id === id); if (idx >= 0) data.decisions[idx] = { ...data.decisions[idx], ...obj }; }
  else data.decisions.push({ id: uid(), ...obj });
  saveData(data); closeModal('decision-modal'); renderDecisions();
}
function deleteDecision() { const id = document.getElementById('dec-id').value; if (!id || !confirm('Delete?')) return; data.decisions = (data.decisions || []).filter(d => d.id !== id); saveData(data); closeModal('decision-modal'); renderDecisions(); }

// ===== NETWORKING =====
let networkFilter = 'all';
function filterNetwork(f, btn) {
  networkFilter = f;
  if (btn) { document.querySelectorAll('#view-network .tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); }
  renderNetwork();
}
function renderNetwork() {
  let list = [...(data.networkContacts || [])];
  const today = todayStr();
  if (networkFilter === 'overdue') list = list.filter(n => { const next = getNextReachOut(n); return next && next <= today; });
  else if (networkFilter !== 'all') list = list.filter(n => n.relationship === networkFilter);
  list.sort((a, b) => { const na = getNextReachOut(a) || '9999'; const nb = getNextReachOut(b) || '9999'; return na.localeCompare(nb); });
  if (!list.length) { document.getElementById('network-list').innerHTML = '<div class="empty-state"><p>No contacts yet. Start building your network map.</p></div>'; return; }
  const relColors = { mentor: 'var(--cat-financial)', peer: 'var(--cat-business)', prospect: 'var(--cat-learning)', partner: 'var(--cat-networking)', friend: 'var(--cat-golf)', family: 'var(--cat-religion)' };
  document.getElementById('network-list').innerHTML = list.map(n => {
    const next = getNextReachOut(n);
    const overdue = next && next <= today;
    const initials = (n.name || '??').split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
    return '<div class="network-card" style="cursor:pointer" onclick="editNetworkContact(\'' + n.id + '\')"><div class="network-avatar" style="background:' + (relColors[n.relationship] || 'var(--border)') + '">' + initials + '</div><div class="network-info"><div class="network-name">' + esc(n.name) + '</div><div class="network-sub">' + esc(n.company || '') + ' &middot; ' + cap(n.relationship || '') + (n.lastContact ? ' &middot; Last: ' + formatDate(n.lastContact) : '') + '</div>' + (overdue ? '<div class="network-overdue">Reach out today!</div>' : next ? '<div style="font-size:11px;color:var(--text-secondary)">Next: ' + formatDate(next) + '</div>' : '') + '</div><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();markReachedOut(\'' + n.id + '\')">Reached Out</button></div>';
  }).join('');
}
function getNextReachOut(n) { if (!n.lastContact || !n.frequency) return ''; const d = new Date(n.lastContact + 'T00:00:00'); d.setDate(d.getDate() + (n.frequency || 30)); return d.toISOString().split('T')[0]; }
function markReachedOut(id) { const n = (data.networkContacts || []).find(x => x.id === id); if (n) { n.lastContact = todayStr(); saveData(data); renderNetwork(); } }
function openNetworkModal(id) {
  document.getElementById('network-modal-title').textContent = id ? 'Edit Person' : 'Add Person';
  document.getElementById('net-id').value = id || '';
  if (id) {
    const n = (data.networkContacts || []).find(x => x.id === id); if (!n) return;
    document.getElementById('net-name').value = n.name; document.getElementById('net-company').value = n.company || '';
    document.getElementById('net-relationship').value = n.relationship || 'peer'; document.getElementById('net-frequency').value = n.frequency || 30;
    document.getElementById('net-give').value = n.give || ''; document.getElementById('net-get').value = n.get || '';
    document.getElementById('net-last-contact').value = n.lastContact || ''; document.getElementById('net-notes').value = n.notes || '';
    document.getElementById('net-delete-btn').style.display = 'inline-flex';
  } else {
    ['net-name','net-company','net-give','net-get','net-notes'].forEach(x => document.getElementById(x).value = '');
    document.getElementById('net-relationship').value = 'peer'; document.getElementById('net-frequency').value = 30;
    document.getElementById('net-last-contact').value = todayStr(); document.getElementById('net-delete-btn').style.display = 'none';
  }
  openModal('network-modal');
}
function editNetworkContact(id) { openNetworkModal(id); }
function saveNetworkContact() {
  const name = document.getElementById('net-name').value.trim(); if (!name) return;
  if (!data.networkContacts) data.networkContacts = [];
  const id = document.getElementById('net-id').value;
  const obj = { name, company: document.getElementById('net-company').value.trim(), relationship: document.getElementById('net-relationship').value, frequency: parseInt(document.getElementById('net-frequency').value) || 30, give: document.getElementById('net-give').value.trim(), get: document.getElementById('net-get').value.trim(), lastContact: document.getElementById('net-last-contact').value, notes: document.getElementById('net-notes').value.trim() };
  if (id) { const idx = data.networkContacts.findIndex(n => n.id === id); if (idx >= 0) data.networkContacts[idx] = { ...data.networkContacts[idx], ...obj }; }
  else data.networkContacts.push({ id: uid(), ...obj });
  saveData(data); closeModal('network-modal'); renderNetwork();
}
function deleteNetworkContact() { const id = document.getElementById('net-id').value; if (!id || !confirm('Delete?')) return; data.networkContacts = (data.networkContacts || []).filter(n => n.id !== id); saveData(data); closeModal('network-modal'); renderNetwork(); }

// ===== GOLF =====
function renderGolf() {
  const rounds = [...(data.golfRounds || [])].sort((a, b) => b.date.localeCompare(a.date));
  const scores = rounds.map(r => r.score).filter(s => s > 0);
  const avg = scores.length ? Math.round(scores.reduce((s, v) => s + v, 0) / scores.length) : 0;
  const best = scores.length ? Math.min(...scores) : 0;
  const worst = scores.length ? Math.max(...scores) : 0;
  document.getElementById('golf-kpis').innerHTML = '<div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-golf)">' + rounds.length + '</div><div class="book-kpi-label">Rounds</div></div><div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-business)">' + (best || 'â€”') + '</div><div class="book-kpi-label">Best</div></div><div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-financial)">' + (avg || 'â€”') + '</div><div class="book-kpi-label">Average</div></div><div class="book-kpi"><div class="book-kpi-val" style="color:var(--danger)">' + (worst || 'â€”') + '</div><div class="book-kpi-label">Worst</div></div>';
  if (!rounds.length) { document.getElementById('golf-list').innerHTML = '<div class="empty-state"><p>No rounds logged. Hit the course and track your progress.</p></div>'; return; }
  document.getElementById('golf-list').innerHTML = rounds.map(r => {
    const diff = r.score - (r.par || 72);
    const diffStr = diff === 0 ? 'E' : (diff > 0 ? '+' + diff : '' + diff);
    const diffColor = diff <= 0 ? 'var(--cat-business)' : diff <= 5 ? 'var(--cat-financial)' : 'var(--danger)';
    return '<div class="golf-card" style="cursor:pointer" onclick="editGolfRound(\'' + r.id + '\')"><div><div style="font-size:14px;font-weight:600">' + esc(r.course || 'Unknown Course') + '</div><div style="font-size:12px;color:var(--text-secondary)">' + formatDate(r.date) + ' &middot; Par ' + (r.par || 72) + '</div>' + (r.notes ? '<div style="font-size:11px;color:var(--text-secondary);margin-top:4px;font-style:italic">' + esc(r.notes) + '</div>' : '') + '</div><div style="text-align:right"><div class="golf-score" style="color:' + diffColor + '">' + r.score + '</div><div class="golf-diff" style="color:' + diffColor + '">' + diffStr + '</div></div></div>';
  }).join('');
}
function openGolfModal(id) {
  document.getElementById('golf-modal-title').textContent = id ? 'Edit Round' : 'Log Round';
  document.getElementById('golf-id').value = id || '';
  if (id) {
    const r = (data.golfRounds || []).find(x => x.id === id); if (!r) return;
    document.getElementById('golf-course').value = r.course || ''; document.getElementById('golf-date').value = r.date;
    document.getElementById('golf-score').value = r.score; document.getElementById('golf-par').value = r.par || 72;
    document.getElementById('golf-notes').value = r.notes || ''; document.getElementById('golf-delete-btn').style.display = 'inline-flex';
  } else {
    document.getElementById('golf-course').value = ''; document.getElementById('golf-date').value = todayStr();
    document.getElementById('golf-score').value = ''; document.getElementById('golf-par').value = 72;
    document.getElementById('golf-notes').value = ''; document.getElementById('golf-delete-btn').style.display = 'none';
  }
  openModal('golf-modal');
}
function editGolfRound(id) { openGolfModal(id); }
function saveGolfRound() {
  const score = parseInt(document.getElementById('golf-score').value); if (!score) return;
  if (!data.golfRounds) data.golfRounds = [];
  const id = document.getElementById('golf-id').value;
  const obj = { course: document.getElementById('golf-course').value.trim(), date: document.getElementById('golf-date').value || todayStr(), score, par: parseInt(document.getElementById('golf-par').value) || 72, notes: document.getElementById('golf-notes').value.trim() };
  if (id) { const idx = data.golfRounds.findIndex(r => r.id === id); if (idx >= 0) data.golfRounds[idx] = { ...data.golfRounds[idx], ...obj }; }
  else data.golfRounds.push({ id: uid(), ...obj });
  saveData(data); closeModal('golf-modal'); renderGolf();
}
function deleteGolfRound() { const id = document.getElementById('golf-id').value; if (!id || !confirm('Delete?')) return; data.golfRounds = (data.golfRounds || []).filter(r => r.id !== id); saveData(data); closeModal('golf-modal'); renderGolf(); }

// ===== GRATITUDE =====
function renderGratitude() {
  const today = todayStr();
  const todayEntry = (data.gratitudeEntries || []).find(e => e.date === today);
  document.getElementById('gratitude-today').innerHTML = '<div style="margin-bottom:12px"><div style="font-size:16px;font-weight:700;margin-bottom:4px">' + formatDate(today) + '</div><div style="font-size:12px;color:var(--text-secondary)">What are you grateful for today?</div></div>' +
    '<div class="form-group"><label style="font-size:11px">1. I\'m grateful for...</label><input type="text" class="form-control" id="grat-1" value="' + esc(todayEntry ? todayEntry.g1 || '' : '') + '" oninput="saveGratitude()" placeholder="Something you appreciate today"></div>' +
    '<div class="form-group"><label style="font-size:11px">2. I\'m grateful for...</label><input type="text" class="form-control" id="grat-2" value="' + esc(todayEntry ? todayEntry.g2 || '' : '') + '" oninput="saveGratitude()" placeholder="A person, opportunity, or moment"></div>' +
    '<div class="form-group"><label style="font-size:11px">3. I\'m grateful for...</label><input type="text" class="form-control" id="grat-3" value="' + esc(todayEntry ? todayEntry.g3 || '' : '') + '" oninput="saveGratitude()" placeholder="Something you might take for granted"></div>' +
    '<div class="form-group"><label style="font-size:11px;color:var(--cat-business)">Today\'s Win</label><input type="text" class="form-control" id="grat-win" value="' + esc(todayEntry ? todayEntry.win || '' : '') + '" oninput="saveGratitude()" placeholder="One thing that went well today"></div>' +
    '<div class="form-group"><label style="font-size:11px;color:var(--cat-learning)">Lesson Learned</label><input type="text" class="form-control" id="grat-lesson" value="' + esc(todayEntry ? todayEntry.lesson || '' : '') + '" oninput="saveGratitude()" placeholder="What did you learn today?"></div>';

  const past = [...(data.gratitudeEntries || [])].filter(e => e.date !== today).sort((a, b) => b.date.localeCompare(a.date));
  document.getElementById('gratitude-list').innerHTML = past.length ? past.map(e => '<div class="gratitude-entry"><div class="gratitude-date">' + formatDate(e.date) + '</div>' + (e.g1 ? '<div class="gratitude-item">' + esc(e.g1) + '</div>' : '') + (e.g2 ? '<div class="gratitude-item">' + esc(e.g2) + '</div>' : '') + (e.g3 ? '<div class="gratitude-item">' + esc(e.g3) + '</div>' : '') + (e.win ? '<div class="gratitude-item gratitude-win">Win: ' + esc(e.win) + '</div>' : '') + (e.lesson ? '<div class="gratitude-item gratitude-lesson">Lesson: ' + esc(e.lesson) + '</div>' : '') + '</div>').join('') : '<div class="empty-state"><p>Start filling in today\'s gratitude above. Your history will appear here.</p></div>';
}
function saveGratitude() {
  if (!data.gratitudeEntries) data.gratitudeEntries = [];
  const today = todayStr();
  const obj = { date: today, g1: document.getElementById('grat-1').value.trim(), g2: document.getElementById('grat-2').value.trim(), g3: document.getElementById('grat-3').value.trim(), win: document.getElementById('grat-win').value.trim(), lesson: document.getElementById('grat-lesson').value.trim() };
  const idx = data.gratitudeEntries.findIndex(e => e.date === today);
  if (idx >= 0) data.gratitudeEntries[idx] = { ...data.gratitudeEntries[idx], ...obj };
  else data.gratitudeEntries.push({ id: uid(), ...obj });
  saveData(data);
}

// ===== FOCUS TIMER =====
let timerInterval = null;
let timerSeconds = 25 * 60;
let timerDuration = 25;
let timerRunning = false;
let timerIsBreak = false;
let todayFocusSessions = 0;

function renderFocus() {
  updateTimerDisplay();
  const today = todayStr();
  const sessions = (data.focusSessions || []).filter(s => s.date === today);
  todayFocusSessions = sessions.length;
  document.getElementById('timer-sessions').innerHTML = Array.from({ length: 8 }, (_, i) => '<div class="timer-dot ' + (i < sessions.length ? 'done' : i === sessions.length && timerRunning ? 'active' : '') + '"></div>').join('');
  document.getElementById('focus-history').innerHTML = sessions.length ? sessions.map(s => '<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:12px;border-bottom:1px solid rgba(42,42,74,.3)"><span>' + esc(s.task || 'Focus session') + '</span><span style="color:var(--text-secondary)">' + s.duration + ' min</span></div>').join('') : '<p style="font-size:12px;color:var(--text-secondary)">No sessions today. Start the timer to focus.</p>';
}
function updateTimerDisplay() {
  const m = Math.floor(timerSeconds / 60);
  const s = timerSeconds % 60;
  document.getElementById('timer-display').textContent = String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
  document.getElementById('timer-display').style.color = timerIsBreak ? 'var(--cat-golf)' : timerRunning ? 'var(--cat-business)' : 'var(--text)';
  document.getElementById('timer-status').textContent = timerIsBreak ? 'Break time' : timerRunning ? 'Focusing...' : 'Ready to focus';
  document.getElementById('timer-start-btn').textContent = timerRunning ? 'Pause' : 'Start';
  document.getElementById('timer-start-btn').style.background = timerRunning ? 'var(--cat-financial)' : 'var(--cat-business)';
}
function toggleTimer() {
  if (timerRunning) { clearInterval(timerInterval); timerRunning = false; }
  else { timerRunning = true; timerInterval = setInterval(timerTick, 1000); }
  updateTimerDisplay();
}
function timerTick() {
  timerSeconds--;
  if (timerSeconds <= 0) {
    clearInterval(timerInterval); timerRunning = false;
    if (!timerIsBreak) {
      if (!data.focusSessions) data.focusSessions = [];
      data.focusSessions.push({ id: uid(), date: todayStr(), duration: timerDuration, task: 'Focus session' });
      saveData(data);
      timerIsBreak = true; timerSeconds = 5 * 60;
      try { new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ==').play(); } catch(e) {}
      renderFocus();
    } else {
      timerIsBreak = false; timerSeconds = timerDuration * 60;
      renderFocus();
    }
  }
  updateTimerDisplay();
}
function resetTimer() { clearInterval(timerInterval); timerRunning = false; timerIsBreak = false; timerSeconds = timerDuration * 60; updateTimerDisplay(); }
function skipTimer() { clearInterval(timerInterval); timerRunning = false; if (timerIsBreak) { timerIsBreak = false; timerSeconds = timerDuration * 60; } updateTimerDisplay(); }
function setTimerDuration(mins) { timerDuration = mins; if (!timerRunning) { timerSeconds = mins * 60; timerIsBreak = false; } updateTimerDisplay(); }

// ===== ACCOUNTABILITY MIRROR =====
function renderMirror() {
  const items = data.mirrorItems || [];
  function renderSection(type, title, icon) {
    const typeItems = items.filter(i => i.type === type).sort((a, b) => (a.order || 0) - (b.order || 0));
    if (!typeItems.length) return '';
    return '<div class="mirror-section"><h3>' + icon + ' ' + title + '</h3>' + typeItems.map(i => '<div class="mirror-item ' + i.type + '" style="cursor:pointer" onclick="editMirrorItem(\'' + i.id + '\')">' + esc(i.text) + '</div>').join('') + '</div>';
  }
  const identity = renderSection('identity', 'I AM...', '&#128170;');
  const standards = renderSection('standard', 'MY STANDARDS', '&#9889;');
  const truths = renderSection('truth', 'HARD TRUTHS', '&#128293;');
  const excuses = renderSection('excuse', 'EXCUSES I\'M KILLING', '&#9760;');
  document.getElementById('mirror-identity').innerHTML = identity || '<div class="empty-state"><p>Add your first "I AM..." statement. Who are you becoming?</p></div>';
  document.getElementById('mirror-standards').innerHTML = standards;
  document.getElementById('mirror-truths').innerHTML = truths;
  document.getElementById('mirror-excuses').innerHTML = excuses;
}
function openMirrorModal(id) {
  document.getElementById('mirror-id').value = id || '';
  if (id) {
    const i = (data.mirrorItems || []).find(x => x.id === id); if (!i) return;
    document.getElementById('mirror-type').value = i.type; document.getElementById('mirror-text').value = i.text;
    document.getElementById('mirror-delete-btn').style.display = 'inline-flex';
  } else {
    document.getElementById('mirror-type').value = 'identity'; document.getElementById('mirror-text').value = '';
    document.getElementById('mirror-delete-btn').style.display = 'none';
  }
  openModal('mirror-modal');
}
function editMirrorItem(id) { openMirrorModal(id); }
function saveMirrorItem() {
  const text = document.getElementById('mirror-text').value.trim(); if (!text) return;
  if (!data.mirrorItems) data.mirrorItems = [];
  const id = document.getElementById('mirror-id').value;
  const obj = { type: document.getElementById('mirror-type').value, text, order: data.mirrorItems.length };
  if (id) { const idx = data.mirrorItems.findIndex(i => i.id === id); if (idx >= 0) data.mirrorItems[idx] = { ...data.mirrorItems[idx], ...obj }; }
  else data.mirrorItems.push({ id: uid(), ...obj });
  saveData(data); closeModal('mirror-modal'); renderMirror();
}
function deleteMirrorItem() { const id = document.getElementById('mirror-id').value; if (!id || !confirm('Delete?')) return; data.mirrorItems = (data.mirrorItems || []).filter(i => i.id !== id); saveData(data); closeModal('mirror-modal'); renderMirror(); }

// ===== ENERGY & SLEEP =====
function renderEnergy() {
  const today = todayStr();
  const todayLog = (data.energyLog || []).find(e => e.date === today) || {};
  function dotRow(label, field, val) {
    const colors = ['#ef4444','#ef4444','#f97316','#f97316','#eab308','#eab308','#84cc16','#22c55e','#10b981','#10b981'];
    return '<div class="energy-row"><div class="energy-label">' + label + '</div><div class="energy-dots">' + Array.from({ length: 10 }, (_, i) => {
      const n = i + 1; const active = val === n;
      return '<div class="energy-dot' + (active ? ' active' : '') + '" style="' + (active ? 'background:' + colors[i] + ';border-color:' + colors[i] : '') + '" onclick="setEnergy(\'' + field + '\',' + n + ')">' + n + '</div>';
    }).join('') + '</div></div>';
  }
  var sleepHrs = todayLog.sleep || 0;
  var bedVal = todayLog.bedtime || '';
  var wakeVal = todayLog.waketime || '';
  if (bedVal && wakeVal && !sleepHrs) sleepHrs = calcSleepHours(bedVal, wakeVal);

  document.getElementById('energy-today').innerHTML = '<div style="font-size:16px;font-weight:700;margin-bottom:12px">' + formatDate(today) + '</div>' +
    '<div class="energy-row"><div class="energy-label">Bedtime</div><input type="time" class="form-control" style="width:120px" id="energy-bedtime" value="' + bedVal + '" onchange="saveSleepTimes()"></div>' +
    '<div class="energy-row"><div class="energy-label">Wake up</div><input type="time" class="form-control" style="width:120px" id="energy-waketime" value="' + wakeVal + '" onchange="saveSleepTimes()"></div>' +
    '<div class="energy-row"><div class="energy-label">Sleep</div><div style="font-size:18px;font-weight:700;color:' + (sleepHrs >= 7 ? 'var(--cat-business)' : sleepHrs >= 5 ? 'var(--cat-financial)' : 'var(--danger)') + '">' + (sleepHrs ? sleepHrs.toFixed(1) + ' hrs' : '--') + '</div></div>' +
    dotRow('Morning', 'morning', todayLog.morning || 0) +
    dotRow('Midday', 'midday', todayLog.midday || 0) +
    dotRow('Evening', 'evening', todayLog.evening || 0);

  const logs = [...(data.energyLog || [])].filter(e => e.date !== today).sort((a, b) => b.date.localeCompare(a.date)).slice(0, 14);
  const allLogs = (data.energyLog || []).filter(e => e.sleep > 0);
  const avgSleep = allLogs.length ? (allLogs.reduce((s, e) => s + (e.sleep || 0), 0) / allLogs.length).toFixed(1) : 'â€”';
  const avgEnergy = allLogs.length ? (allLogs.reduce((s, e) => s + ((e.morning || 0) + (e.midday || 0) + (e.evening || 0)) / 3, 0) / allLogs.length).toFixed(1) : 'â€”';
  document.getElementById('energy-kpis').innerHTML = '<div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-learning)">' + avgSleep + '</div><div class="book-kpi-label">Avg Sleep (hrs)</div></div><div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-business)">' + avgEnergy + '</div><div class="book-kpi-label">Avg Energy</div></div><div class="book-kpi"><div class="book-kpi-val" style="color:var(--cat-financial)">' + allLogs.length + '</div><div class="book-kpi-label">Days Tracked</div></div>';

  document.getElementById('energy-history').innerHTML = logs.length ? logs.map(e => {
    const eColor = v => v >= 7 ? 'var(--cat-business)' : v >= 4 ? 'var(--cat-financial)' : 'var(--danger)';
    var sleepDisplay = e.sleep ? e.sleep.toFixed(1) + 'h' : '';
    var timeDisplay = (e.bedtime && e.waketime) ? ' (' + formatTime12(e.bedtime) + ' - ' + formatTime12(e.waketime) + ')' : '';
    return '<div class="energy-day"><div class="energy-day-date">' + formatDate(e.date) + (sleepDisplay ? ' &middot; ' + sleepDisplay + ' sleep' + timeDisplay : '') + '</div>' +
      '<div class="energy-bar-mini"><div class="energy-bar-mini-label">AM</div><div class="energy-bar-mini-track"><div class="energy-bar-mini-fill" style="width:' + (e.morning || 0) * 10 + '%;background:' + eColor(e.morning || 0) + '"></div></div></div>' +
      '<div class="energy-bar-mini"><div class="energy-bar-mini-label">PM</div><div class="energy-bar-mini-track"><div class="energy-bar-mini-fill" style="width:' + (e.midday || 0) * 10 + '%;background:' + eColor(e.midday || 0) + '"></div></div></div>' +
      '<div class="energy-bar-mini"><div class="energy-bar-mini-label">Eve</div><div class="energy-bar-mini-track"><div class="energy-bar-mini-fill" style="width:' + (e.evening || 0) * 10 + '%;background:' + eColor(e.evening || 0) + '"></div></div></div></div>';
  }).join('') : '';
}
function setEnergy(field, val) {
  if (!data.energyLog) data.energyLog = [];
  const today = todayStr();
  let entry = data.energyLog.find(e => e.date === today);
  if (!entry) { entry = { id: uid(), date: today }; data.energyLog.push(entry); }
  entry[field] = val;
  saveData(data); renderEnergy();
}
function saveEnergyField(field, val) {
  if (!data.energyLog) data.energyLog = [];
  const today = todayStr();
  let entry = data.energyLog.find(e => e.date === today);
  if (!entry) { entry = { id: uid(), date: today }; data.energyLog.push(entry); }
  entry[field] = parseFloat(val) || 0;
  saveData(data);
}

function calcSleepHours(bedtime, waketime) {
  var bedParts = bedtime.split(':');
  var wakeParts = waketime.split(':');
  var bedMin = parseInt(bedParts[0]) * 60 + parseInt(bedParts[1]);
  var wakeMin = parseInt(wakeParts[0]) * 60 + parseInt(wakeParts[1]);
  var diff = wakeMin - bedMin;
  if (diff <= 0) diff += 1440; // crossed midnight
  return diff / 60;
}

function formatTime12(time24) {
  if (!time24) return '';
  var parts = time24.split(':');
  var h = parseInt(parts[0]);
  var m = parts[1];
  var ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  return h + ':' + m + ' ' + ampm;
}

function saveSleepTimes() {
  if (!data.energyLog) data.energyLog = [];
  var today = todayStr();
  var entry = data.energyLog.find(function(e) { return e.date === today; });
  if (!entry) { entry = { id: uid(), date: today }; data.energyLog.push(entry); }
  var bed = document.getElementById('energy-bedtime').value;
  var wake = document.getElementById('energy-waketime').value;
  entry.bedtime = bed;
  entry.waketime = wake;
  if (bed && wake) {
    entry.sleep = parseFloat(calcSleepHours(bed, wake).toFixed(1));
  }
  saveData(data);
  renderEnergy();
}

// ===== HEALTH =====
let healthTab = 'overview';

function switchHealthTab(tab) {
  healthTab = tab;
  document.querySelectorAll('.health-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.health-view').forEach(v => v.classList.remove('active'));
  document.querySelector(`.health-tab[onclick*="${tab}"]`).classList.add('active');
  document.getElementById('health-' + tab).classList.add('active');
  renderHealthTab(tab);
}

function renderHealth() {
  renderHealthTab(healthTab);
}

function renderHealthTab(tab) {
  if (tab === 'overview') renderHealthOverview();
  else if (tab === 'weight') renderHealthWeight();
  else if (tab === 'water') renderHealthWater();
  else if (tab === 'meals') renderHealthMeals();
  else if (tab === 'supplements') renderHealthSupplements();
  else if (tab === 'workouts') renderHealthWorkouts();
  else if (tab === 'routine') renderHealthRoutine();
  else if (tab === 'progress') renderHealthProgress();
}

function todayKey() { return new Date().toISOString().split('T')[0]; }

function renderHealthOverview() {
  const today = todayKey();
  const weights = data.weightLog || [];
  const lastWeight = weights.length ? weights[weights.length - 1] : null;
  const waterToday = (data.waterLog || {})[today] || 0;
  const todayMeals = (data.meals || []).filter(m => m.date === today);
  const todayCals = todayMeals.reduce((s, m) => s + (m.calories || 0), 0);
  const todayProtein = todayMeals.reduce((s, m) => s + (m.protein || 0), 0);
  const supps = data.supplements || [];
  const suppLog = (data.suppLog || {})[today] || {};
  const suppsTaken = supps.filter(s => suppLog[s.id]).length;
  const workouts = data.workouts || [];
  const thisWeek = workouts.filter(w => {
    const d = new Date(w.date + 'T00:00:00');
    const now = new Date();
    const diff = (now - d) / (1000 * 60 * 60 * 24);
    return diff >= 0 && diff < 7;
  });

  document.getElementById('health-overview').innerHTML =
    '<div class="health-kpi-grid">' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-gym)">' + (lastWeight ? lastWeight.weight + ' lbs' : '--') + '</div><div class="health-kpi-label">Current Weight</div>' + (lastWeight ? '<div class="health-kpi-sub">' + formatDate(lastWeight.date) + '</div>' : '') + '</div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:#4FC3F7">' + (waterToday * 16) + ' oz</div><div class="health-kpi-label">Water Today</div><div class="health-kpi-sub">Goal: 1 gallon (128 oz)</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-financial)">' + todayCals + '</div><div class="health-kpi-label">Calories Today</div><div class="health-kpi-sub">' + todayProtein + 'p / ' + todayMeals.reduce(function(s,m){return s+(m.carbs||0)},0) + 'c / ' + todayMeals.reduce(function(s,m){return s+(m.fats||0)},0) + 'f</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-business)">' + suppsTaken + '/' + supps.length + '</div><div class="health-kpi-label">Supps Taken</div><div class="health-kpi-sub">Today</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-gym)">' + thisWeek.length + '</div><div class="health-kpi-label">Workouts This Week</div><div class="health-kpi-sub">' + thisWeek.reduce((s, w) => s + (w.duration || 0), 0) + ' min total</div></div>' +
    '</div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">' +
      '<div class="card"><div class="card-header"><h2>Today\'s Meals</h2></div>' +
        (todayMeals.length ? todayMeals.map(m =>
          '<div class="meal-card"><div class="meal-type" style="color:var(--cat-gym)">' + m.type + '</div><div class="meal-desc">' + esc(m.description) + '</div><div class="meal-cal">' + (m.calories || 0) + ' cal</div></div>'
        ).join('') : '<p style="font-size:12px;color:var(--text-muted);padding:8px">No meals logged today.</p>') +
      '</div>' +
      '<div class="card"><div class="card-header"><h2>Recent Workouts</h2></div>' +
        (workouts.length ? [...workouts].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 3).map(w =>
          '<div class="workout-card"><div class="workout-head"><span class="workout-type">' + esc(w.type) + '</span><span class="workout-date">' + formatDate(w.date) + '</span></div><div class="workout-details">' + esc(w.details || '') + ' &middot; ' + (w.duration || 0) + ' min</div></div>'
        ).join('') : '<p style="font-size:12px;color:var(--text-muted);padding:8px">No workouts logged yet.</p>') +
      '</div>' +
    '</div>';
}

// WEIGHT
function renderHealthWeight() {
  const weights = [...(data.weightLog || [])].sort((a, b) => a.date.localeCompare(b.date));
  const last30 = weights.slice(-30);
  const latest = weights.length ? weights[weights.length - 1] : null;
  const first = weights.length ? weights[0] : null;
  const change = (latest && first) ? (latest.weight - first.weight).toFixed(1) : 0;
  const goal = data.weightGoal || 0;

  let chartHtml = '';
  if (last30.length > 1) {
    const min = Math.min(...last30.map(w => w.weight));
    const max = Math.max(...last30.map(w => w.weight));
    const range = max - min || 1;
    chartHtml = '<div class="weight-chart">' +
      last30.map(w => {
        const h = Math.max(5, Math.round(((w.weight - min) / range) * 100));
        return '<div class="weight-bar" style="height:' + h + '%" data-label="' + w.weight + ' lbs â€” ' + w.date + '"></div>';
      }).join('') +
    '</div>' +
    '<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-bottom:16px"><span>' + formatDate(last30[0].date) + '</span><span>' + formatDate(last30[last30.length - 1].date) + '</span></div>';
  }

  document.getElementById('health-weight').innerHTML =
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">' +
      '<div>' +
        '<span style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary)">Weight Tracker</span>' +
        (goal ? '<span style="font-size:11px;color:var(--text-muted);margin-left:12px">Goal: ' + goal + ' lbs</span>' : '') +
      '</div>' +
      '<div style="display:flex;gap:6px">' +
        '<button class="btn btn-ghost btn-sm" onclick="setWeightGoal()">Set Goal</button>' +
        '<button class="btn btn-primary btn-sm" onclick="openWeightModal()">+ Log Weight</button>' +
      '</div>' +
    '</div>' +
    '<div class="health-kpi-grid">' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-gym)">' + (latest ? latest.weight : '--') + '</div><div class="health-kpi-label">Current (lbs)</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:' + (change > 0 ? 'var(--danger)' : change < 0 ? 'var(--cat-business)' : 'var(--text-secondary)') + '">' + (change > 0 ? '+' : '') + change + '</div><div class="health-kpi-label">Total Change</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-learning)">' + weights.length + '</div><div class="health-kpi-label">Weigh-ins</div></div>' +
      (goal ? '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-financial)">' + (latest ? Math.abs(latest.weight - goal).toFixed(1) : '--') + '</div><div class="health-kpi-label">lbs to Goal</div></div>' : '') +
    '</div>' +
    '<div class="card">' +
      '<div class="card-header"><h2>Trend (Last 30)</h2></div>' +
      (chartHtml || '<p style="font-size:12px;color:var(--text-muted);padding:8px">Log at least 2 weigh-ins to see a trend.</p>') +
    '</div>' +
    '<div class="card" style="margin-top:14px">' +
      '<div class="card-header"><h2>History</h2></div>' +
      ([...weights].reverse().slice(0, 20).map(w =>
        '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px">' +
          '<span>' + formatDate(w.date) + '</span>' +
          '<span style="font-weight:600">' + w.weight + ' lbs</span>' +
          (w.notes ? '<span style="color:var(--text-secondary);font-size:12px">' + esc(w.notes) + '</span>' : '<span></span>') +
          '<button class="btn btn-ghost btn-sm" onclick="deleteWeight(\'' + w.id + '\')" style="color:var(--danger)">&times;</button>' +
        '</div>'
      ).join('') || '<p style="font-size:12px;color:var(--text-muted);padding:8px">No weigh-ins logged yet.</p>') +
    '</div>';
}

function openWeightModal() {
  document.getElementById('weight-val').value = '';
  document.getElementById('weight-date').value = todayKey();
  document.getElementById('weight-notes').value = '';
  openModal('weight-modal');
}

function saveWeight() {
  const weight = parseFloat(document.getElementById('weight-val').value);
  if (!weight) return;
  if (!data.weightLog) data.weightLog = [];
  data.weightLog.push({
    id: uid(),
    weight,
    date: document.getElementById('weight-date').value || todayKey(),
    notes: document.getElementById('weight-notes').value.trim()
  });
  data.weightLog.sort((a, b) => a.date.localeCompare(b.date));
  saveData(data);
  closeModal('weight-modal');
  renderHealthWeight();
}

function deleteWeight(id) {
  data.weightLog = (data.weightLog || []).filter(w => w.id !== id);
  saveData(data);
  renderHealthWeight();
}

function setWeightGoal() {
  const g = prompt('Enter your weight goal (lbs):', data.weightGoal || '');
  if (g === null) return;
  data.weightGoal = parseFloat(g) || 0;
  saveData(data);
  renderHealthWeight();
}

// WATER
function renderHealthWater() {
  const today = todayKey();
  if (!data.waterLog) data.waterLog = {};
  const glasses = data.waterLog[today] || 0;
  const goal = 8;
  const pct = Math.min(100, Math.round((glasses / goal) * 100));

  // Last 7 days
  const last7 = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const key = d.toISOString().split('T')[0];
    const dayLabel = d.toLocaleDateString('en-US', { weekday: 'short' });
    last7.push({ key, label: dayLabel, glasses: data.waterLog[key] || 0 });
  }

  document.getElementById('health-water').innerHTML =
    '<div class="card" style="margin-bottom:14px">' +
      '<div class="card-header"><h2>Today\'s Water Intake</h2></div>' +
      '<div style="text-align:center;margin:16px 0">' +
        '<div style="font-size:48px;font-weight:800;color:#4FC3F7">' + (glasses * 16) + ' oz</div>' +
        '<div style="font-size:13px;color:var(--text-secondary)">of 128 oz (1 gallon)</div>' +
        '<div class="progress-bar" style="margin-top:10px;height:8px;background:var(--border);border-radius:4px;overflow:hidden"><div style="width:' + pct + '%;height:100%;background:#4FC3F7;border-radius:4px;transition:width .3s"></div></div>' +
      '</div>' +
      '<div style="text-align:center;font-size:12px;color:var(--text-secondary);margin-bottom:12px">Each drop = 16 oz &mdash; click to fill</div>' +
      '<div class="water-dots" style="justify-content:center">' +
        Array.from({ length: 10 }, (_, i) =>
          '<div class="water-glass' + (i < glasses ? ' filled' : '') + '" onclick="setWater(' + (i + 1) + ')">&#128167;</div>'
        ).join('') +
      '</div>' +
    '</div>' +
    '<div class="card">' +
      '<div class="card-header"><h2>Last 7 Days</h2></div>' +
      '<div style="display:flex;gap:8px;align-items:flex-end;height:120px;padding:10px 0">' +
        last7.map(d => {
          const oz = d.glasses * 16;
          const h = Math.max(5, Math.round((oz / 160) * 100));
          const color = oz >= 128 ? '#4FC3F7' : oz >= 80 ? 'var(--cat-financial)' : 'var(--border-light)';
          return '<div style="flex:1;text-align:center"><div style="height:' + h + '%;background:' + color + ';border-radius:3px 3px 0 0;min-height:4px;margin:0 auto;width:80%"></div><div style="font-size:10px;color:var(--text-secondary);margin-top:4px">' + d.label + '</div><div style="font-size:11px;font-weight:600">' + oz + '</div></div>';
        }).join('') +
      '</div>' +
    '</div>';
}

function setWater(count) {
  const today = todayKey();
  if (!data.waterLog) data.waterLog = {};
  // If clicking the same count as current, decrease by 1 (toggle off last)
  if (data.waterLog[today] === count) {
    data.waterLog[today] = count - 1;
  } else {
    data.waterLog[today] = count;
  }
  saveData(data);
  renderHealthWater();
}

// MEALS
function macroRingSvg(current, goal, color, label) {
  if (!goal) {
    return '<div class="macro-ring"><svg viewBox="0 0 36 36"><circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--border)" stroke-width="2.5"/><text x="18" y="19" text-anchor="middle" font-size="5" font-weight="700" fill="var(--text-secondary)">--</text></svg><div class="macro-ring-label">' + label + '</div><div class="macro-ring-sub">No goal set</div></div>';
  }
  var pct = Math.min(100, Math.round((current / goal) * 100));
  var dashArr = (pct * 100 / 100).toFixed(1) + ' ' + (100 - pct).toFixed(1);
  var overColor = current > goal ? 'var(--danger)' : color;
  return '<div class="macro-ring"><svg viewBox="0 0 36 36">' +
    '<circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--border)" stroke-width="2.5"/>' +
    '<circle cx="18" cy="18" r="15.9" fill="none" stroke="' + overColor + '" stroke-width="2.5" stroke-dasharray="' + dashArr + '" stroke-dashoffset="25" stroke-linecap="round"/>' +
    '<text x="18" y="17" text-anchor="middle" font-size="6" font-weight="800" fill="' + overColor + '">' + pct + '%</text>' +
    '<text x="18" y="22" text-anchor="middle" font-size="3.2" fill="var(--text-secondary)">' + current + '/' + goal + '</text>' +
    '</svg><div class="macro-ring-label">' + label + '</div><div class="macro-ring-val" style="color:' + overColor + '">' + current + '<span style="font-size:11px;font-weight:400;color:var(--text-muted)">/' + goal + '</span></div></div>';
}

function renderHealthMeals() {
  const today = todayKey();
  const allMeals = data.meals || [];
  const todayMeals = allMeals.filter(m => m.date === today);
  const todayCals = todayMeals.reduce((s, m) => s + (m.calories || 0), 0);
  const todayProtein = todayMeals.reduce((s, m) => s + (m.protein || 0), 0);
  const todayCarbs = todayMeals.reduce((s, m) => s + (m.carbs || 0), 0);
  const todayFats = todayMeals.reduce((s, m) => s + (m.fats || 0), 0);

  if (!data.macroGoals) data.macroGoals = { calories: 0, protein: 0, carbs: 0, fats: 0 };
  const goals = data.macroGoals;

  // Last 7 days calorie trend
  const last7 = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const key = d.toISOString().split('T')[0];
    const dayLabel = d.toLocaleDateString('en-US', { weekday: 'short' });
    const dayMeals = allMeals.filter(m => m.date === key);
    last7.push({ label: dayLabel, cals: dayMeals.reduce((s, m) => s + (m.calories || 0), 0) });
  }
  const maxCal = Math.max(...last7.map(d => d.cals), 1);

  document.getElementById('health-meals').innerHTML =
    '<div style="display:flex;justify-content:flex-end;gap:6px;margin-bottom:12px">' +
      '<button class="btn btn-ghost btn-sm" onclick="setMacroGoals()">Set Goals</button>' +
      '<button class="btn btn-primary btn-sm" onclick="openMealModal()">+ Log Meal</button>' +
    '</div>' +

    // Macro progress rings
    '<div class="macro-grid">' +
      macroRingSvg(todayCals, goals.calories, 'var(--cat-financial)', 'Calories') +
      macroRingSvg(todayProtein, goals.protein, 'var(--cat-gym)', 'Protein (g)') +
      macroRingSvg(todayCarbs, goals.carbs, 'var(--cat-learning)', 'Carbs (g)') +
      macroRingSvg(todayFats, goals.fats, 'var(--cat-networking)', 'Fats (g)') +
    '</div>' +

    // Macro progress bars (compact)
    (goals.calories ? '<div class="card" style="margin-bottom:14px"><div class="card-header"><h2>Daily Progress</h2></div>' +
      buildMacroBar('Calories', todayCals, goals.calories, 'var(--cat-financial)') +
      buildMacroBar('Protein', todayProtein, goals.protein, 'var(--cat-gym)') +
      buildMacroBar('Carbs', todayCarbs, goals.carbs, 'var(--cat-learning)') +
      buildMacroBar('Fats', todayFats, goals.fats, 'var(--cat-networking)') +
    '</div>' : '') +

    // Today's meals
    '<div class="card" style="margin-bottom:14px">' +
      '<div class="card-header"><h2>Today\'s Meals</h2></div>' +
      (todayMeals.length ? todayMeals.map(m =>
        '<div class="meal-card">' +
          '<div class="meal-type" style="color:var(--cat-gym)">' + m.type + '</div>' +
          '<div class="meal-desc">' + esc(m.description) + '</div>' +
          '<div style="display:flex;gap:8px;align-items:center">' +
            '<div class="meal-cal">' + (m.calories || 0) + ' cal</div>' +
            '<div style="font-size:10px;color:var(--text-secondary)">' +
              (m.protein ? m.protein + 'p ' : '') +
              (m.carbs ? m.carbs + 'c ' : '') +
              (m.fats ? m.fats + 'f' : '') +
            '</div>' +
          '</div>' +
          '<button class="btn btn-ghost btn-sm" onclick="deleteMeal(\'' + m.id + '\')" style="color:var(--danger)">&times;</button>' +
        '</div>'
      ).join('') : '<p style="font-size:12px;color:var(--text-muted);padding:8px">No meals logged today. Tap + to add one.</p>') +
    '</div>' +

    // 7-day trend
    '<div class="card">' +
      '<div class="card-header"><h2>Calorie Trend (7 Days)</h2></div>' +
      '<div style="display:flex;gap:8px;align-items:flex-end;height:100px;padding:10px 0">' +
        last7.map(d => {
          const h = Math.max(3, Math.round((d.cals / maxCal) * 100));
          const barColor = goals.calories ? (d.cals > goals.calories ? 'var(--danger)' : d.cals >= goals.calories * 0.8 ? 'var(--cat-business)' : 'var(--cat-financial)') : 'var(--cat-financial)';
          return '<div style="flex:1;text-align:center"><div style="height:' + h + '%;background:' + barColor + ';border-radius:3px 3px 0 0;min-height:4px;margin:0 auto;width:80%"></div><div style="font-size:10px;color:var(--text-secondary);margin-top:4px">' + d.label + '</div><div style="font-size:11px;font-weight:600">' + d.cals + '</div></div>';
        }).join('') +
      '</div>' +
      (goals.calories ? '<div style="font-size:11px;color:var(--text-muted);text-align:center;margin-top:4px">Goal: ' + goals.calories + ' cal/day</div>' : '') +
    '</div>';
}

function buildMacroBar(label, current, goal, color) {
  if (!goal) return '';
  var pct = Math.min(100, Math.round((current / goal) * 100));
  var remaining = Math.max(0, goal - current);
  var overColor = current > goal ? 'var(--danger)' : color;
  return '<div style="margin-bottom:10px">' +
    '<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px">' +
      '<span style="color:var(--text-secondary)">' + label + '</span>' +
      '<span style="font-weight:600;color:' + overColor + '">' + current + ' / ' + goal + (current > goal ? ' (over!)' : ' (' + remaining + ' left)') + '</span>' +
    '</div>' +
    '<div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden"><div style="width:' + pct + '%;height:100%;background:' + overColor + ';border-radius:4px;transition:width .3s"></div></div>' +
  '</div>';
}

function setMacroGoals() {
  if (!data.macroGoals) data.macroGoals = { calories: 0, protein: 0, carbs: 0, fats: 0 };
  var cal = prompt('Daily calorie goal:', data.macroGoals.calories || '');
  if (cal === null) return;
  var pro = prompt('Daily protein goal (g):', data.macroGoals.protein || '');
  if (pro === null) return;
  var carb = prompt('Daily carbs goal (g):', data.macroGoals.carbs || '');
  if (carb === null) return;
  var fat = prompt('Daily fats goal (g):', data.macroGoals.fats || '');
  if (fat === null) return;
  data.macroGoals = {
    calories: parseInt(cal) || 0,
    protein: parseInt(pro) || 0,
    carbs: parseInt(carb) || 0,
    fats: parseInt(fat) || 0
  };
  saveData(data);
  renderHealthMeals();
}

function openMealModal() {
  document.getElementById('meal-type').value = 'Breakfast';
  document.getElementById('meal-cal').value = '';
  document.getElementById('meal-desc').value = '';
  document.getElementById('meal-protein').value = '';
  document.getElementById('meal-carbs').value = '';
  document.getElementById('meal-fats').value = '';
  document.getElementById('meal-date').value = todayKey();
  openModal('meal-modal');
}

function saveMeal() {
  const desc = document.getElementById('meal-desc').value.trim();
  if (!desc) return;
  if (!data.meals) data.meals = [];
  data.meals.push({
    id: uid(),
    type: document.getElementById('meal-type').value,
    description: desc,
    calories: parseInt(document.getElementById('meal-cal').value) || 0,
    protein: parseInt(document.getElementById('meal-protein').value) || 0,
    carbs: parseInt(document.getElementById('meal-carbs').value) || 0,
    fats: parseInt(document.getElementById('meal-fats').value) || 0,
    date: document.getElementById('meal-date').value || todayKey()
  });
  saveData(data);
  closeModal('meal-modal');
  renderHealthMeals();
}

function deleteMeal(id) {
  data.meals = (data.meals || []).filter(m => m.id !== id);
  saveData(data);
  renderHealthMeals();
}

// SUPPLEMENTS
function renderHealthSupplements() {
  const today = todayKey();
  const supps = data.supplements || [];
  if (!data.suppLog) data.suppLog = {};
  const todayLog = data.suppLog[today] || {};
  const taken = supps.filter(s => todayLog[s.id]).length;

  // Streak
  let streak = 0;
  if (supps.length) {
    const d = new Date();
    while (true) {
      const key = d.toISOString().split('T')[0];
      const log = data.suppLog[key] || {};
      const allTaken = supps.every(s => log[s.id]);
      if (allTaken) {
        streak++;
        d.setDate(d.getDate() - 1);
      } else {
        if (streak === 0 && key === todayKey()) { d.setDate(d.getDate() - 1); continue; }
        break;
      }
    }
  }

  document.getElementById('health-supplements').innerHTML =
    '<div style="display:flex;justify-content:flex-end;margin-bottom:12px"><button class="btn btn-primary btn-sm" onclick="openSuppModal()">+ Add Supplement</button></div>' +
    '<div class="health-kpi-grid">' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-business)">' + taken + '/' + supps.length + '</div><div class="health-kpi-label">Taken Today</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-financial)">' + streak + '</div><div class="health-kpi-label">Day Streak</div><div class="health-kpi-sub">All supps taken</div></div>' +
    '</div>' +
    '<div class="card">' +
      '<div class="card-header"><h2>Today\'s Supplements</h2></div>' +
      (supps.length ? supps.map(s => {
        const done = todayLog[s.id] ? true : false;
        return '<div class="supp-item' + (done ? ' taken' : '') + '" onclick="toggleSupp(\'' + s.id + '\')">' +
          '<div class="supp-check' + (done ? ' done' : '') + '">&#10003;</div>' +
          '<div style="flex:1"><span style="font-weight:600">' + esc(s.name) + '</span><span style="color:var(--text-secondary);margin-left:8px;font-size:12px">' + esc(s.dosage || '') + '</span></div>' +
          '<span style="font-size:11px;color:var(--text-muted)">' + esc(s.timeOfDay || '') + '</span>' +
          '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteSupp(\'' + s.id + '\')" style="color:var(--danger)">&times;</button>' +
        '</div>';
      }).join('') : '<p style="font-size:12px;color:var(--text-muted);padding:8px">No supplements added yet. Click + to add your stack.</p>') +
    '</div>';
}

function openSuppModal() {
  document.getElementById('supp-name').value = '';
  document.getElementById('supp-dose').value = '';
  document.getElementById('supp-time').value = 'Morning';
  openModal('supp-modal');
}

function saveSupplement() {
  const name = document.getElementById('supp-name').value.trim();
  if (!name) return;
  if (!data.supplements) data.supplements = [];
  data.supplements.push({
    id: uid(),
    name,
    dosage: document.getElementById('supp-dose').value.trim(),
    timeOfDay: document.getElementById('supp-time').value
  });
  saveData(data);
  closeModal('supp-modal');
  renderHealthSupplements();
}

function toggleSupp(id) {
  const today = todayKey();
  if (!data.suppLog) data.suppLog = {};
  if (!data.suppLog[today]) data.suppLog[today] = {};
  data.suppLog[today][id] = !data.suppLog[today][id];
  saveData(data);
  renderHealthSupplements();
}

function deleteSupp(id) {
  if (!confirm('Remove this supplement?')) return;
  data.supplements = (data.supplements || []).filter(s => s.id !== id);
  saveData(data);
  renderHealthSupplements();
}

// WORKOUTS
function renderHealthWorkouts() {
  const workouts = [...(data.workouts || [])].sort((a, b) => b.date.localeCompare(a.date));
  const thisWeek = workouts.filter(w => {
    const d = new Date(w.date + 'T00:00:00');
    const diff = (new Date() - d) / (1000 * 60 * 60 * 24);
    return diff >= 0 && diff < 7;
  });
  const totalMin = thisWeek.reduce((s, w) => s + (w.duration || 0), 0);
  const totalCal = thisWeek.reduce((s, w) => s + (w.caloriesBurned || 0), 0);

  // Workout type breakdown
  const types = {};
  workouts.forEach(w => { types[w.type] = (types[w.type] || 0) + 1; });

  document.getElementById('health-workouts').innerHTML =
    '<div style="display:flex;justify-content:flex-end;margin-bottom:12px"><button class="btn btn-primary btn-sm" onclick="openWorkoutModal()">+ Log Workout</button></div>' +
    '<div class="health-kpi-grid">' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-gym)">' + thisWeek.length + '</div><div class="health-kpi-label">Workouts This Week</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-financial)">' + totalMin + '</div><div class="health-kpi-label">Minutes This Week</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-learning)">' + workouts.length + '</div><div class="health-kpi-label">Total Workouts</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--danger)">' + totalCal + '</div><div class="health-kpi-label">Cals Burned (Week)</div></div>' +
    '</div>' +
    (Object.keys(types).length ? '<div class="card" style="margin-bottom:14px"><div class="card-header"><h2>Workout Breakdown</h2></div>' +
      Object.entries(types).sort((a, b) => b[1] - a[1]).map(([type, count]) => {
        const maxT = Math.max(...Object.values(types));
        const w = Math.max(8, Math.round((count / maxT) * 100));
        return '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;font-size:12px"><div style="width:100px;color:var(--text-secondary);flex-shrink:0">' + esc(type) + '</div><div style="flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden"><div style="width:' + w + '%;height:100%;background:var(--cat-gym);border-radius:3px"></div></div><div style="font-weight:600;width:30px;text-align:right">' + count + '</div></div>';
      }).join('') +
    '</div>' : '') +
    '<div class="card"><div class="card-header"><h2>Recent Workouts</h2></div>' +
      (workouts.length ? workouts.slice(0, 15).map(w =>
        '<div class="workout-card">' +
          '<div class="workout-head">' +
            '<span class="workout-type">' + esc(w.type) + '</span>' +
            '<span class="workout-date">' + formatDate(w.date) + ' &middot; ' + (w.duration || 0) + ' min' + (w.caloriesBurned ? ' &middot; ' + w.caloriesBurned + ' cal' : '') + '</span>' +
          '</div>' +
          (w.details ? '<div class="workout-details">' + esc(w.details) + '</div>' : '') +
          '<div style="margin-top:6px"><button class="btn btn-ghost btn-sm" onclick="deleteWorkout(\'' + w.id + '\')" style="color:var(--danger)">Delete</button></div>' +
        '</div>'
      ).join('') : '<p style="font-size:12px;color:var(--text-muted);padding:8px">No workouts logged yet.</p>') +
    '</div>';
}

function openWorkoutModal() {
  document.getElementById('workout-type').value = 'Weight Training';
  document.getElementById('workout-duration').value = '';
  document.getElementById('workout-details').value = '';
  document.getElementById('workout-cal').value = '';
  document.getElementById('workout-date').value = todayKey();
  openModal('workout-modal');
}

function saveWorkout() {
  const duration = parseInt(document.getElementById('workout-duration').value) || 0;
  if (!duration) return;
  if (!data.workouts) data.workouts = [];
  data.workouts.push({
    id: uid(),
    type: document.getElementById('workout-type').value,
    duration,
    details: document.getElementById('workout-details').value.trim(),
    caloriesBurned: parseInt(document.getElementById('workout-cal').value) || 0,
    date: document.getElementById('workout-date').value || todayKey()
  });
  saveData(data);
  closeModal('workout-modal');
  renderHealthWorkouts();
}

function deleteWorkout(id) {
  if (!confirm('Delete this workout?')) return;
  data.workouts = (data.workouts || []).filter(w => w.id !== id);
  saveData(data);
  renderHealthWorkouts();
}

// ROUTINE BUILDER
const ROUTINE_DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

function renderHealthRoutine() {
  if (!data.workoutRoutine) data.workoutRoutine = {};
  if (!data.routineLabels) data.routineLabels = {};
  if (!data.routineLog) data.routineLog = {};

  const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
  const today = todayKey();
  const todayLog = data.routineLog[today] || {};

  // Count total exercises and completed today
  let totalExercises = 0;
  let completedToday = 0;
  const todayExercises = data.workoutRoutine[todayName] || [];
  totalExercises = todayExercises.length;
  completedToday = todayExercises.filter(e => todayLog[e.id]).length;

  // Get exercise history for showing last logged weight
  var history = data.exerciseHistory || [];

  document.getElementById('health-routine').innerHTML =
    '<div class="health-kpi-grid" style="margin-bottom:16px">' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-gym)">' + todayName + '</div><div class="health-kpi-label">Today</div><div class="health-kpi-sub">' + (data.routineLabels[todayName] || 'No label set') + '</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-business)">' + completedToday + '/' + totalExercises + '</div><div class="health-kpi-label">Today\'s Progress</div><div class="health-kpi-sub">' + (totalExercises ? Math.round((completedToday / totalExercises) * 100) + '% done' : 'No exercises') + '</div></div>' +
      '<div class="health-kpi"><div class="health-kpi-val" style="color:var(--cat-learning)">' + ROUTINE_DAYS.reduce(function(s, d) { return s + (data.workoutRoutine[d] || []).length; }, 0) + '</div><div class="health-kpi-label">Total Exercises</div><div class="health-kpi-sub">In weekly routine</div></div>' +
    '</div>' +

    ROUTINE_DAYS.map(function(day) {
      var isToday = day === todayName;
      var exercises = data.workoutRoutine[day] || [];
      var label = data.routineLabels[day] || '';
      var dayLog = isToday ? todayLog : {};
      var doneCount = exercises.filter(function(e) { return dayLog[e.id]; }).length;

      return '<div class="routine-day' + (isToday ? ' today' : '') + '">' +
        '<div class="routine-day-head">' +
          '<h3>' + (isToday ? '&#128293; ' : '') + day +
            (label ? ' <span class="routine-day-label" style="background:rgba(233,30,99,.1);color:var(--cat-gym)">' + esc(label) + '</span>' : '') +
          '</h3>' +
          '<div style="display:flex;gap:4px;align-items:center">' +
            (exercises.length && isToday ? '<span style="font-size:11px;color:var(--text-secondary)">' + doneCount + '/' + exercises.length + '</span>' : '') +
            '<button class="btn btn-ghost btn-sm" onclick="openRoutineLabelModal(\'' + day + '\')" title="Set label">&#9997;</button>' +
            '<button class="btn btn-primary btn-sm" onclick="openExerciseModal(\'' + day + '\')">+ Exercise</button>' +
          '</div>' +
        '</div>' +
        (exercises.length ? exercises.map(function(e) {
          var done = isToday && dayLog[e.id];
          var logEntry = done && typeof dayLog[e.id] === 'object' ? dayLog[e.id] : null;
          // Find last logged weight for this exercise
          var exHist = history.filter(function(h) { return h.exerciseName === e.name; }).sort(function(a, b) { return b.date.localeCompare(a.date); });
          var lastLog = exHist.length ? exHist[0] : null;
          var pr = exHist.length >= 2 && lastLog && parseFloat(lastLog.weight) > parseFloat(exHist[1].weight);

          return '<div class="exercise-row' + (done ? ' done' : '') + '">' +
            (isToday ? '<div class="exercise-check' + (done ? ' done' : '') + '" onclick="openLogSetModal(\'' + e.id + '\',\'' + esc(e.name).replace(/'/g, "\\'") + '\')">&#10003;</div>' : '') +
            '<div class="exercise-name" style="' + (done ? 'text-decoration:line-through;opacity:.6' : '') + '">' + esc(e.name) + (pr ? '<span class="pr-badge">PR</span>' : '') + '</div>' +
            '<div class="exercise-meta">' +
              (e.sets ? e.sets + ' sets' : '') +
              (e.reps ? ' x ' + esc(e.reps) : '') +
              (e.weight ? ' @ ' + esc(e.weight) + ' lbs' : '') +
              (e.rest ? ' &middot; ' + e.rest + 's rest' : '') +
            '</div>' +
            (logEntry ? '<div style="font-size:10px;color:var(--cat-business);font-weight:600">Logged: ' + esc(logEntry.weight || '') + ' lbs x ' + esc(logEntry.reps || '') + (logEntry.notes ? ' â€” ' + esc(logEntry.notes) : '') + '</div>' :
              (lastLog ? '<div style="font-size:10px;color:var(--text-muted)">Last: ' + esc(lastLog.weight) + ' lbs (' + formatDate(lastLog.date) + ')</div>' : '')
            ) +
            '<button class="btn btn-ghost btn-sm" onclick="editExercise(\'' + day + '\',\'' + e.id + '\')" style="font-size:10px">Edit</button>' +
          '</div>';
        }).join('') : '<div style="padding:8px;font-size:12px;color:var(--text-muted);text-align:center">' + (label && label.toLowerCase().includes('rest') ? 'Rest day &#128164;' : 'No exercises added yet.') + '</div>') +
      '</div>';
    }).join('');
}

function openRoutineLabelModal(day) {
  document.getElementById('rl-day').value = day;
  document.getElementById('routine-label-title').textContent = day + ' â€” Set Label';
  document.getElementById('rl-label').value = (data.routineLabels || {})[day] || '';
  openModal('routine-label-modal');
}

function saveRoutineLabel() {
  var day = document.getElementById('rl-day').value;
  if (!data.routineLabels) data.routineLabels = {};
  data.routineLabels[day] = document.getElementById('rl-label').value.trim();
  saveData(data);
  closeModal('routine-label-modal');
  renderHealthRoutine();
}

function openExerciseModal(day, exId) {
  document.getElementById('ex-day').value = day;
  document.getElementById('ex-id').value = exId || '';
  document.getElementById('exercise-modal-title').textContent = exId ? 'Edit Exercise' : 'Add Exercise â€” ' + day;

  if (exId) {
    var exercises = (data.workoutRoutine || {})[day] || [];
    var ex = exercises.find(function(e) { return e.id === exId; });
    if (ex) {
      document.getElementById('ex-name').value = ex.name || '';
      document.getElementById('ex-sets').value = ex.sets || '';
      document.getElementById('ex-reps').value = ex.reps || '';
      document.getElementById('ex-weight').value = ex.weight || '';
      document.getElementById('ex-rest').value = ex.rest || '';
      document.getElementById('ex-notes').value = ex.notes || '';
      document.getElementById('ex-delete-btn').style.display = 'inline-flex';
    }
  } else {
    document.getElementById('ex-name').value = '';
    document.getElementById('ex-sets').value = '';
    document.getElementById('ex-reps').value = '';
    document.getElementById('ex-weight').value = '';
    document.getElementById('ex-rest').value = '';
    document.getElementById('ex-notes').value = '';
    document.getElementById('ex-delete-btn').style.display = 'none';
  }
  openModal('exercise-modal');
}

function editExercise(day, exId) { openExerciseModal(day, exId); }

function saveExercise() {
  var day = document.getElementById('ex-day').value;
  var exId = document.getElementById('ex-id').value;
  var name = document.getElementById('ex-name').value.trim();
  if (!name) return;

  if (!data.workoutRoutine) data.workoutRoutine = {};
  if (!data.workoutRoutine[day]) data.workoutRoutine[day] = [];

  var obj = {
    name: name,
    sets: parseInt(document.getElementById('ex-sets').value) || 0,
    reps: document.getElementById('ex-reps').value.trim(),
    weight: document.getElementById('ex-weight').value.trim(),
    rest: parseInt(document.getElementById('ex-rest').value) || 0,
    notes: document.getElementById('ex-notes').value.trim()
  };

  if (exId) {
    var idx = data.workoutRoutine[day].findIndex(function(e) { return e.id === exId; });
    if (idx >= 0) data.workoutRoutine[day][idx] = Object.assign({}, data.workoutRoutine[day][idx], obj);
  } else {
    obj.id = uid();
    data.workoutRoutine[day].push(obj);
  }
  saveData(data);
  closeModal('exercise-modal');
  renderHealthRoutine();
}

function deleteExercise() {
  var day = document.getElementById('ex-day').value;
  var exId = document.getElementById('ex-id').value;
  if (!exId || !confirm('Delete this exercise?')) return;
  if (data.workoutRoutine && data.workoutRoutine[day]) {
    data.workoutRoutine[day] = data.workoutRoutine[day].filter(function(e) { return e.id !== exId; });
  }
  saveData(data);
  closeModal('exercise-modal');
  renderHealthRoutine();
}

function openLogSetModal(exId, exName) {
  var today = todayKey();
  var dayLog = (data.routineLog || {})[today] || {};
  var existing = typeof dayLog[exId] === 'object' ? dayLog[exId] : null;

  // Find the exercise in the routine to get planned weight/reps
  var planned = null;
  var todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
  var exercises = (data.workoutRoutine || {})[todayName] || [];
  planned = exercises.find(function(e) { return e.id === exId; });

  document.getElementById('ls-exid').value = exId;
  document.getElementById('ls-exname').value = exName;
  document.getElementById('logset-title').textContent = 'Log: ' + exName;

  if (existing) {
    document.getElementById('ls-weight').value = existing.weight || '';
    document.getElementById('ls-sets').value = existing.sets || '';
    document.getElementById('ls-reps').value = existing.reps || '';
    document.getElementById('ls-notes').value = existing.notes || '';
  } else {
    // Pre-fill with planned values
    document.getElementById('ls-weight').value = planned ? (planned.weight || '') : '';
    document.getElementById('ls-sets').value = planned ? (planned.sets || '') : '';
    document.getElementById('ls-reps').value = planned ? (planned.reps || '') : '';
    document.getElementById('ls-notes').value = '';
  }
  openModal('logset-modal');
}

function saveLogSet() {
  var exId = document.getElementById('ls-exid').value;
  var exName = document.getElementById('ls-exname').value;
  var weight = document.getElementById('ls-weight').value.trim();
  var sets = document.getElementById('ls-sets').value;
  var reps = document.getElementById('ls-reps').value.trim();
  var notes = document.getElementById('ls-notes').value.trim();
  var today = todayKey();

  if (!data.routineLog) data.routineLog = {};
  if (!data.routineLog[today]) data.routineLog[today] = {};

  // Store performance data instead of just true
  data.routineLog[today][exId] = {
    weight: weight,
    sets: parseInt(sets) || 0,
    reps: reps,
    notes: notes
  };

  // Also add to exercise history for long-term tracking
  if (!data.exerciseHistory) data.exerciseHistory = [];
  // Remove any existing entry for this exercise on this date
  data.exerciseHistory = data.exerciseHistory.filter(function(h) {
    return !(h.exerciseId === exId && h.date === today);
  });
  data.exerciseHistory.push({
    id: uid(),
    exerciseId: exId,
    exerciseName: exName,
    date: today,
    weight: weight,
    sets: parseInt(sets) || 0,
    reps: reps,
    notes: notes
  });

  saveData(data);
  closeModal('logset-modal');
  renderHealthRoutine();
}

function unlogExercise() {
  var exId = document.getElementById('ls-exid').value;
  var today = todayKey();
  if (!data.routineLog) data.routineLog = {};
  if (data.routineLog[today]) {
    delete data.routineLog[today][exId];
  }
  // Also remove from history for today
  if (data.exerciseHistory) {
    data.exerciseHistory = data.exerciseHistory.filter(function(h) {
      return !(h.exerciseId === exId && h.date === today);
    });
  }
  saveData(data);
  closeModal('logset-modal');
  renderHealthRoutine();
}

// PROGRESS TRACKING
function renderHealthProgress() {
  if (!data.exerciseHistory) data.exerciseHistory = [];
  var history = data.exerciseHistory;

  // Get unique exercise names
  var exerciseNames = {};
  history.forEach(function(h) {
    if (h.exerciseName && h.weight) exerciseNames[h.exerciseName] = true;
  });
  var names = Object.keys(exerciseNames).sort();

  if (!names.length) {
    document.getElementById('health-progress').innerHTML =
      '<div style="text-align:center;padding:40px;color:var(--text-muted)">' +
        '<div style="font-size:36px;margin-bottom:12px">&#128170;</div>' +
        '<p style="font-size:14px;margin-bottom:6px">No exercise data yet.</p>' +
        '<p style="font-size:12px">Go to the Routine tab, complete exercises, and log your weights. Your progress will show up here.</p>' +
      '</div>';
    return;
  }

  document.getElementById('health-progress').innerHTML =
    '<div style="margin-bottom:16px;font-size:12px;color:var(--text-secondary)">' +
      'Tracking ' + names.length + ' exercises &middot; ' + history.length + ' total logged sessions' +
    '</div>' +
    names.map(function(name) {
      var entries = history.filter(function(h) { return h.exerciseName === name && h.weight; })
        .sort(function(a, b) { return a.date.localeCompare(b.date); });
      if (!entries.length) return '';

      var weights = entries.map(function(e) { return parseFloat(e.weight) || 0; });
      var maxW = Math.max.apply(null, weights);
      var minW = Math.min.apply(null, weights);
      var range = maxW - minW || 1;
      var latest = entries[entries.length - 1];
      var first = entries[0];
      var change = (parseFloat(latest.weight) || 0) - (parseFloat(first.weight) || 0);
      var isPR = weights.length >= 2 && weights[weights.length - 1] >= maxW;

      // Find all-time PR
      var prWeight = maxW;
      var prEntry = entries.find(function(e) { return parseFloat(e.weight) === prWeight; });

      return '<div class="progress-exercise">' +
        '<h3>' + esc(name) +
          (isPR ? '<span class="pr-badge">PR</span>' : '') +
        '</h3>' +
        '<div style="display:flex;gap:16px;margin-bottom:10px;font-size:12px">' +
          '<div><span style="color:var(--text-secondary)">Current:</span> <strong style="color:var(--cat-gym)">' + esc(latest.weight) + ' lbs</strong></div>' +
          '<div><span style="color:var(--text-secondary)">PR:</span> <strong style="color:var(--cat-business)">' + prWeight + ' lbs</strong></div>' +
          '<div><span style="color:var(--text-secondary)">Change:</span> <strong style="color:' + (change > 0 ? 'var(--cat-business)' : change < 0 ? 'var(--danger)' : 'var(--text-secondary)') + '">' + (change > 0 ? '+' : '') + change.toFixed(1) + ' lbs</strong></div>' +
          '<div><span style="color:var(--text-secondary)">Sessions:</span> <strong>' + entries.length + '</strong></div>' +
        '</div>' +
        // Bar chart
        '<div class="progress-bars">' +
          entries.slice(-20).map(function(e) {
            var w = parseFloat(e.weight) || 0;
            var h = Math.max(8, Math.round(((w - minW + range * 0.1) / (range * 1.2)) * 100));
            var isMax = w === maxW;
            var color = isMax ? 'var(--cat-business)' : 'var(--cat-gym)';
            return '<div class="progress-bar-col">' +
              '<div class="progress-bar-fill" style="height:' + h + '%;background:' + color + '" title="' + e.date + ': ' + w + ' lbs"></div>' +
              '<div class="progress-bar-wt" style="color:' + color + '">' + w + '</div>' +
              '<div class="progress-bar-date">' + formatDate(e.date).replace(/, \d{4}/, '') + '</div>' +
            '</div>';
          }).join('') +
        '</div>' +
        // Recent log details
        '<div style="margin-top:10px">' +
          entries.slice(-5).reverse().map(function(e) {
            return '<div style="display:flex;gap:12px;padding:4px 0;border-bottom:1px solid var(--border);font-size:11px">' +
              '<span style="color:var(--text-secondary);width:60px">' + formatDate(e.date).replace(/, \d{4}/, '') + '</span>' +
              '<span style="font-weight:600;width:60px">' + esc(e.weight) + ' lbs</span>' +
              '<span style="color:var(--text-secondary)">' + (e.sets ? e.sets + ' sets' : '') + (e.reps ? ' x ' + esc(e.reps) : '') + '</span>' +
              (e.notes ? '<span style="color:var(--text-muted);flex:1">' + esc(e.notes) + '</span>' : '') +
            '</div>';
          }).join('') +
        '</div>' +
      '</div>';
    }).join('');
}

// ===== INIT =====
renderDashboard();
</script>
</body>
</html>
